<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-cpp">#include &quot;inline.hs&quot;
</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Module      : Streamly.Internal.Data.Stream.StreamD</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- Copyright   : (c) 2018 Composewell Technologies</span><span>
</span><span id="line-6"></span><span class="hs-comment">--               (c) Roman Leshchinskiy 2008-2010</span><span>
</span><span id="line-7"></span><span class="hs-comment">--               (c) The University of Glasgow, 2009</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- License     : BSD3</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Maintainer  : streamly@composewell.com</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- Stability   : experimental</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Portability : GHC</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- Direct style re-implementation of CPS style stream in StreamK module.  The</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- symbol or suffix 'D' in this module denotes the &quot;Direct&quot; style.  GHC is able</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- to INLINE and fuse direct style better, providing better performance than</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- CPS implementation.</span><span>
</span><span id="line-18"></span><span class="hs-comment">--</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- import qualified Streamly.Internal.Data.Stream.StreamD as D</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-comment">-- Some of the functions in this file have been adapted from the vector</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- library,  https://hackage.haskell.org/package/vector.</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Streamly.Internal.Data.Stream.StreamD</span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">(</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-comment">-- * The stream type</span></span><span>
</span><span id="line-29"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Step"><span class="hs-identifier">Step</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier">Stream</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier">UnStream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Construction</span></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#nil"><span class="hs-identifier">nil</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#nilM"><span class="hs-identifier">nilM</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#cons"><span class="hs-identifier">cons</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Deconstruction</span></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#uncons"><span class="hs-identifier">uncons</span></a></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Generation</span></span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Unfolds</span></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#unfoldr"><span class="hs-identifier">unfoldr</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#unfoldrM"><span class="hs-identifier">unfoldrM</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#unfold"><span class="hs-identifier">unfold</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Specialized Generation</span></span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Generate a monadic stream from a seed.</span></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#repeat"><span class="hs-identifier">repeat</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#repeatM"><span class="hs-identifier">repeatM</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#replicate"><span class="hs-identifier">replicate</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#replicateM"><span class="hs-identifier">replicateM</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromIndices"><span class="hs-identifier">fromIndices</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromIndicesM"><span class="hs-identifier">fromIndicesM</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#generate"><span class="hs-identifier">generate</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#generateM"><span class="hs-identifier">generateM</span></a></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#iterate"><span class="hs-identifier">iterate</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#iterateM"><span class="hs-identifier">iterateM</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Enumerations</span></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepIntegral"><span class="hs-identifier">enumerateFromStepIntegral</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromIntegral"><span class="hs-identifier">enumerateFromIntegral</span></a></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenIntegral"><span class="hs-identifier">enumerateFromThenIntegral</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromToIntegral"><span class="hs-identifier">enumerateFromToIntegral</span></a></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegral"><span class="hs-identifier">enumerateFromThenToIntegral</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepNum"><span class="hs-identifier">enumerateFromStepNum</span></a></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#numFrom"><span class="hs-identifier">numFrom</span></a></span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#numFromThen"><span class="hs-identifier">numFromThen</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromToFractional"><span class="hs-identifier">enumerateFromToFractional</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToFractional"><span class="hs-identifier">enumerateFromThenToFractional</span></a></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Time</span></span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#times"><span class="hs-identifier">times</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Conversions</span></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">-- | Transform an input structure into a stream.</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-comment">-- | Direct style stream does not support @fromFoldable@.</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#yield"><span class="hs-identifier">yield</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#yieldM"><span class="hs-identifier">yieldM</span></a></span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromList"><span class="hs-identifier">fromList</span></a></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromListM"><span class="hs-identifier">fromListM</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromStreamK"><span class="hs-identifier">fromStreamK</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromStreamD"><span class="hs-identifier">fromStreamD</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromPrimIORef"><span class="hs-identifier">fromPrimIORef</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromSVar"><span class="hs-identifier">fromSVar</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Elimination</span></span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** General Folds</span></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldrS"><span class="hs-identifier">foldrS</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldrT"><span class="hs-identifier">foldrT</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldrM"><span class="hs-identifier">foldrM</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldrMx"><span class="hs-identifier">foldrMx</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldr"><span class="hs-identifier">foldr</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#foldr1"><span class="hs-identifier">foldr1</span></a></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldl%27"><span class="hs-identifier">foldl'</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldlM%27"><span class="hs-identifier">foldlM'</span></a></span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#foldlS"><span class="hs-identifier">foldlS</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#foldlT"><span class="hs-identifier">foldlT</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#reverse"><span class="hs-identifier">reverse</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#reverse%27"><span class="hs-identifier">reverse'</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldlx%27"><span class="hs-identifier">foldlx'</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldlMx%27"><span class="hs-identifier">foldlMx'</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runFold"><span class="hs-identifier">runFold</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#parselMx%27"><span class="hs-identifier">parselMx'</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#parseMany"><span class="hs-identifier">parseMany</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#parseIterate"><span class="hs-identifier">parseIterate</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Specialized Folds</span></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tap"><span class="hs-identifier">tap</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tapOffsetEvery"><span class="hs-identifier">tapOffsetEvery</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tapAsync"><span class="hs-identifier">tapAsync</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tapRate"><span class="hs-identifier">tapRate</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#pollCounts"><span class="hs-identifier">pollCounts</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#drain"><span class="hs-identifier">drain</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#null"><span class="hs-identifier">null</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#head"><span class="hs-identifier">head</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#headElse"><span class="hs-identifier">headElse</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tail"><span class="hs-identifier">tail</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#last"><span class="hs-identifier">last</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#elem"><span class="hs-identifier">elem</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#notElem"><span class="hs-identifier">notElem</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#all"><span class="hs-identifier">all</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#any"><span class="hs-identifier">any</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#maximum"><span class="hs-identifier">maximum</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#maximumBy"><span class="hs-identifier">maximumBy</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#minimum"><span class="hs-identifier">minimum</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#minimumBy"><span class="hs-identifier">minimumBy</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#findIndices"><span class="hs-identifier">findIndices</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#lookup"><span class="hs-identifier">lookup</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#findM"><span class="hs-identifier">findM</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#find"><span class="hs-identifier">find</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#%21%21"><span class="hs-operator">(!!)</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#toSVarParallel"><span class="hs-identifier">toSVarParallel</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Flattening nested streams</span></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#concatMapM"><span class="hs-identifier">concatMapM</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#concatMap"><span class="hs-identifier">concatMap</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUState"><span class="hs-identifier">ConcatMapUState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#concatMapU"><span class="hs-identifier">concatMapU</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveState"><span class="hs-identifier">ConcatUnfoldInterleaveState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#concatUnfoldInterleave"><span class="hs-identifier">concatUnfoldInterleave</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#concatUnfoldRoundrobin"><span class="hs-identifier">concatUnfoldRoundrobin</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendState"><span class="hs-identifier">AppendState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#append"><span class="hs-identifier">append</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveState"><span class="hs-identifier">InterleaveState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interleave"><span class="hs-identifier">interleave</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interleaveMin"><span class="hs-identifier">interleaveMin</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interleaveSuffix"><span class="hs-identifier">interleaveSuffix</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interleaveInfix"><span class="hs-identifier">interleaveInfix</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#roundRobin"><span class="hs-identifier">roundRobin</span></a></span><span> </span><span class="hs-comment">-- interleaveFair?/ParallelFair</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#gintercalateSuffix"><span class="hs-identifier">gintercalateSuffix</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interposeSuffix"><span class="hs-identifier">interposeSuffix</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#gintercalate"><span class="hs-identifier">gintercalate</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interpose"><span class="hs-identifier">interpose</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Grouping</span></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#groupsOf"><span class="hs-identifier">groupsOf</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#groupsOf2"><span class="hs-identifier">groupsOf2</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#groupsBy"><span class="hs-identifier">groupsBy</span></a></span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#groupsRollingBy"><span class="hs-identifier">groupsRollingBy</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Splitting</span></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitBy"><span class="hs-identifier">splitBy</span></a></span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitSuffixBy"><span class="hs-identifier">splitSuffixBy</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#wordsBy"><span class="hs-identifier">wordsBy</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitSuffixBy%27"><span class="hs-identifier">splitSuffixBy'</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitOn"><span class="hs-identifier">splitOn</span></a></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitSuffixOn"><span class="hs-identifier">splitSuffixOn</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitInnerBy"><span class="hs-identifier">splitInnerBy</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitInnerBySuffix"><span class="hs-identifier">splitInnerBySuffix</span></a></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Substreams</span></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#isPrefixOf"><span class="hs-identifier">isPrefixOf</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#isSubsequenceOf"><span class="hs-identifier">isSubsequenceOf</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#stripPrefix"><span class="hs-identifier">stripPrefix</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Map and Fold</span></span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mapM_"><span class="hs-identifier">mapM_</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Conversions</span></span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Transform a stream into another type.</span></span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#toList"><span class="hs-identifier">toList</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#toListRev"><span class="hs-identifier">toListRev</span></a></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#toStreamK"><span class="hs-identifier">toStreamK</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#toStreamD"><span class="hs-identifier">toStreamD</span></a></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#hoist"><span class="hs-identifier">hoist</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#generally"><span class="hs-identifier">generally</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#liftInner"><span class="hs-identifier">liftInner</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runReaderT"><span class="hs-identifier">runReaderT</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#evalStateT"><span class="hs-identifier">evalStateT</span></a></span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runStateT"><span class="hs-identifier">runStateT</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Transformation</span></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#transform"><span class="hs-identifier">transform</span></a></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** By folding (scans)</span></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlM%27"><span class="hs-identifier">scanlM'</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlMAfter%27"><span class="hs-identifier">scanlMAfter'</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl%27"><span class="hs-identifier">scanl'</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlM"><span class="hs-identifier">scanlM</span></a></span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl"><span class="hs-identifier">scanl</span></a></span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1M%27"><span class="hs-identifier">scanl1M'</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1%27"><span class="hs-identifier">scanl1'</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1M"><span class="hs-identifier">scanl1M</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1"><span class="hs-identifier">scanl1</span></a></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#prescanl%27"><span class="hs-identifier">prescanl'</span></a></span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#prescanlM%27"><span class="hs-identifier">prescanlM'</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanl"><span class="hs-identifier">postscanl</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlM"><span class="hs-identifier">postscanlM</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanl%27"><span class="hs-identifier">postscanl'</span></a></span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlM%27"><span class="hs-identifier">postscanlM'</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlMAfter%27"><span class="hs-identifier">postscanlMAfter'</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlx%27"><span class="hs-identifier">postscanlx'</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlMx%27"><span class="hs-identifier">postscanlMx'</span></a></span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlMx%27"><span class="hs-identifier">scanlMx'</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlx%27"><span class="hs-identifier">scanlx'</span></a></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Filtering</span></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#filter"><span class="hs-identifier">filter</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#filterM"><span class="hs-identifier">filterM</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#uniq"><span class="hs-identifier">uniq</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#take"><span class="hs-identifier">take</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#takeByTime"><span class="hs-identifier">takeByTime</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhile"><span class="hs-identifier">takeWhile</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhileM"><span class="hs-identifier">takeWhileM</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#drop"><span class="hs-identifier">drop</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#dropByTime"><span class="hs-identifier">dropByTime</span></a></span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#dropWhile"><span class="hs-identifier">dropWhile</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#dropWhileM"><span class="hs-identifier">dropWhileM</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Mapping</span></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#map"><span class="hs-identifier">map</span></a></span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#mapM"><span class="hs-identifier">mapM</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#sequence"><span class="hs-identifier">sequence</span></a></span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#rollingMap"><span class="hs-identifier">rollingMap</span></a></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#rollingMapM"><span class="hs-identifier">rollingMapM</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Inserting</span></span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseM"><span class="hs-identifier">intersperseM</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseM_"><span class="hs-identifier">intersperseM_</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperse"><span class="hs-identifier">intersperse</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseSuffix"><span class="hs-identifier">intersperseSuffix</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseSuffix_"><span class="hs-identifier">intersperseSuffix_</span></a></span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseSuffixBySpan"><span class="hs-identifier">intersperseSuffixBySpan</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#insertBy"><span class="hs-identifier">insertBy</span></a></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Deleting</span></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#deleteBy"><span class="hs-identifier">deleteBy</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Map and Filter</span></span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mapMaybe"><span class="hs-identifier">mapMaybe</span></a></span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mapMaybeM"><span class="hs-identifier">mapMaybeM</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Zipping</span></span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#indexed"><span class="hs-identifier">indexed</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#indexedR"><span class="hs-identifier">indexedR</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#zipWith"><span class="hs-identifier">zipWith</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#zipWithM"><span class="hs-identifier">zipWithM</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Comparisons</span></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#eqBy"><span class="hs-identifier">eqBy</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#cmpBy"><span class="hs-identifier">cmpBy</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Merging</span></span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mergeBy"><span class="hs-identifier">mergeBy</span></a></span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mergeByM"><span class="hs-identifier">mergeByM</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Transformation comprehensions</span></span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#the"><span class="hs-identifier">the</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Exceptions</span></span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#newFinalizedIORef"><span class="hs-identifier">newFinalizedIORef</span></a></span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runIORefFinalizer"><span class="hs-identifier">runIORefFinalizer</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#withIORefFinalizer"><span class="hs-identifier">withIORefFinalizer</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket_"><span class="hs-identifier">gbracket_</span></a></span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket"><span class="hs-identifier">gbracket</span></a></span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#before"><span class="hs-identifier">before</span></a></span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#after_"><span class="hs-identifier">after_</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#after"><span class="hs-identifier">after</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#bracket_"><span class="hs-identifier">bracket_</span></a></span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#bracket"><span class="hs-identifier">bracket</span></a></span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#onException"><span class="hs-identifier">onException</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#finally_"><span class="hs-identifier">finally_</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#finally"><span class="hs-identifier">finally</span></a></span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ghandle"><span class="hs-identifier">ghandle</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#handle"><span class="hs-identifier">handle</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Concurrent Application</span></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mkParallel"><span class="hs-identifier">mkParallel</span></a></span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mkParallelD"><span class="hs-identifier">mkParallelD</span></a></span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#newCallbackStream"><span class="hs-identifier">newCallbackStream</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#lastN"><span class="hs-identifier">lastN</span></a></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span class="hs-keyword">where</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">killThread</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">myThreadId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">takeMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">threadDelay</span></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span>
</span><span id="line-309"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">assert</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Exception</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">SomeException</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AsyncException</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromException</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mask_</span></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">void</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">forever</span></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadCatch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MonadThrow</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwM</span></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ReaderT</span></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StateT</span></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadTrans</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lift</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">liftBaseOp_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">control</span></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bits</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">shiftR</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">shiftL</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.|.)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.&amp;.)</span></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor.Identity</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Identity</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Int</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mkWeakIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">writeIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">IORef</span></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromJust</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isNothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word32</span></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.Ptr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ptr</span></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.Storable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Storable</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Exts</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SpecConstrAnnotation</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SPEC</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Mem</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">performMajorGC</span></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Fusion.Plugin.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Fuse</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.IORef.Prim.html"><span class="hs-identifier">Streamly.Internal.Data.IORef.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Prim</span></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html"><span class="hs-identifier">Streamly.Internal.Data.Time.Units</span></a></span><span>
</span><span id="line-331"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#TimeUnit64"><span class="hs-identifier">TimeUnit64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#toRelTime64"><span class="hs-identifier">toRelTime64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#diffAbsTime64"><span class="hs-identifier">diffAbsTime64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#RelTime64"><span class="hs-identifier">RelTime64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Atomics.html"><span class="hs-identifier">Streamly.Internal.Data.Atomics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Atomics.html#atomicModifyIORefCAS_"><span class="hs-identifier">atomicModifyIORefCAS_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html"><span class="hs-identifier">Streamly.Internal.Data.Array.Storable.Foreign.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#Array"><span class="hs-identifier">Array</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html"><span class="hs-identifier">Streamly.Internal.Data.Fold.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier">Fold</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Parser.html"><span class="hs-identifier">Streamly.Internal.Data.Parser</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#ParseError"><span class="hs-identifier">ParseError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html"><span class="hs-identifier">Streamly.Internal.Data.Pipe.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#Pipe"><span class="hs-identifier">Pipe</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#PipeState"><span class="hs-identifier">PipeState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Clock.html"><span class="hs-identifier">Streamly.Internal.Data.Time.Clock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Time.Clock.html#Clock"><span class="hs-identifier">Clock</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Time.Clock.html#Monotonic"><span class="hs-identifier">Monotonic</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Clock.html#getTime"><span class="hs-identifier">getTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html"><span class="hs-identifier">Streamly.Internal.Data.Time.Units</span></a></span><span>
</span><span id="line-339"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#MicroSecond64"><span class="hs-identifier">MicroSecond64</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#fromAbsTime"><span class="hs-identifier">fromAbsTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#toAbsTime"><span class="hs-identifier">toAbsTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#AbsTime"><span class="hs-identifier">AbsTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html"><span class="hs-identifier">Streamly.Internal.Data.Unfold.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier">Unfold</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Tuple.Strict.html"><span class="hs-identifier">Streamly.Internal.Data.Tuple.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier">Tuple3'</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.SVar.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.SVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.SVar.html#fromConsumer"><span class="hs-identifier">fromConsumer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.SVar.html#pushToFold"><span class="hs-identifier">pushToFold</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.IORef.Prim.html"><span class="hs-identifier">Streamly.Internal.Data.IORef.Prim</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Prim</span></span><span>
</span><span id="line-345"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html"><span class="hs-identifier">Streamly.Internal.Data.Pipe.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pipe</span></span><span>
</span><span id="line-346"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html"><span class="hs-identifier">Streamly.Internal.Data.Array.Storable.Foreign.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-347"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Storable.Foreign.Mut.Types.html"><span class="hs-identifier">Streamly.Internal.Data.Array.Storable.Foreign.Mut.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MA</span></span><span>
</span><span id="line-348"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.html"><span class="hs-identifier">Streamly.Internal.Data.Fold</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FL</span></span><span>
</span><span id="line-349"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Memory.Ring.html"><span class="hs-identifier">Streamly.Memory.Ring</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RB</span></span><span>
</span><span id="line-350"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.StreamK</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">K</span></span><span>
</span><span id="line-351"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Parser.html"><span class="hs-identifier">Streamly.Internal.Data.Parser</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PR</span></span><span>
</span><span id="line-352"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.html"><span class="hs-identifier">Streamly.Internal.Data.Parser.ParserD</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PRD</span></span><span>
</span><span id="line-353"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span>
</span><span id="line-354"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Reader</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Reader</span></span><span>
</span><span id="line-355"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">State</span></span><span>
</span><span id="line-356"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-359"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">map</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapM_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">repeat</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">foldr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">last</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">take</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">filter</span></span><span>
</span><span id="line-360"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">takeWhile</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">drop</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">dropWhile</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">all</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">any</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">maximum</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">minimum</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">elem</span></span><span>
</span><span id="line-361"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">notElem</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">null</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">head</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tail</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zipWith</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">lookup</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">foldr1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sequence</span></span><span>
</span><span id="line-362"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(!!)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">scanl</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">scanl1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">concatMap</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">replicate</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">enumFromTo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">concat</span></span><span>
</span><span id="line-363"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">reverse</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">iterate</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">splitAt</span></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.StreamD.Type</span></a></span><span>
</span><span id="line-365"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html"><span class="hs-identifier">Streamly.Internal.Data.SVar</span></a></span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- Construction</span><span>
</span><span id="line-369"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span class="hs-comment">-- | An empty 'Stream'.</span><span>
</span><span id="line-372"></span><span class="hs-pragma">{-# INLINE_NORMAL nil #-}</span><span>
</span><span id="line-373"></span><span id="local-6989586621679314670"><span id="local-6989586621679314671"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#nil"><span class="hs-identifier hs-type">nil</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314671"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314671"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314670"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-374"></span><span id="nil"><span class="annot"><span class="annottext">nil :: Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#nil"><span class="hs-identifier hs-var hs-var">nil</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; () -&gt; m (Step () a)) -&gt; () -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step () a -&gt; m (Step () a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step () a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span class="hs-comment">-- | An empty 'Stream' with a side effect.</span><span>
</span><span id="line-377"></span><span class="hs-pragma">{-# INLINE_NORMAL nilM #-}</span><span>
</span><span id="line-378"></span><span id="local-6989586621679315422"><span id="local-6989586621679315423"><span id="local-6989586621679315424"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#nilM"><span class="hs-identifier hs-type">nilM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315424"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315424"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315423"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315424"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315422"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-379"></span><span id="nilM"><span class="annot"><span class="annottext">nilM :: m b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#nilM"><span class="hs-identifier hs-var hs-var">nilM</span></a></span></span><span> </span><span id="local-6989586621679314668"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679314668"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; () -&gt; m (Step () a)) -&gt; () -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679314668"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; m (Step () a) -&gt; m (Step () a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Step () a -&gt; m (Step () a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step () a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span class="hs-pragma">{-# INLINE_NORMAL consM #-}</span><span>
</span><span id="line-382"></span><span id="local-6989586621679315320"><span id="local-6989586621679315321"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#consM"><span class="hs-identifier hs-type">consM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315321"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315321"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315320"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315321"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315320"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315321"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315320"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-383"></span><span id="consM"><span class="annot"><span class="annottext">consM :: m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#consM"><span class="hs-identifier hs-var hs-var">consM</span></a></span></span><span> </span><span id="local-6989586621679314666"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314666"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314665"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314665"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314664"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314664"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a))
-&gt; Maybe s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679314663"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step1 #-}</span><span>
</span><span id="line-386"></span><span>    </span><span id="local-6989586621679314663"><span class="annot"><span class="annottext">step1 :: State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679314663"><span class="hs-identifier hs-var hs-var">step1</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314666"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679314662"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314662"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314662"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314664"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><a href="#local-6989586621679314663"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span id="local-6989586621679314660"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314660"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679314659"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314659"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-388"></span><span>        </span><span id="local-6989586621679314658"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314658"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314665"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314660"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314659"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-390"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314658"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-391"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314657"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314657"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679314656"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314656"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314657"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314656"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679314654"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314654"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314654"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span class="hs-comment">-- XXX implement in terms of consM?</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- cons x = consM (return x)</span><span>
</span><span id="line-397"></span><span class="hs-comment">--</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- | Can fuse but has O(n^2) complexity.</span><span>
</span><span id="line-399"></span><span class="hs-pragma">{-# INLINE_NORMAL cons #-}</span><span>
</span><span id="line-400"></span><span id="local-6989586621679314652"><span id="local-6989586621679314653"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#cons"><span class="hs-identifier hs-type">cons</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314653"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314652"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314653"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314652"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314653"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314652"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-401"></span><span id="cons"><span class="annot"><span class="annottext">cons :: a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#cons"><span class="hs-identifier hs-var hs-var">cons</span></a></span></span><span> </span><span id="local-6989586621679314651"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314651"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314650"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314650"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314649"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314649"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a))
-&gt; Maybe s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679314648"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step1 #-}</span><span>
</span><span id="line-404"></span><span>    </span><span id="local-6989586621679314648"><span class="annot"><span class="annottext">step1 :: State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679314648"><span class="hs-identifier hs-var hs-var">step1</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314651"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314649"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>    </span><span class="annot"><a href="#local-6989586621679314648"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span id="local-6989586621679314647"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314647"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679314646"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314646"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-406"></span><span>        </span><span id="local-6989586621679314645"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314645"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314650"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314647"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314646"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-407"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-408"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314645"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-409"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314644"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314644"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679314643"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314643"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314644"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314643"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-410"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679314642"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314642"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314642"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- Deconstruction</span><span>
</span><span id="line-415"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span class="hs-comment">-- Does not fuse, has the same performance as the StreamK version.</span><span>
</span><span id="line-418"></span><span class="hs-pragma">{-# INLINE_NORMAL uncons #-}</span><span>
</span><span id="line-419"></span><span id="local-6989586621679315918"><span id="local-6989586621679315919"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#uncons"><span class="hs-identifier hs-type">uncons</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315919"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315919"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315918"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315919"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315918"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315919"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315918"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-420"></span><span id="uncons"><span class="annot"><span class="annottext">uncons :: Stream m a -&gt; m (Maybe (a, Stream m a))
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#uncons"><span class="hs-identifier hs-var hs-var">uncons</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-type">UnStream</span></a></span><span> </span><span id="local-6989586621679314641"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314641"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314640"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314640"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Maybe (a, Stream m a))
</span><a href="#local-6989586621679314639"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314640"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-422"></span><span>    </span><span id="local-6989586621679314639"><span class="annot"><span class="annottext">go :: s -&gt; m (Maybe (a, Stream m a))
</span><a href="#local-6989586621679314639"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679314638"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314638"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-423"></span><span>        </span><span id="local-6989586621679314637"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314637"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314641"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314638"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-424"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314637"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-425"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314635"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314635"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314634"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314634"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (a, Stream m a) -&gt; m (Maybe (a, Stream m a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (a, Stream m a) -&gt; m (Maybe (a, Stream m a)))
-&gt; Maybe (a, Stream m a) -&gt; m (Maybe (a, Stream m a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(a, Stream m a) -&gt; Maybe (a, Stream m a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314635"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314641"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314634"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679314633"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314633"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Maybe (a, Stream m a))
</span><a href="#local-6989586621679314639"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314633"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-427"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (a, Stream m a) -&gt; m (Maybe (a, Stream m a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (a, Stream m a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- Generation by unfold</span><span>
</span><span id="line-431"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="hs-pragma">{-# INLINE_NORMAL unfoldrM #-}</span><span>
</span><span id="line-434"></span><span id="local-6989586621679316155"><span id="local-6989586621679316156"><span id="local-6989586621679316157"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#unfoldrM"><span class="hs-identifier hs-type">unfoldrM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316157"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679316156"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316157"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679316155"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679316156"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316156"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316157"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316155"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-435"></span><span id="unfoldrM"><span class="annot"><span class="annottext">unfoldrM :: (s -&gt; m (Maybe (a, s))) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#unfoldrM"><span class="hs-identifier hs-var hs-var">unfoldrM</span></a></span></span><span> </span><span id="local-6989586621679314632"><span class="annot"><span class="annottext">s -&gt; m (Maybe (a, s))
</span><a href="#local-6989586621679314632"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span id="local-6989586621679314631"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314631"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
forall p. p -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314630"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314631"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-437"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-438"></span><span>    </span><span id="local-6989586621679314630"><span class="annot"><span class="annottext">step :: p -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314630"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314629"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314629"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>        </span><span id="local-6989586621679314628"><span class="annot"><span class="annottext">Maybe (a, s)
</span><a href="#local-6989586621679314628"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Maybe (a, s))
</span><a href="#local-6989586621679314632"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314629"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-440"></span><span>        </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (a, s)
</span><a href="#local-6989586621679314628"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-441"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314627"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314627"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314626"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314626"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; Step s a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314627"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314626"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-442"></span><span>            </span><span class="annot"><span class="annottext">Maybe (a, s)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span class="hs-pragma">{-# INLINE_LATE unfoldr #-}</span><span>
</span><span id="line-445"></span><span id="local-6989586621679314623"><span id="local-6989586621679314624"><span id="local-6989586621679314625"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#unfoldr"><span class="hs-identifier hs-type">unfoldr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314625"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314624"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314623"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679314624"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314624"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314625"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314623"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-446"></span><span id="unfoldr"><span class="annot"><span class="annottext">unfoldr :: (s -&gt; Maybe (a, s)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#unfoldr"><span class="hs-identifier hs-var hs-var">unfoldr</span></a></span></span><span> </span><span id="local-6989586621679314622"><span class="annot"><span class="annottext">s -&gt; Maybe (a, s)
</span><a href="#local-6989586621679314622"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s -&gt; m (Maybe (a, s))) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) s a.
Monad m =&gt;
(s -&gt; m (Maybe (a, s))) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#unfoldrM"><span class="hs-identifier hs-var">unfoldrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (a, s) -&gt; m (Maybe (a, s))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (a, s) -&gt; m (Maybe (a, s)))
-&gt; (s -&gt; Maybe (a, s)) -&gt; s -&gt; m (Maybe (a, s))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe (a, s)
</span><a href="#local-6989586621679314622"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="hs-comment">-- | Convert an 'Unfold' into a 'Stream' by supplying it a seed.</span><span>
</span><span id="line-449"></span><span class="hs-comment">--</span><span>
</span><span id="line-450"></span><span class="hs-pragma">{-# INLINE_NORMAL unfold #-}</span><span>
</span><span id="line-451"></span><span id="local-6989586621679314618"><span id="local-6989586621679314619"><span id="local-6989586621679314620"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#unfold"><span class="hs-identifier hs-type">unfold</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314620"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314620"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314619"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314618"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314619"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314620"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314618"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-452"></span><span id="unfold"><span class="annot"><span class="annottext">unfold :: Unfold m a b -&gt; a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#unfold"><span class="hs-identifier hs-var hs-var">unfold</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679314616"><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679314616"><span class="hs-identifier hs-var">ustep</span></a></span></span><span> </span><span id="local-6989586621679314615"><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679314615"><span class="hs-identifier hs-var">inject</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679314614"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314614"><span class="hs-identifier hs-var">seed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b))
-&gt; Maybe s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b)
forall p. p -&gt; Maybe s -&gt; m (Step (Maybe s) b)
</span><a href="#local-6989586621679314613"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-455"></span><span>    </span><span id="local-6989586621679314613"><span class="annot"><span class="annottext">step :: p -&gt; Maybe s -&gt; m (Step (Maybe s) b)
</span><a href="#local-6989586621679314613"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679314615"><span class="hs-identifier hs-var">inject</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314614"><span class="hs-identifier hs-var">seed</span></a></span><span> </span><span class="annot"><span class="annottext">m s -&gt; (s -&gt; m (Step (Maybe s) b)) -&gt; m (Step (Maybe s) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) b -&gt; m (Step (Maybe s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) b -&gt; m (Step (Maybe s) b))
-&gt; (s -&gt; Step (Maybe s) b) -&gt; s -&gt; m (Step (Maybe s) b)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe s -&gt; Step (Maybe s) b)
-&gt; (s -&gt; Maybe s) -&gt; s -&gt; Step (Maybe s) b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span>
</span><span id="line-456"></span><span>    </span><span class="annot"><a href="#local-6989586621679314613"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679314612"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314612"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-457"></span><span>        </span><span id="local-6989586621679314611"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314611"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679314616"><span class="hs-identifier hs-var">ustep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314612"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe s) b -&gt; m (Step (Maybe s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) b -&gt; m (Step (Maybe s) b))
-&gt; Step (Maybe s) b -&gt; m (Step (Maybe s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314611"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-459"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314610"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314610"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314609"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314609"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; Maybe s -&gt; Step (Maybe s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314610"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314609"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314608"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314608"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314608"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-464"></span><span class="hs-comment">-- Specialized Generation</span><span>
</span><span id="line-465"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span class="hs-pragma">{-# INLINE_NORMAL repeatM #-}</span><span>
</span><span id="line-468"></span><span id="local-6989586621679314606"><span id="local-6989586621679314607"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#repeatM"><span class="hs-identifier hs-type">repeatM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314607"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314607"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314606"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314607"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314606"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-469"></span><span id="repeatM"><span class="annot"><span class="annottext">repeatM :: m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#repeatM"><span class="hs-identifier hs-var hs-var">repeatM</span></a></span></span><span> </span><span id="local-6989586621679314605"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314605"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; () -&gt; m (Step () a)) -&gt; () -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314605"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step () a)) -&gt; m (Step () a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679314604"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314604"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step () a -&gt; m (Step () a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step () a -&gt; m (Step () a)) -&gt; Step () a -&gt; m (Step () a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; () -&gt; Step () a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314604"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span class="hs-pragma">{-# INLINE_NORMAL repeat #-}</span><span>
</span><span id="line-472"></span><span id="local-6989586621679314602"><span id="local-6989586621679314603"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#repeat"><span class="hs-identifier hs-type">repeat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314603"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314602"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314603"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314602"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-473"></span><span id="repeat"><span class="annot"><span class="annottext">repeat :: a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#repeat"><span class="hs-identifier hs-var hs-var">repeat</span></a></span></span><span> </span><span id="local-6989586621679314601"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314601"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; () -&gt; m (Step () a)) -&gt; () -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step () a -&gt; m (Step () a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step () a -&gt; m (Step () a)) -&gt; Step () a -&gt; m (Step () a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; () -&gt; Step () a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314601"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="hs-pragma">{-# INLINE_NORMAL iterateM #-}</span><span>
</span><span id="line-476"></span><span id="local-6989586621679316136"><span id="local-6989586621679316137"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#iterateM"><span class="hs-identifier hs-type">iterateM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316137"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679316136"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316137"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316136"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316137"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316136"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316137"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316136"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-477"></span><span id="iterateM"><span class="annot"><span class="annottext">iterateM :: (a -&gt; m a) -&gt; m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#iterateM"><span class="hs-identifier hs-var hs-var">iterateM</span></a></span></span><span> </span><span id="local-6989586621679314600"><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621679314600"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; m a -&gt; m (Step (m a) a)) -&gt; m a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314599"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314599"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314599"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (m a) a)) -&gt; m (Step (m a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679314598"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314598"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (m a) a -&gt; m (Step (m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (m a) a -&gt; m (Step (m a) a))
-&gt; Step (m a) a -&gt; m (Step (m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m a -&gt; Step (m a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314598"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621679314600"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314598"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="hs-pragma">{-# INLINE_NORMAL iterate #-}</span><span>
</span><span id="line-480"></span><span id="local-6989586621679314596"><span id="local-6989586621679314597"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#iterate"><span class="hs-identifier hs-type">iterate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314597"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314596"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314596"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314596"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314597"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314596"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-481"></span><span id="iterate"><span class="annot"><span class="annottext">iterate :: (a -&gt; a) -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#iterate"><span class="hs-identifier hs-var hs-var">iterate</span></a></span></span><span> </span><span id="local-6989586621679314595"><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679314595"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314594"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314594"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m a) -&gt; m a -&gt; Stream m a
forall (m :: * -&gt; *) a. Monad m =&gt; (a -&gt; m a) -&gt; m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#iterateM"><span class="hs-identifier hs-var">iterateM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m a) -&gt; (a -&gt; a) -&gt; a -&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679314595"><span class="hs-identifier hs-var">step</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314594"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span class="hs-pragma">{-# INLINE_NORMAL replicateM #-}</span><span>
</span><span id="line-484"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#replicateM"><span class="hs-identifier hs-type">replicateM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679316128"><span class="annot"><a href="#local-6989586621679316128"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679316127"><span class="annot"><a href="#local-6989586621679316127"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316128"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316128"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316127"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316128"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316127"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-485"></span><span id="replicateM"><span class="annot"><span class="annottext">replicateM :: Int -&gt; m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#replicateM"><span class="hs-identifier hs-var hs-var">replicateM</span></a></span></span><span> </span><span id="local-6989586621679314593"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314593"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314592"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314592"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; Int -&gt; m (Step Int a)) -&gt; Int -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Int -&gt; m (Step Int a)
forall p. p -&gt; Int -&gt; m (Step Int a)
</span><a href="#local-6989586621679314591"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314593"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-487"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-488"></span><span>    </span><span id="local-6989586621679314591"><span class="annot"><span class="annottext">step :: p -&gt; Int -&gt; m (Step Int a)
</span><a href="#local-6989586621679314591"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314590"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314590"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314590"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step Int a -&gt; m (Step Int a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step Int a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-490"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-491"></span><span>          </span><span id="local-6989586621679314588"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314588"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314592"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-492"></span><span>          </span><span class="annot"><span class="annottext">Step Int a -&gt; m (Step Int a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step Int a -&gt; m (Step Int a)) -&gt; Step Int a -&gt; m (Step Int a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; Step Int a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314588"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314590"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="hs-pragma">{-# INLINE_NORMAL replicate #-}</span><span>
</span><span id="line-495"></span><span id="local-6989586621679314586"><span id="local-6989586621679314587"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#replicate"><span class="hs-identifier hs-type">replicate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314586"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314586"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-496"></span><span id="replicate"><span class="annot"><span class="annottext">replicate :: Int -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#replicate"><span class="hs-identifier hs-var hs-var">replicate</span></a></span></span><span> </span><span id="local-6989586621679314585"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314585"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314584"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314584"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m a -&gt; Stream m a
forall (m :: * -&gt; *) a. Monad m =&gt; Int -&gt; m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#replicateM"><span class="hs-identifier hs-var">replicateM</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314585"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314584"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span class="hs-comment">-- This would not work properly for floats, therefore we put an Integral</span><span>
</span><span id="line-499"></span><span class="hs-comment">-- constraint.</span><span>
</span><span id="line-500"></span><span class="hs-comment">-- | Can be used to enumerate unbounded integrals. This does not check for</span><span>
</span><span id="line-501"></span><span class="hs-comment">-- overflow or underflow for bounded integrals.</span><span>
</span><span id="line-502"></span><span class="hs-pragma">{-# INLINE_NORMAL enumerateFromStepIntegral #-}</span><span>
</span><span id="line-503"></span><span id="local-6989586621679316115"><span id="local-6989586621679316116"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepIntegral"><span class="hs-identifier hs-type">enumerateFromStepIntegral</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Integral</span></span><span> </span><span class="annot"><a href="#local-6989586621679316116"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316115"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316116"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316116"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316115"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316116"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-504"></span><span id="enumerateFromStepIntegral"><span class="annot"><span class="annottext">enumerateFromStepIntegral :: a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepIntegral"><span class="hs-identifier hs-var hs-var">enumerateFromStepIntegral</span></a></span></span><span> </span><span id="local-6989586621679314583"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314583"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314582"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314582"><span class="hs-identifier hs-var">stride</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-505"></span><span>    </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314583"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; Stream m a
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314582"><span class="hs-identifier hs-var">stride</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; Stream m a
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; a -&gt; m (Step a a)) -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; a -&gt; m (Step a a)
forall (m :: * -&gt; *) p. Monad m =&gt; p -&gt; a -&gt; m (Step a a)
</span><a href="#local-6989586621679314581"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314583"><span class="hs-identifier hs-var">from</span></a></span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-507"></span><span>        </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-508"></span><span>        </span><span id="local-6989586621679314581"><span class="annot"><span class="annottext">step :: p -&gt; a -&gt; m (Step a a)
</span><a href="#local-6989586621679314581"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679314580"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314580"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step a a -&gt; m (Step a a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step a a -&gt; m (Step a a)) -&gt; Step a a -&gt; m (Step a a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Step a a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314580"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Step a a) -&gt; a -&gt; Step a a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314580"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314582"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span class="hs-comment">-- We are assuming that &quot;to&quot; is constrained by the type to be within</span><span>
</span><span id="line-511"></span><span class="hs-comment">-- max/min bounds.</span><span>
</span><span id="line-512"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromToIntegral"><span class="hs-pragma hs-type">enumerateFromToIntegral</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-513"></span><span id="local-6989586621679316111"><span id="local-6989586621679316112"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromToIntegral"><span class="hs-identifier hs-type">enumerateFromToIntegral</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316112"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integral</span></span><span> </span><span class="annot"><a href="#local-6989586621679316111"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316111"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316111"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316112"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316111"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-514"></span><span id="enumerateFromToIntegral"><span class="annot"><span class="annottext">enumerateFromToIntegral :: a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromToIntegral"><span class="hs-identifier hs-var hs-var">enumerateFromToIntegral</span></a></span></span><span> </span><span id="local-6989586621679314577"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314577"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314576"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314576"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-515"></span><span>    </span><span class="annot"><span class="annottext">(a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhile"><span class="hs-identifier hs-var">takeWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314576"><span class="hs-identifier hs-var">to</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Stream m a
forall a (m :: * -&gt; *).
(Integral a, Monad m) =&gt;
a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepIntegral"><span class="hs-identifier hs-var">enumerateFromStepIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314577"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromIntegral"><span class="hs-pragma hs-type">enumerateFromIntegral</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-518"></span><span id="local-6989586621679314574"><span id="local-6989586621679314575"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromIntegral"><span class="hs-identifier hs-type">enumerateFromIntegral</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314575"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integral</span></span><span> </span><span class="annot"><a href="#local-6989586621679314574"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bounded</span></span><span> </span><span class="annot"><a href="#local-6989586621679314574"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314574"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314575"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314574"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-519"></span><span id="enumerateFromIntegral"><span class="annot"><span class="annottext">enumerateFromIntegral :: a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromIntegral"><span class="hs-identifier hs-var hs-var">enumerateFromIntegral</span></a></span></span><span> </span><span id="local-6989586621679314573"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314573"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a.
(Monad m, Integral a) =&gt;
a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromToIntegral"><span class="hs-identifier hs-var">enumerateFromToIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314573"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
forall a. Bounded a =&gt; a
</span><span class="hs-identifier hs-var">maxBound</span></span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span class="hs-keyword">data</span><span> </span><span id="EnumState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumState"><span class="hs-identifier hs-var">EnumState</span></a></span></span><span> </span><span id="local-6989586621679316104"><span class="annot"><a href="#local-6989586621679316104"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EnumInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumInit"><span class="hs-identifier hs-var">EnumInit</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="EnumYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumYield"><span class="hs-identifier hs-var">EnumYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679316104"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316104"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316104"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="EnumStop"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumStop"><span class="hs-identifier hs-var">EnumStop</span></a></span></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span class="hs-pragma">{-# INLINE_NORMAL enumerateFromThenToIntegralUp #-}</span><span>
</span><span id="line-524"></span><span id="local-6989586621679316096"><span id="local-6989586621679316097"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegralUp"><span class="hs-identifier hs-type">enumerateFromThenToIntegralUp</span></a></span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316097"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integral</span></span><span> </span><span class="annot"><a href="#local-6989586621679316096"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316096"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316096"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316096"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316097"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316096"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-527"></span><span id="enumerateFromThenToIntegralUp"><span class="annot"><span class="annottext">enumerateFromThenToIntegralUp :: a -&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegralUp"><span class="hs-identifier hs-var hs-var">enumerateFromThenToIntegralUp</span></a></span></span><span> </span><span id="local-6989586621679314567"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314567"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314566"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314566"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span id="local-6989586621679314565"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314565"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; EnumState a -&gt; m (Step (EnumState a) a))
-&gt; EnumState a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; EnumState a -&gt; m (Step (EnumState a) a)
forall (m :: * -&gt; *) p.
Monad m =&gt;
p -&gt; EnumState a -&gt; m (Step (EnumState a) a)
</span><a href="#local-6989586621679314564"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">EnumState a
forall a. EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumInit"><span class="hs-identifier hs-var">EnumInit</span></a></span><span>
</span><span id="line-528"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-529"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-530"></span><span>    </span><span id="local-6989586621679314564"><span class="annot"><span class="annottext">step :: p -&gt; EnumState a -&gt; m (Step (EnumState a) a)
</span><a href="#local-6989586621679314564"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumInit"><span class="hs-identifier hs-var">EnumInit</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-531"></span><span>        </span><span class="annot"><span class="annottext">Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (EnumState a) a -&gt; m (Step (EnumState a) a))
-&gt; Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-532"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314565"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314566"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-533"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314565"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314567"><span class="hs-identifier hs-var">from</span></a></span><span>
</span><span id="line-534"></span><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (EnumState a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-535"></span><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">a -&gt; EnumState a -&gt; Step (EnumState a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314567"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">EnumState a
forall a. EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumStop"><span class="hs-identifier hs-var">EnumStop</span></a></span><span>
</span><span id="line-536"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- from &lt;= next &lt;= to</span><span>
</span><span id="line-537"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314562"><span class="annot"><span class="annottext">stride :: a
</span><a href="#local-6989586621679314562"><span class="hs-identifier hs-var hs-var">stride</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314566"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314567"><span class="hs-identifier hs-var">from</span></a></span><span>
</span><span id="line-538"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EnumState a -&gt; Step (EnumState a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(EnumState a -&gt; Step (EnumState a) a)
-&gt; EnumState a -&gt; Step (EnumState a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; EnumState a
forall a. a -&gt; a -&gt; a -&gt; EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumYield"><span class="hs-identifier hs-var">EnumYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314567"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314562"><span class="hs-identifier hs-var">stride</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314565"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314562"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span>    </span><span class="annot"><a href="#local-6989586621679314564"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumYield"><span class="hs-identifier hs-type">EnumYield</span></a></span><span> </span><span id="local-6989586621679314561"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314561"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314560"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314560"><span class="hs-identifier hs-var">stride</span></a></span></span><span> </span><span id="local-6989586621679314559"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314559"><span class="hs-identifier hs-var">toMinus</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-541"></span><span>        </span><span class="annot"><span class="annottext">Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (EnumState a) a -&gt; m (Step (EnumState a) a))
-&gt; Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-542"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314561"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314559"><span class="hs-identifier hs-var">toMinus</span></a></span><span>
</span><span id="line-543"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">a -&gt; EnumState a -&gt; Step (EnumState a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314561"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">EnumState a
forall a. EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumStop"><span class="hs-identifier hs-var">EnumStop</span></a></span><span>
</span><span id="line-544"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">a -&gt; EnumState a -&gt; Step (EnumState a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314561"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(EnumState a -&gt; Step (EnumState a) a)
-&gt; EnumState a -&gt; Step (EnumState a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; EnumState a
forall a. a -&gt; a -&gt; a -&gt; EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumYield"><span class="hs-identifier hs-var">EnumYield</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314561"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314560"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314560"><span class="hs-identifier hs-var">stride</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314559"><span class="hs-identifier hs-var">toMinus</span></a></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span>    </span><span class="annot"><a href="#local-6989586621679314564"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumStop"><span class="hs-identifier hs-var">EnumStop</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (EnumState a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-547"></span><span>
</span><span id="line-548"></span><span class="hs-pragma">{-# INLINE_NORMAL enumerateFromThenToIntegralDn #-}</span><span>
</span><span id="line-549"></span><span id="local-6989586621679314555"><span id="local-6989586621679314556"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegralDn"><span class="hs-identifier hs-type">enumerateFromThenToIntegralDn</span></a></span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314556"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integral</span></span><span> </span><span class="annot"><a href="#local-6989586621679314555"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314555"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314555"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314555"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314556"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314555"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-552"></span><span id="enumerateFromThenToIntegralDn"><span class="annot"><span class="annottext">enumerateFromThenToIntegralDn :: a -&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegralDn"><span class="hs-identifier hs-var hs-var">enumerateFromThenToIntegralDn</span></a></span></span><span> </span><span id="local-6989586621679314554"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314554"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314553"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314553"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span id="local-6989586621679314552"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314552"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; EnumState a -&gt; m (Step (EnumState a) a))
-&gt; EnumState a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; EnumState a -&gt; m (Step (EnumState a) a)
forall (m :: * -&gt; *) p.
Monad m =&gt;
p -&gt; EnumState a -&gt; m (Step (EnumState a) a)
</span><a href="#local-6989586621679314551"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">EnumState a
forall a. EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumInit"><span class="hs-identifier hs-var">EnumInit</span></a></span><span>
</span><span id="line-553"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-555"></span><span>    </span><span id="local-6989586621679314551"><span class="annot"><span class="annottext">step :: p -&gt; EnumState a -&gt; m (Step (EnumState a) a)
</span><a href="#local-6989586621679314551"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumInit"><span class="hs-identifier hs-var">EnumInit</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-556"></span><span>        </span><span class="annot"><span class="annottext">Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (EnumState a) a -&gt; m (Step (EnumState a) a))
-&gt; Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314552"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314553"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-557"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314552"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314554"><span class="hs-identifier hs-var">from</span></a></span><span>
</span><span id="line-558"></span><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (EnumState a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-559"></span><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">a -&gt; EnumState a -&gt; Step (EnumState a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314554"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">EnumState a
forall a. EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumStop"><span class="hs-identifier hs-var">EnumStop</span></a></span><span>
</span><span id="line-560"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- from &gt;= next &gt;= to</span><span>
</span><span id="line-561"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314550"><span class="annot"><span class="annottext">stride :: a
</span><a href="#local-6989586621679314550"><span class="hs-identifier hs-var hs-var">stride</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314553"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314554"><span class="hs-identifier hs-var">from</span></a></span><span>
</span><span id="line-562"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EnumState a -&gt; Step (EnumState a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(EnumState a -&gt; Step (EnumState a) a)
-&gt; EnumState a -&gt; Step (EnumState a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; EnumState a
forall a. a -&gt; a -&gt; a -&gt; EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumYield"><span class="hs-identifier hs-var">EnumYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314554"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314550"><span class="hs-identifier hs-var">stride</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314552"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314550"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span>    </span><span class="annot"><a href="#local-6989586621679314551"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumYield"><span class="hs-identifier hs-type">EnumYield</span></a></span><span> </span><span id="local-6989586621679314549"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314549"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314548"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314548"><span class="hs-identifier hs-var">stride</span></a></span></span><span> </span><span id="local-6989586621679314547"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314547"><span class="hs-identifier hs-var">toMinus</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-565"></span><span>        </span><span class="annot"><span class="annottext">Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (EnumState a) a -&gt; m (Step (EnumState a) a))
-&gt; Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-566"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314549"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314547"><span class="hs-identifier hs-var">toMinus</span></a></span><span>
</span><span id="line-567"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">a -&gt; EnumState a -&gt; Step (EnumState a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314549"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">EnumState a
forall a. EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumStop"><span class="hs-identifier hs-var">EnumStop</span></a></span><span>
</span><span id="line-568"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">a -&gt; EnumState a -&gt; Step (EnumState a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314549"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(EnumState a -&gt; Step (EnumState a) a)
-&gt; EnumState a -&gt; Step (EnumState a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; EnumState a
forall a. a -&gt; a -&gt; a -&gt; EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumYield"><span class="hs-identifier hs-var">EnumYield</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314549"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314548"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314548"><span class="hs-identifier hs-var">stride</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314547"><span class="hs-identifier hs-var">toMinus</span></a></span><span>
</span><span id="line-569"></span><span>
</span><span id="line-570"></span><span>    </span><span class="annot"><a href="#local-6989586621679314551"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">EnumState a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#EnumStop"><span class="hs-identifier hs-var">EnumStop</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (EnumState a) a -&gt; m (Step (EnumState a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (EnumState a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-571"></span><span>
</span><span id="line-572"></span><span class="hs-pragma">{-# INLINE_NORMAL enumerateFromThenToIntegral #-}</span><span>
</span><span id="line-573"></span><span id="local-6989586621679314545"><span id="local-6989586621679314546"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegral"><span class="hs-identifier hs-type">enumerateFromThenToIntegral</span></a></span><span>
</span><span id="line-574"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314546"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integral</span></span><span> </span><span class="annot"><a href="#local-6989586621679314545"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314545"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314545"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314545"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314546"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314545"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-576"></span><span id="enumerateFromThenToIntegral"><span class="annot"><span class="annottext">enumerateFromThenToIntegral :: a -&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegral"><span class="hs-identifier hs-var hs-var">enumerateFromThenToIntegral</span></a></span></span><span> </span><span id="local-6989586621679314544"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314544"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314543"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314543"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span id="local-6989586621679314542"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314542"><span class="hs-identifier hs-var">to</span></a></span></span><span>
</span><span id="line-577"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314543"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314544"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a.
(Monad m, Integral a) =&gt;
a -&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegralUp"><span class="hs-identifier hs-var">enumerateFromThenToIntegralUp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314544"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314543"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314542"><span class="hs-identifier hs-var">to</span></a></span><span>
</span><span id="line-578"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a.
(Monad m, Integral a) =&gt;
a -&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegralDn"><span class="hs-identifier hs-var">enumerateFromThenToIntegralDn</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314544"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314543"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314542"><span class="hs-identifier hs-var">to</span></a></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span class="hs-pragma">{-# INLINE_NORMAL enumerateFromThenIntegral #-}</span><span>
</span><span id="line-581"></span><span id="local-6989586621679314540"><span id="local-6989586621679314541"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenIntegral"><span class="hs-identifier hs-type">enumerateFromThenIntegral</span></a></span><span>
</span><span id="line-582"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314541"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integral</span></span><span> </span><span class="annot"><a href="#local-6989586621679314540"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bounded</span></span><span> </span><span class="annot"><a href="#local-6989586621679314540"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314540"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314540"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314541"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314540"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-584"></span><span id="enumerateFromThenIntegral"><span class="annot"><span class="annottext">enumerateFromThenIntegral :: a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenIntegral"><span class="hs-identifier hs-var hs-var">enumerateFromThenIntegral</span></a></span></span><span> </span><span id="local-6989586621679314539"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314539"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314538"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314538"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-585"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314538"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314539"><span class="hs-identifier hs-var">from</span></a></span><span>
</span><span id="line-586"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a.
(Monad m, Integral a) =&gt;
a -&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegralUp"><span class="hs-identifier hs-var">enumerateFromThenToIntegralUp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314539"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314538"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a
forall a. Bounded a =&gt; a
</span><span class="hs-identifier hs-var">maxBound</span></span><span>
</span><span id="line-587"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a.
(Monad m, Integral a) =&gt;
a -&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToIntegralDn"><span class="hs-identifier hs-var">enumerateFromThenToIntegralDn</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314539"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314538"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a
forall a. Bounded a =&gt; a
</span><span class="hs-identifier hs-var">minBound</span></span><span>
</span><span id="line-588"></span><span>
</span><span id="line-589"></span><span class="hs-comment">-- For floating point numbers if the increment is less than the precision then</span><span>
</span><span id="line-590"></span><span class="hs-comment">-- it just gets lost. Therefore we cannot always increment it correctly by just</span><span>
</span><span id="line-591"></span><span class="hs-comment">-- repeated addition.</span><span>
</span><span id="line-592"></span><span class="hs-comment">-- 9007199254740992 + 1 + 1 :: Double =&gt; 9.007199254740992e15</span><span>
</span><span id="line-593"></span><span class="hs-comment">-- 9007199254740992 + 2     :: Double =&gt; 9.007199254740994e15</span><span>
</span><span id="line-594"></span><span>
</span><span id="line-595"></span><span class="hs-comment">-- Instead we accumulate the increment counter and compute the increment</span><span>
</span><span id="line-596"></span><span class="hs-comment">-- every time before adding it to the starting number.</span><span>
</span><span id="line-597"></span><span class="hs-comment">--</span><span>
</span><span id="line-598"></span><span class="hs-comment">-- This works for Integrals as well as floating point numbers, but</span><span>
</span><span id="line-599"></span><span class="hs-comment">-- enumerateFromStepIntegral is faster for integrals.</span><span>
</span><span id="line-600"></span><span class="hs-pragma">{-# INLINE_NORMAL enumerateFromStepNum #-}</span><span>
</span><span id="line-601"></span><span id="local-6989586621679316086"><span id="local-6989586621679316087"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepNum"><span class="hs-identifier hs-type">enumerateFromStepNum</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316087"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Num</span></span><span> </span><span class="annot"><a href="#local-6989586621679316086"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316086"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316086"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316087"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316086"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-602"></span><span id="enumerateFromStepNum"><span class="annot"><span class="annottext">enumerateFromStepNum :: a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepNum"><span class="hs-identifier hs-var hs-var">enumerateFromStepNum</span></a></span></span><span> </span><span id="local-6989586621679314536"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314536"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314535"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314535"><span class="hs-identifier hs-var">stride</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; a -&gt; m (Step a a)) -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; a -&gt; m (Step a a)
forall (m :: * -&gt; *) p. Monad m =&gt; p -&gt; a -&gt; m (Step a a)
</span><a href="#local-6989586621679314534"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span>
</span><span id="line-603"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-604"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-605"></span><span>    </span><span id="local-6989586621679314534"><span class="annot"><span class="annottext">step :: p -&gt; a -&gt; m (Step a a)
</span><a href="#local-6989586621679314534"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679314533"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314533"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step a a -&gt; m (Step a a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step a a -&gt; m (Step a a)) -&gt; Step a a -&gt; m (Step a a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; Step a a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; a -&gt; Step a a) -&gt; a -&gt; a -&gt; Step a a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314536"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314533"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314535"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Step a a) -&gt; a -&gt; Step a a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314533"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>
</span><span id="line-607"></span><span class="hs-pragma">{-# INLINE_NORMAL numFrom #-}</span><span>
</span><span id="line-608"></span><span id="local-6989586621679314530"><span id="local-6989586621679314531"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#numFrom"><span class="hs-identifier hs-type">numFrom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314531"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Num</span></span><span> </span><span class="annot"><a href="#local-6989586621679314530"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314530"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314531"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314530"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-609"></span><span id="numFrom"><span class="annot"><span class="annottext">numFrom :: a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#numFrom"><span class="hs-identifier hs-var hs-var">numFrom</span></a></span></span><span> </span><span id="local-6989586621679314529"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314529"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a. (Monad m, Num a) =&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepNum"><span class="hs-identifier hs-var">enumerateFromStepNum</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314529"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span class="hs-pragma">{-# INLINE_NORMAL numFromThen #-}</span><span>
</span><span id="line-612"></span><span id="local-6989586621679314527"><span id="local-6989586621679314528"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#numFromThen"><span class="hs-identifier hs-type">numFromThen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314528"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Num</span></span><span> </span><span class="annot"><a href="#local-6989586621679314527"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314527"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314527"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314528"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314527"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-613"></span><span id="numFromThen"><span class="annot"><span class="annottext">numFromThen :: a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#numFromThen"><span class="hs-identifier hs-var hs-var">numFromThen</span></a></span></span><span> </span><span id="local-6989586621679314526"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314526"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314525"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314525"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a. (Monad m, Num a) =&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepNum"><span class="hs-identifier hs-var">enumerateFromStepNum</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314526"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314525"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314526"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span class="hs-comment">-- We cannot write a general function for Num.  The only way to write code</span><span>
</span><span id="line-616"></span><span class="hs-comment">-- portable between the two is to use a 'Real' constraint and convert between</span><span>
</span><span id="line-617"></span><span class="hs-comment">-- Fractional and Integral using fromRational which is horribly slow.</span><span>
</span><span id="line-618"></span><span class="hs-pragma">{-# INLINE_NORMAL enumerateFromToFractional #-}</span><span>
</span><span id="line-619"></span><span id="local-6989586621679314523"><span id="local-6989586621679314524"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromToFractional"><span class="hs-identifier hs-type">enumerateFromToFractional</span></a></span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314524"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fractional</span></span><span> </span><span class="annot"><a href="#local-6989586621679314523"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679314523"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314523"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314523"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314524"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314523"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-622"></span><span id="enumerateFromToFractional"><span class="annot"><span class="annottext">enumerateFromToFractional :: a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromToFractional"><span class="hs-identifier hs-var hs-var">enumerateFromToFractional</span></a></span></span><span> </span><span id="local-6989586621679314522"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314522"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314521"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314521"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-623"></span><span>    </span><span class="annot"><span class="annottext">(a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhile"><span class="hs-identifier hs-var">takeWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314521"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a. (Monad m, Num a) =&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromStepNum"><span class="hs-identifier hs-var">enumerateFromStepNum</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314522"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-624"></span><span>
</span><span id="line-625"></span><span class="hs-pragma">{-# INLINE_NORMAL enumerateFromThenToFractional #-}</span><span>
</span><span id="line-626"></span><span id="local-6989586621679314518"><span id="local-6989586621679314519"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToFractional"><span class="hs-identifier hs-type">enumerateFromThenToFractional</span></a></span><span>
</span><span id="line-627"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314519"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fractional</span></span><span> </span><span class="annot"><a href="#local-6989586621679314518"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679314518"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-628"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314518"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314518"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314518"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314519"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314518"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-629"></span><span id="enumerateFromThenToFractional"><span class="annot"><span class="annottext">enumerateFromThenToFractional :: a -&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#enumerateFromThenToFractional"><span class="hs-identifier hs-var hs-var">enumerateFromThenToFractional</span></a></span></span><span> </span><span id="local-6989586621679314517"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314517"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679314516"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314516"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span id="local-6989586621679314515"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314515"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-630"></span><span>    </span><span class="annot"><span class="annottext">(a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhile"><span class="hs-identifier hs-var">takeWhile</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679314514"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Stream m a
forall (m :: * -&gt; *) a. (Monad m, Num a) =&gt; a -&gt; a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#numFromThen"><span class="hs-identifier hs-var">numFromThen</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314517"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314516"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-631"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-632"></span><span>    </span><span id="local-6989586621679314513"><span class="annot"><span class="annottext">mid :: a
</span><a href="#local-6989586621679314513"><span class="hs-identifier hs-var hs-var">mid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314516"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314517"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">2</span></span><span>
</span><span id="line-633"></span><span>    </span><span id="local-6989586621679314514"><span class="annot"><span class="annottext">predicate :: a -&gt; Bool
</span><a href="#local-6989586621679314514"><span class="hs-identifier hs-var hs-var">predicate</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314516"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314517"><span class="hs-identifier hs-var">from</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314515"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314513"><span class="hs-identifier hs-var">mid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-634"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314515"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314513"><span class="hs-identifier hs-var">mid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-635"></span><span>
</span><span id="line-636"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-637"></span><span class="hs-comment">-- Generation by Conversion</span><span>
</span><span id="line-638"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span class="hs-pragma">{-# INLINE_NORMAL fromIndicesM #-}</span><span>
</span><span id="line-641"></span><span id="local-6989586621679316072"><span id="local-6989586621679316073"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromIndicesM"><span class="hs-identifier hs-type">fromIndicesM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316073"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316073"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316072"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316073"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316072"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-642"></span><span id="fromIndicesM"><span class="annot"><span class="annottext">fromIndicesM :: (Int -&gt; m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromIndicesM"><span class="hs-identifier hs-var hs-var">fromIndicesM</span></a></span></span><span> </span><span id="local-6989586621679314512"><span class="annot"><span class="annottext">Int -&gt; m a
</span><a href="#local-6989586621679314512"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; Int -&gt; m (Step Int a)) -&gt; Int -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Int -&gt; m (Step Int a)
forall p. p -&gt; Int -&gt; m (Step Int a)
</span><a href="#local-6989586621679314511"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-643"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-644"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-645"></span><span>    </span><span id="local-6989586621679314511"><span class="annot"><span class="annottext">step :: p -&gt; Int -&gt; m (Step Int a)
</span><a href="#local-6989586621679314511"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314510"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314510"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-646"></span><span>       </span><span id="local-6989586621679314509"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314509"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m a
</span><a href="#local-6989586621679314512"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314510"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-647"></span><span>       </span><span class="annot"><span class="annottext">Step Int a -&gt; m (Step Int a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step Int a -&gt; m (Step Int a)) -&gt; Step Int a -&gt; m (Step Int a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; Step Int a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314509"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314510"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-648"></span><span>
</span><span id="line-649"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromIndices"><span class="hs-pragma hs-type">fromIndices</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-650"></span><span id="local-6989586621679314507"><span id="local-6989586621679314508"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromIndices"><span class="hs-identifier hs-type">fromIndices</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314507"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314507"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-651"></span><span id="fromIndices"><span class="annot"><span class="annottext">fromIndices :: (Int -&gt; a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromIndices"><span class="hs-identifier hs-var hs-var">fromIndices</span></a></span></span><span> </span><span id="local-6989586621679314506"><span class="annot"><span class="annottext">Int -&gt; a
</span><a href="#local-6989586621679314506"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; m a) -&gt; Stream m a
forall (m :: * -&gt; *) a. Monad m =&gt; (Int -&gt; m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromIndicesM"><span class="hs-identifier hs-var">fromIndicesM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m a) -&gt; (Int -&gt; a) -&gt; Int -&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; a
</span><a href="#local-6989586621679314506"><span class="hs-identifier hs-var">gen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span>
</span><span id="line-653"></span><span class="hs-pragma">{-# INLINE_NORMAL generateM #-}</span><span>
</span><span id="line-654"></span><span id="local-6989586621679316065"><span id="local-6989586621679316066"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#generateM"><span class="hs-identifier hs-type">generateM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316066"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679316066"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316065"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316066"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316065"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-655"></span><span id="generateM"><span class="annot"><span class="annottext">generateM :: Int -&gt; (Int -&gt; m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#generateM"><span class="hs-identifier hs-var hs-var">generateM</span></a></span></span><span> </span><span id="local-6989586621679314505"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314505"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314504"><span class="annot"><span class="annottext">Int -&gt; m a
</span><a href="#local-6989586621679314504"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314505"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Stream m a -&gt; Stream m a
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; Int -&gt; m (Step Int a)) -&gt; Int -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Int -&gt; m (Step Int a)
forall p. p -&gt; Int -&gt; m (Step Int a)
</span><a href="#local-6989586621679314503"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-656"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-657"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-658"></span><span>    </span><span id="local-6989586621679314503"><span class="annot"><span class="annottext">step :: p -&gt; Int -&gt; m (Step Int a)
</span><a href="#local-6989586621679314503"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314502"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314502"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314502"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314505"><span class="hs-identifier hs-var">n</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-659"></span><span>                           </span><span id="local-6989586621679314501"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314501"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m a
</span><a href="#local-6989586621679314504"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314502"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-660"></span><span>                           </span><span class="annot"><span class="annottext">Step Int a -&gt; m (Step Int a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step Int a -&gt; m (Step Int a)) -&gt; Step Int a -&gt; m (Step Int a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; Step Int a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314501"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314502"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-661"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step Int a -&gt; m (Step Int a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step Int a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-662"></span><span>
</span><span id="line-663"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#generate"><span class="hs-pragma hs-type">generate</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-664"></span><span id="local-6989586621679314499"><span id="local-6989586621679314500"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#generate"><span class="hs-identifier hs-type">generate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314500"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314499"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314500"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314499"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-665"></span><span id="generate"><span class="annot"><span class="annottext">generate :: Int -&gt; (Int -&gt; a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#generate"><span class="hs-identifier hs-var hs-var">generate</span></a></span></span><span> </span><span id="local-6989586621679314498"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314498"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314497"><span class="annot"><span class="annottext">Int -&gt; a
</span><a href="#local-6989586621679314497"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; (Int -&gt; m a) -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
Int -&gt; (Int -&gt; m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#generateM"><span class="hs-identifier hs-var">generateM</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314498"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m a) -&gt; (Int -&gt; a) -&gt; Int -&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; a
</span><a href="#local-6989586621679314497"><span class="hs-identifier hs-var">gen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-666"></span><span>
</span><span id="line-667"></span><span class="hs-comment">-- XXX we need the MonadAsync constraint because of a rewrite rule.</span><span>
</span><span id="line-668"></span><span class="hs-comment">-- | Convert a list of monadic actions to a 'Stream'</span><span>
</span><span id="line-669"></span><span class="hs-pragma">{-# INLINE_LATE fromListM #-}</span><span>
</span><span id="line-670"></span><span id="local-6989586621679314495"><span id="local-6989586621679314496"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromListM"><span class="hs-identifier hs-type">fromListM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314496"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679314496"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314496"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314495"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-671"></span><span id="fromListM"><span class="annot"><span class="annottext">fromListM :: [m a] -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromListM"><span class="hs-identifier hs-var hs-var">fromListM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; [m a] -&gt; m (Step [m a] a))
-&gt; [m a] -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; [m a] -&gt; m (Step [m a] a)
forall (m :: * -&gt; *) p a. Monad m =&gt; p -&gt; [m a] -&gt; m (Step [m a] a)
</span><a href="#local-6989586621679314494"><span class="hs-identifier hs-var">step</span></a></span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-673"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-674"></span><span>    </span><span id="local-6989586621679314494"><span class="annot"><span class="annottext">step :: p -&gt; [m a] -&gt; m (Step [m a] a)
</span><a href="#local-6989586621679314494"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314493"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314493"><span class="hs-identifier hs-var">m</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679314492"><span class="annot"><span class="annottext">[m a]
</span><a href="#local-6989586621679314492"><span class="hs-identifier hs-var">ms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679314493"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step [m a] a)) -&gt; m (Step [m a] a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679314491"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314491"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step [m a] a -&gt; m (Step [m a] a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step [m a] a -&gt; m (Step [m a] a))
-&gt; Step [m a] a -&gt; m (Step [m a] a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; [m a] -&gt; Step [m a] a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314491"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">[m a]
</span><a href="#local-6989586621679314492"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-675"></span><span>    </span><span class="annot"><a href="#local-6989586621679314494"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step [m a] a -&gt; m (Step [m a] a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step [m a] a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-676"></span><span>
</span><span id="line-677"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#toStreamD"><span class="hs-pragma hs-type">toStreamD</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-678"></span><span id="local-6989586621679315037"><span id="local-6989586621679315038"><span id="local-6989586621679315039"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#toStreamD"><span class="hs-identifier hs-type">toStreamD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">K.IsStream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315039"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315038"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315039"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315038"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315037"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315038"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315037"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-679"></span><span id="toStreamD"><span class="annot"><span class="annottext">toStreamD :: t m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#toStreamD"><span class="hs-identifier hs-var hs-var">toStreamD</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a. Monad m =&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromStreamK"><span class="hs-identifier hs-var">fromStreamK</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; Stream m a)
-&gt; (t m a -&gt; Stream m a) -&gt; t m a -&gt; Stream m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">t m a -&gt; Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
IsStream t =&gt;
t m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#toStream"><span class="hs-identifier hs-var">K.toStream</span></a></span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span class="hs-pragma">{-# INLINE_NORMAL fromPrimIORef #-}</span><span>
</span><span id="line-682"></span><span id="local-6989586621679315219"><span id="local-6989586621679315220"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromPrimIORef"><span class="hs-identifier hs-type">fromPrimIORef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679315220"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Prim</span></span><span> </span><span class="annot"><a href="#local-6989586621679315219"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.IORef.Prim.html#IORef"><span class="hs-identifier hs-type">Prim.IORef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315219"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315220"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315219"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-683"></span><span id="fromPrimIORef"><span class="annot"><span class="annottext">fromPrimIORef :: IORef a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromPrimIORef"><span class="hs-identifier hs-var hs-var">fromPrimIORef</span></a></span></span><span> </span><span id="local-6989586621679314489"><span class="annot"><span class="annottext">IORef a
</span><a href="#local-6989586621679314489"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; () -&gt; m (Step () a)) -&gt; () -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; () -&gt; m (Step () a)
forall (m :: * -&gt; *) p. MonadIO m =&gt; p -&gt; () -&gt; m (Step () a)
</span><a href="#local-6989586621679314488"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-685"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-686"></span><span>    </span><span id="local-6989586621679314488"><span class="annot"><span class="annottext">step :: p -&gt; () -&gt; m (Step () a)
</span><a href="#local-6989586621679314488"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef a -&gt; IO a
forall a. Prim a =&gt; IORef a -&gt; IO a
</span><a href="Streamly.Internal.Data.IORef.Prim.html#readIORef"><span class="hs-identifier hs-var">Prim.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef a
</span><a href="#local-6989586621679314489"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step () a)) -&gt; m (Step () a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679314485"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314485"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step () a -&gt; m (Step () a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step () a -&gt; m (Step () a)) -&gt; Step () a -&gt; m (Step () a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; () -&gt; Step () a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314485"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-687"></span><span>
</span><span id="line-688"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-689"></span><span class="hs-comment">-- Generation from SVar</span><span>
</span><span id="line-690"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span class="hs-keyword">data</span><span> </span><span id="FromSVarState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarState"><span class="hs-identifier hs-var">FromSVarState</span></a></span></span><span> </span><span id="local-6989586621679316034"><span class="annot"><a href="#local-6989586621679316034"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621679316033"><span class="annot"><a href="#local-6989586621679316033"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679316032"><span class="annot"><a href="#local-6989586621679316032"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-693"></span><span>      </span><span id="FromSVarInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarInit"><span class="hs-identifier hs-var">FromSVarInit</span></a></span></span><span>
</span><span id="line-694"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="FromSVarRead"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarRead"><span class="hs-identifier hs-var">FromSVarRead</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#SVar"><span class="hs-identifier hs-type">SVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316034"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316033"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316032"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-695"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="FromSVarLoop"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-var">FromSVarLoop</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#SVar"><span class="hs-identifier hs-type">SVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316034"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316033"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316032"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#ChildEvent"><span class="hs-identifier hs-type">ChildEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316032"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-696"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="FromSVarDone"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarDone"><span class="hs-identifier hs-var">FromSVarDone</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#SVar"><span class="hs-identifier hs-type">SVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316034"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316033"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316032"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>
</span><span id="line-698"></span><span class="hs-pragma">{-# INLINE_NORMAL fromSVar #-}</span><span>
</span><span id="line-699"></span><span id="local-6989586621679315049"><span id="local-6989586621679315050"><span id="local-6989586621679315051"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromSVar"><span class="hs-identifier hs-type">fromSVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315051"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#SVar"><span class="hs-identifier hs-type">SVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315050"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315049"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315049"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-700"></span><span id="fromSVar"><span class="annot"><span class="annottext">fromSVar :: SVar t m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromSVar"><span class="hs-identifier hs-var hs-var">fromSVar</span></a></span></span><span> </span><span id="local-6989586621679314480"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314480"><span class="hs-identifier hs-var">svar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; FromSVarState t m a -&gt; m (Step (FromSVarState t m a) a))
-&gt; FromSVarState t m a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; FromSVarState t m a -&gt; m (Step (FromSVarState t m a) a)
forall p.
p -&gt; FromSVarState t m a -&gt; m (Step (FromSVarState t m a) a)
</span><a href="#local-6989586621679314479"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarInit"><span class="hs-identifier hs-var">FromSVarInit</span></a></span><span>
</span><span id="line-701"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-702"></span><span>
</span><span id="line-703"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-704"></span><span>    </span><span id="local-6989586621679314479"><span class="annot"><span class="annottext">step :: p -&gt; FromSVarState t m a -&gt; m (Step (FromSVarState t m a) a)
</span><a href="#local-6989586621679314479"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarInit"><span class="hs-identifier hs-var">FromSVarInit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-705"></span><span>        </span><span id="local-6989586621679314478"><span class="annot"><span class="annottext">IORef ()
</span><a href="#local-6989586621679314478"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef ()) -&gt; m (IORef ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef ()) -&gt; m (IORef ())) -&gt; IO (IORef ()) -&gt; m (IORef ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; IO (IORef ())
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>        </span><span class="annot"><span class="annottext">Weak (IORef ())
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Weak (IORef ())) -&gt; m (Weak (IORef ()))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Weak (IORef ())) -&gt; m (Weak (IORef ())))
-&gt; IO (Weak (IORef ())) -&gt; m (Weak (IORef ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef () -&gt; IO () -&gt; IO (Weak (IORef ()))
forall a. IORef a -&gt; IO () -&gt; IO (Weak (IORef a))
</span><span class="hs-identifier hs-var">mkWeakIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef ()
</span><a href="#local-6989586621679314478"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679314477"><span class="hs-identifier hs-var">hook</span></a></span><span>
</span><span id="line-707"></span><span>        </span><span class="hs-comment">-- when this copy of svar gets garbage collected &quot;ref&quot; will get</span><span>
</span><span id="line-708"></span><span>        </span><span class="hs-comment">-- garbage collected and our GC hook will be called.</span><span>
</span><span id="line-709"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314476"><span class="annot"><span class="annottext">sv :: SVar t m a
</span><a href="#local-6989586621679314476"><span class="hs-identifier hs-var hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314480"><span class="hs-identifier hs-var">svar</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">svarRef :: Maybe (IORef ())
</span><a href="Streamly.Internal.Data.SVar.html#svarRef"><span class="hs-identifier hs-var">svarRef</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef () -&gt; Maybe (IORef ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IORef ()
</span><a href="#local-6989586621679314478"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-710"></span><span>        </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarRead"><span class="hs-identifier hs-var">FromSVarRead</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314476"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span>        </span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="#local-6989586621679314477"><span class="hs-pragma hs-type">hook</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-715"></span><span>        </span><span id="local-6989586621679314477"><span class="annot"><span class="annottext">hook :: IO ()
</span><a href="#local-6989586621679314477"><span class="hs-identifier hs-var hs-var">hook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-716"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; Bool
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; Bool
</span><a href="Streamly.Internal.Data.SVar.html#svarInspectMode"><span class="hs-identifier hs-var hs-var">svarInspectMode</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314480"><span class="hs-identifier hs-var">svar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-717"></span><span>                </span><span id="local-6989586621679314473"><span class="annot"><span class="annottext">Maybe AbsTime
</span><a href="#local-6989586621679314473"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe AbsTime) -&gt; IO (Maybe AbsTime)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe AbsTime) -&gt; IO (Maybe AbsTime))
-&gt; IO (Maybe AbsTime) -&gt; IO (Maybe AbsTime)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe AbsTime) -&gt; IO (Maybe AbsTime)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVarStats -&gt; IORef (Maybe AbsTime)
</span><a href="Streamly.Internal.Data.SVar.html#svarStopTime"><span class="hs-identifier hs-var hs-var">svarStopTime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; SVarStats
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; SVarStats
</span><a href="Streamly.Internal.Data.SVar.html#svarStats"><span class="hs-identifier hs-var hs-var">svarStats</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314480"><span class="hs-identifier hs-var">svar</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-718"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe AbsTime -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe AbsTime
</span><a href="#local-6989586621679314473"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-719"></span><span>                    </span><span class="annot"><span class="annottext">SVar t m a -&gt; String -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; String -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#printSVar"><span class="hs-identifier hs-var">printSVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314480"><span class="hs-identifier hs-var">svar</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SVar Garbage Collected&quot;</span></span><span>
</span><span id="line-720"></span><span>            </span><span class="annot"><span class="annottext">SVar t m a -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#cleanupSVar"><span class="hs-identifier hs-var">cleanupSVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314480"><span class="hs-identifier hs-var">svar</span></a></span><span>
</span><span id="line-721"></span><span>            </span><span class="hs-comment">-- If there are any SVars referenced by this SVar a GC will prompt</span><span>
</span><span id="line-722"></span><span>            </span><span class="hs-comment">-- them to be cleaned up quickly.</span><span>
</span><span id="line-723"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; Bool
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; Bool
</span><a href="Streamly.Internal.Data.SVar.html#svarInspectMode"><span class="hs-identifier hs-var hs-var">svarInspectMode</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314480"><span class="hs-identifier hs-var">svar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><span class="hs-identifier hs-var">performMajorGC</span></span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span>    </span><span class="annot"><a href="#local-6989586621679314479"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarRead"><span class="hs-identifier hs-type">FromSVarRead</span></a></span><span> </span><span id="local-6989586621679314468"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314468"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-726"></span><span>        </span><span id="local-6989586621679314467"><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314467"><span class="hs-identifier hs-var">list</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; m [ChildEvent a]
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; m [ChildEvent a]
</span><a href="Streamly.Internal.Data.SVar.html#readOutputQ"><span class="hs-identifier hs-var hs-var">readOutputQ</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314468"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-727"></span><span>        </span><span class="hs-comment">-- Reversing the output is important to guarantee that we process the</span><span>
</span><span id="line-728"></span><span>        </span><span class="hs-comment">-- outputs in the same order as they were generated by the constituent</span><span>
</span><span id="line-729"></span><span>        </span><span class="hs-comment">-- streams.</span><span>
</span><span id="line-730"></span><span>        </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(FromSVarState t m a -&gt; Step (FromSVarState t m a) a)
-&gt; FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-var">FromSVarLoop</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314468"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ChildEvent a] -&gt; [ChildEvent a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314467"><span class="hs-identifier hs-var">list</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span>    </span><span class="annot"><a href="#local-6989586621679314479"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-type">FromSVarLoop</span></a></span><span> </span><span id="local-6989586621679314465"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314465"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-733"></span><span>        </span><span id="local-6989586621679314464"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679314464"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; m Bool
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.SVar.html#postProcess"><span class="hs-identifier hs-var hs-var">postProcess</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314465"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-734"></span><span>        </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(FromSVarState t m a -&gt; Step (FromSVarState t m a) a)
-&gt; FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679314464"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-735"></span><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarDone"><span class="hs-identifier hs-var">FromSVarDone</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314465"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-736"></span><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarRead"><span class="hs-identifier hs-var">FromSVarRead</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314465"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>
</span><span id="line-738"></span><span>    </span><span class="annot"><a href="#local-6989586621679314479"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-type">FromSVarLoop</span></a></span><span> </span><span id="local-6989586621679314462"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314461"><span class="annot"><span class="annottext">ChildEvent a
</span><a href="#local-6989586621679314461"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679314460"><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314460"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-739"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChildEvent a
</span><a href="#local-6989586621679314461"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-740"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#ChildYield"><span class="hs-identifier hs-type">ChildYield</span></a></span><span> </span><span id="local-6989586621679314458"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314458"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314458"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-var">FromSVarLoop</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314460"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#ChildStop"><span class="hs-identifier hs-type">ChildStop</span></a></span><span> </span><span id="local-6989586621679314456"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679314456"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span id="local-6989586621679314455"><span class="annot"><span class="annottext">Maybe SomeException
</span><a href="#local-6989586621679314455"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-742"></span><span>                </span><span class="annot"><span class="annottext">SVar t m a -&gt; ThreadId -&gt; m ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; ThreadId -&gt; m ()
</span><a href="Streamly.Internal.Data.SVar.html#accountThread"><span class="hs-identifier hs-var hs-var">accountThread</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679314456"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-743"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SomeException
</span><a href="#local-6989586621679314455"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-744"></span><span>                    </span><span class="annot"><span class="annottext">Maybe SomeException
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-745"></span><span>                        </span><span id="local-6989586621679314453"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679314453"><span class="hs-identifier hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; m Bool
forall (m :: * -&gt; *). MonadIO m =&gt; ThreadId -&gt; m Bool
</span><a href="#local-6989586621679314452"><span class="hs-identifier hs-var">shouldStop</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679314456"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-746"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679314453"><span class="hs-identifier hs-var">stop</span></a></span><span>
</span><span id="line-747"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-748"></span><span>                            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#cleanupSVar"><span class="hs-identifier hs-var">cleanupSVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-749"></span><span>                            </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarDone"><span class="hs-identifier hs-var">FromSVarDone</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-750"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-var">FromSVarLoop</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314460"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-751"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679314451"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679314451"><span class="hs-identifier hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-752"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe ThreadAbort
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679314451"><span class="hs-identifier hs-var">ex</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-753"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">ThreadAbort
</span><a href="Streamly.Internal.Data.SVar.html#ThreadAbort"><span class="hs-identifier hs-var">ThreadAbort</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-754"></span><span>                                </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-var">FromSVarLoop</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314460"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-755"></span><span>                            </span><span class="annot"><span class="annottext">Maybe ThreadAbort
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#cleanupSVar"><span class="hs-identifier hs-var">cleanupSVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m ()
-&gt; m (Step (FromSVarState t m a) a)
-&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679314451"><span class="hs-identifier hs-var">ex</span></a></span><span>
</span><span id="line-756"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-757"></span><span>
</span><span id="line-758"></span><span>        </span><span id="local-6989586621679314452"><span class="annot"><span class="annottext">shouldStop :: ThreadId -&gt; m Bool
</span><a href="#local-6989586621679314452"><span class="hs-identifier hs-var hs-var">shouldStop</span></a></span></span><span> </span><span id="local-6989586621679314449"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679314449"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-759"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; SVarStopStyle
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; SVarStopStyle
</span><a href="Streamly.Internal.Data.SVar.html#svarStopStyle"><span class="hs-identifier hs-var hs-var">svarStopStyle</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-760"></span><span>                </span><span class="annot"><span class="annottext">SVarStopStyle
</span><a href="Streamly.Internal.Data.SVar.html#StopNone"><span class="hs-identifier hs-var">StopNone</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-761"></span><span>                </span><span class="annot"><span class="annottext">SVarStopStyle
</span><a href="Streamly.Internal.Data.SVar.html#StopAny"><span class="hs-identifier hs-var">StopAny</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-762"></span><span>                </span><span class="annot"><span class="annottext">SVarStopStyle
</span><a href="Streamly.Internal.Data.SVar.html#StopBy"><span class="hs-identifier hs-var">StopBy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-763"></span><span>                    </span><span id="local-6989586621679314444"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679314444"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId -&gt; m ThreadId
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; m ThreadId) -&gt; IO ThreadId -&gt; m ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef ThreadId -&gt; IO ThreadId
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; IORef ThreadId
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; IORef ThreadId
</span><a href="Streamly.Internal.Data.SVar.html#svarStopBy"><span class="hs-identifier hs-var hs-var">svarStopBy</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314462"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>                    </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679314449"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; ThreadId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679314444"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-765"></span><span>
</span><span id="line-766"></span><span>    </span><span class="annot"><a href="#local-6989586621679314479"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarDone"><span class="hs-identifier hs-type">FromSVarDone</span></a></span><span> </span><span id="local-6989586621679314442"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314442"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-767"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; Bool
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; Bool
</span><a href="Streamly.Internal.Data.SVar.html#svarInspectMode"><span class="hs-identifier hs-var hs-var">svarInspectMode</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314442"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-768"></span><span>            </span><span id="local-6989586621679314441"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679314441"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AbsTime -&gt; m AbsTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO AbsTime -&gt; m AbsTime) -&gt; IO AbsTime -&gt; m AbsTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO AbsTime
</span><a href="Streamly.Internal.Data.Time.Clock.html#getTime"><span class="hs-identifier hs-var">getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="Streamly.Internal.Data.Time.Clock.html#Monotonic"><span class="hs-identifier hs-var">Monotonic</span></a></span><span>
</span><span id="line-769"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe AbsTime) -&gt; Maybe AbsTime -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVarStats -&gt; IORef (Maybe AbsTime)
</span><a href="Streamly.Internal.Data.SVar.html#svarStopTime"><span class="hs-identifier hs-var hs-var">svarStopTime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; SVarStats
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; SVarStats
</span><a href="Streamly.Internal.Data.SVar.html#svarStats"><span class="hs-identifier hs-var hs-var">svarStats</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314442"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbsTime -&gt; Maybe AbsTime
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679314441"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; String -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; String -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#printSVar"><span class="hs-identifier hs-var">printSVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314442"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SVar Done&quot;</span></span><span>
</span><span id="line-771"></span><span>        </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-772"></span><span>
</span><span id="line-773"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-774"></span><span class="hs-comment">-- Process events received by a fold consumer from a stream producer</span><span>
</span><span id="line-775"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span class="hs-pragma">{-# INLINE_NORMAL fromProducer #-}</span><span>
</span><span id="line-778"></span><span id="local-6989586621679314437"><span id="local-6989586621679314438"><span id="local-6989586621679314439"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#fromProducer"><span class="hs-identifier hs-type">fromProducer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314439"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#SVar"><span class="hs-identifier hs-type">SVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314438"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314439"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314437"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314439"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314437"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-779"></span><span id="fromProducer"><span class="annot"><span class="annottext">fromProducer :: SVar t m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromProducer"><span class="hs-identifier hs-var hs-var">fromProducer</span></a></span></span><span> </span><span id="local-6989586621679314436"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314436"><span class="hs-identifier hs-var">svar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; FromSVarState t m a -&gt; m (Step (FromSVarState t m a) a))
-&gt; FromSVarState t m a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; FromSVarState t m a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) p (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadIO m =&gt;
p -&gt; FromSVarState t m a -&gt; m (Step (FromSVarState t m a) a)
</span><a href="#local-6989586621679314435"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarRead"><span class="hs-identifier hs-var">FromSVarRead</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314436"><span class="hs-identifier hs-var">svar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-780"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-781"></span><span>
</span><span id="line-782"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-783"></span><span>    </span><span id="local-6989586621679314435"><span class="annot"><span class="annottext">step :: p -&gt; FromSVarState t m a -&gt; m (Step (FromSVarState t m a) a)
</span><a href="#local-6989586621679314435"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarRead"><span class="hs-identifier hs-type">FromSVarRead</span></a></span><span> </span><span id="local-6989586621679314434"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314434"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-784"></span><span>        </span><span id="local-6989586621679314433"><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314433"><span class="hs-identifier hs-var">list</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; m [ChildEvent a]
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; m [ChildEvent a]
</span><a href="Streamly.Internal.Data.SVar.html#readOutputQ"><span class="hs-identifier hs-var hs-var">readOutputQ</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314434"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-785"></span><span>        </span><span class="hs-comment">-- Reversing the output is important to guarantee that we process the</span><span>
</span><span id="line-786"></span><span>        </span><span class="hs-comment">-- outputs in the same order as they were generated by the constituent</span><span>
</span><span id="line-787"></span><span>        </span><span class="hs-comment">-- streams.</span><span>
</span><span id="line-788"></span><span>        </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(FromSVarState t m a -&gt; Step (FromSVarState t m a) a)
-&gt; FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-var">FromSVarLoop</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314434"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ChildEvent a] -&gt; [ChildEvent a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314433"><span class="hs-identifier hs-var">list</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span>    </span><span class="annot"><a href="#local-6989586621679314435"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-type">FromSVarLoop</span></a></span><span> </span><span id="local-6989586621679314432"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314432"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(FromSVarState t m a -&gt; Step (FromSVarState t m a) a)
-&gt; FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarRead"><span class="hs-identifier hs-var">FromSVarRead</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314432"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-791"></span><span>    </span><span class="annot"><a href="#local-6989586621679314435"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-type">FromSVarLoop</span></a></span><span> </span><span id="local-6989586621679314431"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314431"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314430"><span class="annot"><span class="annottext">ChildEvent a
</span><a href="#local-6989586621679314430"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679314429"><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314429"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-792"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChildEvent a
</span><a href="#local-6989586621679314430"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-793"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#ChildYield"><span class="hs-identifier hs-type">ChildYield</span></a></span><span> </span><span id="local-6989586621679314428"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314428"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314428"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; [ChildEvent a] -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarLoop"><span class="hs-identifier hs-var">FromSVarLoop</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314431"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">[ChildEvent a]
</span><a href="#local-6989586621679314429"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#ChildStop"><span class="hs-identifier hs-type">ChildStop</span></a></span><span> </span><span id="local-6989586621679314427"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679314427"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span id="local-6989586621679314426"><span class="annot"><span class="annottext">Maybe SomeException
</span><a href="#local-6989586621679314426"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-795"></span><span>                </span><span class="annot"><span class="annottext">SVar t m a -&gt; ThreadId -&gt; m ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; ThreadId -&gt; m ()
</span><a href="Streamly.Internal.Data.SVar.html#accountThread"><span class="hs-identifier hs-var hs-var">accountThread</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314431"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679314427"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-796"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SomeException
</span><a href="#local-6989586621679314426"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-797"></span><span>                    </span><span class="annot"><span class="annottext">Maybe SomeException
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-798"></span><span>                        </span><span class="annot"><span class="annottext">SVar t m a -&gt; m ()
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadIO m =&gt;
SVar t m a -&gt; m ()
</span><a href="Streamly.Internal.Data.SVar.html#sendStopToProducer"><span class="hs-identifier hs-var">sendStopToProducer</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314431"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-799"></span><span>                        </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a))
-&gt; Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a -&gt; Step (FromSVarState t m a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; FromSVarState t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarDone"><span class="hs-identifier hs-var">FromSVarDone</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314431"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-800"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m (Step (FromSVarState t m a) a)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Bug: fromProducer: received exception&quot;</span></span><span>
</span><span id="line-801"></span><span>
</span><span id="line-802"></span><span>    </span><span class="annot"><a href="#local-6989586621679314435"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarDone"><span class="hs-identifier hs-type">FromSVarDone</span></a></span><span> </span><span id="local-6989586621679314423"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314423"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-803"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; Bool
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; Bool
</span><a href="Streamly.Internal.Data.SVar.html#svarInspectMode"><span class="hs-identifier hs-var hs-var">svarInspectMode</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314423"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-804"></span><span>            </span><span id="local-6989586621679314422"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679314422"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AbsTime -&gt; m AbsTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO AbsTime -&gt; m AbsTime) -&gt; IO AbsTime -&gt; m AbsTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO AbsTime
</span><a href="Streamly.Internal.Data.Time.Clock.html#getTime"><span class="hs-identifier hs-var">getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="Streamly.Internal.Data.Time.Clock.html#Monotonic"><span class="hs-identifier hs-var">Monotonic</span></a></span><span>
</span><span id="line-805"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe AbsTime) -&gt; Maybe AbsTime -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVarStats -&gt; IORef (Maybe AbsTime)
</span><a href="Streamly.Internal.Data.SVar.html#svarStopTime"><span class="hs-identifier hs-var hs-var">svarStopTime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; SVarStats
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; SVarStats
</span><a href="Streamly.Internal.Data.SVar.html#svarStats"><span class="hs-identifier hs-var hs-var">svarStats</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314423"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbsTime -&gt; Maybe AbsTime
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679314422"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; String -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; String -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#printSVar"><span class="hs-identifier hs-var">printSVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679314423"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SVar Done&quot;</span></span><span>
</span><span id="line-807"></span><span>        </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a -&gt; m (Step (FromSVarState t m a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (FromSVarState t m a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span>    </span><span class="annot"><a href="#local-6989586621679314435"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FromSVarState t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FromSVarInit"><span class="hs-identifier hs-var">FromSVarInit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Step (FromSVarState t m a) a)
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-810"></span><span>
</span><span id="line-811"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-812"></span><span class="hs-comment">-- Hoisting the inner monad</span><span>
</span><span id="line-813"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-814"></span><span>
</span><span id="line-815"></span><span class="hs-pragma">{-# INLINE_NORMAL hoist #-}</span><span>
</span><span id="line-816"></span><span id="local-6989586621679315964"><span id="local-6989586621679315965"><span id="local-6989586621679315966"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#hoist"><span class="hs-identifier hs-type">hoist</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315966"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679315980"><span class="annot"><a href="#local-6989586621679315980"><span class="hs-identifier hs-type">x</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679315965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315980"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315966"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315980"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315964"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315966"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315964"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-817"></span><span id="hoist"><span class="annot"><span class="annottext">hoist :: (forall x. m x -&gt; n x) -&gt; Stream m a -&gt; Stream n a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#hoist"><span class="hs-identifier hs-var hs-var">hoist</span></a></span></span><span> </span><span id="local-6989586621679314420"><span class="annot"><span class="annottext">forall x. m x -&gt; n x
</span><a href="#local-6989586621679314420"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314419"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314419"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314418"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314418"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream n a -&gt; s -&gt; n (Step s a)) -&gt; s -&gt; Stream n a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream n a -&gt; s -&gt; n (Step s a)
forall (m :: * -&gt; *) a. State Stream m a -&gt; s -&gt; n (Step s a)
</span><a href="#local-6989586621679314417"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314418"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-818"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-819"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-820"></span><span>    </span><span id="local-6989586621679314417"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; s -&gt; n (Step s a)
</span><a href="#local-6989586621679314417"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679314416"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314416"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span id="local-6989586621679314415"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314415"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-821"></span><span>        </span><span id="local-6989586621679314414"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314414"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Step s a) -&gt; n (Step s a)
forall x. m x -&gt; n x
</span><a href="#local-6989586621679314420"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Step s a) -&gt; n (Step s a)) -&gt; m (Step s a) -&gt; n (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314419"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314416"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314415"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><span class="annottext">Step s a -&gt; n (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; n (Step s a)) -&gt; Step s a -&gt; n (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314414"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-823"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314412"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314412"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314411"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314411"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; Step s a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314412"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314411"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-824"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679314410"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314410"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; Step s a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314410"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-825"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-826"></span><span>
</span><span id="line-827"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#generally"><span class="hs-pragma hs-type">generally</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-828"></span><span id="local-6989586621679314408"><span id="local-6989586621679314409"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#generally"><span class="hs-identifier hs-type">generally</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314409"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span> </span><span class="annot"><a href="#local-6989586621679314408"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314409"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314408"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-829"></span><span id="generally"><span class="annot"><span class="annottext">generally :: Stream Identity a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#generally"><span class="hs-identifier hs-var hs-var">generally</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall x. Identity x -&gt; m x) -&gt; Stream Identity a -&gt; Stream m a
forall (n :: * -&gt; *) (m :: * -&gt; *) a.
Monad n =&gt;
(forall x. m x -&gt; n x) -&gt; Stream m a -&gt; Stream n a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#hoist"><span class="hs-identifier hs-var">hoist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x -&gt; m x
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(x -&gt; m x) -&gt; (Identity x -&gt; x) -&gt; Identity x -&gt; m x
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Identity x -&gt; x
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span class="hs-special">)</span><span>
</span><span id="line-830"></span><span>
</span><span id="line-831"></span><span class="hs-pragma">{-# INLINE_NORMAL liftInner #-}</span><span>
</span><span id="line-832"></span><span id="local-6989586621679314404"><span id="local-6989586621679314405"><span id="local-6989586621679314406"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#liftInner"><span class="hs-identifier hs-type">liftInner</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314406"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTrans</span></span><span> </span><span class="annot"><a href="#local-6989586621679314405"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314405"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314406"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314404"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314405"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314406"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679314404"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-834"></span><span id="liftInner"><span class="annot"><span class="annottext">liftInner :: Stream m a -&gt; Stream (t m) a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#liftInner"><span class="hs-identifier hs-var hs-var">liftInner</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314403"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314403"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314402"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314402"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream (t m) a -&gt; s -&gt; t m (Step s a))
-&gt; s -&gt; Stream (t m) a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream (t m) a -&gt; s -&gt; t m (Step s a)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad (t m)) =&gt;
State Stream m a -&gt; s -&gt; t m (Step s a)
</span><a href="#local-6989586621679314401"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314402"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-835"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-836"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-837"></span><span>    </span><span id="local-6989586621679314401"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; s -&gt; t m (Step s a)
</span><a href="#local-6989586621679314401"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679314400"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314400"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span id="local-6989586621679314399"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314399"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-838"></span><span>        </span><span id="local-6989586621679314398"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314398"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Step s a) -&gt; t m (Step s a)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (Step s a) -&gt; t m (Step s a)) -&gt; m (Step s a) -&gt; t m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314403"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314400"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314399"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-839"></span><span>        </span><span class="annot"><span class="annottext">Step s a -&gt; t m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; t m (Step s a)) -&gt; Step s a -&gt; t m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314398"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-840"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314397"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314397"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314396"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314396"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; Step s a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314397"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314396"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-841"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314395"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314395"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; Step s a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314395"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-842"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-843"></span><span>
</span><span id="line-844"></span><span class="hs-pragma">{-# INLINE_NORMAL runReaderT #-}</span><span>
</span><span id="line-845"></span><span id="local-6989586621679314392"><span id="local-6989586621679314393"><span id="local-6989586621679314394"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runReaderT"><span class="hs-identifier hs-type">runReaderT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314394"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314394"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314393"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679314393"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314394"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679314392"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314394"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314392"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-846"></span><span id="runReaderT"><span class="annot"><span class="annottext">runReaderT :: m s -&gt; Stream (ReaderT s m) a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runReaderT"><span class="hs-identifier hs-var hs-var">runReaderT</span></a></span></span><span> </span><span id="local-6989586621679314391"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314391"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314390"><span class="annot"><span class="annottext">State Stream (ReaderT s m) a -&gt; s -&gt; ReaderT s m (Step s a)
</span><a href="#local-6989586621679314390"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314389"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314389"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) a))
-&gt; (s, m s) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) a)
forall (m :: * -&gt; *) (m :: * -&gt; *) a.
Monad m =&gt;
State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) a)
</span><a href="#local-6989586621679314388"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314389"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314391"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-848"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-849"></span><span>    </span><span id="local-6989586621679314388"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) a)
</span><a href="#local-6989586621679314388"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679314387"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314387"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314386"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314386"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314385"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314385"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-850"></span><span>        </span><span id="local-6989586621679314384"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314384"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314385"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-851"></span><span>        </span><span id="local-6989586621679314383"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314383"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT s m (Step s a) -&gt; s -&gt; m (Step s a)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">Reader.runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream (ReaderT s m) a -&gt; s -&gt; ReaderT s m (Step s a)
</span><a href="#local-6989586621679314390"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream (ReaderT s m) a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314387"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314386"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314384"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-852"></span><span>        </span><span class="annot"><span class="annottext">Step (s, m s) a -&gt; m (Step (s, m s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, m s) a -&gt; m (Step (s, m s) a))
-&gt; Step (s, m s) a -&gt; m (Step (s, m s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314383"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-853"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314381"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314381"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314380"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314380"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, m s) -&gt; Step (s, m s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314381"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314380"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314384"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-854"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679314379"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314379"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, m s) -&gt; Step (s, m s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314379"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314384"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-855"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, m s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-856"></span><span>
</span><span id="line-857"></span><span class="hs-pragma">{-# INLINE_NORMAL evalStateT #-}</span><span>
</span><span id="line-858"></span><span id="local-6989586621679314376"><span id="local-6989586621679314377"><span id="local-6989586621679314378"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#evalStateT"><span class="hs-identifier hs-type">evalStateT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314377"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="#local-6989586621679314377"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314378"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679314376"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314376"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-859"></span><span id="evalStateT"><span class="annot"><span class="annottext">evalStateT :: m s -&gt; Stream (StateT s m) a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#evalStateT"><span class="hs-identifier hs-var hs-var">evalStateT</span></a></span></span><span> </span><span id="local-6989586621679314375"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314375"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314374"><span class="annot"><span class="annottext">State Stream (StateT s m) a -&gt; s -&gt; StateT s m (Step s a)
</span><a href="#local-6989586621679314374"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314373"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314373"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) a))
-&gt; (s, m s) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) a)
forall (m :: * -&gt; *) (m :: * -&gt; *) a.
Monad m =&gt;
State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) a)
</span><a href="#local-6989586621679314372"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314373"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314375"><span class="hs-identifier hs-var">initial</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-860"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-861"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-862"></span><span>    </span><span id="local-6989586621679314372"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) a)
</span><a href="#local-6989586621679314372"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679314371"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314371"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314370"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314370"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314369"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314369"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-863"></span><span>        </span><span id="local-6989586621679314368"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314368"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314369"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-864"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679314367"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314367"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314366"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314366"><span class="hs-identifier hs-var">sv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT s m (Step s a) -&gt; s -&gt; m (Step s a, s)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">State.runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream (StateT s m) a -&gt; s -&gt; StateT s m (Step s a)
</span><a href="#local-6989586621679314374"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream (StateT s m) a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314371"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314370"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314368"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-865"></span><span>        </span><span class="annot"><span class="annottext">Step (s, m s) a -&gt; m (Step (s, m s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, m s) a -&gt; m (Step (s, m s) a))
-&gt; Step (s, m s) a -&gt; m (Step (s, m s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314367"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-866"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314364"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314364"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314363"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314363"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, m s) -&gt; Step (s, m s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314364"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314363"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314366"><span class="hs-identifier hs-var">sv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-867"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679314362"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314362"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, m s) -&gt; Step (s, m s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314362"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314366"><span class="hs-identifier hs-var">sv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-868"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, m s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-869"></span><span>
</span><span id="line-870"></span><span class="hs-pragma">{-# INLINE_NORMAL runStateT #-}</span><span>
</span><span id="line-871"></span><span id="local-6989586621679314359"><span id="local-6989586621679314360"><span id="local-6989586621679314361"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runStateT"><span class="hs-identifier hs-type">runStateT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314361"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314361"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314360"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="#local-6989586621679314360"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314361"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679314359"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314361"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314360"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679314359"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-872"></span><span id="runStateT"><span class="annot"><span class="annottext">runStateT :: m s -&gt; Stream (StateT s m) a -&gt; Stream m (s, a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runStateT"><span class="hs-identifier hs-var hs-var">runStateT</span></a></span></span><span> </span><span id="local-6989586621679314358"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314358"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314357"><span class="annot"><span class="annottext">State Stream (StateT s m) a -&gt; s -&gt; StateT s m (Step s a)
</span><a href="#local-6989586621679314357"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314356"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314356"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m (s, a) -&gt; (s, m s) -&gt; m (Step (s, m s) (s, a)))
-&gt; (s, m s) -&gt; Stream m (s, a)
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (s, a) -&gt; (s, m s) -&gt; m (Step (s, m s) (s, a))
forall (m :: * -&gt; *) (m :: * -&gt; *) a.
Monad m =&gt;
State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) (s, a))
</span><a href="#local-6989586621679314355"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314356"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314358"><span class="hs-identifier hs-var">initial</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-873"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-874"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-875"></span><span>    </span><span id="local-6989586621679314355"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, m s) -&gt; m (Step (s, m s) (s, a))
</span><a href="#local-6989586621679314355"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679314354"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314354"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314353"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314353"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314352"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314352"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-876"></span><span>        </span><span id="local-6989586621679314351"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314351"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314352"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-877"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679314350"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314350"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314349"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314349"><span class="hs-identifier hs-var">sv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT s m (Step s a) -&gt; s -&gt; m (Step s a, s)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">State.runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream (StateT s m) a -&gt; s -&gt; StateT s m (Step s a)
</span><a href="#local-6989586621679314357"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream (StateT s m) a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314354"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314353"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314351"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-878"></span><span>        </span><span class="annot"><span class="annottext">Step (s, m s) (s, a) -&gt; m (Step (s, m s) (s, a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, m s) (s, a) -&gt; m (Step (s, m s) (s, a)))
-&gt; Step (s, m s) (s, a) -&gt; m (Step (s, m s) (s, a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314350"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-879"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314348"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314348"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314347"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314347"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, a) -&gt; (s, m s) -&gt; Step (s, m s) (s, a)
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314349"><span class="hs-identifier hs-var">sv'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314348"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314347"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314349"><span class="hs-identifier hs-var">sv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-880"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679314346"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314346"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, m s) -&gt; Step (s, m s) (s, a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314346"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314349"><span class="hs-identifier hs-var">sv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-881"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, m s) (s, a)
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-882"></span><span>
</span><span id="line-883"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-884"></span><span class="hs-comment">-- Elimination by Folds</span><span>
</span><span id="line-885"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-886"></span><span>
</span><span id="line-887"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-888"></span><span class="hs-comment">-- Right Folds</span><span>
</span><span id="line-889"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-890"></span><span>
</span><span id="line-891"></span><span class="hs-pragma">{-# INLINE_NORMAL foldr1 #-}</span><span>
</span><span id="line-892"></span><span id="local-6989586621679314344"><span id="local-6989586621679314345"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#foldr1"><span class="hs-identifier hs-type">foldr1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314345"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314344"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314344"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314344"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314345"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314344"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314345"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679314344"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-893"></span><span id="foldr1"><span class="annot"><span class="annottext">foldr1 :: (a -&gt; a -&gt; a) -&gt; Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#foldr1"><span class="hs-identifier hs-var hs-var">foldr1</span></a></span></span><span> </span><span id="local-6989586621679314343"><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="#local-6989586621679314343"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679314342"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314342"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-894"></span><span>     </span><span id="local-6989586621679314341"><span class="annot"><span class="annottext">Maybe (a, Stream m a)
</span><a href="#local-6989586621679314341"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m (Maybe (a, Stream m a))
forall (m :: * -&gt; *) a.
Monad m =&gt;
Stream m a -&gt; m (Maybe (a, Stream m a))
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#uncons"><span class="hs-identifier hs-var">uncons</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314342"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-895"></span><span>     </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (a, Stream m a)
</span><a href="#local-6989586621679314341"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-896"></span><span>         </span><span class="annot"><span class="annottext">Maybe (a, Stream m a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-897"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314340"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314340"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314339"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314339"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Maybe a) -&gt; m a -&gt; m (Maybe a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; a -&gt; a) -&gt; a -&gt; Stream m a -&gt; m a
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="#local-6989586621679314343"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314340"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314339"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span>
</span><span id="line-899"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-900"></span><span class="hs-comment">-- Left Folds</span><span>
</span><span id="line-901"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-902"></span><span>
</span><span id="line-903"></span><span class="hs-pragma">{-# INLINE_NORMAL foldlT #-}</span><span>
</span><span id="line-904"></span><span id="local-6989586621679314335"><span id="local-6989586621679314336"><span id="local-6989586621679314337"><span id="local-6989586621679314338"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#foldlT"><span class="hs-identifier hs-type">foldlT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314338"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314337"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314338"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTrans</span></span><span> </span><span class="annot"><a href="#local-6989586621679314337"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-905"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314337"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314338"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314336"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314335"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314337"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314338"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314336"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314337"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314338"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314336"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314338"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314335"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314337"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314338"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314336"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span><span>
</span><span id="line-906"></span><span id="foldlT"><span class="annot"><span class="annottext">foldlT :: (s m b -&gt; a -&gt; s m b) -&gt; s m b -&gt; Stream m a -&gt; s m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#foldlT"><span class="hs-identifier hs-var hs-var">foldlT</span></a></span></span><span> </span><span id="local-6989586621679314334"><span class="annot"><span class="annottext">s m b -&gt; a -&gt; s m b
</span><a href="#local-6989586621679314334"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679314333"><span class="annot"><span class="annottext">s m b
</span><a href="#local-6989586621679314333"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314332"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314332"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314331"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314331"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s m b -&gt; s -&gt; s m b
</span><a href="#local-6989586621679314330"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s m b
</span><a href="#local-6989586621679314333"><span class="hs-identifier hs-var">begin</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314331"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-907"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-908"></span><span>    </span><span id="local-6989586621679314330"><span class="annot"><span class="annottext">go :: SPEC -&gt; s m b -&gt; s -&gt; s m b
</span><a href="#local-6989586621679314330"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314328"><span class="annot"><span class="annottext">s m b
</span><a href="#local-6989586621679314328"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679314327"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314327"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-909"></span><span>        </span><span id="local-6989586621679314326"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314326"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Step s a) -&gt; s m (Step s a)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (Step s a) -&gt; s m (Step s a)) -&gt; m (Step s a) -&gt; s m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314332"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314327"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-910"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314326"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-911"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314325"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314325"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314324"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314324"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s m b -&gt; s -&gt; s m b
</span><a href="#local-6989586621679314330"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s m b -&gt; a -&gt; s m b
</span><a href="#local-6989586621679314334"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s m b
</span><a href="#local-6989586621679314328"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314325"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314324"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-912"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314323"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314323"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s m b -&gt; s -&gt; s m b
</span><a href="#local-6989586621679314330"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s m b
</span><a href="#local-6989586621679314328"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314323"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-913"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s m b
</span><a href="#local-6989586621679314328"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-914"></span><span>
</span><span id="line-915"></span><span class="hs-comment">-- Note, this is going to have horrible performance, because of the nature of</span><span>
</span><span id="line-916"></span><span class="hs-comment">-- the stream type (i.e. direct stream vs CPS). Its only for reference, it is</span><span>
</span><span id="line-917"></span><span class="hs-comment">-- likely be practically unusable.</span><span>
</span><span id="line-918"></span><span class="hs-pragma">{-# INLINE_NORMAL foldlS #-}</span><span>
</span><span id="line-919"></span><span id="local-6989586621679314320"><span id="local-6989586621679314321"><span id="local-6989586621679314322"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#foldlS"><span class="hs-identifier hs-type">foldlS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314322"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-920"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314322"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314321"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314320"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314322"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314321"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314322"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314321"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314322"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314320"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314322"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314321"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-921"></span><span id="foldlS"><span class="annot"><span class="annottext">foldlS :: (Stream m b -&gt; a -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#foldlS"><span class="hs-identifier hs-var hs-var">foldlS</span></a></span></span><span> </span><span id="local-6989586621679314319"><span class="annot"><span class="annottext">Stream m b -&gt; a -&gt; Stream m b
</span><a href="#local-6989586621679314319"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679314318"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679314318"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314317"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314317"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314316"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314316"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; Either (s, Stream m b) (Stream m b)
 -&gt; m (Step (Either (s, Stream m b) (Stream m b)) b))
-&gt; Either (s, Stream m b) (Stream m b) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; Either (s, Stream m b) (Stream m b)
-&gt; m (Step (Either (s, Stream m b) (Stream m b)) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; Either (s, Stream m b) (Stream m b)
-&gt; m (Step (Either (s, Stream m b) (Stream m b)) b)
</span><a href="#local-6989586621679314315"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, Stream m b) -&gt; Either (s, Stream m b) (Stream m b)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314316"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679314318"><span class="hs-identifier hs-var">begin</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-923"></span><span>    </span><span id="local-6989586621679314315"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; Either (s, Stream m b) (Stream m b)
-&gt; m (Step (Either (s, Stream m b) (Stream m b)) b)
</span><a href="#local-6989586621679314315"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679314314"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314314"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314313"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314313"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314312"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679314312"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-924"></span><span>        </span><span id="local-6989586621679314311"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314311"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314317"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314314"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314313"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-925"></span><span>        </span><span class="annot"><span class="annottext">Step (Either (s, Stream m b) (Stream m b)) b
-&gt; m (Step (Either (s, Stream m b) (Stream m b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either (s, Stream m b) (Stream m b)) b
 -&gt; m (Step (Either (s, Stream m b) (Stream m b)) b))
-&gt; Step (Either (s, Stream m b) (Stream m b)) b
-&gt; m (Step (Either (s, Stream m b) (Stream m b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314311"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-926"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314310"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314310"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314309"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314309"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either (s, Stream m b) (Stream m b)
-&gt; Step (Either (s, Stream m b) (Stream m b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, Stream m b) -&gt; Either (s, Stream m b) (Stream m b)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314309"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; a -&gt; Stream m b
</span><a href="#local-6989586621679314319"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679314312"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314310"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-927"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314308"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314308"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either (s, Stream m b) (Stream m b)
-&gt; Step (Either (s, Stream m b) (Stream m b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, Stream m b) -&gt; Either (s, Stream m b) (Stream m b)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314308"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679314312"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-928"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either (s, Stream m b) (Stream m b)
-&gt; Step (Either (s, Stream m b) (Stream m b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b -&gt; Either (s, Stream m b) (Stream m b)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679314312"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span>    </span><span class="annot"><a href="#local-6989586621679314315"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679314307"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314307"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314306"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679314306"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span id="local-6989586621679314305"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314305"><span class="hs-identifier hs-var">stt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-931"></span><span>        </span><span id="local-6989586621679314304"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314304"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679314306"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m b
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314307"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314305"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-932"></span><span>        </span><span class="annot"><span class="annottext">Step (Either (s, Stream m b) (Stream m b)) b
-&gt; m (Step (Either (s, Stream m b) (Stream m b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either (s, Stream m b) (Stream m b)) b
 -&gt; m (Step (Either (s, Stream m b) (Stream m b)) b))
-&gt; Step (Either (s, Stream m b) (Stream m b)) b
-&gt; m (Step (Either (s, Stream m b) (Stream m b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314304"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-933"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314303"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314303"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314302"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314302"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b
-&gt; Either (s, Stream m b) (Stream m b)
-&gt; Step (Either (s, Stream m b) (Stream m b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314303"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b -&gt; Either (s, Stream m b) (Stream m b)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679314306"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314302"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-934"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314301"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314301"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either (s, Stream m b) (Stream m b)
-&gt; Step (Either (s, Stream m b) (Stream m b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b -&gt; Either (s, Stream m b) (Stream m b)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679314306"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314301"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-935"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either (s, Stream m b) (Stream m b)) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-936"></span><span>
</span><span id="line-937"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-938"></span><span class="hs-comment">-- Parses</span><span>
</span><span id="line-939"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-940"></span><span>
</span><span id="line-941"></span><span class="hs-comment">-- Inlined definition. Without the inline &quot;serially/parser/take&quot; benchmark</span><span>
</span><span id="line-942"></span><span class="hs-comment">-- degrades and parseMany does not fuse. Even using &quot;inline&quot; at the callsite</span><span>
</span><span id="line-943"></span><span class="hs-comment">-- does not help.</span><span>
</span><span id="line-944"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitAt"><span class="hs-pragma hs-type">splitAt</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-945"></span><span id="local-6989586621679314299"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitAt"><span class="hs-identifier hs-type">splitAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679314299"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679314299"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679314299"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-946"></span><span id="splitAt"><span class="annot"><span class="annottext">splitAt :: Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitAt"><span class="hs-identifier hs-var hs-var">splitAt</span></a></span></span><span> </span><span id="local-6989586621679314298"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314298"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314297"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314297"><span class="hs-identifier hs-var">ls</span></a></span></span><span>
</span><span id="line-947"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314298"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314297"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="#local-6989586621679314296"><span class="hs-identifier hs-var">splitAt'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314298"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314297"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-949"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-950"></span><span>        </span><span id="local-6989586621679315896"><span class="annot"><a href="#local-6989586621679314296"><span class="hs-identifier hs-type">splitAt'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315896"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315896"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315896"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-951"></span><span>        </span><span id="local-6989586621679314296"><span class="annot"><span class="annottext">splitAt' :: Int -&gt; [a] -&gt; ([a], [a])
</span><a href="#local-6989586621679314296"><span class="hs-identifier hs-var hs-var">splitAt'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-952"></span><span>        </span><span class="annot"><a href="#local-6989586621679314296"><span class="hs-identifier hs-var">splitAt'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679314295"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314295"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679314294"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314294"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314295"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314294"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-953"></span><span>        </span><span class="annot"><a href="#local-6989586621679314296"><span class="hs-identifier hs-var">splitAt'</span></a></span><span> </span><span id="local-6989586621679314293"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314293"><span class="hs-identifier hs-var">m</span></a></span></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679314292"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314292"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679314291"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314291"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314292"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314290"><span class="hs-identifier hs-var">xs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314289"><span class="hs-identifier hs-var">xs''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-954"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-955"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679314290"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314290"><span class="hs-identifier hs-var">xs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314289"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314289"><span class="hs-identifier hs-var">xs''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="#local-6989586621679314296"><span class="hs-identifier hs-var">splitAt'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314293"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314291"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-956"></span><span>
</span><span id="line-957"></span><span class="hs-comment">-- GHC parser does not accept {-# ANN type [] NoSpecConstr #-}, so we need</span><span>
</span><span id="line-958"></span><span class="hs-comment">-- to make a newtype.</span><span>
</span><span id="line-959"></span><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">type</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-pragma hs-type">List</span></a></span><span> </span><span class="annot"><span class="hs-pragma hs-type">NoSpecConstr</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-960"></span><span class="hs-keyword">newtype</span><span> </span><span id="List"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span></span><span> </span><span id="local-6989586621679315886"><span class="annot"><a href="#local-6989586621679315886"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="List"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span></span><span> </span><span class="hs-special">{</span><span id="getList"><span class="annot"><span class="annottext">List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315886"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><span id="line-961"></span><span>
</span><span id="line-962"></span><span class="hs-comment">-- | Run a 'Parse' over a stream.</span><span>
</span><span id="line-963"></span><span class="hs-pragma">{-# INLINE_NORMAL parselMx' #-}</span><span>
</span><span id="line-964"></span><span id="local-6989586621679314282"><span id="local-6989586621679314283"><span id="local-6989586621679314284"><span id="local-6989586621679314285"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#parselMx%27"><span class="hs-identifier hs-type">parselMx'</span></a></span><span>
</span><span id="line-965"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679314285"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-966"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314284"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314283"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314285"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Step"><span class="hs-identifier hs-type">PR.Step</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314284"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314282"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314285"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314284"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-968"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314284"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314285"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314282"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-969"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314285"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314283"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-970"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314285"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314282"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span><span>
</span><span id="line-971"></span><span id="parselMx%27"><span class="annot"><span class="annottext">parselMx' :: (s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#parselMx%27"><span class="hs-identifier hs-var hs-var">parselMx'</span></a></span></span><span> </span><span id="local-6989586621679314281"><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314281"><span class="hs-identifier hs-var">pstep</span></a></span></span><span> </span><span id="local-6989586621679314280"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314280"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679314279"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314279"><span class="hs-identifier hs-var">extract</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314278"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314278"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314277"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314277"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-972"></span><span>    </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314280"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m s -&gt; (s -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314276"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314277"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span>
</span><span id="line-974"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-975"></span><span>
</span><span id="line-976"></span><span>    </span><span class="hs-comment">-- XXX currently we are using a dumb list based approach for backtracking</span><span>
</span><span id="line-977"></span><span>    </span><span class="hs-comment">-- buffer. This can be replaced by a sliding/ring buffer using Data.Array.</span><span>
</span><span id="line-978"></span><span>    </span><span class="hs-comment">-- That will allow us more efficient random back and forth movement.</span><span>
</span><span id="line-979"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679314276"><span class="hs-pragma hs-type">go</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-980"></span><span>    </span><span id="local-6989586621679314276"><span class="annot"><span class="annottext">go :: SPEC -&gt; s -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314276"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314275"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314275"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679314274"><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314274"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679314273"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314273"><span class="hs-identifier hs-var">pst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-981"></span><span>        </span><span id="local-6989586621679314272"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314272"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314278"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314275"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-982"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314272"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-983"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314271"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314271"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314270"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314270"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-984"></span><span>                </span><span id="local-6989586621679314269"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314269"><span class="hs-identifier hs-var">pRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314281"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314273"><span class="hs-identifier hs-var">pst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314271"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-985"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314269"><span class="hs-identifier hs-var">pRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-986"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314267"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314267"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314276"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314270"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314267"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-987"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span id="local-6989586621679314266"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314266"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314265"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314265"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-988"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314266"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314271"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314274"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-989"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314263"><span class="annot"><span class="annottext">src0 :: [a]
</span><a href="#local-6989586621679314263"><span class="hs-identifier hs-var hs-var">src0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314266"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314271"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314274"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>                            </span><span id="local-6989586621679314262"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314262"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314263"><span class="hs-identifier hs-var">src0</span></a></span><span>
</span><span id="line-991"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314261"><span class="hs-identifier hs-var">gobuf</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314270"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314262"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314265"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-992"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314259"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314259"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314276"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314270"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314271"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314274"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314259"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-993"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span id="local-6989586621679314258"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314258"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314257"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314257"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-994"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314258"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314271"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314274"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-995"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314256"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314256"><span class="hs-identifier hs-var">src0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314255"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314255"><span class="hs-identifier hs-var">buf1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314258"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314271"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314274"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-996"></span><span>                            </span><span id="local-6989586621679314254"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314254"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314256"><span class="hs-identifier hs-var">src0</span></a></span><span>
</span><span id="line-997"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314261"><span class="hs-identifier hs-var">gobuf</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314270"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314255"><span class="hs-identifier hs-var">buf1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314254"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314257"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-998"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Done"><span class="hs-identifier hs-type">PR.Done</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314252"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314252"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314252"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-999"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Error"><span class="hs-identifier hs-type">PR.Error</span></a></span><span> </span><span id="local-6989586621679314250"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314250"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ParseError -&gt; m b
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(ParseError -&gt; m b) -&gt; ParseError -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ParseError
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314250"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1000"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314248"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314248"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314276"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314248"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314274"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314273"><span class="hs-identifier hs-var">pst</span></a></span><span>
</span><span id="line-1001"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314279"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314273"><span class="hs-identifier hs-var">pst</span></a></span><span>
</span><span id="line-1002"></span><span>
</span><span id="line-1003"></span><span>    </span><span id="local-6989586621679314261"><span class="annot"><span class="annottext">gobuf :: SPEC -&gt; s -&gt; List a -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314261"><span class="hs-identifier hs-var hs-var">gobuf</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314247"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314247"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679314246"><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314246"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-type">List</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679314245"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314245"><span class="hs-identifier hs-var">pst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314276"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314247"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314246"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314245"><span class="hs-identifier hs-var">pst</span></a></span><span>
</span><span id="line-1004"></span><span>    </span><span class="annot"><a href="#local-6989586621679314261"><span class="hs-identifier hs-var">gobuf</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314244"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314244"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679314243"><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314243"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-type">List</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314242"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314242"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679314241"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314241"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679314240"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314240"><span class="hs-identifier hs-var">pst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1005"></span><span>        </span><span id="local-6989586621679314239"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314239"><span class="hs-identifier hs-var">pRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314281"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314240"><span class="hs-identifier hs-var">pst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314242"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1006"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314239"><span class="hs-identifier hs-var">pRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1007"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314238"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314238"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1008"></span><span>                </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314261"><span class="hs-identifier hs-var">gobuf</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314244"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314241"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314238"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1009"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span id="local-6989586621679314237"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314237"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314236"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314236"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1010"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314237"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314242"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314243"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1011"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314235"><span class="annot"><span class="annottext">src0 :: [a]
</span><a href="#local-6989586621679314235"><span class="hs-identifier hs-var hs-var">src0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314237"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314242"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314243"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1012"></span><span>                    </span><span id="local-6989586621679314234"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314234"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314235"><span class="hs-identifier hs-var">src0</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314241"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1013"></span><span>                </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314261"><span class="hs-identifier hs-var">gobuf</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314244"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314234"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314236"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1014"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314233"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314233"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1015"></span><span>                </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314261"><span class="hs-identifier hs-var">gobuf</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314244"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314242"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314243"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314241"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314233"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1016"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span id="local-6989586621679314232"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314232"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314231"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314231"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1017"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314232"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314242"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314243"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1018"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314230"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314230"><span class="hs-identifier hs-var">src0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314229"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314229"><span class="hs-identifier hs-var">buf1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314232"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314242"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">List a -&gt; [a]
forall a. List a -&gt; [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#getList"><span class="hs-identifier hs-var hs-var">getList</span></a></span><span> </span><span class="annot"><span class="annottext">List a
</span><a href="#local-6989586621679314243"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1019"></span><span>                    </span><span id="local-6989586621679314228"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314228"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314230"><span class="hs-identifier hs-var">src0</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314241"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1020"></span><span>                </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; List a -&gt; List a -&gt; s -&gt; m b
</span><a href="#local-6989586621679314261"><span class="hs-identifier hs-var">gobuf</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314244"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314229"><span class="hs-identifier hs-var">buf1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; List a
forall a. [a] -&gt; List a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#List"><span class="hs-identifier hs-var">List</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314228"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314231"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1021"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Done"><span class="hs-identifier hs-type">PR.Done</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314227"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314227"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314227"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1022"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Error"><span class="hs-identifier hs-type">PR.Error</span></a></span><span> </span><span id="local-6989586621679314226"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314226"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ParseError -&gt; m b
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(ParseError -&gt; m b) -&gt; ParseError -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ParseError
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314226"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1023"></span><span>
</span><span id="line-1024"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1025"></span><span class="hs-comment">-- Repeated parsing</span><span>
</span><span id="line-1026"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1027"></span><span>
</span><span id="line-1028"></span><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">type</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksState"><span class="hs-pragma hs-type">ParseChunksState</span></a></span><span> </span><span class="annot"><span class="hs-pragma hs-type">Fuse</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1029"></span><span class="hs-keyword">data</span><span> </span><span id="ParseChunksState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksState"><span class="hs-identifier hs-var">ParseChunksState</span></a></span></span><span> </span><span id="local-6989586621679315868"><span class="annot"><a href="#local-6989586621679315868"><span class="hs-identifier hs-type">x</span></a></span></span><span> </span><span id="local-6989586621679315870"><span class="annot"><a href="#local-6989586621679315870"><span class="hs-identifier hs-type">inpBuf</span></a></span></span><span> </span><span id="local-6989586621679315869"><span class="annot"><a href="#local-6989586621679315869"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679315867"><span class="annot"><a href="#local-6989586621679315867"><span class="hs-identifier hs-type">pst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1030"></span><span>      </span><span id="ParseChunksInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInit"><span class="hs-identifier hs-var">ParseChunksInit</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315870"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315869"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-1031"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ParseChunksInitLeftOver"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInitLeftOver"><span class="hs-identifier hs-var">ParseChunksInitLeftOver</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315870"><span class="hs-identifier hs-type">inpBuf</span></a></span><span>
</span><span id="line-1032"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ParseChunksStream"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksStream"><span class="hs-identifier hs-var">ParseChunksStream</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315869"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315870"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679315867"><span class="hs-identifier hs-type">pst</span></a></span><span>
</span><span id="line-1033"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ParseChunksBuf"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-var">ParseChunksBuf</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315870"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315869"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315870"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679315867"><span class="hs-identifier hs-type">pst</span></a></span><span>
</span><span id="line-1034"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ParseChunksYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksYield"><span class="hs-identifier hs-var">ParseChunksYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315868"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksState"><span class="hs-identifier hs-type">ParseChunksState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315868"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315870"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315869"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315867"><span class="hs-identifier hs-type">pst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1035"></span><span>
</span><span id="line-1036"></span><span class="hs-pragma">{-# INLINE_NORMAL parseMany #-}</span><span>
</span><span id="line-1037"></span><span id="local-6989586621679314217"><span id="local-6989586621679314218"><span id="local-6989586621679314219"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#parseMany"><span class="hs-identifier hs-type">parseMany</span></a></span><span>
</span><span id="line-1038"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679314219"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1039"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-type">PRD.Parser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314219"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314218"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314217"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-1040"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314219"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314218"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1041"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314219"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314217"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1042"></span><span id="parseMany"><span class="annot"><span class="annottext">parseMany :: Parser m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#parseMany"><span class="hs-identifier hs-var hs-var">parseMany</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-type">PRD.Parser</span></a></span><span> </span><span id="local-6989586621679314215"><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314215"><span class="hs-identifier hs-var">pstep</span></a></span></span><span> </span><span id="local-6989586621679314214"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314214"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679314213"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314213"><span class="hs-identifier hs-var">extract</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314212"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314212"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314211"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314211"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1043"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; ParseChunksState b [a] s s
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; ParseChunksState b [a] s s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; ParseChunksState b [a] s s
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; ParseChunksState b [a] s s
-&gt; m (Step (ParseChunksState b [a] s s) b)
</span><a href="#local-6989586621679314210"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInit"><span class="hs-identifier hs-var">ParseChunksInit</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314211"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1044"></span><span>
</span><span id="line-1045"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1046"></span><span>
</span><span id="line-1047"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE stepOuter #-}</span><span>
</span><span id="line-1048"></span><span>    </span><span class="hs-comment">-- Buffer is empty, get the first element from the stream, initialize the</span><span>
</span><span id="line-1049"></span><span>    </span><span class="hs-comment">-- fold and then go to stream processing loop.</span><span>
</span><span id="line-1050"></span><span>    </span><span id="local-6989586621679314210"><span class="annot"><span class="annottext">stepOuter :: State Stream m a
-&gt; ParseChunksState b [a] s s
-&gt; m (Step (ParseChunksState b [a] s s) b)
</span><a href="#local-6989586621679314210"><span class="hs-identifier hs-var hs-var">stepOuter</span></a></span></span><span> </span><span id="local-6989586621679314209"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314209"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInit"><span class="hs-identifier hs-type">ParseChunksInit</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679314208"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314208"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1051"></span><span>        </span><span id="local-6989586621679314207"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314207"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314212"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314209"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314208"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1052"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314207"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1053"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314206"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314206"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314205"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314205"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314214"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; (s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; s
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; (s -&gt; ParseChunksState b [a] s s)
-&gt; s
-&gt; Step (ParseChunksState b [a] s s) b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-var">ParseChunksBuf</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314206"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314205"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1054"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314204"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314204"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInit"><span class="hs-identifier hs-var">ParseChunksInit</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314204"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1055"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1056"></span><span>
</span><span id="line-1057"></span><span>    </span><span class="hs-comment">-- Buffer is not empty, go to buffered processing loop</span><span>
</span><span id="line-1058"></span><span>    </span><span class="annot"><a href="#local-6989586621679314210"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInit"><span class="hs-identifier hs-type">ParseChunksInit</span></a></span><span> </span><span id="local-6989586621679314203"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314203"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621679314202"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314202"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1059"></span><span>        </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314214"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; (s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; s
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; (s -&gt; ParseChunksState b [a] s s)
-&gt; s
-&gt; Step (ParseChunksState b [a] s s) b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-var">ParseChunksBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314203"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314202"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1060"></span><span>
</span><span id="line-1061"></span><span>    </span><span class="hs-comment">-- XXX we just discard any leftover input at the end</span><span>
</span><span id="line-1062"></span><span>    </span><span class="annot"><a href="#local-6989586621679314210"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInitLeftOver"><span class="hs-identifier hs-type">ParseChunksInitLeftOver</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1063"></span><span>
</span><span id="line-1064"></span><span>    </span><span class="hs-comment">-- Buffer is empty, process elements from the stream</span><span>
</span><span id="line-1065"></span><span>    </span><span class="annot"><a href="#local-6989586621679314210"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679314201"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314201"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksStream"><span class="hs-identifier hs-type">ParseChunksStream</span></a></span><span> </span><span id="local-6989586621679314200"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314200"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679314199"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span id="local-6989586621679314198"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314198"><span class="hs-identifier hs-var">pst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1066"></span><span>        </span><span id="local-6989586621679314197"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314197"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314212"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314201"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314200"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1067"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314197"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1068"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314196"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314196"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314195"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314195"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1069"></span><span>                </span><span id="local-6989586621679314194"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314194"><span class="hs-identifier hs-var">pRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314215"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314198"><span class="hs-identifier hs-var">pst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314196"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1070"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314194"><span class="hs-identifier hs-var">pRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1071"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314193"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314193"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1072"></span><span>                        </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksStream"><span class="hs-identifier hs-var">ParseChunksStream</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314195"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314193"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1073"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span id="local-6989586621679314192"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314192"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314191"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314191"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1074"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314192"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314196"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1075"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314190"><span class="annot"><span class="annottext">src0 :: [a]
</span><a href="#local-6989586621679314190"><span class="hs-identifier hs-var hs-var">src0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314192"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314196"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1076"></span><span>                            </span><span id="local-6989586621679314189"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314189"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314190"><span class="hs-identifier hs-var">src0</span></a></span><span>
</span><span id="line-1077"></span><span>                        </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-var">ParseChunksBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314189"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314195"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314191"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1078"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314188"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314188"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1079"></span><span>                        </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksStream"><span class="hs-identifier hs-var">ParseChunksStream</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314195"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314196"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314188"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1080"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span id="local-6989586621679314187"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314187"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314186"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314186"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1081"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314187"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314196"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1082"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314185"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314185"><span class="hs-identifier hs-var">src0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314184"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314184"><span class="hs-identifier hs-var">buf1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314187"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314196"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1083"></span><span>                            </span><span id="local-6989586621679314183"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314183"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314185"><span class="hs-identifier hs-var">src0</span></a></span><span>
</span><span id="line-1084"></span><span>                        </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-var">ParseChunksBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314183"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314195"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314184"><span class="hs-identifier hs-var">buf1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314186"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1085"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Done"><span class="hs-identifier hs-type">PR.Done</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314182"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314182"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1086"></span><span>                        </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1087"></span><span>                            </span><span class="annot"><span class="annottext">b -&gt; ParseChunksState b [a] s s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
x
-&gt; ParseChunksState x inpBuf st pst
-&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksYield"><span class="hs-identifier hs-var">ParseChunksYield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314182"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInit"><span class="hs-identifier hs-var">ParseChunksInit</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314195"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1088"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Done"><span class="hs-identifier hs-type">PR.Done</span></a></span><span> </span><span id="local-6989586621679314181"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314181"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314180"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314180"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1089"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314181"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314196"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1090"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314179"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314179"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314181"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314196"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1091"></span><span>                        </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1092"></span><span>                            </span><span class="annot"><span class="annottext">b -&gt; ParseChunksState b [a] s s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
x
-&gt; ParseChunksState x inpBuf st pst
-&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksYield"><span class="hs-identifier hs-var">ParseChunksYield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314180"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInit"><span class="hs-identifier hs-var">ParseChunksInit</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314179"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314195"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1093"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Error"><span class="hs-identifier hs-type">PR.Error</span></a></span><span> </span><span id="local-6989586621679314178"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314178"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ParseError -&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(ParseError -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; ParseError -&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ParseError
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314178"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1094"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314177"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314177"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksStream"><span class="hs-identifier hs-var">ParseChunksStream</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314177"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314198"><span class="hs-identifier hs-var">pst</span></a></span><span>
</span><span id="line-1095"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1096"></span><span>                </span><span id="local-6989586621679314176"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314176"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314213"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314198"><span class="hs-identifier hs-var">pst</span></a></span><span>
</span><span id="line-1097"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314175"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314175"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314199"><span class="hs-identifier hs-var">buf</span></a></span><span>
</span><span id="line-1098"></span><span>                </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1099"></span><span>                    </span><span class="annot"><span class="annottext">b -&gt; ParseChunksState b [a] s s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
x
-&gt; ParseChunksState x inpBuf st pst
-&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksYield"><span class="hs-identifier hs-var">ParseChunksYield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314176"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst. inpBuf -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInitLeftOver"><span class="hs-identifier hs-var">ParseChunksInitLeftOver</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314175"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1100"></span><span>
</span><span id="line-1101"></span><span>    </span><span class="hs-comment">-- go back to stream processing mode</span><span>
</span><span id="line-1102"></span><span>    </span><span class="annot"><a href="#local-6989586621679314210"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-type">ParseChunksBuf</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679314174"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314174"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679314173"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314173"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span id="local-6989586621679314172"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314172"><span class="hs-identifier hs-var">pst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1103"></span><span>        </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksStream"><span class="hs-identifier hs-var">ParseChunksStream</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314174"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314173"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314172"><span class="hs-identifier hs-var">pst</span></a></span><span>
</span><span id="line-1104"></span><span>
</span><span id="line-1105"></span><span>    </span><span class="hs-comment">-- buffered processing loop</span><span>
</span><span id="line-1106"></span><span>    </span><span class="annot"><a href="#local-6989586621679314210"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-type">ParseChunksBuf</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314171"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314171"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679314170"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314170"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679314169"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314169"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679314168"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314168"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span id="local-6989586621679314167"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314167"><span class="hs-identifier hs-var">pst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1107"></span><span>        </span><span id="local-6989586621679314166"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314166"><span class="hs-identifier hs-var">pRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314215"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314167"><span class="hs-identifier hs-var">pst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314171"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1108"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314166"><span class="hs-identifier hs-var">pRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1109"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314165"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314165"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1110"></span><span>                </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-var">ParseChunksBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314170"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314169"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314165"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1111"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span id="local-6989586621679314164"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314164"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314163"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314163"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1112"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314164"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314171"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314168"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1113"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314162"><span class="annot"><span class="annottext">src0 :: [a]
</span><a href="#local-6989586621679314162"><span class="hs-identifier hs-var hs-var">src0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314164"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314171"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314168"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1114"></span><span>                    </span><span id="local-6989586621679314161"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314161"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314162"><span class="hs-identifier hs-var">src0</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314170"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1115"></span><span>                </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-var">ParseChunksBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314161"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314169"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314163"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1116"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314160"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314160"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1117"></span><span>                </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-var">ParseChunksBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314170"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314169"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314171"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314168"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314160"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1118"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span id="local-6989586621679314159"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314159"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314158"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314158"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1119"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314159"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314171"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314168"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1120"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314157"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314157"><span class="hs-identifier hs-var">src0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314156"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314156"><span class="hs-identifier hs-var">buf1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314159"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314171"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314168"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1121"></span><span>                    </span><span id="local-6989586621679314155"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314155"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314157"><span class="hs-identifier hs-var">src0</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314170"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1122"></span><span>                </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; [a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; inpBuf -&gt; pst -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksBuf"><span class="hs-identifier hs-var">ParseChunksBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314155"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314169"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314156"><span class="hs-identifier hs-var">buf1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314158"><span class="hs-identifier hs-var">pst1</span></a></span><span>
</span><span id="line-1123"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Done"><span class="hs-identifier hs-type">PR.Done</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314154"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314154"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1124"></span><span>                </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; ParseChunksState b [a] s s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
x
-&gt; ParseChunksState x inpBuf st pst
-&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksYield"><span class="hs-identifier hs-var">ParseChunksYield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314154"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInit"><span class="hs-identifier hs-var">ParseChunksInit</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314170"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314169"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1125"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Done"><span class="hs-identifier hs-type">PR.Done</span></a></span><span> </span><span id="local-6989586621679314153"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314153"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314152"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314152"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1126"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314153"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314171"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314168"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1127"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314151"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314151"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314153"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314171"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314168"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314170"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1128"></span><span>                </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ParseChunksState b [a] s s -&gt; Step (ParseChunksState b [a] s s) b)
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; ParseChunksState b [a] s s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
x
-&gt; ParseChunksState x inpBuf st pst
-&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksYield"><span class="hs-identifier hs-var">ParseChunksYield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314152"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; ParseChunksState b [a] s s
forall x inpBuf st pst.
inpBuf -&gt; st -&gt; ParseChunksState x inpBuf st pst
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksInit"><span class="hs-identifier hs-var">ParseChunksInit</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314151"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314169"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1129"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Error"><span class="hs-identifier hs-type">PR.Error</span></a></span><span> </span><span id="local-6989586621679314150"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314150"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ParseError -&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(ParseError -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; ParseError -&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ParseError
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314150"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1130"></span><span>
</span><span id="line-1131"></span><span>    </span><span class="annot"><a href="#local-6989586621679314210"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ParseChunksYield"><span class="hs-identifier hs-type">ParseChunksYield</span></a></span><span> </span><span id="local-6989586621679314149"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314149"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679314148"><span class="annot"><span class="annottext">ParseChunksState b [a] s s
</span><a href="#local-6989586621679314148"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ParseChunksState b [a] s s) b
 -&gt; m (Step (ParseChunksState b [a] s s) b))
-&gt; Step (ParseChunksState b [a] s s) b
-&gt; m (Step (ParseChunksState b [a] s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b
-&gt; ParseChunksState b [a] s s
-&gt; Step (ParseChunksState b [a] s s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314149"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ParseChunksState b [a] s s
</span><a href="#local-6989586621679314148"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-1132"></span><span>
</span><span id="line-1133"></span><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">type</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseState"><span class="hs-pragma hs-type">ConcatParseState</span></a></span><span> </span><span class="annot"><span class="hs-pragma hs-type">Fuse</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1134"></span><span class="hs-keyword">data</span><span> </span><span id="ConcatParseState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseState"><span class="hs-identifier hs-var">ConcatParseState</span></a></span></span><span> </span><span id="local-6989586621679315856"><span class="annot"><a href="#local-6989586621679315856"><span class="hs-identifier hs-type">x</span></a></span></span><span> </span><span id="local-6989586621679315859"><span class="annot"><a href="#local-6989586621679315859"><span class="hs-identifier hs-type">inpBuf</span></a></span></span><span> </span><span id="local-6989586621679315858"><span class="annot"><a href="#local-6989586621679315858"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679315857"><span class="annot"><a href="#local-6989586621679315857"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1135"></span><span>      </span><span id="ConcatParseInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseInit"><span class="hs-identifier hs-var">ConcatParseInit</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315859"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315858"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315857"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-1136"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ConcatParseInitLeftOver"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseInitLeftOver"><span class="hs-identifier hs-var">ConcatParseInitLeftOver</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315859"><span class="hs-identifier hs-type">inpBuf</span></a></span><span>
</span><span id="line-1137"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ConcatParseStream"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseStream"><span class="hs-identifier hs-var">ConcatParseStream</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315858"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315859"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315857"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-1138"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ConcatParseBuf"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseBuf"><span class="hs-identifier hs-var">ConcatParseBuf</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315859"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315858"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315859"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315857"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-1139"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ConcatParseYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseYield"><span class="hs-identifier hs-var">ConcatParseYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315856"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseState"><span class="hs-identifier hs-type">ConcatParseState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315856"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315859"><span class="hs-identifier hs-type">inpBuf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315858"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315857"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1140"></span><span>
</span><span id="line-1141"></span><span class="hs-pragma">{-# INLINE_NORMAL parseIterate #-}</span><span>
</span><span id="line-1142"></span><span id="local-6989586621679314140"><span id="local-6989586621679314141"><span id="local-6989586621679314142"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#parseIterate"><span class="hs-identifier hs-type">parseIterate</span></a></span><span>
</span><span id="line-1143"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679314142"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1144"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314141"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-type">PRD.Parser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314142"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314140"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314141"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1145"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314141"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-1146"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314142"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314140"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1147"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314142"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314141"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1148"></span><span id="parseIterate"><span class="annot"><span class="annottext">parseIterate :: (b -&gt; Parser m a b) -&gt; b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#parseIterate"><span class="hs-identifier hs-var hs-var">parseIterate</span></a></span></span><span> </span><span id="local-6989586621679314139"><span class="annot"><span class="annottext">b -&gt; Parser m a b
</span><a href="#local-6989586621679314139"><span class="hs-identifier hs-var">func</span></a></span></span><span> </span><span id="local-6989586621679314138"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314138"><span class="hs-identifier hs-var">seed</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314137"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314137"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314136"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314136"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1149"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; ConcatParseState b [a] s (Parser m a b)
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; ConcatParseState b [a] s (Parser m a b) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
</span><a href="#local-6989586621679314135"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; Parser m a b -&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
inpBuf -&gt; st -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseInit"><span class="hs-identifier hs-var">ConcatParseInit</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314136"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Parser m a b
</span><a href="#local-6989586621679314139"><span class="hs-identifier hs-var">func</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314138"><span class="hs-identifier hs-var">seed</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1150"></span><span>
</span><span id="line-1151"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1152"></span><span>
</span><span id="line-1153"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE stepOuter #-}</span><span>
</span><span id="line-1154"></span><span>    </span><span class="hs-comment">-- Buffer is empty, go to stream processing loop</span><span>
</span><span id="line-1155"></span><span>    </span><span id="local-6989586621679314135"><span class="annot"><span class="annottext">stepOuter :: State Stream m a
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
</span><a href="#local-6989586621679314135"><span class="hs-identifier hs-var hs-var">stepOuter</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseInit"><span class="hs-identifier hs-type">ConcatParseInit</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679314134"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314134"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-type">PRD.Parser</span></a></span><span> </span><span id="local-6989586621679314133"><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314133"><span class="hs-identifier hs-var">pstep</span></a></span></span><span> </span><span id="local-6989586621679314132"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314132"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679314131"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314131"><span class="hs-identifier hs-var">extract</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1156"></span><span>        </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314132"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679314130"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314130"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; [a] -&gt; Parser m a b -&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseStream"><span class="hs-identifier hs-var">ConcatParseStream</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314134"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1157"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-var">PRD.Parser</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314133"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314130"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314131"><span class="hs-identifier hs-var">extract</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1158"></span><span>
</span><span id="line-1159"></span><span>    </span><span class="hs-comment">-- Buffer is not empty, go to buffered processing loop</span><span>
</span><span id="line-1160"></span><span>    </span><span class="annot"><a href="#local-6989586621679314135"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseInit"><span class="hs-identifier hs-type">ConcatParseInit</span></a></span><span> </span><span id="local-6989586621679314129"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314129"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621679314128"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314128"><span class="hs-identifier hs-var">st</span></a></span></span><span>
</span><span id="line-1161"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-type">PRD.Parser</span></a></span><span> </span><span id="local-6989586621679314127"><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314127"><span class="hs-identifier hs-var">pstep</span></a></span></span><span> </span><span id="local-6989586621679314126"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314126"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679314125"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314125"><span class="hs-identifier hs-var">extract</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1162"></span><span>        </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314126"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679314124"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314124"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a]
-&gt; s
-&gt; [a]
-&gt; Parser m a b
-&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
inpBuf -&gt; st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseBuf"><span class="hs-identifier hs-var">ConcatParseBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314129"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314128"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1163"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-var">PRD.Parser</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314127"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314124"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314125"><span class="hs-identifier hs-var">extract</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1164"></span><span>
</span><span id="line-1165"></span><span>    </span><span class="hs-comment">-- XXX we just discard any leftover input at the end</span><span>
</span><span id="line-1166"></span><span>    </span><span class="annot"><a href="#local-6989586621679314135"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseInitLeftOver"><span class="hs-identifier hs-type">ConcatParseInitLeftOver</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1167"></span><span>
</span><span id="line-1168"></span><span>    </span><span class="hs-comment">-- Buffer is empty process elements from the stream</span><span>
</span><span id="line-1169"></span><span>    </span><span class="annot"><a href="#local-6989586621679314135"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679314123"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314123"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseStream"><span class="hs-identifier hs-type">ConcatParseStream</span></a></span><span> </span><span id="local-6989586621679314122"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314122"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679314121"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314121"><span class="hs-identifier hs-var">buf</span></a></span></span><span>
</span><span id="line-1170"></span><span>                    </span><span id="local-6989586621679314120"><span class="annot"><span class="annottext">p :: Parser m a b
</span><a href="#local-6989586621679314120"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-type">PRD.Parser</span></a></span><span> </span><span id="local-6989586621679314119"><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314119"><span class="hs-identifier hs-var">pstep</span></a></span></span><span> </span><span id="local-6989586621679314118"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314118"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679314117"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314117"><span class="hs-identifier hs-var">extract</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1171"></span><span>        </span><span id="local-6989586621679314116"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314116"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314137"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679314123"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314122"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1172"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314116"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1173"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314115"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314115"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314114"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314114"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1174"></span><span>                </span><span id="local-6989586621679314113"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314113"><span class="hs-identifier hs-var">pst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314118"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1175"></span><span>                </span><span id="local-6989586621679314112"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314112"><span class="hs-identifier hs-var">pRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314119"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314113"><span class="hs-identifier hs-var">pst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314115"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1176"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314112"><span class="hs-identifier hs-var">pRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1177"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314111"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314111"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1178"></span><span>                        </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; [a] -&gt; Parser m a b -&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseStream"><span class="hs-identifier hs-var">ConcatParseStream</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314114"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1179"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-var">PRD.Parser</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314119"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314111"><span class="hs-identifier hs-var">pst1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314117"><span class="hs-identifier hs-var">extract</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1180"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span id="local-6989586621679314110"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314110"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314109"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314109"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1181"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314110"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314115"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314121"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1182"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314108"><span class="annot"><span class="annottext">src0 :: [a]
</span><a href="#local-6989586621679314108"><span class="hs-identifier hs-var hs-var">src0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314110"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314115"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314121"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1183"></span><span>                            </span><span id="local-6989586621679314107"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314107"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314108"><span class="hs-identifier hs-var">src0</span></a></span><span>
</span><span id="line-1184"></span><span>                        </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a]
-&gt; s
-&gt; [a]
-&gt; Parser m a b
-&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
inpBuf -&gt; st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseBuf"><span class="hs-identifier hs-var">ConcatParseBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314107"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314114"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1185"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-var">PRD.Parser</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314119"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314109"><span class="hs-identifier hs-var">pst1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314117"><span class="hs-identifier hs-var">extract</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1186"></span><span>                    </span><span class="hs-comment">-- PR.Continue 0 pst1 -&gt;</span><span>
</span><span id="line-1187"></span><span>                    </span><span class="hs-comment">--     return $ Skip $ ConcatParseStream s (x:buf) pst1</span><span>
</span><span id="line-1188"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span id="local-6989586621679314106"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314106"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314105"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314105"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1189"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314106"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314115"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314121"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1190"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314104"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314104"><span class="hs-identifier hs-var">src0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314103"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314103"><span class="hs-identifier hs-var">buf1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314106"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314115"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314121"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1191"></span><span>                            </span><span id="local-6989586621679314102"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314102"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314104"><span class="hs-identifier hs-var">src0</span></a></span><span>
</span><span id="line-1192"></span><span>                        </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a]
-&gt; s
-&gt; [a]
-&gt; Parser m a b
-&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
inpBuf -&gt; st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseBuf"><span class="hs-identifier hs-var">ConcatParseBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314102"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314114"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314103"><span class="hs-identifier hs-var">buf1</span></a></span><span>
</span><span id="line-1193"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-var">PRD.Parser</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314119"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314105"><span class="hs-identifier hs-var">pst1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314117"><span class="hs-identifier hs-var">extract</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1194"></span><span>                    </span><span class="hs-comment">-- XXX Specialize for Stop 0 common case?</span><span>
</span><span id="line-1195"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Done"><span class="hs-identifier hs-type">PR.Done</span></a></span><span> </span><span id="local-6989586621679314101"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314101"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314100"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314100"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1196"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314101"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314115"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314121"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1197"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314099"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314099"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314101"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314115"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314121"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1198"></span><span>                        </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1199"></span><span>                            </span><span class="annot"><span class="annottext">b
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
x
-&gt; ConcatParseState x inpBuf st p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseYield"><span class="hs-identifier hs-var">ConcatParseYield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314100"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; Parser m a b -&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
inpBuf -&gt; st -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseInit"><span class="hs-identifier hs-var">ConcatParseInit</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314099"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314114"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Parser m a b
</span><a href="#local-6989586621679314139"><span class="hs-identifier hs-var">func</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314100"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1200"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Error"><span class="hs-identifier hs-type">PR.Error</span></a></span><span> </span><span id="local-6989586621679314098"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314098"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ParseError -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(ParseError
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; ParseError
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ParseError
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314098"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1201"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314097"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314097"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; [a] -&gt; Parser m a b -&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseStream"><span class="hs-identifier hs-var">ConcatParseStream</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314097"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314121"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">Parser m a b
</span><a href="#local-6989586621679314120"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1202"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1203"></span><span>                </span><span id="local-6989586621679314096"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314096"><span class="hs-identifier hs-var">pst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314118"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1204"></span><span>                </span><span id="local-6989586621679314095"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314095"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314117"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314096"><span class="hs-identifier hs-var">pst</span></a></span><span>
</span><span id="line-1205"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314094"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314094"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314121"><span class="hs-identifier hs-var">buf</span></a></span><span>
</span><span id="line-1206"></span><span>                </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1207"></span><span>                    </span><span class="annot"><span class="annottext">b
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
x
-&gt; ConcatParseState x inpBuf st p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseYield"><span class="hs-identifier hs-var">ConcatParseYield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314095"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p. inpBuf -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseInitLeftOver"><span class="hs-identifier hs-var">ConcatParseInitLeftOver</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314094"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1208"></span><span>
</span><span id="line-1209"></span><span>    </span><span class="hs-comment">-- go back to stream processing mode</span><span>
</span><span id="line-1210"></span><span>    </span><span class="annot"><a href="#local-6989586621679314135"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseBuf"><span class="hs-identifier hs-type">ConcatParseBuf</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679314093"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314093"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679314092"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314092"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span id="local-6989586621679314091"><span class="annot"><span class="annottext">Parser m a b
</span><a href="#local-6989586621679314091"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1211"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; [a] -&gt; Parser m a b -&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseStream"><span class="hs-identifier hs-var">ConcatParseStream</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314093"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314092"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">Parser m a b
</span><a href="#local-6989586621679314091"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1212"></span><span>
</span><span id="line-1213"></span><span>    </span><span class="hs-comment">-- buffered processing loop</span><span>
</span><span id="line-1214"></span><span>    </span><span class="annot"><a href="#local-6989586621679314135"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseBuf"><span class="hs-identifier hs-type">ConcatParseBuf</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314090"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314090"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679314089"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314089"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679314088"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314088"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679314087"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314087"><span class="hs-identifier hs-var">buf</span></a></span></span><span>
</span><span id="line-1215"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-type">PRD.Parser</span></a></span><span> </span><span id="local-6989586621679314086"><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314086"><span class="hs-identifier hs-var">pstep</span></a></span></span><span> </span><span id="local-6989586621679314085"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314085"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679314084"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314084"><span class="hs-identifier hs-var">extract</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1216"></span><span>        </span><span id="local-6989586621679314083"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314083"><span class="hs-identifier hs-var">pst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679314085"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1217"></span><span>        </span><span id="local-6989586621679314082"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314082"><span class="hs-identifier hs-var">pRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314086"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314083"><span class="hs-identifier hs-var">pst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314090"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1218"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679314082"><span class="hs-identifier hs-var">pRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1219"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679314081"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314081"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1220"></span><span>                </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a]
-&gt; s
-&gt; [a]
-&gt; Parser m a b
-&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
inpBuf -&gt; st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseBuf"><span class="hs-identifier hs-var">ConcatParseBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314089"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314088"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1221"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-var">PRD.Parser</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314086"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314081"><span class="hs-identifier hs-var">pst1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314084"><span class="hs-identifier hs-var">extract</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1222"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Partial"><span class="hs-identifier hs-type">PR.Partial</span></a></span><span> </span><span id="local-6989586621679314080"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314080"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314079"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314079"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1223"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314080"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314090"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314087"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1224"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314078"><span class="annot"><span class="annottext">src0 :: [a]
</span><a href="#local-6989586621679314078"><span class="hs-identifier hs-var hs-var">src0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314080"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314090"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314087"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1225"></span><span>                    </span><span id="local-6989586621679314077"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314077"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314078"><span class="hs-identifier hs-var">src0</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314089"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1226"></span><span>                </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a]
-&gt; s
-&gt; [a]
-&gt; Parser m a b
-&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
inpBuf -&gt; st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseBuf"><span class="hs-identifier hs-var">ConcatParseBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314077"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314088"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1227"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-var">PRD.Parser</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314086"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314079"><span class="hs-identifier hs-var">pst1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314084"><span class="hs-identifier hs-var">extract</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1228"></span><span>         </span><span class="hs-comment">-- PR.Continue 0 pst1 -&gt; return $ Skip $ ConcatParseBuf xs s (x:buf) pst1</span><span>
</span><span id="line-1229"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Continue"><span class="hs-identifier hs-type">PR.Continue</span></a></span><span> </span><span id="local-6989586621679314076"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314076"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314075"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314075"><span class="hs-identifier hs-var">pst1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1230"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314076"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314090"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314087"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1231"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679314074"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314074"><span class="hs-identifier hs-var">src0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679314073"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314073"><span class="hs-identifier hs-var">buf1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314076"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314090"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314087"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1232"></span><span>                    </span><span id="local-6989586621679314072"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314072"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314074"><span class="hs-identifier hs-var">src0</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314089"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1233"></span><span>                </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a]
-&gt; s
-&gt; [a]
-&gt; Parser m a b
-&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
inpBuf -&gt; st -&gt; inpBuf -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseBuf"><span class="hs-identifier hs-var">ConcatParseBuf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314072"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314088"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314073"><span class="hs-identifier hs-var">buf1</span></a></span><span>
</span><span id="line-1234"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b)) -&gt; m s -&gt; (s -&gt; m b) -&gt; Parser m a b
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Parser"><span class="hs-identifier hs-var">PRD.Parser</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m (Step s b)
</span><a href="#local-6989586621679314086"><span class="hs-identifier hs-var">pstep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314075"><span class="hs-identifier hs-var">pst1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679314084"><span class="hs-identifier hs-var">extract</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1235"></span><span>            </span><span class="hs-comment">-- XXX Specialize for Stop 0 common case?</span><span>
</span><span id="line-1236"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Done"><span class="hs-identifier hs-type">PR.Done</span></a></span><span> </span><span id="local-6989586621679314071"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314071"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679314070"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314070"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1237"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314071"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314090"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314087"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1238"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679314069"><span class="annot"><span class="annottext">src :: [a]
</span><a href="#local-6989586621679314069"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [a]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">Prelude.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679314071"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314090"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314087"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314089"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1239"></span><span>                </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatParseState b [a] s (Parser m a b)
 -&gt; Step (ConcatParseState b [a] s (Parser m a b)) b)
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
x
-&gt; ConcatParseState x inpBuf st p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseYield"><span class="hs-identifier hs-var">ConcatParseYield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314070"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1240"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; s -&gt; Parser m a b -&gt; ConcatParseState b [a] s (Parser m a b)
forall x inpBuf st p.
inpBuf -&gt; st -&gt; p -&gt; ConcatParseState x inpBuf st p
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseInit"><span class="hs-identifier hs-var">ConcatParseInit</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679314069"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314088"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Parser m a b
</span><a href="#local-6989586621679314139"><span class="hs-identifier hs-var">func</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314070"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1241"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#Error"><span class="hs-identifier hs-type">PR.Error</span></a></span><span> </span><span id="local-6989586621679314068"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314068"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ParseError -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(ParseError
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; ParseError
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ParseError
</span><a href="Streamly.Internal.Data.Parser.ParserD.Types.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679314068"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1242"></span><span>
</span><span id="line-1243"></span><span>    </span><span class="annot"><a href="#local-6989586621679314135"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatParseYield"><span class="hs-identifier hs-type">ConcatParseYield</span></a></span><span> </span><span id="local-6989586621679314067"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314067"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679314066"><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
</span><a href="#local-6989586621679314066"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatParseState b [a] s (Parser m a b)) b
 -&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b))
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
-&gt; m (Step (ConcatParseState b [a] s (Parser m a b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b
-&gt; ConcatParseState b [a] s (Parser m a b)
-&gt; Step (ConcatParseState b [a] s (Parser m a b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679314067"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ConcatParseState b [a] s (Parser m a b)
</span><a href="#local-6989586621679314066"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-1244"></span><span>
</span><span id="line-1245"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1246"></span><span class="hs-comment">-- Specialized Folds</span><span>
</span><span id="line-1247"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1248"></span><span>
</span><span id="line-1249"></span><span class="hs-comment">-- | Run a streaming composition, discard the results.</span><span>
</span><span id="line-1250"></span><span class="hs-pragma">{-# INLINE_LATE drain #-}</span><span>
</span><span id="line-1251"></span><span id="local-6989586621679315625"><span id="local-6989586621679315626"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#drain"><span class="hs-identifier hs-type">drain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315626"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315626"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315625"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315626"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1252"></span><span class="hs-comment">-- drain = foldrM (\_ xs -&gt; xs) (return ())</span><span>
</span><span id="line-1253"></span><span id="drain"><span class="annot"><span class="annottext">drain :: Stream m a -&gt; m ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#drain"><span class="hs-identifier hs-var hs-var">drain</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314065"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314065"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314064"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314064"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; m ()
</span><a href="#local-6989586621679314063"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314064"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1254"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1255"></span><span>    </span><span id="local-6989586621679314063"><span class="annot"><span class="annottext">go :: SPEC -&gt; s -&gt; m ()
</span><a href="#local-6989586621679314063"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314062"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314062"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1256"></span><span>        </span><span id="local-6989586621679314061"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314061"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314065"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314062"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1257"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314061"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1258"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314060"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314060"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; m ()
</span><a href="#local-6989586621679314063"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314060"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1259"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314059"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314059"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; m ()
</span><a href="#local-6989586621679314063"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314059"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1260"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1261"></span><span>
</span><span id="line-1262"></span><span class="hs-pragma">{-# INLINE_NORMAL null #-}</span><span>
</span><span id="line-1263"></span><span id="local-6989586621679314057"><span id="local-6989586621679314058"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#null"><span class="hs-identifier hs-type">null</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314058"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314058"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314057"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314058"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-1264"></span><span id="null"><span class="annot"><span class="annottext">null :: Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#null"><span class="hs-identifier hs-var hs-var">null</span></a></span></span><span> </span><span id="local-6989586621679314056"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314056"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m Bool -&gt; m Bool) -&gt; m Bool -&gt; Stream m a -&gt; m Bool
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldrM"><span class="hs-identifier hs-var">foldrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">m Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314056"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1265"></span><span>
</span><span id="line-1266"></span><span class="hs-pragma">{-# INLINE_NORMAL head #-}</span><span>
</span><span id="line-1267"></span><span id="local-6989586621679314054"><span id="local-6989586621679314055"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#head"><span class="hs-identifier hs-type">head</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314055"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314055"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314054"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314055"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679314054"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1268"></span><span id="head"><span class="annot"><span class="annottext">head :: Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#head"><span class="hs-identifier hs-var hs-var">head</span></a></span></span><span> </span><span id="local-6989586621679314053"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314053"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m (Maybe a) -&gt; m (Maybe a))
-&gt; m (Maybe a) -&gt; Stream m a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldrM"><span class="hs-identifier hs-var">foldrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679314052"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314052"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">m (Maybe a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314052"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314053"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1269"></span><span>
</span><span id="line-1270"></span><span class="hs-pragma">{-# INLINE_NORMAL headElse #-}</span><span>
</span><span id="line-1271"></span><span id="local-6989586621679314050"><span id="local-6989586621679314051"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#headElse"><span class="hs-identifier hs-type">headElse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314050"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314050"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314050"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1272"></span><span id="headElse"><span class="annot"><span class="annottext">headElse :: a -&gt; Stream m a -&gt; m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#headElse"><span class="hs-identifier hs-var hs-var">headElse</span></a></span></span><span> </span><span id="local-6989586621679314049"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314049"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679314048"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314048"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m a -&gt; m a) -&gt; m a -&gt; Stream m a -&gt; m a
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldrM"><span class="hs-identifier hs-var">foldrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679314047"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314047"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314047"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314049"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314048"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1273"></span><span>
</span><span id="line-1274"></span><span class="hs-comment">-- Does not fuse, has the same performance as the StreamK version.</span><span>
</span><span id="line-1275"></span><span class="hs-pragma">{-# INLINE_NORMAL tail #-}</span><span>
</span><span id="line-1276"></span><span id="local-6989586621679314045"><span id="local-6989586621679314046"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tail"><span class="hs-identifier hs-type">tail</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314046"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314046"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314045"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314046"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314046"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314045"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1277"></span><span id="tail"><span class="annot"><span class="annottext">tail :: Stream m a -&gt; m (Maybe (Stream m a))
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#tail"><span class="hs-identifier hs-var hs-var">tail</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-type">UnStream</span></a></span><span> </span><span id="local-6989586621679314044"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314044"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314043"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314043"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679314042"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314043"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1278"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1279"></span><span>    </span><span id="local-6989586621679314042"><span class="annot"><span class="annottext">go :: s -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679314042"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679314041"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314041"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1280"></span><span>        </span><span id="local-6989586621679314040"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314040"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314044"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314041"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1281"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314040"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1282"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314039"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314039"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a) -&gt; m (Maybe (Stream m a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Maybe (Stream m a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; Maybe (Stream m a))
-&gt; Stream m a -&gt; Maybe (Stream m a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314044"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314039"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1283"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679314038"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314038"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679314042"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314038"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1284"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a) -&gt; m (Maybe (Stream m a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1285"></span><span>
</span><span id="line-1286"></span><span class="hs-comment">-- XXX will it fuse? need custom impl?</span><span>
</span><span id="line-1287"></span><span class="hs-pragma">{-# INLINE_NORMAL last #-}</span><span>
</span><span id="line-1288"></span><span id="local-6989586621679314036"><span id="local-6989586621679314037"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#last"><span class="hs-identifier hs-type">last</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314036"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679314036"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1289"></span><span id="last"><span class="annot"><span class="annottext">last :: Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#last"><span class="hs-identifier hs-var hs-var">last</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; a -&gt; Maybe a) -&gt; Maybe a -&gt; Stream m a -&gt; m (Maybe a)
forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679314035"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314035"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314035"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1290"></span><span>
</span><span id="line-1291"></span><span class="hs-pragma">{-# INLINE_NORMAL elem #-}</span><span>
</span><span id="line-1292"></span><span id="local-6989586621679315821"><span id="local-6989586621679315822"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#elem"><span class="hs-identifier hs-type">elem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315822"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679315821"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315821"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315822"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315821"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315822"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-1293"></span><span class="hs-comment">-- elem e m = foldrM (\x xs -&gt; if x == e then return True else xs) (return False) m</span><span>
</span><span id="line-1294"></span><span id="elem"><span class="annot"><span class="annottext">elem :: a -&gt; Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#elem"><span class="hs-identifier hs-var hs-var">elem</span></a></span></span><span> </span><span id="local-6989586621679314034"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314034"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314033"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314033"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314032"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314032"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s -&gt; m Bool
</span><a href="#local-6989586621679314031"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314032"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1295"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1296"></span><span>    </span><span id="local-6989586621679314031"><span class="annot"><span class="annottext">go :: s -&gt; m Bool
</span><a href="#local-6989586621679314031"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679314030"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314030"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1297"></span><span>        </span><span id="local-6989586621679314029"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314029"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314033"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314030"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1298"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314029"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1299"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314028"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314028"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314027"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314027"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-1300"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314028"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314034"><span class="hs-identifier hs-var">e</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1301"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m Bool
</span><a href="#local-6989586621679314031"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314027"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1302"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314026"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314026"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m Bool
</span><a href="#local-6989586621679314031"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314026"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1303"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1304"></span><span>
</span><span id="line-1305"></span><span class="hs-pragma">{-# INLINE_NORMAL notElem #-}</span><span>
</span><span id="line-1306"></span><span id="local-6989586621679314024"><span id="local-6989586621679314025"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#notElem"><span class="hs-identifier hs-type">notElem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314025"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679314024"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314024"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314025"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314024"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314025"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-1307"></span><span id="notElem"><span class="annot"><span class="annottext">notElem :: a -&gt; Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#notElem"><span class="hs-identifier hs-var hs-var">notElem</span></a></span></span><span> </span><span id="local-6989586621679314023"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314023"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679314022"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314022"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; m Bool -&gt; m Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m Bool
forall (m :: * -&gt; *) a.
(Monad m, Eq a) =&gt;
a -&gt; Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#elem"><span class="hs-identifier hs-var">elem</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314023"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679314022"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1308"></span><span>
</span><span id="line-1309"></span><span class="hs-pragma">{-# INLINE_NORMAL all #-}</span><span>
</span><span id="line-1310"></span><span id="local-6989586621679314019"><span id="local-6989586621679314020"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#all"><span class="hs-identifier hs-type">all</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314019"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314019"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-1311"></span><span class="hs-comment">-- all p m = foldrM (\x xs -&gt; if p x then xs else return False) (return True) m</span><span>
</span><span id="line-1312"></span><span id="all"><span class="annot"><span class="annottext">all :: (a -&gt; Bool) -&gt; Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#all"><span class="hs-identifier hs-var hs-var">all</span></a></span></span><span> </span><span id="local-6989586621679314018"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679314018"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314017"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314017"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314016"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314016"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s -&gt; m Bool
</span><a href="#local-6989586621679314015"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314016"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1313"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1314"></span><span>    </span><span id="local-6989586621679314015"><span class="annot"><span class="annottext">go :: s -&gt; m Bool
</span><a href="#local-6989586621679314015"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679314014"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314014"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1315"></span><span>        </span><span id="local-6989586621679314013"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314013"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314017"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314014"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1316"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314013"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1317"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314012"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314012"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314011"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314011"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-1318"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679314018"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314012"><span class="hs-identifier hs-var">x</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m Bool
</span><a href="#local-6989586621679314015"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314011"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1319"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1320"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679314010"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314010"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m Bool
</span><a href="#local-6989586621679314015"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314010"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1321"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1322"></span><span>
</span><span id="line-1323"></span><span class="hs-pragma">{-# INLINE_NORMAL any #-}</span><span>
</span><span id="line-1324"></span><span id="local-6989586621679314008"><span id="local-6989586621679314009"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#any"><span class="hs-identifier hs-type">any</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679314009"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679314008"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314009"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314008"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314009"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-1325"></span><span class="hs-comment">-- any p m = foldrM (\x xs -&gt; if p x then return True else xs) (return False) m</span><span>
</span><span id="line-1326"></span><span id="any"><span class="annot"><span class="annottext">any :: (a -&gt; Bool) -&gt; Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#any"><span class="hs-identifier hs-var hs-var">any</span></a></span></span><span> </span><span id="local-6989586621679314007"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679314007"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679314006"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314006"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679314005"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314005"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s -&gt; m Bool
</span><a href="#local-6989586621679314004"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314005"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1327"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1328"></span><span>    </span><span id="local-6989586621679314004"><span class="annot"><span class="annottext">go :: s -&gt; m Bool
</span><a href="#local-6989586621679314004"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679314003"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314003"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1329"></span><span>        </span><span id="local-6989586621679314002"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314002"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679314006"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314003"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1330"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679314002"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1331"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679314001"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314001"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679314000"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314000"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-1332"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679314007"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679314001"><span class="hs-identifier hs-var">x</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1333"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m Bool
</span><a href="#local-6989586621679314004"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679314000"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1334"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313999"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313999"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m Bool
</span><a href="#local-6989586621679314004"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313999"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1335"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1336"></span><span>
</span><span id="line-1337"></span><span class="hs-pragma">{-# INLINE_NORMAL maximum #-}</span><span>
</span><span id="line-1338"></span><span id="local-6989586621679313997"><span id="local-6989586621679313998"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#maximum"><span class="hs-identifier hs-type">maximum</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313998"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679313997"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313998"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313997"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313998"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679313997"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1339"></span><span id="maximum"><span class="annot"><span class="annottext">maximum :: Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#maximum"><span class="hs-identifier hs-var hs-var">maximum</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313996"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313996"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313995"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313995"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313994"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313995"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1340"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1341"></span><span>    </span><span id="local-6989586621679313994"><span class="annot"><span class="annottext">go :: Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313994"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621679313993"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313993"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1342"></span><span>        </span><span id="local-6989586621679313992"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313992"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313996"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313993"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1343"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313992"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1344"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313991"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313991"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313990"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313990"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313994"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313991"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313990"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1345"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679313989"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313989"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313994"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313989"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1346"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1347"></span><span>    </span><span class="annot"><a href="#local-6989586621679313994"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313988"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313988"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313987"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313987"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1348"></span><span>        </span><span id="local-6989586621679313986"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313986"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313996"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313987"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1349"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313986"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1350"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313985"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313985"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313984"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313984"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-1351"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313988"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313985"><span class="hs-identifier hs-var">x</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313994"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313985"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313984"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1352"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313994"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313988"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313984"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1353"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313983"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313983"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313994"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313988"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313983"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1354"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313988"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1355"></span><span>
</span><span id="line-1356"></span><span class="hs-pragma">{-# INLINE_NORMAL maximumBy #-}</span><span>
</span><span id="line-1357"></span><span id="local-6989586621679313981"><span id="local-6989586621679313982"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#maximumBy"><span class="hs-identifier hs-type">maximumBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313981"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313981"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ordering</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313981"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679313981"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1358"></span><span id="maximumBy"><span class="annot"><span class="annottext">maximumBy :: (a -&gt; a -&gt; Ordering) -&gt; Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#maximumBy"><span class="hs-identifier hs-var hs-var">maximumBy</span></a></span></span><span> </span><span id="local-6989586621679313980"><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
</span><a href="#local-6989586621679313980"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313979"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313979"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313978"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313978"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313977"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313978"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1359"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1360"></span><span>    </span><span id="local-6989586621679313977"><span class="annot"><span class="annottext">go :: Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313977"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621679313976"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313976"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1361"></span><span>        </span><span id="local-6989586621679313975"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313975"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313979"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313976"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1362"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313975"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1363"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313974"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313974"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313973"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313973"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313977"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313974"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313973"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1364"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679313972"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313972"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313977"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313972"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1365"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1366"></span><span>    </span><span class="annot"><a href="#local-6989586621679313977"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313971"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313971"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313970"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313970"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1367"></span><span>        </span><span id="local-6989586621679313969"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313969"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313979"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313970"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1368"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313969"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1369"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313968"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313968"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313967"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313967"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
</span><a href="#local-6989586621679313980"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313971"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313968"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1370"></span><span>                </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313977"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313971"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313967"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1371"></span><span>                </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313977"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313968"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313967"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1372"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313966"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313966"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313977"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313971"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313966"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1373"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313971"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1374"></span><span>
</span><span id="line-1375"></span><span class="hs-pragma">{-# INLINE_NORMAL minimum #-}</span><span>
</span><span id="line-1376"></span><span id="local-6989586621679313964"><span id="local-6989586621679313965"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#minimum"><span class="hs-identifier hs-type">minimum</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313965"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679313964"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313964"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679313964"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1377"></span><span id="minimum"><span class="annot"><span class="annottext">minimum :: Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#minimum"><span class="hs-identifier hs-var hs-var">minimum</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313963"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313963"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313962"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313962"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313961"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313962"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1378"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1379"></span><span>    </span><span id="local-6989586621679313961"><span class="annot"><span class="annottext">go :: Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313961"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621679313960"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313960"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1380"></span><span>        </span><span id="local-6989586621679313959"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313959"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313963"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313960"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1381"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313959"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1382"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313958"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313958"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313957"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313957"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313961"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313958"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313957"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1383"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679313956"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313956"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313961"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313956"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1384"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1385"></span><span>    </span><span class="annot"><a href="#local-6989586621679313961"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313955"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313955"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313954"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313954"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1386"></span><span>        </span><span id="local-6989586621679313953"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313953"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313963"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313954"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1387"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313953"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1388"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313952"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313952"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313951"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313951"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-1389"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313955"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313952"><span class="hs-identifier hs-var">x</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313961"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313955"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313951"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1390"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313961"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313952"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313951"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1391"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313950"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313950"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313961"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313955"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313950"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1392"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313955"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1393"></span><span>
</span><span id="line-1394"></span><span class="hs-pragma">{-# INLINE_NORMAL minimumBy #-}</span><span>
</span><span id="line-1395"></span><span id="local-6989586621679313948"><span id="local-6989586621679313949"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#minimumBy"><span class="hs-identifier hs-type">minimumBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313949"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313948"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313948"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ordering</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313949"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313948"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313949"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679313948"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1396"></span><span id="minimumBy"><span class="annot"><span class="annottext">minimumBy :: (a -&gt; a -&gt; Ordering) -&gt; Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#minimumBy"><span class="hs-identifier hs-var hs-var">minimumBy</span></a></span></span><span> </span><span id="local-6989586621679313947"><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
</span><a href="#local-6989586621679313947"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313946"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313946"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313945"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313945"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313944"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313945"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1397"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1398"></span><span>    </span><span id="local-6989586621679313944"><span class="annot"><span class="annottext">go :: Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313944"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621679313943"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313943"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1399"></span><span>        </span><span id="local-6989586621679313942"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313942"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313946"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313943"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1400"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313942"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1401"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313941"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313941"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313940"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313940"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313944"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313941"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313940"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1402"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679313939"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313939"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313944"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313939"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1403"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1404"></span><span>    </span><span class="annot"><a href="#local-6989586621679313944"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313938"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313938"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313937"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313937"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1405"></span><span>        </span><span id="local-6989586621679313936"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313936"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313946"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313937"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1406"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313936"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1407"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313935"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313935"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313934"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313934"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
</span><a href="#local-6989586621679313947"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313938"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313935"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1408"></span><span>                </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313944"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313935"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313934"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1409"></span><span>                </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313944"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313938"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313934"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1410"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313933"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313933"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313944"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313938"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313933"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1411"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313938"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1412"></span><span>
</span><span id="line-1413"></span><span class="hs-pragma">{-# INLINE_NORMAL (!!) #-}</span><span>
</span><span id="line-1414"></span><span id="local-6989586621679313931"><span id="local-6989586621679313932"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#%21%21"><span class="hs-operator hs-type">(!!)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313932"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313932"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313931"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313932"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679313931"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1415"></span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313930"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313930"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313929"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313929"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span id="%21%21"><span class="annot"><span class="annottext">!! :: Stream m a -&gt; Int -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#%21%21"><span class="hs-operator hs-var hs-var">!!</span></a></span></span><span> </span><span id="local-6989586621679313928"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313928"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; s -&gt; m (Maybe a)
forall t. (Ord t, Num t) =&gt; t -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313927"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313928"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313929"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1416"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1417"></span><span>    </span><span id="local-6989586621679313927"><span class="annot"><span class="annottext">go :: t -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313927"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679313926"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679313926"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679313925"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313925"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1418"></span><span>        </span><span id="local-6989586621679313924"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313924"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313930"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313925"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1419"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313924"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1420"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313923"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313923"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313922"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313922"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679313926"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1421"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679313926"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; m (Maybe a)) -&gt; Maybe a -&gt; m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313923"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1422"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313927"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679313926"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313922"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1423"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313921"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313921"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679313927"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679313926"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313921"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1424"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1425"></span><span>
</span><span id="line-1426"></span><span class="hs-pragma">{-# INLINE_NORMAL lookup #-}</span><span>
</span><span id="line-1427"></span><span id="local-6989586621679313918"><span id="local-6989586621679313919"><span id="local-6989586621679313920"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#lookup"><span class="hs-identifier hs-type">lookup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313920"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679313919"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313919"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313920"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313919"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679313918"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313920"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679313918"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1428"></span><span id="lookup"><span class="annot"><span class="annottext">lookup :: a -&gt; Stream m (a, b) -&gt; m (Maybe b)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#lookup"><span class="hs-identifier hs-var hs-var">lookup</span></a></span></span><span> </span><span id="local-6989586621679313917"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313917"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679313916"><span class="annot"><span class="annottext">Stream m (a, b)
</span><a href="#local-6989586621679313916"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((a, b) -&gt; m (Maybe b) -&gt; m (Maybe b))
-&gt; m (Maybe b) -&gt; Stream m (a, b) -&gt; m (Maybe b)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldrM"><span class="hs-identifier hs-var">foldrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679313915"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313915"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313914"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313914"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313913"><span class="annot"><span class="annottext">m (Maybe b)
</span><a href="#local-6989586621679313913"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313917"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313915"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe b -&gt; m (Maybe b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Maybe b
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313914"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">m (Maybe b)
</span><a href="#local-6989586621679313913"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1429"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe b -&gt; m (Maybe b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe b
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m (a, b)
</span><a href="#local-6989586621679313916"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1430"></span><span>
</span><span id="line-1431"></span><span class="hs-pragma">{-# INLINE_NORMAL findM #-}</span><span>
</span><span id="line-1432"></span><span id="local-6989586621679315790"><span id="local-6989586621679315791"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#findM"><span class="hs-identifier hs-type">findM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315791"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315790"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315791"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315791"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315790"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315791"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679315790"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1433"></span><span id="findM"><span class="annot"><span class="annottext">findM :: (a -&gt; m Bool) -&gt; Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#findM"><span class="hs-identifier hs-var hs-var">findM</span></a></span></span><span> </span><span id="local-6989586621679313912"><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679313912"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679313911"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679313911"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m (Maybe a) -&gt; m (Maybe a))
-&gt; m (Maybe a) -&gt; Stream m a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldrM"><span class="hs-identifier hs-var">foldrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679313910"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313910"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313909"><span class="annot"><span class="annottext">m (Maybe a)
</span><a href="#local-6989586621679313909"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679313912"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313910"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; (Bool -&gt; m (Maybe a)) -&gt; m (Maybe a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313908"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313908"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313908"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313910"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">m (Maybe a)
</span><a href="#local-6989586621679313909"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1434"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679313911"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1435"></span><span>
</span><span id="line-1436"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#find"><span class="hs-pragma hs-type">find</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1437"></span><span id="local-6989586621679313906"><span id="local-6989586621679313907"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#find"><span class="hs-identifier hs-type">find</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313907"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313906"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313907"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313906"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313907"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679313906"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1438"></span><span id="find"><span class="annot"><span class="annottext">find :: (a -&gt; Bool) -&gt; Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#find"><span class="hs-identifier hs-var hs-var">find</span></a></span></span><span> </span><span id="local-6989586621679313905"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313905"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m Bool) -&gt; Stream m a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; m Bool) -&gt; Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#findM"><span class="hs-identifier hs-var">findM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; (a -&gt; Bool) -&gt; a -&gt; m Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313905"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1439"></span><span>
</span><span id="line-1440"></span><span class="hs-pragma">{-# INLINE_NORMAL findIndices #-}</span><span>
</span><span id="line-1441"></span><span id="local-6989586621679313903"><span id="local-6989586621679313904"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#findIndices"><span class="hs-identifier hs-type">findIndices</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313904"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313903"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313904"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313903"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313904"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span></span><span>
</span><span id="line-1442"></span><span id="findIndices"><span class="annot"><span class="annottext">findIndices :: (a -&gt; Bool) -&gt; Stream m a -&gt; Stream m Int
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#findIndices"><span class="hs-identifier hs-var hs-var">findIndices</span></a></span></span><span> </span><span id="local-6989586621679313902"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313902"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313901"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313901"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313900"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313900"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m Int -&gt; (s, Int) -&gt; m (Step (s, Int) Int))
-&gt; (s, Int) -&gt; Stream m Int
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m Int -&gt; (s, Int) -&gt; m (Step (s, Int) Int)
forall b (m :: * -&gt; *) a.
Num b =&gt;
State Stream m a -&gt; (s, b) -&gt; m (Step (s, b) b)
</span><a href="#local-6989586621679313899"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313900"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1443"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1444"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-1445"></span><span>    </span><span id="local-6989586621679313899"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, b) -&gt; m (Step (s, b) b)
</span><a href="#local-6989586621679313899"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679313898"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313898"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313897"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313897"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313896"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313896"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313896"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m (Step (s, b) b) -&gt; m (Step (s, b) b)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1446"></span><span>      </span><span id="local-6989586621679313895"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313895"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313901"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313898"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313897"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1447"></span><span>      </span><span class="annot"><span class="annottext">Step (s, b) b -&gt; m (Step (s, b) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, b) b -&gt; m (Step (s, b) b))
-&gt; Step (s, b) b -&gt; m (Step (s, b) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313895"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1448"></span><span>          </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313894"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313894"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313893"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313893"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313902"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313894"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">b -&gt; (s, b) -&gt; Step (s, b) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313896"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313893"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313896"><span class="hs-identifier hs-var">i</span></a></span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">b
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(s, b) -&gt; Step (s, b) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313893"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313896"><span class="hs-identifier hs-var">i</span></a></span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">b
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-1449"></span><span>          </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313892"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313892"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, b) -&gt; Step (s, b) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313892"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313896"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1450"></span><span>          </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, b) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1451"></span><span>
</span><span id="line-1452"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#toListRev"><span class="hs-pragma hs-type">toListRev</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1453"></span><span id="local-6989586621679315774"><span id="local-6989586621679315775"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#toListRev"><span class="hs-identifier hs-type">toListRev</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315774"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315774"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-1454"></span><span id="toListRev"><span class="annot"><span class="annottext">toListRev :: Stream m a -&gt; m [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#toListRev"><span class="hs-identifier hs-var hs-var">toListRev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([a] -&gt; a -&gt; [a]) -&gt; [a] -&gt; Stream m a -&gt; m [a]
forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; [a] -&gt; [a]) -&gt; [a] -&gt; a -&gt; [a]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1455"></span><span>
</span><span id="line-1456"></span><span class="hs-comment">-- We can implement reverse as:</span><span>
</span><span id="line-1457"></span><span class="hs-comment">--</span><span>
</span><span id="line-1458"></span><span class="hs-comment">-- &gt; reverse = foldlS (flip cons) nil</span><span>
</span><span id="line-1459"></span><span class="hs-comment">--</span><span>
</span><span id="line-1460"></span><span class="hs-comment">-- However, this implementation is unusable because of the horrible performance</span><span>
</span><span id="line-1461"></span><span class="hs-comment">-- of cons. So we just convert it to a list first and then stream from the</span><span>
</span><span id="line-1462"></span><span class="hs-comment">-- list.</span><span>
</span><span id="line-1463"></span><span class="hs-comment">--</span><span>
</span><span id="line-1464"></span><span class="hs-comment">-- XXX Maybe we can use an Array instead of a list here?</span><span>
</span><span id="line-1465"></span><span class="hs-pragma">{-# INLINE_NORMAL reverse #-}</span><span>
</span><span id="line-1466"></span><span id="local-6989586621679313889"><span id="local-6989586621679313890"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#reverse"><span class="hs-identifier hs-type">reverse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313889"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313889"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1467"></span><span id="reverse"><span class="annot"><span class="annottext">reverse :: Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#reverse"><span class="hs-identifier hs-var hs-var">reverse</span></a></span></span><span> </span><span id="local-6989586621679313888"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679313888"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; Maybe [a] -&gt; m (Step (Maybe [a]) a))
-&gt; Maybe [a] -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Maybe [a] -&gt; m (Step (Maybe [a]) a)
forall p. p -&gt; Maybe [a] -&gt; m (Step (Maybe [a]) a)
</span><a href="#local-6989586621679313887"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [a]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1468"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1469"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-1470"></span><span>    </span><span id="local-6989586621679313887"><span class="annot"><span class="annottext">step :: p -&gt; Maybe [a] -&gt; m (Step (Maybe [a]) a)
</span><a href="#local-6989586621679313887"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe [a]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1471"></span><span>        </span><span id="local-6989586621679313886"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679313886"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m [a]
forall (m :: * -&gt; *) a. Monad m =&gt; Stream m a -&gt; m [a]
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#toListRev"><span class="hs-identifier hs-var">toListRev</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679313888"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1472"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe [a]) a -&gt; m (Step (Maybe [a]) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe [a]) a -&gt; m (Step (Maybe [a]) a))
-&gt; Step (Maybe [a]) a -&gt; m (Step (Maybe [a]) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe [a] -&gt; Step (Maybe [a]) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; Maybe [a]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679313886"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1473"></span><span>    </span><span class="annot"><a href="#local-6989586621679313887"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313885"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313885"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679313884"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679313884"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe [a]) a -&gt; m (Step (Maybe [a]) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe [a]) a -&gt; m (Step (Maybe [a]) a))
-&gt; Step (Maybe [a]) a -&gt; m (Step (Maybe [a]) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe [a] -&gt; Step (Maybe [a]) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313885"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; Maybe [a]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679313884"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1474"></span><span>    </span><span class="annot"><a href="#local-6989586621679313887"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe [a]) a -&gt; m (Step (Maybe [a]) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe [a]) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1475"></span><span>
</span><span id="line-1476"></span><span class="hs-comment">-- Much faster reverse for Storables</span><span>
</span><span id="line-1477"></span><span class="hs-pragma">{-# INLINE_NORMAL reverse' #-}</span><span>
</span><span id="line-1478"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#reverse%27"><span class="hs-identifier hs-type">reverse'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679313883"><span class="annot"><a href="#local-6989586621679313883"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679313882"><span class="annot"><a href="#local-6989586621679313882"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679313883"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679313882"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313883"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313882"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313883"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313882"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1479"></span><span class="hs-comment">{-
-- This commented implementation copies the whole stream into one single array
-- and then streams from that array, this is 3-4x faster than the chunked code
-- that follows.  Though this could be problematic due to unbounded large
-- allocations. We need to figure out why the chunked code is slower and if we
-- can optimize the chunked code to work as fast as this one. It may be a
-- fusion issue?
import Foreign.ForeignPtr (touchForeignPtr)
import Foreign.ForeignPtr.Unsafe (unsafeForeignPtrToPtr)
import Foreign.Ptr (Ptr, plusPtr)
reverse' m = Stream step Nothing
    where
    {-# INLINE_LATE step #-}
    step _ Nothing = do
        arr &lt;- A.fromStreamD m
        let p = aEnd arr `plusPtr` negate (sizeOf (undefined :: a))
        return $ Skip $ Just (aStart arr, p)

    step _ (Just (start, p)) | p &lt; unsafeForeignPtrToPtr start = return Stop

    step _ (Just (start, p)) = do
        let !x = A.unsafeInlineIO $ do
                    r &lt;- peek p
                    touchForeignPtr start
                    return r
            next = p `plusPtr` negate (sizeOf (undefined :: a))
        return $ Yield x (Just (start, next))
-}</span><span>
</span><span id="line-1507"></span><span id="reverse%27"><span class="annot"><span class="annottext">reverse' :: Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#reverse%27"><span class="hs-identifier hs-var hs-var">reverse'</span></a></span></span><span> </span><span id="local-6989586621679313881"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679313881"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1508"></span><span>          </span><span class="annot"><span class="annottext">Stream m (Array a) -&gt; Stream m a
forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Stream m (Array a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#flattenArraysRev"><span class="hs-identifier hs-var">A.flattenArraysRev</span></a></span><span>
</span><span id="line-1509"></span><span>        </span><span class="annot"><span class="annottext">(Stream m (Array a) -&gt; Stream m a)
-&gt; Stream m (Array a) -&gt; Stream m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m (Array a) -&gt; Stream m (Array a)
forall (m :: * -&gt; *) a. Monad m =&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromStreamK"><span class="hs-identifier hs-var">fromStreamK</span></a></span><span>
</span><span id="line-1510"></span><span>        </span><span class="annot"><span class="annottext">(Stream m (Array a) -&gt; Stream m (Array a))
-&gt; Stream m (Array a) -&gt; Stream m (Array a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m (Array a) -&gt; Stream m (Array a)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
IsStream t =&gt;
t m a -&gt; t m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.html#reverse"><span class="hs-identifier hs-var">K.reverse</span></a></span><span>
</span><span id="line-1511"></span><span>        </span><span class="annot"><span class="annottext">(Stream m (Array a) -&gt; Stream m (Array a))
-&gt; Stream m (Array a) -&gt; Stream m (Array a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m (Array a) -&gt; Stream m (Array a)
forall (m :: * -&gt; *) a. Monad m =&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#toStreamK"><span class="hs-identifier hs-var">toStreamK</span></a></span><span>
</span><span id="line-1512"></span><span>        </span><span class="annot"><span class="annottext">(Stream m (Array a) -&gt; Stream m (Array a))
-&gt; Stream m (Array a) -&gt; Stream m (Array a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Stream m a -&gt; Stream m (Array a)
forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Stream m a -&gt; Stream m (Array a)
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#fromStreamDArraysOf"><span class="hs-identifier hs-var">A.fromStreamDArraysOf</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Mut.Types.html#defaultChunkSize"><span class="hs-identifier hs-var">A.defaultChunkSize</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679313881"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1513"></span><span>
</span><span id="line-1514"></span><span>
</span><span id="line-1515"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1516"></span><span class="hs-comment">-- Grouping/Splitting</span><span>
</span><span id="line-1517"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1518"></span><span>
</span><span id="line-1519"></span><span class="hs-pragma">{-# INLINE_NORMAL splitSuffixBy' #-}</span><span>
</span><span id="line-1520"></span><span id="local-6989586621679313874"><span id="local-6989586621679313875"><span id="local-6989586621679313876"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitSuffixBy%27"><span class="hs-identifier hs-type">splitSuffixBy'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313876"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1521"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313875"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313876"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313875"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313874"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313876"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313875"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313876"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313874"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1522"></span><span id="splitSuffixBy%27"><span class="annot"><span class="annottext">splitSuffixBy' :: (a -&gt; Bool) -&gt; Fold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitSuffixBy%27"><span class="hs-identifier hs-var hs-var">splitSuffixBy'</span></a></span></span><span> </span><span id="local-6989586621679313873"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313873"><span class="hs-identifier hs-var">predicate</span></a></span></span><span> </span><span id="local-6989586621679313872"><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313872"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313871"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313871"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313870"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313870"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1523"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b))
-&gt; Maybe s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fold m a b -&gt; State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b)
forall a (m :: * -&gt; *) a.
Fold m a a -&gt; State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313869"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313872"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313870"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1524"></span><span>
</span><span id="line-1525"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1526"></span><span>
</span><span id="line-1527"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE stepOuter #-}</span><span>
</span><span id="line-1528"></span><span>    </span><span id="local-6989586621679313869"><span class="annot"><span class="annottext">stepOuter :: Fold m a a -&gt; State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313869"><span class="hs-identifier hs-var hs-var">stepOuter</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313867"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313867"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313866"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313866"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313865"><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313865"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313864"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313864"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313863"><span class="annot"><a href="#local-6989586621679313863"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1529"></span><span>        </span><span id="local-6989586621679313862"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313862"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313871"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313864"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313863"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1530"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313862"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1531"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313861"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313861"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313860"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313860"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1532"></span><span>                </span><span id="local-6989586621679313859"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313859"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313866"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1533"></span><span>                </span><span id="local-6989586621679313858"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313858"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313867"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313859"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313861"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1534"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313873"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313861"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1535"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313865"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313858"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313857"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313857"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313857"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313860"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1536"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313856"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313860"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313858"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1537"></span><span>
</span><span id="line-1538"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313855"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313855"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe s -&gt; Step (Maybe s) a) -&gt; Maybe s -&gt; Step (Maybe s) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313855"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1539"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1540"></span><span>
</span><span id="line-1541"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1542"></span><span>
</span><span id="line-1543"></span><span>        </span><span id="local-6989586621679313856"><span class="annot"><span class="annottext">go :: SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313856"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313854"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313854"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313853"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313853"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1544"></span><span>            </span><span id="local-6989586621679313852"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313852"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313871"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313864"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313854"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1545"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313852"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1546"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313851"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313851"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313850"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313850"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1547"></span><span>                    </span><span id="local-6989586621679313849"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313849"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313867"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313853"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313851"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1548"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313873"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313851"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1549"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313865"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313849"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313848"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313848"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313848"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313850"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1550"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313856"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313850"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313849"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1551"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313847"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313847"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313856"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313847"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313853"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1552"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313865"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313853"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313846"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313846"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313846"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1553"></span><span>
</span><span id="line-1554"></span><span>    </span><span class="annot"><a href="#local-6989586621679313869"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1555"></span><span>
</span><span id="line-1556"></span><span class="hs-pragma">{-# INLINE_NORMAL groupsBy #-}</span><span>
</span><span id="line-1557"></span><span id="local-6989586621679313843"><span id="local-6989586621679313844"><span id="local-6989586621679313845"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#groupsBy"><span class="hs-identifier hs-type">groupsBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313845"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1558"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313844"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313844"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-1559"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313845"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313844"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313843"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-1560"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313845"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313844"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1561"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313845"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313843"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1562"></span><span id="groupsBy"><span class="annot"><span class="annottext">groupsBy :: (a -&gt; a -&gt; Bool) -&gt; Fold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#groupsBy"><span class="hs-identifier hs-var hs-var">groupsBy</span></a></span></span><span> </span><span id="local-6989586621679313842"><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
</span><a href="#local-6989586621679313842"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span id="local-6989586621679313841"><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313841"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313840"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313840"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313839"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313839"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; (Maybe s, Maybe a) -&gt; m (Step (Maybe s, Maybe a) b))
-&gt; (Maybe s, Maybe a) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fold m a b
-&gt; State Stream m b
-&gt; (Maybe s, Maybe a)
-&gt; m (Step (Maybe s, Maybe a) b)
forall a (m :: * -&gt; *) a.
Fold m a a
-&gt; State Stream m a
-&gt; (Maybe s, Maybe a)
-&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313838"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313841"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313839"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1563"></span><span>
</span><span id="line-1564"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1565"></span><span>
</span><span id="line-1566"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE stepOuter #-}</span><span>
</span><span id="line-1567"></span><span>    </span><span id="local-6989586621679313838"><span class="annot"><span class="annottext">stepOuter :: Fold m a a
-&gt; State Stream m a
-&gt; (Maybe s, Maybe a)
-&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313838"><span class="hs-identifier hs-var hs-var">stepOuter</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313837"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313837"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313836"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313836"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313835"><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313835"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313834"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313834"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313833"><span class="annot"><a href="#local-6989586621679313833"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1568"></span><span>        </span><span id="local-6989586621679313832"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313832"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313840"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313834"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313833"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1569"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313832"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1570"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313831"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313831"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313830"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313830"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1571"></span><span>                </span><span id="local-6989586621679313829"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313829"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313836"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1572"></span><span>                </span><span id="local-6989586621679313828"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313828"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313837"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313829"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313831"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1573"></span><span>                </span><span class="annot"><span class="annottext">SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313827"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313831"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313830"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313828"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1574"></span><span>
</span><span id="line-1575"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313826"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313826"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a)
-&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313826"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1576"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1577"></span><span>
</span><span id="line-1578"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1579"></span><span>
</span><span id="line-1580"></span><span>        </span><span id="local-6989586621679313827"><span class="annot"><span class="annottext">go :: SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313827"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313825"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313825"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span id="local-6989586621679313824"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313824"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313823"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313823"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1581"></span><span>            </span><span id="local-6989586621679313822"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313822"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313840"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313834"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313824"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1582"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313822"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1583"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313821"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313821"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313820"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313820"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1584"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
</span><a href="#local-6989586621679313842"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313821"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313825"><span class="hs-identifier hs-var">prev</span></a></span><span>
</span><span id="line-1585"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1586"></span><span>                        </span><span id="local-6989586621679313819"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313819"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313837"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313823"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313821"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1587"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313827"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313825"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313820"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313819"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1588"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313835"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313823"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313818"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313818"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313818"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313820"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313821"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1589"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313817"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313817"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313827"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313825"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313817"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313823"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1590"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313835"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313823"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313816"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313816"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313816"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1591"></span><span>
</span><span id="line-1592"></span><span>    </span><span class="annot"><a href="#local-6989586621679313838"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313815"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313815"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313814"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313814"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313813"><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313813"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313812"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313812"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313811"><span class="annot"><a href="#local-6989586621679313811"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313810"><span class="annot"><a href="#local-6989586621679313810"><span class="hs-identifier hs-var">prev</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1593"></span><span>        </span><span id="local-6989586621679313809"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313809"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313814"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1594"></span><span>        </span><span id="local-6989586621679313808"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313808"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313815"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313809"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313810"><span class="hs-identifier hs-var">prev</span></a></span><span>
</span><span id="line-1595"></span><span>        </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313807"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313811"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313808"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1596"></span><span>
</span><span id="line-1597"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1598"></span><span>
</span><span id="line-1599"></span><span>        </span><span class="hs-comment">-- XXX code duplicated from the previous equation</span><span>
</span><span id="line-1600"></span><span>        </span><span id="local-6989586621679313807"><span class="annot"><span class="annottext">go :: SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313807"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313806"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313806"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313805"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313805"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1601"></span><span>            </span><span id="local-6989586621679313804"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313804"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313840"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313812"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313806"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1602"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313804"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1603"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313803"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313803"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313802"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313802"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1604"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
</span><a href="#local-6989586621679313842"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313803"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313810"><span class="hs-identifier hs-var">prev</span></a></span><span>
</span><span id="line-1605"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1606"></span><span>                        </span><span id="local-6989586621679313801"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313801"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313815"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313805"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313803"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1607"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313807"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313802"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313801"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1608"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313813"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313805"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313800"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313800"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313800"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313802"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313803"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1609"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313799"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313799"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313807"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313799"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313805"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1610"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313813"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313805"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313798"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313798"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313798"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1611"></span><span>
</span><span id="line-1612"></span><span>    </span><span class="annot"><a href="#local-6989586621679313838"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1613"></span><span>
</span><span id="line-1614"></span><span class="hs-pragma">{-# INLINE_NORMAL groupsRollingBy #-}</span><span>
</span><span id="line-1615"></span><span id="local-6989586621679313795"><span id="local-6989586621679313796"><span id="local-6989586621679313797"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#groupsRollingBy"><span class="hs-identifier hs-type">groupsRollingBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313797"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1616"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313796"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313796"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-1617"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313797"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313796"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313795"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-1618"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313797"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313796"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1619"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313797"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313795"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1620"></span><span id="groupsRollingBy"><span class="annot"><span class="annottext">groupsRollingBy :: (a -&gt; a -&gt; Bool) -&gt; Fold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#groupsRollingBy"><span class="hs-identifier hs-var hs-var">groupsRollingBy</span></a></span></span><span> </span><span id="local-6989586621679313794"><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
</span><a href="#local-6989586621679313794"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span id="local-6989586621679313793"><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313793"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313792"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313792"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313791"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313791"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1621"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; (Maybe s, Maybe a) -&gt; m (Step (Maybe s, Maybe a) b))
-&gt; (Maybe s, Maybe a) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fold m a b
-&gt; State Stream m b
-&gt; (Maybe s, Maybe a)
-&gt; m (Step (Maybe s, Maybe a) b)
forall a (m :: * -&gt; *) a.
Fold m a a
-&gt; State Stream m a
-&gt; (Maybe s, Maybe a)
-&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313790"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313793"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313791"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1622"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1623"></span><span>
</span><span id="line-1624"></span><span>      </span><span class="hs-pragma">{-# INLINE_LATE stepOuter #-}</span><span>
</span><span id="line-1625"></span><span>      </span><span id="local-6989586621679313790"><span class="annot"><span class="annottext">stepOuter :: Fold m a a
-&gt; State Stream m a
-&gt; (Maybe s, Maybe a)
-&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313790"><span class="hs-identifier hs-var hs-var">stepOuter</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313789"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313789"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313788"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313788"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313787"><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313787"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313786"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313786"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313785"><span class="annot"><a href="#local-6989586621679313785"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1626"></span><span>          </span><span id="local-6989586621679313784"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313784"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313792"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313786"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313785"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1627"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313784"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1628"></span><span>              </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313783"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313783"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313782"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313782"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1629"></span><span>                  </span><span id="local-6989586621679313781"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313781"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313788"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1630"></span><span>                  </span><span id="local-6989586621679313780"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313780"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313789"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313781"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313783"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1631"></span><span>                  </span><span class="annot"><span class="annottext">SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313779"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313783"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313782"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313780"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1632"></span><span>
</span><span id="line-1633"></span><span>              </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313778"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313778"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a)
-&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313778"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1634"></span><span>              </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1635"></span><span>
</span><span id="line-1636"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1637"></span><span>          </span><span id="local-6989586621679313779"><span class="annot"><span class="annottext">go :: SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313779"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313777"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313777"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span id="local-6989586621679313776"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313776"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313775"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313775"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1638"></span><span>              </span><span id="local-6989586621679313774"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313774"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313792"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313786"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313776"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1639"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313774"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1640"></span><span>                  </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313773"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313773"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313772"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313772"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1641"></span><span>                      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
</span><a href="#local-6989586621679313794"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313777"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313773"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1642"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1643"></span><span>                          </span><span id="local-6989586621679313771"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313771"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313789"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313775"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313773"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1644"></span><span>                          </span><span class="annot"><span class="annottext">SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313779"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313773"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313772"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313771"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1645"></span><span>                        </span><span class="hs-keyword">else</span><span>
</span><span id="line-1646"></span><span>                          </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313787"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313775"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313770"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313770"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313770"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313772"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313773"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1647"></span><span>                  </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313769"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313769"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313779"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313777"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313769"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313775"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1648"></span><span>                  </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313787"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313775"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313768"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313768"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313768"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1649"></span><span>
</span><span id="line-1650"></span><span>      </span><span class="annot"><a href="#local-6989586621679313790"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313767"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313767"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313766"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313766"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313765"><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313765"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313764"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313764"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313763"><span class="annot"><a href="#local-6989586621679313763"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313762"><span class="annot"><a href="#local-6989586621679313762"><span class="hs-identifier hs-var">prev'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1651"></span><span>          </span><span id="local-6989586621679313761"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313761"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313766"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1652"></span><span>          </span><span id="local-6989586621679313760"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313760"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313767"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313761"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313762"><span class="hs-identifier hs-var">prev'</span></a></span><span>
</span><span id="line-1653"></span><span>          </span><span class="annot"><span class="annottext">SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313759"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313762"><span class="hs-identifier hs-var">prev'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313763"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313760"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1654"></span><span>
</span><span id="line-1655"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1656"></span><span>          </span><span id="local-6989586621679313759"><span class="annot"><span class="annottext">go :: SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313759"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313758"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313758"><span class="hs-identifier hs-var">prevv</span></a></span></span><span> </span><span id="local-6989586621679313757"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313757"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313756"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313756"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1657"></span><span>              </span><span id="local-6989586621679313755"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313755"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313792"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313764"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313757"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1658"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313755"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1659"></span><span>                  </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313754"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313754"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313753"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313753"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1660"></span><span>                      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
</span><a href="#local-6989586621679313794"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313758"><span class="hs-identifier hs-var">prevv</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313754"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1661"></span><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1662"></span><span>                          </span><span id="local-6989586621679313752"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313752"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313767"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313756"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313754"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1663"></span><span>                          </span><span class="annot"><span class="annottext">SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313759"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313754"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313753"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313752"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1664"></span><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313765"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313756"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313751"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313751"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313751"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313753"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313754"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1665"></span><span>                  </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313750"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313750"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; a -&gt; s -&gt; s -&gt; m (Step (Maybe s, Maybe a) a)
</span><a href="#local-6989586621679313759"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313758"><span class="hs-identifier hs-var">prevv</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313750"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313756"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1666"></span><span>                  </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313765"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313756"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313749"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313749"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a))
-&gt; Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe s, Maybe a) -&gt; Step (Maybe s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313749"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1667"></span><span>
</span><span id="line-1668"></span><span>      </span><span class="annot"><a href="#local-6989586621679313790"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a -&gt; m (Step (Maybe s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1669"></span><span>
</span><span id="line-1670"></span><span class="hs-pragma">{-# INLINE_NORMAL splitBy #-}</span><span>
</span><span id="line-1671"></span><span id="local-6989586621679313746"><span id="local-6989586621679313747"><span id="local-6989586621679313748"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitBy"><span class="hs-identifier hs-type">splitBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313748"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313747"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313748"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313747"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313746"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313748"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313747"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313748"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313746"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1672"></span><span id="splitBy"><span class="annot"><span class="annottext">splitBy :: (a -&gt; Bool) -&gt; Fold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitBy"><span class="hs-identifier hs-var hs-var">splitBy</span></a></span></span><span> </span><span id="local-6989586621679313745"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313745"><span class="hs-identifier hs-var">predicate</span></a></span></span><span> </span><span id="local-6989586621679313744"><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313744"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313743"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313743"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313742"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313742"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b))
-&gt; Maybe s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fold m a b -&gt; State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b)
forall a (m :: * -&gt; *) a.
Fold m a a -&gt; State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313741"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313744"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313742"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1673"></span><span>
</span><span id="line-1674"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1675"></span><span>
</span><span id="line-1676"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-1677"></span><span>    </span><span id="local-6989586621679313741"><span class="annot"><span class="annottext">step' :: Fold m a a -&gt; State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313741"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313740"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313740"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313739"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313739"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313738"><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313738"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313737"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313737"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313736"><span class="annot"><a href="#local-6989586621679313736"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313739"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m s -&gt; (s -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313735"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313736"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1678"></span><span>
</span><span id="line-1679"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1680"></span><span>
</span><span id="line-1681"></span><span>        </span><span id="local-6989586621679313735"><span class="annot"><span class="annottext">go :: SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313735"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313734"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313734"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313733"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313733"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1682"></span><span>            </span><span id="local-6989586621679313732"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313732"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313743"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313737"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313734"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1683"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313732"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1684"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313731"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313731"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313730"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313730"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1685"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313745"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313731"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1686"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313738"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313733"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313729"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313729"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313729"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313730"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1687"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1688"></span><span>                        </span><span id="local-6989586621679313728"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313728"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313740"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313733"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313731"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1689"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313735"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313730"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313728"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1690"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313727"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313727"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313735"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313727"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313733"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1691"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313738"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313733"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313726"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313726"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313726"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1692"></span><span>
</span><span id="line-1693"></span><span>    </span><span class="annot"><a href="#local-6989586621679313741"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1694"></span><span>
</span><span id="line-1695"></span><span class="hs-comment">-- XXX requires -funfolding-use-threshold=150 in lines-unlines benchmark</span><span>
</span><span id="line-1696"></span><span class="hs-pragma">{-# INLINE_NORMAL splitSuffixBy #-}</span><span>
</span><span id="line-1697"></span><span id="local-6989586621679313723"><span id="local-6989586621679313724"><span id="local-6989586621679313725"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitSuffixBy"><span class="hs-identifier hs-type">splitSuffixBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313725"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1698"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313724"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313725"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313724"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313723"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313725"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313724"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313725"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313723"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1699"></span><span id="splitSuffixBy"><span class="annot"><span class="annottext">splitSuffixBy :: (a -&gt; Bool) -&gt; Fold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitSuffixBy"><span class="hs-identifier hs-var hs-var">splitSuffixBy</span></a></span></span><span> </span><span id="local-6989586621679313722"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313722"><span class="hs-identifier hs-var">predicate</span></a></span></span><span> </span><span id="local-6989586621679313721"><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313721"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313720"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313720"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313719"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313719"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b))
-&gt; Maybe s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fold m a b -&gt; State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b)
forall a (m :: * -&gt; *) a.
Fold m a a -&gt; State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313718"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313721"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313719"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1700"></span><span>
</span><span id="line-1701"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1702"></span><span>
</span><span id="line-1703"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-1704"></span><span>    </span><span id="local-6989586621679313718"><span class="annot"><span class="annottext">step' :: Fold m a a -&gt; State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313718"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313717"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313717"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313716"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313716"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313715"><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313715"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313714"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313714"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313713"><span class="annot"><a href="#local-6989586621679313713"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1705"></span><span>        </span><span id="local-6989586621679313712"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313712"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313720"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313714"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313713"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1706"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313712"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1707"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313711"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313711"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313710"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313710"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1708"></span><span>                </span><span id="local-6989586621679313709"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313709"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313716"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1709"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313722"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313711"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1710"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313715"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313709"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313708"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313708"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313708"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313710"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1711"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1712"></span><span>                    </span><span id="local-6989586621679313707"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313707"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313717"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313709"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313711"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1713"></span><span>                    </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313706"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313710"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313707"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1714"></span><span>
</span><span id="line-1715"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313705"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313705"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe s -&gt; Step (Maybe s) a) -&gt; Maybe s -&gt; Step (Maybe s) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313705"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1716"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1717"></span><span>
</span><span id="line-1718"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1719"></span><span>
</span><span id="line-1720"></span><span>        </span><span id="local-6989586621679313706"><span class="annot"><span class="annottext">go :: SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313706"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313704"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313704"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313703"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313703"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1721"></span><span>            </span><span id="local-6989586621679313702"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313702"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313720"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313714"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313704"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1722"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313702"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1723"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313701"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313701"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313700"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313700"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1724"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313722"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313701"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1725"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313715"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313703"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313699"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313699"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313699"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313700"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1726"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1727"></span><span>                        </span><span id="local-6989586621679313698"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313698"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313717"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313703"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313701"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1728"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313706"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313700"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313698"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1729"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313697"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313697"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313706"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313697"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313703"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1730"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313715"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313703"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313696"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313696"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313696"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1731"></span><span>
</span><span id="line-1732"></span><span>    </span><span class="annot"><a href="#local-6989586621679313718"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1733"></span><span>
</span><span id="line-1734"></span><span class="hs-pragma">{-# INLINE_NORMAL wordsBy #-}</span><span>
</span><span id="line-1735"></span><span id="local-6989586621679313693"><span id="local-6989586621679313694"><span id="local-6989586621679313695"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#wordsBy"><span class="hs-identifier hs-type">wordsBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313694"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313694"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313693"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313694"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313693"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1736"></span><span id="wordsBy"><span class="annot"><span class="annottext">wordsBy :: (a -&gt; Bool) -&gt; Fold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#wordsBy"><span class="hs-identifier hs-var hs-var">wordsBy</span></a></span></span><span> </span><span id="local-6989586621679313692"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313692"><span class="hs-identifier hs-var">predicate</span></a></span></span><span> </span><span id="local-6989586621679313691"><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313691"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313690"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313690"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313689"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313689"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b))
-&gt; Maybe s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fold m a b -&gt; State Stream m b -&gt; Maybe s -&gt; m (Step (Maybe s) b)
forall a (m :: * -&gt; *) a.
Fold m a a -&gt; State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313688"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679313691"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313689"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1737"></span><span>
</span><span id="line-1738"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1739"></span><span>
</span><span id="line-1740"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE stepOuter #-}</span><span>
</span><span id="line-1741"></span><span>    </span><span id="local-6989586621679313688"><span class="annot"><span class="annottext">stepOuter :: Fold m a a -&gt; State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313688"><span class="hs-identifier hs-var hs-var">stepOuter</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313687"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313687"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313686"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313686"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313685"><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313685"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313684"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313684"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313683"><span class="annot"><a href="#local-6989586621679313683"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1742"></span><span>        </span><span id="local-6989586621679313682"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313682"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313690"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313684"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313683"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1743"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313682"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1744"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313681"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313681"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313680"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313680"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1745"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313692"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313681"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1746"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313680"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1747"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1748"></span><span>                    </span><span id="local-6989586621679313679"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313679"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313686"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1749"></span><span>                    </span><span id="local-6989586621679313678"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313678"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313687"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313679"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313681"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1750"></span><span>                    </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313677"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313680"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313678"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1751"></span><span>
</span><span id="line-1752"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313676"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313676"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe s -&gt; Step (Maybe s) a) -&gt; Maybe s -&gt; Step (Maybe s) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313676"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1753"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1754"></span><span>
</span><span id="line-1755"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1756"></span><span>
</span><span id="line-1757"></span><span>        </span><span id="local-6989586621679313677"><span class="annot"><span class="annottext">go :: SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313677"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313675"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313675"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313674"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313674"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1758"></span><span>            </span><span id="local-6989586621679313673"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313673"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313690"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313684"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313675"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1759"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313673"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1760"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313672"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313672"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313671"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313671"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1761"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679313692"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313672"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1762"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313685"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313674"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313670"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313670"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313670"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313671"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1763"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1764"></span><span>                        </span><span id="local-6989586621679313669"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313669"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313687"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313674"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313672"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1765"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313677"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313671"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313669"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1766"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313668"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313668"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679313677"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313668"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313674"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1767"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m a
</span><a href="#local-6989586621679313685"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313674"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step (Maybe s) a)) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313667"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313667"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313667"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1768"></span><span>
</span><span id="line-1769"></span><span>    </span><span class="annot"><a href="#local-6989586621679313688"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1770"></span><span>
</span><span id="line-1771"></span><span class="hs-comment">-- String search algorithms:</span><span>
</span><span id="line-1772"></span><span class="hs-comment">-- http://www-igm.univ-mlv.fr/~lecroq/string/index.html</span><span>
</span><span id="line-1773"></span><span>
</span><span id="line-1774"></span><span class="hs-comment">{-
-- TODO can we unify the splitting operations using a splitting configuration
-- like in the split package.
--
data SplitStyle = Infix | Suffix | Prefix deriving (Eq, Show)

data SplitOptions = SplitOptions
    { style    :: SplitStyle
    , withSep  :: Bool  -- ^ keep the separators in output
    -- , compact  :: Bool  -- ^ treat multiple consecutive separators as one
    -- , trimHead :: Bool  -- ^ drop blank at head
    -- , trimTail :: Bool  -- ^ drop blank at tail
    }
-}</span><span>
</span><span id="line-1788"></span><span>
</span><span id="line-1789"></span><span class="hs-keyword">data</span><span> </span><span id="SplitOnState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitOnState"><span class="hs-identifier hs-var">SplitOnState</span></a></span></span><span> </span><span id="local-6989586621679315701"><span class="annot"><a href="#local-6989586621679315701"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679315700"><span class="annot"><a href="#local-6989586621679315700"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1790"></span><span>      </span><span id="GO_START"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_START"><span class="hs-identifier hs-var">GO_START</span></a></span></span><span>
</span><span id="line-1791"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GO_EMPTY_PAT"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_EMPTY_PAT"><span class="hs-identifier hs-var">GO_EMPTY_PAT</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315701"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-1792"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GO_SINGLE_PAT"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SINGLE_PAT"><span class="hs-identifier hs-var">GO_SINGLE_PAT</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315701"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315700"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1793"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GO_SHORT_PAT"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-var">GO_SHORT_PAT</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315701"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-1794"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GO_KARP_RABIN"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_KARP_RABIN"><span class="hs-identifier hs-var">GO_KARP_RABIN</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315701"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Memory.Ring.html#Ring"><span class="hs-identifier hs-type">RB.Ring</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315700"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679315700"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1795"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GO_DONE"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span></span><span>
</span><span id="line-1796"></span><span>
</span><span id="line-1797"></span><span class="hs-pragma">{-# INLINE_NORMAL splitOn #-}</span><span>
</span><span id="line-1798"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitOn"><span class="hs-identifier hs-type">splitOn</span></a></span><span>
</span><span id="line-1799"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679313660"><span class="annot"><a href="#local-6989586621679313660"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679313659"><span class="annot"><a href="#local-6989586621679313659"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679313658"><span class="annot"><a href="#local-6989586621679313658"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679313660"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679313659"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Enum</span></span><span> </span><span class="annot"><a href="#local-6989586621679313659"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679313659"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1800"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313659"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1801"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313660"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313659"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313658"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-1802"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313660"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313659"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1803"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313660"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313658"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-1804"></span><span id="splitOn"><span class="annot"><span class="annottext">splitOn :: Array a -&gt; Fold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitOn"><span class="hs-identifier hs-var hs-var">splitOn</span></a></span></span><span> </span><span id="local-6989586621679313657"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313657"><span class="hs-identifier hs-var">patArr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313656"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313656"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313655"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313655"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313654"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313653"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313653"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313652"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313652"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1805"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; SplitOnState s a -&gt; m (Step (SplitOnState s a) b))
-&gt; SplitOnState s a -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; SplitOnState s a -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; SplitOnState s a -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313651"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_START"><span class="hs-identifier hs-var">GO_START</span></a></span><span>
</span><span id="line-1806"></span><span>
</span><span id="line-1807"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1808"></span><span>
</span><span id="line-1809"></span><span>    </span><span id="local-6989586621679313650"><span class="annot"><span class="annottext">patLen :: Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var hs-var">patLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Array a -&gt; Int
forall a. Storable a =&gt; Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#length"><span class="hs-identifier hs-var">A.length</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313657"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-1810"></span><span>    </span><span id="local-6989586621679313648"><span class="annot"><span class="annottext">maxIndex :: Int
</span><a href="#local-6989586621679313648"><span class="hs-identifier hs-var hs-var">maxIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1811"></span><span>    </span><span id="local-6989586621679313647"><span class="annot"><span class="annottext">elemBits :: Int
</span><a href="#local-6989586621679313647"><span class="hs-identifier hs-var hs-var">elemBits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679313659"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-1812"></span><span>
</span><span id="line-1813"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE stepOuter #-}</span><span>
</span><span id="line-1814"></span><span>    </span><span id="local-6989586621679313651"><span class="annot"><span class="annottext">stepOuter :: State Stream m a
-&gt; SplitOnState s a -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313651"><span class="hs-identifier hs-var hs-var">stepOuter</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_START"><span class="hs-identifier hs-var">GO_START</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1815"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1816"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitOnState s a -&gt; Step (SplitOnState s a) b)
-&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_EMPTY_PAT"><span class="hs-identifier hs-var">GO_EMPTY_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313652"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1817"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1818"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1819"></span><span>                </span><span id="local-6989586621679313645"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313645"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; m a) -&gt; IO a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array a -&gt; Int -&gt; IO a
forall a. Storable a =&gt; Array a -&gt; Int -&gt; IO a
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#unsafeIndexIO"><span class="hs-identifier hs-var">A.unsafeIndexIO</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313657"><span class="hs-identifier hs-var">patArr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1820"></span><span>                </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitOnState s a -&gt; Step (SplitOnState s a) b)
-&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; SplitOnState s a
forall s a. s -&gt; a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SINGLE_PAT"><span class="hs-identifier hs-var">GO_SINGLE_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313652"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313645"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1821"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679313659"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-1822"></span><span>                    </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span class="hs-special">)</span><span>
</span><span id="line-1823"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitOnState s a -&gt; Step (SplitOnState s a) b)
-&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-var">GO_SHORT_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313652"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1824"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1825"></span><span>                    </span><span class="hs-special">(</span><span id="local-6989586621679313643"><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313643"><span class="hs-identifier hs-var">rb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313642"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313642"><span class="hs-identifier hs-var">rhead</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ring a, Ptr a) -&gt; m (Ring a, Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Ring a, Ptr a) -&gt; m (Ring a, Ptr a))
-&gt; IO (Ring a, Ptr a) -&gt; m (Ring a, Ptr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (Ring a, Ptr a)
forall a. Storable a =&gt; Int -&gt; IO (Ring a, Ptr a)
</span><a href="Streamly.Memory.Ring.html#new"><span class="hs-identifier hs-var">RB.new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-1826"></span><span>                    </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitOnState s a -&gt; Step (SplitOnState s a) b)
-&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
forall s a. s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_KARP_RABIN"><span class="hs-identifier hs-var">GO_KARP_RABIN</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313652"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313643"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313642"><span class="hs-identifier hs-var">rhead</span></a></span><span>
</span><span id="line-1827"></span><span>
</span><span id="line-1828"></span><span>    </span><span class="annot"><a href="#local-6989586621679313651"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679313640"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313640"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SINGLE_PAT"><span class="hs-identifier hs-type">GO_SINGLE_PAT</span></a></span><span> </span><span id="local-6989586621679313639"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313639"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span id="local-6989586621679313638"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313638"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313655"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313637"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313639"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1829"></span><span>
</span><span id="line-1830"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1831"></span><span>
</span><span id="line-1832"></span><span>        </span><span id="local-6989586621679313637"><span class="annot"><span class="annottext">go :: SPEC -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313637"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313636"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313636"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313635"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313635"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1833"></span><span>            </span><span id="local-6989586621679313634"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313634"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313653"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313640"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313636"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1834"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313634"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1835"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313633"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313633"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313632"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313632"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1836"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313638"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313633"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1837"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1838"></span><span>                        </span><span id="local-6989586621679313631"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313631"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313635"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1839"></span><span>                        </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313631"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; a -&gt; SplitOnState s a
forall s a. s -&gt; a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SINGLE_PAT"><span class="hs-identifier hs-var">GO_SINGLE_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313632"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313638"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1840"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313656"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313635"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313633"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313637"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313632"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1841"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313630"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313630"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313637"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313630"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313635"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1842"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313635"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313629"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313629"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313629"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-1843"></span><span>
</span><span id="line-1844"></span><span>    </span><span class="annot"><a href="#local-6989586621679313651"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679313628"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313628"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-type">GO_SHORT_PAT</span></a></span><span> </span><span id="local-6989586621679313627"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313627"><span class="hs-identifier hs-var">stt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313655"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
forall a.
SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313626"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313627"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1845"></span><span>
</span><span id="line-1846"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1847"></span><span>
</span><span id="line-1848"></span><span>        </span><span class="annot"><a href="#local-6989586621679313625"><span class="hs-identifier hs-type">mask</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-1849"></span><span>        </span><span id="local-6989586621679313625"><span class="annot"><span class="annottext">mask :: Word
</span><a href="#local-6989586621679313625"><span class="hs-identifier hs-var hs-var">mask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; Word
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313647"><span class="hs-identifier hs-var">elemBits</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var">patLen</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1850"></span><span>
</span><span id="line-1851"></span><span>        </span><span id="local-6989586621679313624"><span class="annot"><span class="annottext">addToWord :: a -&gt; a -&gt; a
</span><a href="#local-6989586621679313624"><span class="hs-identifier hs-var hs-var">addToWord</span></a></span></span><span> </span><span id="local-6989586621679313623"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313623"><span class="hs-identifier hs-var">wrd</span></a></span></span><span> </span><span id="local-6989586621679313622"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313622"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313623"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; a
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313647"><span class="hs-identifier hs-var">elemBits</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313622"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1852"></span><span>
</span><span id="line-1853"></span><span>        </span><span class="annot"><a href="#local-6989586621679313620"><span class="hs-identifier hs-type">patWord</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-1854"></span><span>        </span><span id="local-6989586621679313620"><span class="annot"><span class="annottext">patWord :: Word
</span><a href="#local-6989586621679313620"><span class="hs-identifier hs-var hs-var">patWord</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313625"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">(Word -&gt; a -&gt; Word) -&gt; Word -&gt; Array a -&gt; Word
forall a b. Storable a =&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Array a -&gt; b
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#foldl%27"><span class="hs-identifier hs-var">A.foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; a -&gt; Word
forall a a. (Bits a, Num a, Enum a) =&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679313624"><span class="hs-identifier hs-var">addToWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313657"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-1855"></span><span>
</span><span id="line-1856"></span><span>        </span><span id="local-6989586621679313626"><span class="annot"><span class="annottext">go0 :: SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313626"><span class="hs-identifier hs-var hs-var">go0</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313618"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313618"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621679313617"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313617"><span class="hs-identifier hs-var">wrd</span></a></span></span><span> </span><span id="local-6989586621679313616"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313616"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313615"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313615"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1857"></span><span>            </span><span id="local-6989586621679313614"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313614"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313653"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313628"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313616"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1858"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313614"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1859"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313613"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313613"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313612"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313612"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1860"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313611"><span class="annot"><span class="annottext">wrd' :: Word
</span><a href="#local-6989586621679313611"><span class="hs-identifier hs-var hs-var">wrd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; a -&gt; Word
forall a a. (Bits a, Num a, Enum a) =&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679313624"><span class="hs-identifier hs-var">addToWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313617"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313613"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1861"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313618"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313648"><span class="hs-identifier hs-var">maxIndex</span></a></span><span>
</span><span id="line-1862"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1863"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313611"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313625"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313620"><span class="hs-identifier hs-var">patWord</span></a></span><span>
</span><span id="line-1864"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1865"></span><span>                            </span><span id="local-6989586621679313610"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313610"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313615"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1866"></span><span>                            </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313610"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-var">GO_SHORT_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313612"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1867"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
forall a. SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313609"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313611"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313612"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313615"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1868"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313626"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313618"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313611"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313612"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313615"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1869"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313608"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313608"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313626"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313618"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313617"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313608"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313615"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1870"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1871"></span><span>                    </span><span id="local-6989586621679313607"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313607"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313618"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1872"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; s -&gt; m s
</span><a href="#local-6989586621679313605"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313617"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313618"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313615"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1873"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313615"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1874"></span><span>                    </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313607"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313604"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313604"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313604"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-1875"></span><span>
</span><span id="line-1876"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679313609"><span class="hs-pragma hs-type">go1</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1877"></span><span>        </span><span id="local-6989586621679313609"><span class="annot"><span class="annottext">go1 :: SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313609"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313603"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313603"><span class="hs-identifier hs-var">wrd</span></a></span></span><span> </span><span id="local-6989586621679313602"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313602"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313601"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313601"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1878"></span><span>            </span><span id="local-6989586621679313600"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313600"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313653"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313628"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313602"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1879"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313600"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1880"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313599"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313599"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313598"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313598"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1881"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313597"><span class="annot"><span class="annottext">wrd' :: Word
</span><a href="#local-6989586621679313597"><span class="hs-identifier hs-var hs-var">wrd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; a -&gt; Word
forall a a. (Bits a, Num a, Enum a) =&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679313624"><span class="hs-identifier hs-var">addToWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313603"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313599"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1882"></span><span>                        </span><span id="local-6989586621679313596"><span class="annot"><span class="annottext">old :: Word
</span><a href="#local-6989586621679313596"><span class="hs-identifier hs-var hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313625"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313603"><span class="hs-identifier hs-var">wrd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; Word
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftR`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313647"><span class="hs-identifier hs-var">elemBits</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1883"></span><span>                    </span><span id="local-6989586621679313595"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313595"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313656"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313601"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; a
forall a. Enum a =&gt; Int -&gt; a
</span><span class="hs-identifier hs-var">toEnum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; a) -&gt; Int -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313596"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1884"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313597"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313625"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313620"><span class="hs-identifier hs-var">patWord</span></a></span><span>
</span><span id="line-1885"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313595"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313593"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313593"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313593"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-var">GO_SHORT_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313598"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1886"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313609"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313597"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313598"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313595"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1887"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313592"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313592"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313609"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313603"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313592"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313601"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1888"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1889"></span><span>                    </span><span id="local-6989586621679313591"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313591"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; s -&gt; m s
</span><a href="#local-6989586621679313605"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313603"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313601"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1890"></span><span>                    </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313591"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313590"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313590"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313590"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-1891"></span><span>
</span><span id="line-1892"></span><span>        </span><span id="local-6989586621679313605"><span class="annot"><span class="annottext">go2 :: Word -&gt; Int -&gt; s -&gt; m s
</span><a href="#local-6989586621679313605"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313589"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313589"><span class="hs-identifier hs-var">wrd</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313588"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313588"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313587"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313587"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313588"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1893"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313586"><span class="annot"><span class="annottext">old :: Word
</span><a href="#local-6989586621679313586"><span class="hs-identifier hs-var hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313625"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313589"><span class="hs-identifier hs-var">wrd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; Word
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftR`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313647"><span class="hs-identifier hs-var">elemBits</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313588"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1894"></span><span>            </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313656"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313587"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; a
forall a. Enum a =&gt; Int -&gt; a
</span><span class="hs-identifier hs-var">toEnum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; a) -&gt; Int -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313586"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m s -&gt; (s -&gt; m s) -&gt; m s
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; s -&gt; m s
</span><a href="#local-6989586621679313605"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313589"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313588"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-1895"></span><span>        </span><span class="annot"><a href="#local-6989586621679313605"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313585"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313585"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313585"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1896"></span><span>
</span><span id="line-1897"></span><span>    </span><span class="annot"><a href="#local-6989586621679313651"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679313584"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313584"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_KARP_RABIN"><span class="hs-identifier hs-type">GO_KARP_RABIN</span></a></span><span> </span><span id="local-6989586621679313583"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313583"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span id="local-6989586621679313582"><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span></span><span> </span><span id="local-6989586621679313581"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313581"><span class="hs-identifier hs-var">rhead</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1898"></span><span>        </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313655"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313580"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313581"><span class="hs-identifier hs-var">rhead</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313583"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-1899"></span><span>
</span><span id="line-1900"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1901"></span><span>
</span><span id="line-1902"></span><span>        </span><span id="local-6989586621679313579"><span class="annot"><span class="annottext">k :: Word32
</span><a href="#local-6989586621679313579"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">2891336453</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-1903"></span><span>        </span><span id="local-6989586621679313578"><span class="annot"><span class="annottext">coeff :: Word32
</span><a href="#local-6989586621679313578"><span class="hs-identifier hs-var hs-var">coeff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313579"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><span class="hs-operator hs-var">^</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313650"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-1904"></span><span>        </span><span id="local-6989586621679313576"><span class="annot"><span class="annottext">addCksum :: Word32 -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313576"><span class="hs-identifier hs-var hs-var">addCksum</span></a></span></span><span> </span><span id="local-6989586621679313575"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313575"><span class="hs-identifier hs-var">cksum</span></a></span></span><span> </span><span id="local-6989586621679313574"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313574"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313575"><span class="hs-identifier hs-var">cksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313579"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313574"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1905"></span><span>        </span><span id="local-6989586621679313573"><span class="annot"><span class="annottext">deltaCksum :: Word32 -&gt; a -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313573"><span class="hs-identifier hs-var hs-var">deltaCksum</span></a></span></span><span> </span><span id="local-6989586621679313572"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313572"><span class="hs-identifier hs-var">cksum</span></a></span></span><span> </span><span id="local-6989586621679313571"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313571"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621679313570"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313570"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1906"></span><span>            </span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; Word32
forall a. Enum a =&gt; Word32 -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313576"><span class="hs-identifier hs-var">addCksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313572"><span class="hs-identifier hs-var">cksum</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313570"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313578"><span class="hs-identifier hs-var">coeff</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313571"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1907"></span><span>
</span><span id="line-1908"></span><span>        </span><span class="hs-comment">-- XXX shall we use a random starting hash or 1 instead of 0?</span><span>
</span><span id="line-1909"></span><span>        </span><span id="local-6989586621679313569"><span class="annot"><span class="annottext">patHash :: Word32
</span><a href="#local-6989586621679313569"><span class="hs-identifier hs-var hs-var">patHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; a -&gt; Word32) -&gt; Word32 -&gt; Array a -&gt; Word32
forall a b. Storable a =&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Array a -&gt; b
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#foldl%27"><span class="hs-identifier hs-var">A.foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; Word32
forall a. Enum a =&gt; Word32 -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313576"><span class="hs-identifier hs-var">addCksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313657"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-1910"></span><span>
</span><span id="line-1911"></span><span>        </span><span class="hs-comment">-- rh == ringHead</span><span>
</span><span id="line-1912"></span><span>        </span><span id="local-6989586621679313580"><span class="annot"><span class="annottext">go0 :: SPEC -&gt; Int -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313580"><span class="hs-identifier hs-var hs-var">go0</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313568"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313568"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313567"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313567"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span id="local-6989586621679313566"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313566"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313565"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313565"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1913"></span><span>            </span><span id="local-6989586621679313564"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313564"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313653"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313584"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313566"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1914"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313564"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1915"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313563"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313563"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313562"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313562"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1916"></span><span>                    </span><span id="local-6989586621679313561"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313561"><span class="hs-identifier hs-var">rh'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ptr a) -&gt; m (Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Ptr a) -&gt; m (Ptr a)) -&gt; IO (Ptr a) -&gt; m (Ptr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
forall a. Storable a =&gt; Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
</span><a href="Streamly.Memory.Ring.html#unsafeInsert"><span class="hs-identifier hs-var">RB.unsafeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313567"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313563"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1917"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313568"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313648"><span class="hs-identifier hs-var">maxIndex</span></a></span><span>
</span><span id="line-1918"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1919"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313559"><span class="annot"><span class="annottext">fold :: (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
</span><a href="#local-6989586621679313559"><span class="hs-identifier hs-var hs-var">fold</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
forall a b.
Storable a =&gt;
Ptr a -&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
</span><a href="Streamly.Memory.Ring.html#unsafeFoldRing"><span class="hs-identifier hs-var">RB.unsafeFoldRing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a
forall a. Ring a -&gt; Ptr a
</span><a href="Streamly.Memory.Ring.html#ringBound"><span class="hs-identifier hs-var hs-var">RB.ringBound</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1920"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313556"><span class="annot"><span class="annottext">ringHash :: Word32
</span><a href="#local-6989586621679313556"><span class="hs-identifier hs-var hs-var">ringHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; a -&gt; Word32) -&gt; Word32 -&gt; Ring a -&gt; Word32
forall b. (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
</span><a href="#local-6989586621679313559"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; Word32
forall a. Enum a =&gt; Word32 -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313576"><span class="hs-identifier hs-var">addCksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span><span>
</span><span id="line-1921"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313556"><span class="hs-identifier hs-var">ringHash</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313569"><span class="hs-identifier hs-var">patHash</span></a></span><span>
</span><span id="line-1922"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313555"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313556"><span class="hs-identifier hs-var">ringHash</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313561"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313562"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313565"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1923"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313554"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313556"><span class="hs-identifier hs-var">ringHash</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313561"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313562"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313565"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1924"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313580"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313568"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313561"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313562"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313565"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1925"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313553"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313553"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313580"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313568"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313567"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313553"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313565"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1926"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1927"></span><span>                    </span><span class="hs-glyph">!</span><span id="local-6989586621679313552"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313552"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313568"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1928"></span><span>                             </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; (s -&gt; a -&gt; m s) -&gt; s -&gt; Ring a -&gt; m s
forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="Streamly.Memory.Ring.html#unsafeFoldRingM"><span class="hs-identifier hs-var">RB.unsafeFoldRingM</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313567"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313656"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313565"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span><span>
</span><span id="line-1929"></span><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313565"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1930"></span><span>                    </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313552"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313550"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313550"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313550"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-1931"></span><span>
</span><span id="line-1932"></span><span>        </span><span class="hs-comment">-- XXX Theoretically this code can do 4 times faster if GHC generates</span><span>
</span><span id="line-1933"></span><span>        </span><span class="hs-comment">-- optimal code. If we use just &quot;(cksum' == patHash)&quot; condition it goes</span><span>
</span><span id="line-1934"></span><span>        </span><span class="hs-comment">-- 4x faster, as soon as we add the &quot;RB.unsafeEqArray rb v&quot; condition</span><span>
</span><span id="line-1935"></span><span>        </span><span class="hs-comment">-- the generated code changes drastically and becomes 4x slower. Need</span><span>
</span><span id="line-1936"></span><span>        </span><span class="hs-comment">-- to investigate what is going on with GHC.</span><span>
</span><span id="line-1937"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679313554"><span class="hs-pragma hs-type">go1</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1938"></span><span>        </span><span id="local-6989586621679313554"><span class="annot"><span class="annottext">go1 :: SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313554"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313549"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313549"><span class="hs-identifier hs-var">cksum</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313548"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313548"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span id="local-6989586621679313547"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313547"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313546"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313546"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1939"></span><span>            </span><span id="local-6989586621679313545"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313545"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313653"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313584"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313547"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1940"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313545"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1941"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313544"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313544"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313543"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313543"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1942"></span><span>                    </span><span id="local-6989586621679313542"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313542"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; m a) -&gt; IO a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; IO a
forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313548"><span class="hs-identifier hs-var">rh</span></a></span><span>
</span><span id="line-1943"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313540"><span class="annot"><span class="annottext">cksum' :: Word32
</span><a href="#local-6989586621679313540"><span class="hs-identifier hs-var hs-var">cksum'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; a -&gt; Word32
forall a a. (Enum a, Enum a) =&gt; Word32 -&gt; a -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313573"><span class="hs-identifier hs-var">deltaCksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313549"><span class="hs-identifier hs-var">cksum</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313542"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313544"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1944"></span><span>                    </span><span id="local-6989586621679313539"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313539"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313656"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313546"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313542"><span class="hs-identifier hs-var">old</span></a></span><span>
</span><span id="line-1945"></span><span>
</span><span id="line-1946"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313540"><span class="hs-identifier hs-var">cksum'</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313569"><span class="hs-identifier hs-var">patHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1947"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1948"></span><span>                        </span><span id="local-6989586621679313538"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313538"><span class="hs-identifier hs-var">rh'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ptr a) -&gt; m (Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
forall a. Storable a =&gt; Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
</span><a href="Streamly.Memory.Ring.html#unsafeInsert"><span class="hs-identifier hs-var">RB.unsafeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313548"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313544"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1949"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313555"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313540"><span class="hs-identifier hs-var">cksum'</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313538"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313543"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313539"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1950"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1951"></span><span>                        </span><span id="local-6989586621679313537"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313537"><span class="hs-identifier hs-var">rh'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ptr a) -&gt; m (Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
forall a. Storable a =&gt; Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
</span><a href="Streamly.Memory.Ring.html#unsafeInsert"><span class="hs-identifier hs-var">RB.unsafeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313548"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313544"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1952"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313554"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313540"><span class="hs-identifier hs-var">cksum'</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313537"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313543"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313539"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1953"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313536"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313536"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313554"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313549"><span class="hs-identifier hs-var">cksum</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313548"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313536"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313546"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1954"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1955"></span><span>                    </span><span id="local-6989586621679313535"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313535"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; (s -&gt; a -&gt; m s) -&gt; s -&gt; Ring a -&gt; m s
forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="Streamly.Memory.Ring.html#unsafeFoldRingFullM"><span class="hs-identifier hs-var">RB.unsafeFoldRingFullM</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313548"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313656"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313546"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span><span>
</span><span id="line-1956"></span><span>                    </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313535"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313533"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313533"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313533"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-1957"></span><span>
</span><span id="line-1958"></span><span>        </span><span id="local-6989586621679313555"><span class="annot"><span class="annottext">go2 :: SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313555"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313532"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313532"><span class="hs-identifier hs-var">cksum'</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313531"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313531"><span class="hs-identifier hs-var">rh'</span></a></span></span><span> </span><span id="local-6989586621679313530"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313530"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313529"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313529"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1959"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; Array a -&gt; Bool
forall a. Ring a -&gt; Ptr a -&gt; Array a -&gt; Bool
</span><a href="Streamly.Memory.Ring.html#unsafeEqArray"><span class="hs-identifier hs-var">RB.unsafeEqArray</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313531"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313657"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-1960"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1961"></span><span>                </span><span id="local-6989586621679313527"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313527"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313529"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1962"></span><span>                </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313527"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
forall s a. s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_KARP_RABIN"><span class="hs-identifier hs-var">GO_KARP_RABIN</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313530"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313582"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313581"><span class="hs-identifier hs-var">rhead</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1963"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313554"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313532"><span class="hs-identifier hs-var">cksum'</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313531"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313530"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313529"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-1964"></span><span>
</span><span id="line-1965"></span><span>    </span><span class="annot"><a href="#local-6989586621679313651"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679313526"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313526"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_EMPTY_PAT"><span class="hs-identifier hs-type">GO_EMPTY_PAT</span></a></span><span> </span><span id="local-6989586621679313525"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313525"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1966"></span><span>        </span><span id="local-6989586621679313524"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313524"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313653"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313526"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313525"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1967"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313524"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1968"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313523"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313523"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313522"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313522"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1969"></span><span>                </span><span id="local-6989586621679313521"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313521"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313655"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1970"></span><span>                </span><span id="local-6989586621679313520"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313520"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313656"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313521"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313523"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1971"></span><span>                </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313654"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313520"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313519"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313519"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313519"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_EMPTY_PAT"><span class="hs-identifier hs-var">GO_EMPTY_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313522"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1972"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313518"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313518"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_EMPTY_PAT"><span class="hs-identifier hs-var">GO_EMPTY_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313518"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1973"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1974"></span><span>
</span><span id="line-1975"></span><span>    </span><span class="annot"><a href="#local-6989586621679313651"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-1976"></span><span>
</span><span id="line-1977"></span><span class="hs-pragma">{-# INLINE_NORMAL splitSuffixOn #-}</span><span>
</span><span id="line-1978"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitSuffixOn"><span class="hs-identifier hs-type">splitSuffixOn</span></a></span><span>
</span><span id="line-1979"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679313517"><span class="annot"><a href="#local-6989586621679313517"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679313516"><span class="annot"><a href="#local-6989586621679313516"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679313515"><span class="annot"><a href="#local-6989586621679313515"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679313517"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679313516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Enum</span></span><span> </span><span class="annot"><a href="#local-6989586621679313516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679313516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1980"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1981"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313516"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1982"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313517"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313516"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313515"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-1983"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313517"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313516"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1984"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313517"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313515"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-1985"></span><span id="splitSuffixOn"><span class="annot"><span class="annottext">splitSuffixOn :: Bool -&gt; Array a -&gt; Fold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitSuffixOn"><span class="hs-identifier hs-var hs-var">splitSuffixOn</span></a></span></span><span> </span><span id="local-6989586621679313514"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span></span><span> </span><span id="local-6989586621679313513"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313513"><span class="hs-identifier hs-var">patArr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679313512"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679313511"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313511"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679313510"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1986"></span><span>                </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313509"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313508"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313508"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1987"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; SplitOnState s a -&gt; m (Step (SplitOnState s a) b))
-&gt; SplitOnState s a -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; SplitOnState s a -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; SplitOnState s a -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313507"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_START"><span class="hs-identifier hs-var">GO_START</span></a></span><span>
</span><span id="line-1988"></span><span>
</span><span id="line-1989"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1990"></span><span>
</span><span id="line-1991"></span><span>    </span><span id="local-6989586621679313506"><span class="annot"><span class="annottext">patLen :: Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var hs-var">patLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Array a -&gt; Int
forall a. Storable a =&gt; Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#length"><span class="hs-identifier hs-var">A.length</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313513"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-1992"></span><span>    </span><span id="local-6989586621679313505"><span class="annot"><span class="annottext">maxIndex :: Int
</span><a href="#local-6989586621679313505"><span class="hs-identifier hs-var hs-var">maxIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1993"></span><span>    </span><span id="local-6989586621679313504"><span class="annot"><span class="annottext">elemBits :: Int
</span><a href="#local-6989586621679313504"><span class="hs-identifier hs-var hs-var">elemBits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679313516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-1994"></span><span>
</span><span id="line-1995"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE stepOuter #-}</span><span>
</span><span id="line-1996"></span><span>    </span><span id="local-6989586621679313507"><span class="annot"><span class="annottext">stepOuter :: State Stream m a
-&gt; SplitOnState s a -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313507"><span class="hs-identifier hs-var hs-var">stepOuter</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_START"><span class="hs-identifier hs-var">GO_START</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1997"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1998"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitOnState s a -&gt; Step (SplitOnState s a) b)
-&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_EMPTY_PAT"><span class="hs-identifier hs-var">GO_EMPTY_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313508"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1999"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2000"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2001"></span><span>                </span><span id="local-6989586621679313503"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313503"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; m a) -&gt; IO a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array a -&gt; Int -&gt; IO a
forall a. Storable a =&gt; Array a -&gt; Int -&gt; IO a
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#unsafeIndexIO"><span class="hs-identifier hs-var">A.unsafeIndexIO</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313513"><span class="hs-identifier hs-var">patArr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-2002"></span><span>                </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitOnState s a -&gt; Step (SplitOnState s a) b)
-&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; SplitOnState s a
forall s a. s -&gt; a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SINGLE_PAT"><span class="hs-identifier hs-var">GO_SINGLE_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313508"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313503"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-2003"></span><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679313516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-2004"></span><span>                    </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span class="hs-special">)</span><span>
</span><span id="line-2005"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitOnState s a -&gt; Step (SplitOnState s a) b)
-&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-var">GO_SHORT_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313508"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-2006"></span><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2007"></span><span>                    </span><span class="hs-special">(</span><span id="local-6989586621679313502"><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313502"><span class="hs-identifier hs-var">rb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313501"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313501"><span class="hs-identifier hs-var">rhead</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ring a, Ptr a) -&gt; m (Ring a, Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Ring a, Ptr a) -&gt; m (Ring a, Ptr a))
-&gt; IO (Ring a, Ptr a) -&gt; m (Ring a, Ptr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (Ring a, Ptr a)
forall a. Storable a =&gt; Int -&gt; IO (Ring a, Ptr a)
</span><a href="Streamly.Memory.Ring.html#new"><span class="hs-identifier hs-var">RB.new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-2008"></span><span>                    </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitOnState s a -&gt; Step (SplitOnState s a) b)
-&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
forall s a. s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_KARP_RABIN"><span class="hs-identifier hs-var">GO_KARP_RABIN</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313508"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313502"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313501"><span class="hs-identifier hs-var">rhead</span></a></span><span>
</span><span id="line-2009"></span><span>
</span><span id="line-2010"></span><span>    </span><span class="annot"><a href="#local-6989586621679313507"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679313500"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313500"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SINGLE_PAT"><span class="hs-identifier hs-type">GO_SINGLE_PAT</span></a></span><span> </span><span id="local-6989586621679313499"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313499"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span id="local-6989586621679313498"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313498"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2011"></span><span>        </span><span class="hs-comment">-- This first part is the only difference between splitOn and</span><span>
</span><span id="line-2012"></span><span>        </span><span class="hs-comment">-- splitSuffixOn.</span><span>
</span><span id="line-2013"></span><span>        </span><span class="hs-comment">-- If the last element is a separator do not issue a blank segment.</span><span>
</span><span id="line-2014"></span><span>        </span><span id="local-6989586621679313497"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313497"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313500"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313499"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-2015"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313497"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2016"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313496"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313496"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313495"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313495"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2017"></span><span>                </span><span id="local-6989586621679313494"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313494"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313511"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-2018"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313498"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313496"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2019"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2020"></span><span>                    </span><span id="local-6989586621679313493"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313493"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313494"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313496"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313494"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2021"></span><span>                    </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313493"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313492"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313492"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313492"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; a -&gt; SplitOnState s a
forall s a. s -&gt; a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SINGLE_PAT"><span class="hs-identifier hs-var">GO_SINGLE_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313495"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313498"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2022"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313494"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313496"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313491"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313495"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-2023"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313490"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313490"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitOnState s a -&gt; Step (SplitOnState s a) b)
-&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; a -&gt; SplitOnState s a
forall s a. s -&gt; a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SINGLE_PAT"><span class="hs-identifier hs-var">GO_SINGLE_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313490"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313498"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2024"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2025"></span><span>
</span><span id="line-2026"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-2027"></span><span>
</span><span id="line-2028"></span><span>        </span><span class="hs-comment">-- This is identical for splitOn and splitSuffixOn</span><span>
</span><span id="line-2029"></span><span>        </span><span id="local-6989586621679313491"><span class="annot"><span class="annottext">go :: SPEC -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313491"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313489"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313489"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313488"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313488"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2030"></span><span>            </span><span id="local-6989586621679313487"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313487"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313500"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313489"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2031"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313487"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2032"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313486"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313486"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313485"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313485"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2033"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313498"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313486"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2034"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2035"></span><span>                        </span><span id="local-6989586621679313484"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313484"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313488"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313486"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313488"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2036"></span><span>                        </span><span id="local-6989586621679313483"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313483"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313484"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2037"></span><span>                        </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313483"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; a -&gt; SplitOnState s a
forall s a. s -&gt; a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SINGLE_PAT"><span class="hs-identifier hs-var">GO_SINGLE_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313485"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313498"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2038"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313488"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313486"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m s
-&gt; (s -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313491"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313485"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-2039"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313482"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313482"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313491"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313482"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313488"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2040"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313488"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313481"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313481"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313481"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-2041"></span><span>
</span><span id="line-2042"></span><span>    </span><span class="annot"><a href="#local-6989586621679313507"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679313480"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313480"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-type">GO_SHORT_PAT</span></a></span><span> </span><span id="local-6989586621679313479"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313479"><span class="hs-identifier hs-var">stt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2043"></span><span>
</span><span id="line-2044"></span><span>        </span><span class="hs-comment">-- Call &quot;initial&quot; only if the stream yields an element, otherwise we</span><span>
</span><span id="line-2045"></span><span>        </span><span class="hs-comment">-- may call &quot;initial&quot; but never yield anything. initial may produce a</span><span>
</span><span id="line-2046"></span><span>        </span><span class="hs-comment">-- side effect, therefore we will end up doing and discard a side</span><span>
</span><span id="line-2047"></span><span>        </span><span class="hs-comment">-- effect.</span><span>
</span><span id="line-2048"></span><span>
</span><span id="line-2049"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313478"><span class="annot"><span class="annottext">idx :: Int
</span><a href="#local-6989586621679313478"><span class="hs-identifier hs-var hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2050"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313477"><span class="annot"><span class="annottext">wrd :: Word
</span><a href="#local-6989586621679313477"><span class="hs-identifier hs-var hs-var">wrd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2051"></span><span>        </span><span id="local-6989586621679313476"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313476"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313480"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313479"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-2052"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313476"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2053"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313475"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313475"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313474"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313474"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2054"></span><span>                </span><span id="local-6989586621679313473"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313473"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313511"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-2055"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313472"><span class="annot"><span class="annottext">wrd' :: Word
</span><a href="#local-6989586621679313472"><span class="hs-identifier hs-var hs-var">wrd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; a -&gt; Word
forall a a. (Bits a, Num a, Enum a) =&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679313471"><span class="hs-identifier hs-var">addToWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313477"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313475"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2056"></span><span>                </span><span id="local-6989586621679313470"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313470"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313473"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313475"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313473"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2057"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313478"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313505"><span class="hs-identifier hs-var">maxIndex</span></a></span><span>
</span><span id="line-2058"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2059"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313472"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313469"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313468"><span class="hs-identifier hs-var">patWord</span></a></span><span>
</span><span id="line-2060"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313470"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313467"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313467"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313467"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-var">GO_SHORT_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313474"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2061"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
forall a.
SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313466"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313478"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313472"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313474"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313470"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2062"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
forall a.
SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313466"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313478"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313472"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313474"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313470"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2063"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313465"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313465"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-var">GO_SHORT_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313465"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2064"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2065"></span><span>
</span><span id="line-2066"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-2067"></span><span>
</span><span id="line-2068"></span><span>        </span><span class="annot"><a href="#local-6989586621679313469"><span class="hs-identifier hs-type">mask</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-2069"></span><span>        </span><span id="local-6989586621679313469"><span class="annot"><span class="annottext">mask :: Word
</span><a href="#local-6989586621679313469"><span class="hs-identifier hs-var hs-var">mask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; Word
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313504"><span class="hs-identifier hs-var">elemBits</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var">patLen</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2070"></span><span>
</span><span id="line-2071"></span><span>        </span><span id="local-6989586621679313471"><span class="annot"><span class="annottext">addToWord :: a -&gt; a -&gt; a
</span><a href="#local-6989586621679313471"><span class="hs-identifier hs-var hs-var">addToWord</span></a></span></span><span> </span><span id="local-6989586621679313464"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313464"><span class="hs-identifier hs-var">wrd</span></a></span></span><span> </span><span id="local-6989586621679313463"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313463"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313464"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; a
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313504"><span class="hs-identifier hs-var">elemBits</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313463"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2072"></span><span>
</span><span id="line-2073"></span><span>        </span><span class="annot"><a href="#local-6989586621679313468"><span class="hs-identifier hs-type">patWord</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-2074"></span><span>        </span><span id="local-6989586621679313468"><span class="annot"><span class="annottext">patWord :: Word
</span><a href="#local-6989586621679313468"><span class="hs-identifier hs-var hs-var">patWord</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313469"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">(Word -&gt; a -&gt; Word) -&gt; Word -&gt; Array a -&gt; Word
forall a b. Storable a =&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Array a -&gt; b
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#foldl%27"><span class="hs-identifier hs-var">A.foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; a -&gt; Word
forall a a. (Bits a, Num a, Enum a) =&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679313471"><span class="hs-identifier hs-var">addToWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313513"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-2075"></span><span>
</span><span id="line-2076"></span><span>        </span><span id="local-6989586621679313466"><span class="annot"><span class="annottext">go0 :: SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313466"><span class="hs-identifier hs-var hs-var">go0</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313462"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313462"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621679313461"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313461"><span class="hs-identifier hs-var">wrd</span></a></span></span><span> </span><span id="local-6989586621679313460"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313460"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313459"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313459"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2077"></span><span>            </span><span id="local-6989586621679313458"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313458"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313480"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313460"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2078"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313458"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2079"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313457"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313457"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313456"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313456"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2080"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313455"><span class="annot"><span class="annottext">wrd' :: Word
</span><a href="#local-6989586621679313455"><span class="hs-identifier hs-var hs-var">wrd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; a -&gt; Word
forall a a. (Bits a, Num a, Enum a) =&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679313471"><span class="hs-identifier hs-var">addToWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313461"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313457"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2081"></span><span>                    </span><span id="local-6989586621679313454"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313454"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313459"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313457"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313459"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2082"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313462"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313505"><span class="hs-identifier hs-var">maxIndex</span></a></span><span>
</span><span id="line-2083"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2084"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313455"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313469"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313468"><span class="hs-identifier hs-var">patWord</span></a></span><span>
</span><span id="line-2085"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2086"></span><span>                            </span><span id="local-6989586621679313453"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313453"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313454"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2087"></span><span>                            </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313453"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-var">GO_SHORT_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313456"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2088"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
forall a. SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313452"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313455"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313456"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313454"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2089"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313466"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313462"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313455"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313456"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313454"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2090"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313451"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313451"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313466"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313462"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313461"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313451"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313459"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2091"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2092"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313462"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313505"><span class="hs-identifier hs-var">maxIndex</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313461"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313469"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313468"><span class="hs-identifier hs-var">patWord</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2093"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2094"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2095"></span><span>                        </span><span id="local-6989586621679313449"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313449"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313462"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span>
</span><span id="line-2096"></span><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; s -&gt; m s
</span><a href="#local-6989586621679313448"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313461"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313462"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313459"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2097"></span><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313459"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2098"></span><span>                        </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313449"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313447"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313447"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313447"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-2099"></span><span>
</span><span id="line-2100"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679313452"><span class="hs-pragma hs-type">go1</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-2101"></span><span>        </span><span id="local-6989586621679313452"><span class="annot"><span class="annottext">go1 :: SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313452"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313446"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313446"><span class="hs-identifier hs-var">wrd</span></a></span></span><span> </span><span id="local-6989586621679313445"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313445"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313444"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313444"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2102"></span><span>            </span><span id="local-6989586621679313443"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313443"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313480"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313445"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2103"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313443"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2104"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313442"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313442"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313441"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313441"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2105"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313440"><span class="annot"><span class="annottext">wrd' :: Word
</span><a href="#local-6989586621679313440"><span class="hs-identifier hs-var hs-var">wrd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; a -&gt; Word
forall a a. (Bits a, Num a, Enum a) =&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679313471"><span class="hs-identifier hs-var">addToWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313446"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313442"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2106"></span><span>                        </span><span id="local-6989586621679313439"><span class="annot"><span class="annottext">old :: Word
</span><a href="#local-6989586621679313439"><span class="hs-identifier hs-var hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313469"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313446"><span class="hs-identifier hs-var">wrd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; Word
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftR`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313504"><span class="hs-identifier hs-var">elemBits</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2107"></span><span>                    </span><span id="local-6989586621679313438"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313438"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span>
</span><span id="line-2108"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313444"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313442"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2109"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313444"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; a
forall a. Enum a =&gt; Int -&gt; a
</span><span class="hs-identifier hs-var">toEnum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; a) -&gt; Int -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313439"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2110"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313440"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313469"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313468"><span class="hs-identifier hs-var">patWord</span></a></span><span>
</span><span id="line-2111"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313438"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313437"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313437"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313437"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_SHORT_PAT"><span class="hs-identifier hs-var">GO_SHORT_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313441"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2112"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313452"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313440"><span class="hs-identifier hs-var">wrd'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313441"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313438"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2113"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313436"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313436"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313452"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313446"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313436"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313444"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2114"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2115"></span><span>                    </span><span class="hs-comment">-- If the last sequence is a separator do not issue a blank</span><span>
</span><span id="line-2116"></span><span>                    </span><span class="hs-comment">-- segment.</span><span>
</span><span id="line-2117"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313446"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313469"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313468"><span class="hs-identifier hs-var">patWord</span></a></span><span>
</span><span id="line-2118"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2119"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2120"></span><span>                        </span><span id="local-6989586621679313435"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313435"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span>
</span><span id="line-2121"></span><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313444"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2122"></span><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; s -&gt; m s
</span><a href="#local-6989586621679313448"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313446"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313444"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2123"></span><span>                        </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313435"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313434"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313434"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313434"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-2124"></span><span>
</span><span id="line-2125"></span><span>        </span><span id="local-6989586621679313448"><span class="annot"><span class="annottext">go2 :: Word -&gt; Int -&gt; s -&gt; m s
</span><a href="#local-6989586621679313448"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313433"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313433"><span class="hs-identifier hs-var">wrd</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313432"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313432"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313431"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313431"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313432"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2126"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313430"><span class="annot"><span class="annottext">old :: Word
</span><a href="#local-6989586621679313430"><span class="hs-identifier hs-var hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313469"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313433"><span class="hs-identifier hs-var">wrd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; Word
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftR`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313504"><span class="hs-identifier hs-var">elemBits</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313432"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2127"></span><span>            </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313431"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; a
forall a. Enum a =&gt; Int -&gt; a
</span><span class="hs-identifier hs-var">toEnum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; a) -&gt; Int -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313430"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m s -&gt; (s -&gt; m s) -&gt; m s
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Int -&gt; s -&gt; m s
</span><a href="#local-6989586621679313448"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679313433"><span class="hs-identifier hs-var">wrd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313432"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-2128"></span><span>        </span><span class="annot"><a href="#local-6989586621679313448"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679313429"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313429"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313429"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2129"></span><span>
</span><span id="line-2130"></span><span>    </span><span class="annot"><a href="#local-6989586621679313507"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679313428"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313428"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_KARP_RABIN"><span class="hs-identifier hs-type">GO_KARP_RABIN</span></a></span><span> </span><span id="local-6989586621679313427"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313427"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span id="local-6989586621679313426"><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span></span><span> </span><span id="local-6989586621679313425"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313425"><span class="hs-identifier hs-var">rhead</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2131"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313424"><span class="annot"><span class="annottext">idx :: Int
</span><a href="#local-6989586621679313424"><span class="hs-identifier hs-var hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2132"></span><span>        </span><span id="local-6989586621679313423"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313423"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313428"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313427"><span class="hs-identifier hs-var">stt</span></a></span><span>
</span><span id="line-2133"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313423"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2134"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313422"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313422"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313421"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313421"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2135"></span><span>                </span><span id="local-6989586621679313420"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313420"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313511"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-2136"></span><span>                </span><span id="local-6989586621679313419"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313419"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313420"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313422"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313420"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2137"></span><span>                </span><span id="local-6989586621679313418"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313418"><span class="hs-identifier hs-var">rh'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ptr a) -&gt; m (Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
forall a. Storable a =&gt; Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
</span><a href="Streamly.Memory.Ring.html#unsafeInsert"><span class="hs-identifier hs-var">RB.unsafeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313425"><span class="hs-identifier hs-var">rhead</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313422"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2138"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313424"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313505"><span class="hs-identifier hs-var">maxIndex</span></a></span><span>
</span><span id="line-2139"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2140"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313417"><span class="annot"><span class="annottext">fold :: (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
</span><a href="#local-6989586621679313417"><span class="hs-identifier hs-var hs-var">fold</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
forall a b.
Storable a =&gt;
Ptr a -&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
</span><a href="Streamly.Memory.Ring.html#unsafeFoldRing"><span class="hs-identifier hs-var">RB.unsafeFoldRing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a
forall a. Ring a -&gt; Ptr a
</span><a href="Streamly.Memory.Ring.html#ringBound"><span class="hs-identifier hs-var hs-var">RB.ringBound</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2141"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313416"><span class="annot"><span class="annottext">ringHash :: Word32
</span><a href="#local-6989586621679313416"><span class="hs-identifier hs-var hs-var">ringHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; a -&gt; Word32) -&gt; Word32 -&gt; Ring a -&gt; Word32
forall b. (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
</span><a href="#local-6989586621679313417"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; Word32
forall a. Enum a =&gt; Word32 -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313415"><span class="hs-identifier hs-var">addCksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span>
</span><span id="line-2142"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313416"><span class="hs-identifier hs-var">ringHash</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313414"><span class="hs-identifier hs-var">patHash</span></a></span><span>
</span><span id="line-2143"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313413"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313416"><span class="hs-identifier hs-var">ringHash</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313418"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313421"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313419"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2144"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313412"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313424"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313418"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313421"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313419"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2145"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313412"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313424"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313418"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313421"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313419"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2146"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313411"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313411"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
forall s a. s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_KARP_RABIN"><span class="hs-identifier hs-var">GO_KARP_RABIN</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313411"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313425"><span class="hs-identifier hs-var">rhead</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2147"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2148"></span><span>
</span><span id="line-2149"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-2150"></span><span>
</span><span id="line-2151"></span><span>        </span><span id="local-6989586621679313410"><span class="annot"><span class="annottext">k :: Word32
</span><a href="#local-6989586621679313410"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">2891336453</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-2152"></span><span>        </span><span id="local-6989586621679313409"><span class="annot"><span class="annottext">coeff :: Word32
</span><a href="#local-6989586621679313409"><span class="hs-identifier hs-var hs-var">coeff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313410"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><span class="hs-operator hs-var">^</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313506"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-2153"></span><span>        </span><span id="local-6989586621679313415"><span class="annot"><span class="annottext">addCksum :: Word32 -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313415"><span class="hs-identifier hs-var hs-var">addCksum</span></a></span></span><span> </span><span id="local-6989586621679313408"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313408"><span class="hs-identifier hs-var">cksum</span></a></span></span><span> </span><span id="local-6989586621679313407"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313407"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313408"><span class="hs-identifier hs-var">cksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313410"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313407"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2154"></span><span>        </span><span id="local-6989586621679313406"><span class="annot"><span class="annottext">deltaCksum :: Word32 -&gt; a -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313406"><span class="hs-identifier hs-var hs-var">deltaCksum</span></a></span></span><span> </span><span id="local-6989586621679313405"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313405"><span class="hs-identifier hs-var">cksum</span></a></span></span><span> </span><span id="local-6989586621679313404"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313404"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621679313403"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313403"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2155"></span><span>            </span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; Word32
forall a. Enum a =&gt; Word32 -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313415"><span class="hs-identifier hs-var">addCksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313405"><span class="hs-identifier hs-var">cksum</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313403"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313409"><span class="hs-identifier hs-var">coeff</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313404"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2156"></span><span>
</span><span id="line-2157"></span><span>        </span><span class="hs-comment">-- XXX shall we use a random starting hash or 1 instead of 0?</span><span>
</span><span id="line-2158"></span><span>        </span><span id="local-6989586621679313414"><span class="annot"><span class="annottext">patHash :: Word32
</span><a href="#local-6989586621679313414"><span class="hs-identifier hs-var hs-var">patHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; a -&gt; Word32) -&gt; Word32 -&gt; Array a -&gt; Word32
forall a b. Storable a =&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Array a -&gt; b
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#foldl%27"><span class="hs-identifier hs-var">A.foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; Word32
forall a. Enum a =&gt; Word32 -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313415"><span class="hs-identifier hs-var">addCksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313513"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-2159"></span><span>
</span><span id="line-2160"></span><span>        </span><span class="hs-comment">-- rh == ringHead</span><span>
</span><span id="line-2161"></span><span>        </span><span id="local-6989586621679313412"><span class="annot"><span class="annottext">go0 :: SPEC -&gt; Int -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313412"><span class="hs-identifier hs-var hs-var">go0</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313402"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313402"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313401"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313401"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span id="local-6989586621679313400"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313400"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313399"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313399"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2162"></span><span>            </span><span id="local-6989586621679313398"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313398"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313428"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313400"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2163"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313398"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2164"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313397"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313397"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313396"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313396"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2165"></span><span>                    </span><span id="local-6989586621679313395"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313395"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313399"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313397"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313399"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2166"></span><span>                    </span><span id="local-6989586621679313394"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313394"><span class="hs-identifier hs-var">rh'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ptr a) -&gt; m (Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
forall a. Storable a =&gt; Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
</span><a href="Streamly.Memory.Ring.html#unsafeInsert"><span class="hs-identifier hs-var">RB.unsafeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313401"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313397"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2167"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313402"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313505"><span class="hs-identifier hs-var">maxIndex</span></a></span><span>
</span><span id="line-2168"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2169"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313393"><span class="annot"><span class="annottext">fold :: (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
</span><a href="#local-6989586621679313393"><span class="hs-identifier hs-var hs-var">fold</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
forall a b.
Storable a =&gt;
Ptr a -&gt; (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
</span><a href="Streamly.Memory.Ring.html#unsafeFoldRing"><span class="hs-identifier hs-var">RB.unsafeFoldRing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a
forall a. Ring a -&gt; Ptr a
</span><a href="Streamly.Memory.Ring.html#ringBound"><span class="hs-identifier hs-var hs-var">RB.ringBound</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2170"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313392"><span class="annot"><span class="annottext">ringHash :: Word32
</span><a href="#local-6989586621679313392"><span class="hs-identifier hs-var hs-var">ringHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; a -&gt; Word32) -&gt; Word32 -&gt; Ring a -&gt; Word32
forall b. (b -&gt; a -&gt; b) -&gt; b -&gt; Ring a -&gt; b
</span><a href="#local-6989586621679313393"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; Word32
forall a. Enum a =&gt; Word32 -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313415"><span class="hs-identifier hs-var">addCksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span>
</span><span id="line-2171"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313392"><span class="hs-identifier hs-var">ringHash</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313414"><span class="hs-identifier hs-var">patHash</span></a></span><span>
</span><span id="line-2172"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313413"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313392"><span class="hs-identifier hs-var">ringHash</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313394"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313396"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313395"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2173"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313391"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313392"><span class="hs-identifier hs-var">ringHash</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313394"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313396"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313395"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2174"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313412"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313402"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313394"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313396"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313395"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2175"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313390"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313390"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Int -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313412"><span class="hs-identifier hs-var">go0</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313402"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313401"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313390"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313399"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2176"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2177"></span><span>                    </span><span class="hs-comment">-- do not issue a blank segment when we end at pattern</span><span>
</span><span id="line-2178"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313402"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313505"><span class="hs-identifier hs-var">maxIndex</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; Array a -&gt; Bool
forall a. Ring a -&gt; Ptr a -&gt; Array a -&gt; Bool
</span><a href="Streamly.Memory.Ring.html#unsafeEqArray"><span class="hs-identifier hs-var">RB.unsafeEqArray</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313401"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313513"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-2179"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2180"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2181"></span><span>                        </span><span class="hs-glyph">!</span><span id="local-6989586621679313389"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313389"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679313402"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span>
</span><span id="line-2182"></span><span>                                 </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; (s -&gt; a -&gt; m s) -&gt; s -&gt; Ring a -&gt; m s
forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="Streamly.Memory.Ring.html#unsafeFoldRingM"><span class="hs-identifier hs-var">RB.unsafeFoldRingM</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313401"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313399"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span>
</span><span id="line-2183"></span><span>                                 </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313399"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2184"></span><span>                        </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313389"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313388"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313388"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313388"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-2185"></span><span>
</span><span id="line-2186"></span><span>        </span><span class="hs-comment">-- XXX Theoretically this code can do 4 times faster if GHC generates</span><span>
</span><span id="line-2187"></span><span>        </span><span class="hs-comment">-- optimal code. If we use just &quot;(cksum' == patHash)&quot; condition it goes</span><span>
</span><span id="line-2188"></span><span>        </span><span class="hs-comment">-- 4x faster, as soon as we add the &quot;RB.unsafeEqArray rb v&quot; condition</span><span>
</span><span id="line-2189"></span><span>        </span><span class="hs-comment">-- the generated code changes drastically and becomes 4x slower. Need</span><span>
</span><span id="line-2190"></span><span>        </span><span class="hs-comment">-- to investigate what is going on with GHC.</span><span>
</span><span id="line-2191"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679313391"><span class="hs-pragma hs-type">go1</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-2192"></span><span>        </span><span id="local-6989586621679313391"><span class="annot"><span class="annottext">go1 :: SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313391"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313387"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313387"><span class="hs-identifier hs-var">cksum</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313386"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313386"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span id="local-6989586621679313385"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313385"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313384"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313384"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2193"></span><span>            </span><span id="local-6989586621679313383"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313383"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313428"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313385"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2194"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313383"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2195"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313382"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313382"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313381"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313381"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2196"></span><span>                    </span><span id="local-6989586621679313380"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313380"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; m a) -&gt; IO a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; IO a
forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313386"><span class="hs-identifier hs-var">rh</span></a></span><span>
</span><span id="line-2197"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679313379"><span class="annot"><span class="annottext">cksum' :: Word32
</span><a href="#local-6989586621679313379"><span class="hs-identifier hs-var hs-var">cksum'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; a -&gt; Word32
forall a a. (Enum a, Enum a) =&gt; Word32 -&gt; a -&gt; a -&gt; Word32
</span><a href="#local-6989586621679313406"><span class="hs-identifier hs-var">deltaCksum</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313387"><span class="hs-identifier hs-var">cksum</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313380"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313382"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2198"></span><span>                    </span><span id="local-6989586621679313378"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313378"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span>
</span><span id="line-2199"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313384"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313382"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2200"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313384"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313380"><span class="hs-identifier hs-var">old</span></a></span><span>
</span><span id="line-2201"></span><span>
</span><span id="line-2202"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313379"><span class="hs-identifier hs-var">cksum'</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313414"><span class="hs-identifier hs-var">patHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2203"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2204"></span><span>                        </span><span id="local-6989586621679313377"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313377"><span class="hs-identifier hs-var">rh'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ptr a) -&gt; m (Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
forall a. Storable a =&gt; Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
</span><a href="Streamly.Memory.Ring.html#unsafeInsert"><span class="hs-identifier hs-var">RB.unsafeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313386"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313382"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2205"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313413"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313379"><span class="hs-identifier hs-var">cksum'</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313377"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313381"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313378"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2206"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2207"></span><span>                        </span><span id="local-6989586621679313376"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313376"><span class="hs-identifier hs-var">rh'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ptr a) -&gt; m (Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
forall a. Storable a =&gt; Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
</span><a href="Streamly.Memory.Ring.html#unsafeInsert"><span class="hs-identifier hs-var">RB.unsafeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313386"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313382"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2208"></span><span>                        </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313391"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313379"><span class="hs-identifier hs-var">cksum'</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313376"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313381"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313378"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2209"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313375"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313375"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313391"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313387"><span class="hs-identifier hs-var">cksum</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313386"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313375"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313384"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2210"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2211"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; Array a -&gt; Bool
forall a. Ring a -&gt; Ptr a -&gt; Array a -&gt; Bool
</span><a href="Streamly.Memory.Ring.html#unsafeEqArray"><span class="hs-identifier hs-var">RB.unsafeEqArray</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313386"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313513"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-2212"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2213"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2214"></span><span>                        </span><span id="local-6989586621679313374"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313374"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679313514"><span class="hs-identifier hs-var">withSep</span></a></span><span>
</span><span id="line-2215"></span><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">s -&gt; m s
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313384"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-2216"></span><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; (s -&gt; a -&gt; m s) -&gt; s -&gt; Ring a -&gt; m s
forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="Streamly.Memory.Ring.html#unsafeFoldRingFullM"><span class="hs-identifier hs-var">RB.unsafeFoldRingFullM</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313386"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313384"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span>
</span><span id="line-2217"></span><span>                        </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313374"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313373"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313373"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313373"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
forall s a. SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span>
</span><span id="line-2218"></span><span>
</span><span id="line-2219"></span><span>        </span><span id="local-6989586621679313413"><span class="annot"><span class="annottext">go2 :: SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313413"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313372"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313372"><span class="hs-identifier hs-var">cksum'</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313371"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313371"><span class="hs-identifier hs-var">rh'</span></a></span></span><span> </span><span id="local-6989586621679313370"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313370"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679313369"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313369"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2220"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; Array a -&gt; Bool
forall a. Ring a -&gt; Ptr a -&gt; Array a -&gt; Bool
</span><a href="Streamly.Memory.Ring.html#unsafeEqArray"><span class="hs-identifier hs-var">RB.unsafeEqArray</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313371"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679313513"><span class="hs-identifier hs-var">patArr</span></a></span><span>
</span><span id="line-2221"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2222"></span><span>                </span><span id="local-6989586621679313368"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313368"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313369"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2223"></span><span>                </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313368"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
forall s a. s -&gt; Ring a -&gt; Ptr a -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_KARP_RABIN"><span class="hs-identifier hs-var">GO_KARP_RABIN</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313370"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679313426"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313425"><span class="hs-identifier hs-var">rhead</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2224"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPEC -&gt; Word32 -&gt; Ptr a -&gt; s -&gt; s -&gt; m (Step (SplitOnState s a) b)
</span><a href="#local-6989586621679313391"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">SPEC
</span><span class="hs-identifier hs-var">SPEC</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679313372"><span class="hs-identifier hs-var">cksum'</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679313371"><span class="hs-identifier hs-var">rh'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313370"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313369"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-2225"></span><span>
</span><span id="line-2226"></span><span>    </span><span class="annot"><a href="#local-6989586621679313507"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span id="local-6989586621679313367"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313367"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_EMPTY_PAT"><span class="hs-identifier hs-type">GO_EMPTY_PAT</span></a></span><span> </span><span id="local-6989586621679313366"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313366"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2227"></span><span>        </span><span id="local-6989586621679313365"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313365"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313509"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313367"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313366"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2228"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313365"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2229"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313364"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313364"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313363"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313363"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2230"></span><span>                </span><span id="local-6989586621679313362"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313362"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679313511"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-2231"></span><span>                </span><span id="local-6989586621679313361"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313361"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679313512"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313362"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313364"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2232"></span><span>                </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679313510"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313361"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (SplitOnState s a) b))
-&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679313360"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313360"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313360"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_EMPTY_PAT"><span class="hs-identifier hs-var">GO_EMPTY_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313363"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2233"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313359"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313359"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b))
-&gt; Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a -&gt; Step (SplitOnState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitOnState s a
forall s a. s -&gt; SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_EMPTY_PAT"><span class="hs-identifier hs-var">GO_EMPTY_PAT</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313359"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2234"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2235"></span><span>
</span><span id="line-2236"></span><span>    </span><span class="annot"><a href="#local-6989586621679313507"><span class="hs-identifier hs-var">stepOuter</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SplitOnState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GO_DONE"><span class="hs-identifier hs-var">GO_DONE</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b -&gt; m (Step (SplitOnState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitOnState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2237"></span><span>
</span><span id="line-2238"></span><span class="hs-keyword">data</span><span> </span><span id="SplitState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitState"><span class="hs-identifier hs-var">SplitState</span></a></span></span><span> </span><span id="local-6989586621679315648"><span class="annot"><a href="#local-6989586621679315648"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679315647"><span class="annot"><a href="#local-6989586621679315647"><span class="hs-identifier hs-type">arr</span></a></span></span><span>
</span><span id="line-2239"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="SplitInitial"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitInitial"><span class="hs-identifier hs-var">SplitInitial</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315648"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-2240"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SplitBuffering"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-var">SplitBuffering</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315648"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315647"><span class="hs-identifier hs-type">arr</span></a></span><span>
</span><span id="line-2241"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SplitSplitting"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitSplitting"><span class="hs-identifier hs-var">SplitSplitting</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315648"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315647"><span class="hs-identifier hs-type">arr</span></a></span><span>
</span><span id="line-2242"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SplitYielding"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-var">SplitYielding</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315647"><span class="hs-identifier hs-type">arr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitState"><span class="hs-identifier hs-type">SplitState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315648"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315647"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2243"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SplitFinishing"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitFinishing"><span class="hs-identifier hs-var">SplitFinishing</span></a></span></span><span>
</span><span id="line-2244"></span><span>
</span><span id="line-2245"></span><span class="hs-comment">-- XXX An alternative approach would be to use a partial fold (Fold m a b) to</span><span>
</span><span id="line-2246"></span><span class="hs-comment">-- split using a splitBy like combinator. The Fold would consume upto the</span><span>
</span><span id="line-2247"></span><span class="hs-comment">-- separator and return any leftover which can then be fed to the next fold.</span><span>
</span><span id="line-2248"></span><span class="hs-comment">--</span><span>
</span><span id="line-2249"></span><span class="hs-comment">-- We can revisit this once we have partial folds/parsers.</span><span>
</span><span id="line-2250"></span><span class="hs-comment">--</span><span>
</span><span id="line-2251"></span><span class="hs-comment">-- | Performs infix separator style splitting.</span><span>
</span><span id="line-2252"></span><span class="hs-pragma">{-# INLINE_NORMAL splitInnerBy #-}</span><span>
</span><span id="line-2253"></span><span id="local-6989586621679313351"><span id="local-6989586621679313352"><span id="local-6989586621679313353"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitInnerBy"><span class="hs-identifier hs-type">splitInnerBy</span></a></span><span>
</span><span id="line-2254"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313353"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-2255"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313352"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313351"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313352"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313351"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313352"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313351"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- splitter</span><span>
</span><span id="line-2256"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313352"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313351"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313352"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313351"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313352"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313351"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- joiner</span><span>
</span><span id="line-2257"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313352"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313351"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2258"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313352"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313351"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-2259"></span><span id="splitInnerBy"><span class="annot"><span class="annottext">splitInnerBy :: (f a -&gt; m (f a, Maybe (f a)))
-&gt; (f a -&gt; f a -&gt; m (f a)) -&gt; Stream m (f a) -&gt; Stream m (f a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitInnerBy"><span class="hs-identifier hs-var hs-var">splitInnerBy</span></a></span></span><span> </span><span id="local-6989586621679313350"><span class="annot"><span class="annottext">f a -&gt; m (f a, Maybe (f a))
</span><a href="#local-6989586621679313350"><span class="hs-identifier hs-var">splitter</span></a></span></span><span> </span><span id="local-6989586621679313349"><span class="annot"><span class="annottext">f a -&gt; f a -&gt; m (f a)
</span><a href="#local-6989586621679313349"><span class="hs-identifier hs-var">joiner</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313348"><span class="annot"><span class="annottext">State Stream m (f a) -&gt; s -&gt; m (Step s (f a))
</span><a href="#local-6989586621679313348"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679313347"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313347"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2260"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m (f a)
 -&gt; SplitState s (f a) -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; SplitState s (f a) -&gt; Stream m (f a)
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
-&gt; SplitState s (f a) -&gt; m (Step (SplitState s (f a)) (f a))
</span><a href="#local-6989586621679313346"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitState s (f a)
forall s arr. s -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitInitial"><span class="hs-identifier hs-var">SplitInitial</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313347"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2261"></span><span>
</span><span id="line-2262"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2263"></span><span>
</span><span id="line-2264"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2265"></span><span>    </span><span id="local-6989586621679313346"><span class="annot"><span class="annottext">step :: State Stream m (f a)
-&gt; SplitState s (f a) -&gt; m (Step (SplitState s (f a)) (f a))
</span><a href="#local-6989586621679313346"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313345"><span class="annot"><span class="annottext">State Stream m (f a)
</span><a href="#local-6989586621679313345"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitInitial"><span class="hs-identifier hs-type">SplitInitial</span></a></span><span> </span><span id="local-6989586621679313344"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313344"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2266"></span><span>        </span><span id="local-6989586621679313343"><span class="annot"><span class="annottext">Step s (f a)
</span><a href="#local-6989586621679313343"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m (f a) -&gt; s -&gt; m (Step s (f a))
</span><a href="#local-6989586621679313348"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><a href="#local-6989586621679313345"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313344"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2267"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s (f a)
</span><a href="#local-6989586621679313343"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2268"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313342"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313342"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313341"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313341"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2269"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679313340"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313340"><span class="hs-identifier hs-var">x1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313339"><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313339"><span class="hs-identifier hs-var">mx2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f a -&gt; m (f a, Maybe (f a))
</span><a href="#local-6989586621679313350"><span class="hs-identifier hs-var">splitter</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313342"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2270"></span><span>                </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313339"><span class="hs-identifier hs-var">mx2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2271"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (f a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-var">SplitBuffering</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313341"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313340"><span class="hs-identifier hs-var">x1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2272"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313338"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313338"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; SplitState s (f a)
forall s arr. arr -&gt; SplitState s arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-var">SplitYielding</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313340"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitSplitting"><span class="hs-identifier hs-var">SplitSplitting</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313341"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313338"><span class="hs-identifier hs-var">x2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2273"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313337"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313337"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitState s (f a)
forall s arr. s -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitInitial"><span class="hs-identifier hs-var">SplitInitial</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313337"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2274"></span><span>            </span><span class="annot"><span class="annottext">Step s (f a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2275"></span><span>
</span><span id="line-2276"></span><span>    </span><span class="annot"><a href="#local-6989586621679313346"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679313336"><span class="annot"><span class="annottext">State Stream m (f a)
</span><a href="#local-6989586621679313336"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-type">SplitBuffering</span></a></span><span> </span><span id="local-6989586621679313335"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313335"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679313334"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313334"><span class="hs-identifier hs-var">buf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2277"></span><span>        </span><span id="local-6989586621679313333"><span class="annot"><span class="annottext">Step s (f a)
</span><a href="#local-6989586621679313333"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m (f a) -&gt; s -&gt; m (Step s (f a))
</span><a href="#local-6989586621679313348"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><a href="#local-6989586621679313336"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313335"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2278"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s (f a)
</span><a href="#local-6989586621679313333"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2279"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313332"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313332"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313331"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313331"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2280"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679313330"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313330"><span class="hs-identifier hs-var">x1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313329"><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313329"><span class="hs-identifier hs-var">mx2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f a -&gt; m (f a, Maybe (f a))
</span><a href="#local-6989586621679313350"><span class="hs-identifier hs-var">splitter</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313332"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2281"></span><span>                </span><span id="local-6989586621679313328"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313328"><span class="hs-identifier hs-var">buf'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f a -&gt; f a -&gt; m (f a)
</span><a href="#local-6989586621679313349"><span class="hs-identifier hs-var">joiner</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313334"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313330"><span class="hs-identifier hs-var">x1</span></a></span><span>
</span><span id="line-2282"></span><span>                </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313329"><span class="hs-identifier hs-var">mx2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2283"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (f a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-var">SplitBuffering</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313331"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313328"><span class="hs-identifier hs-var">buf'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2284"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313327"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313327"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; SplitState s (f a)
forall s arr. arr -&gt; SplitState s arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-var">SplitYielding</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313328"><span class="hs-identifier hs-var">buf'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitSplitting"><span class="hs-identifier hs-var">SplitSplitting</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313331"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313327"><span class="hs-identifier hs-var">x2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2285"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313326"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313326"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-var">SplitBuffering</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313326"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313334"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2286"></span><span>            </span><span class="annot"><span class="annottext">Step s (f a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; SplitState s (f a)
forall s arr. arr -&gt; SplitState s arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-var">SplitYielding</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313334"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a)
forall s arr. SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitFinishing"><span class="hs-identifier hs-var">SplitFinishing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2287"></span><span>
</span><span id="line-2288"></span><span>    </span><span class="annot"><a href="#local-6989586621679313346"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitSplitting"><span class="hs-identifier hs-type">SplitSplitting</span></a></span><span> </span><span id="local-6989586621679313325"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313325"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679313324"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313324"><span class="hs-identifier hs-var">buf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2289"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679313323"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313323"><span class="hs-identifier hs-var">x1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313322"><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313322"><span class="hs-identifier hs-var">mx2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f a -&gt; m (f a, Maybe (f a))
</span><a href="#local-6989586621679313350"><span class="hs-identifier hs-var">splitter</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313324"><span class="hs-identifier hs-var">buf</span></a></span><span>
</span><span id="line-2290"></span><span>        </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313322"><span class="hs-identifier hs-var">mx2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2291"></span><span>                </span><span class="annot"><span class="annottext">Maybe (f a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a))
-&gt; SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-var">SplitBuffering</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313325"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313323"><span class="hs-identifier hs-var">x1</span></a></span><span>
</span><span id="line-2292"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313321"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313321"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a))
-&gt; SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; SplitState s (f a)
forall s arr. arr -&gt; SplitState s arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-var">SplitYielding</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313323"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitSplitting"><span class="hs-identifier hs-var">SplitSplitting</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313325"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313321"><span class="hs-identifier hs-var">x2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2293"></span><span>
</span><span id="line-2294"></span><span>    </span><span class="annot"><a href="#local-6989586621679313346"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-type">SplitYielding</span></a></span><span> </span><span id="local-6989586621679313320"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313320"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313319"><span class="annot"><span class="annottext">SplitState s (f a)
</span><a href="#local-6989586621679313319"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313320"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a)
</span><a href="#local-6989586621679313319"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-2295"></span><span>    </span><span class="annot"><a href="#local-6989586621679313346"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitFinishing"><span class="hs-identifier hs-var">SplitFinishing</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2296"></span><span>
</span><span id="line-2297"></span><span class="hs-comment">-- | Performs infix separator style splitting.</span><span>
</span><span id="line-2298"></span><span class="hs-pragma">{-# INLINE_NORMAL splitInnerBySuffix #-}</span><span>
</span><span id="line-2299"></span><span id="local-6989586621679313316"><span id="local-6989586621679313317"><span id="local-6989586621679313318"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#splitInnerBySuffix"><span class="hs-identifier hs-type">splitInnerBySuffix</span></a></span><span>
</span><span id="line-2300"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313318"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2301"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- splitter</span><span>
</span><span id="line-2302"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- joiner</span><span>
</span><span id="line-2303"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2304"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313317"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313316"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-2305"></span><span id="splitInnerBySuffix"><span class="annot"><span class="annottext">splitInnerBySuffix :: (f a -&gt; m (f a, Maybe (f a)))
-&gt; (f a -&gt; f a -&gt; m (f a)) -&gt; Stream m (f a) -&gt; Stream m (f a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#splitInnerBySuffix"><span class="hs-identifier hs-var hs-var">splitInnerBySuffix</span></a></span></span><span> </span><span id="local-6989586621679313315"><span class="annot"><span class="annottext">f a -&gt; m (f a, Maybe (f a))
</span><a href="#local-6989586621679313315"><span class="hs-identifier hs-var">splitter</span></a></span></span><span> </span><span id="local-6989586621679313314"><span class="annot"><span class="annottext">f a -&gt; f a -&gt; m (f a)
</span><a href="#local-6989586621679313314"><span class="hs-identifier hs-var">joiner</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313313"><span class="annot"><span class="annottext">State Stream m (f a) -&gt; s -&gt; m (Step s (f a))
</span><a href="#local-6989586621679313313"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679313312"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313312"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2306"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m (f a)
 -&gt; SplitState s (f a) -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; SplitState s (f a) -&gt; Stream m (f a)
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
-&gt; SplitState s (f a) -&gt; m (Step (SplitState s (f a)) (f a))
</span><a href="#local-6989586621679313311"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitState s (f a)
forall s arr. s -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitInitial"><span class="hs-identifier hs-var">SplitInitial</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313312"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2307"></span><span>
</span><span id="line-2308"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2309"></span><span>
</span><span id="line-2310"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2311"></span><span>    </span><span id="local-6989586621679313311"><span class="annot"><span class="annottext">step :: State Stream m (f a)
-&gt; SplitState s (f a) -&gt; m (Step (SplitState s (f a)) (f a))
</span><a href="#local-6989586621679313311"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313310"><span class="annot"><span class="annottext">State Stream m (f a)
</span><a href="#local-6989586621679313310"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitInitial"><span class="hs-identifier hs-type">SplitInitial</span></a></span><span> </span><span id="local-6989586621679313309"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313309"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2312"></span><span>        </span><span id="local-6989586621679313308"><span class="annot"><span class="annottext">Step s (f a)
</span><a href="#local-6989586621679313308"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m (f a) -&gt; s -&gt; m (Step s (f a))
</span><a href="#local-6989586621679313313"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><a href="#local-6989586621679313310"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313309"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2313"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s (f a)
</span><a href="#local-6989586621679313308"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2314"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313307"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313307"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313306"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313306"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2315"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679313305"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313305"><span class="hs-identifier hs-var">x1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313304"><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313304"><span class="hs-identifier hs-var">mx2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f a -&gt; m (f a, Maybe (f a))
</span><a href="#local-6989586621679313315"><span class="hs-identifier hs-var">splitter</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313307"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2316"></span><span>                </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313304"><span class="hs-identifier hs-var">mx2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2317"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (f a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-var">SplitBuffering</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313306"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313305"><span class="hs-identifier hs-var">x1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2318"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313303"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313303"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; SplitState s (f a)
forall s arr. arr -&gt; SplitState s arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-var">SplitYielding</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313305"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitSplitting"><span class="hs-identifier hs-var">SplitSplitting</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313306"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313303"><span class="hs-identifier hs-var">x2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2319"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313302"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313302"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SplitState s (f a)
forall s arr. s -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitInitial"><span class="hs-identifier hs-var">SplitInitial</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313302"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2320"></span><span>            </span><span class="annot"><span class="annottext">Step s (f a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2321"></span><span>
</span><span id="line-2322"></span><span>    </span><span class="annot"><a href="#local-6989586621679313311"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679313301"><span class="annot"><span class="annottext">State Stream m (f a)
</span><a href="#local-6989586621679313301"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-type">SplitBuffering</span></a></span><span> </span><span id="local-6989586621679313300"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313300"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679313299"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313299"><span class="hs-identifier hs-var">buf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2323"></span><span>        </span><span id="local-6989586621679313298"><span class="annot"><span class="annottext">Step s (f a)
</span><a href="#local-6989586621679313298"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m (f a) -&gt; s -&gt; m (Step s (f a))
</span><a href="#local-6989586621679313313"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><a href="#local-6989586621679313301"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313300"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2324"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s (f a)
</span><a href="#local-6989586621679313298"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2325"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313297"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313297"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313296"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313296"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2326"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679313295"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313295"><span class="hs-identifier hs-var">x1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313294"><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313294"><span class="hs-identifier hs-var">mx2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f a -&gt; m (f a, Maybe (f a))
</span><a href="#local-6989586621679313315"><span class="hs-identifier hs-var">splitter</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313297"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-2327"></span><span>                </span><span id="local-6989586621679313293"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313293"><span class="hs-identifier hs-var">buf'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f a -&gt; f a -&gt; m (f a)
</span><a href="#local-6989586621679313314"><span class="hs-identifier hs-var">joiner</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313299"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313295"><span class="hs-identifier hs-var">x1</span></a></span><span>
</span><span id="line-2328"></span><span>                </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313294"><span class="hs-identifier hs-var">mx2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2329"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (f a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-var">SplitBuffering</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313296"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313293"><span class="hs-identifier hs-var">buf'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2330"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313292"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313292"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; SplitState s (f a)
forall s arr. arr -&gt; SplitState s arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-var">SplitYielding</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313293"><span class="hs-identifier hs-var">buf'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitSplitting"><span class="hs-identifier hs-var">SplitSplitting</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313296"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313292"><span class="hs-identifier hs-var">x2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2331"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313291"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313291"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-var">SplitBuffering</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313291"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313299"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2332"></span><span>            </span><span class="annot"><span class="annottext">Step s (f a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2333"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313299"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">f a -&gt; f a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">f a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-2334"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2335"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; SplitState s (f a)
forall s arr. arr -&gt; SplitState s arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-var">SplitYielding</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313299"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a)
forall s arr. SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitFinishing"><span class="hs-identifier hs-var">SplitFinishing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2336"></span><span>
</span><span id="line-2337"></span><span>    </span><span class="annot"><a href="#local-6989586621679313311"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitSplitting"><span class="hs-identifier hs-type">SplitSplitting</span></a></span><span> </span><span id="local-6989586621679313290"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313290"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679313289"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313289"><span class="hs-identifier hs-var">buf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2338"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679313288"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313288"><span class="hs-identifier hs-var">x1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313287"><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313287"><span class="hs-identifier hs-var">mx2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f a -&gt; m (f a, Maybe (f a))
</span><a href="#local-6989586621679313315"><span class="hs-identifier hs-var">splitter</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313289"><span class="hs-identifier hs-var">buf</span></a></span><span>
</span><span id="line-2339"></span><span>        </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (f a)
</span><a href="#local-6989586621679313287"><span class="hs-identifier hs-var">mx2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2340"></span><span>                </span><span class="annot"><span class="annottext">Maybe (f a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a))
-&gt; SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitBuffering"><span class="hs-identifier hs-var">SplitBuffering</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313290"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313288"><span class="hs-identifier hs-var">x1</span></a></span><span>
</span><span id="line-2341"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313286"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313286"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a))
-&gt; SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; SplitState s (f a)
forall s arr. arr -&gt; SplitState s arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-var">SplitYielding</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313288"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; f a -&gt; SplitState s (f a)
forall s arr. s -&gt; arr -&gt; SplitState s arr
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitSplitting"><span class="hs-identifier hs-var">SplitSplitting</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313290"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313286"><span class="hs-identifier hs-var">x2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2342"></span><span>
</span><span id="line-2343"></span><span>    </span><span class="annot"><a href="#local-6989586621679313311"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitYielding"><span class="hs-identifier hs-type">SplitYielding</span></a></span><span> </span><span id="local-6989586621679313285"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313285"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313284"><span class="annot"><span class="annottext">SplitState s (f a)
</span><a href="#local-6989586621679313284"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f a -&gt; SplitState s (f a) -&gt; Step (SplitState s (f a)) (f a)
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679313285"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a)
</span><a href="#local-6989586621679313284"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-2344"></span><span>    </span><span class="annot"><a href="#local-6989586621679313311"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (f a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SplitState s (f a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SplitFinishing"><span class="hs-identifier hs-var">SplitFinishing</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SplitState s (f a)) (f a)
 -&gt; m (Step (SplitState s (f a)) (f a)))
-&gt; Step (SplitState s (f a)) (f a)
-&gt; m (Step (SplitState s (f a)) (f a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (SplitState s (f a)) (f a)
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2345"></span><span>
</span><span id="line-2346"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2347"></span><span class="hs-comment">-- Substreams</span><span>
</span><span id="line-2348"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2349"></span><span>
</span><span id="line-2350"></span><span class="hs-pragma">{-# INLINE_NORMAL isPrefixOf #-}</span><span>
</span><span id="line-2351"></span><span id="local-6989586621679313282"><span id="local-6989586621679313283"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#isPrefixOf"><span class="hs-identifier hs-type">isPrefixOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679313283"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313282"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313283"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313283"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-2352"></span><span id="isPrefixOf"><span class="annot"><span class="annottext">isPrefixOf :: Stream m a -&gt; Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#isPrefixOf"><span class="hs-identifier hs-var hs-var">isPrefixOf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313281"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313281"><span class="hs-identifier hs-var">stepa</span></a></span></span><span> </span><span id="local-6989586621679313280"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313280"><span class="hs-identifier hs-var">ta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313279"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313279"><span class="hs-identifier hs-var">stepb</span></a></span></span><span> </span><span id="local-6989586621679313278"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313278"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313280"><span class="hs-identifier hs-var">ta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313278"><span class="hs-identifier hs-var">tb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2353"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2354"></span><span>    </span><span id="local-6989586621679313277"><span class="annot"><span class="annottext">go :: (s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313277"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313276"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313276"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313275"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313275"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2355"></span><span>        </span><span id="local-6989586621679313274"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313274"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313281"><span class="hs-identifier hs-var">stepa</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313276"><span class="hs-identifier hs-var">sa</span></a></span><span>
</span><span id="line-2356"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313274"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2357"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313273"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313273"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313272"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313272"><span class="hs-identifier hs-var">sa'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313272"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313275"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313273"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2358"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313271"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313271"><span class="hs-identifier hs-var">sa'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313271"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313275"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2359"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2360"></span><span>
</span><span id="line-2361"></span><span>    </span><span class="annot"><a href="#local-6989586621679313277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313270"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313270"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313269"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313269"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313268"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313268"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2362"></span><span>        </span><span id="local-6989586621679313267"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313267"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313279"><span class="hs-identifier hs-var">stepb</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313269"><span class="hs-identifier hs-var">sb</span></a></span><span>
</span><span id="line-2363"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313267"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2364"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313266"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313266"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679313265"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313265"><span class="hs-identifier hs-var">sb'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2365"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313268"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313266"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-2366"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313270"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313265"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2367"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2368"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313264"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313264"><span class="hs-identifier hs-var">sb'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313270"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313264"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313268"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2369"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2370"></span><span>
</span><span id="line-2371"></span><span class="hs-pragma">{-# INLINE_NORMAL isSubsequenceOf #-}</span><span>
</span><span id="line-2372"></span><span id="local-6989586621679313262"><span id="local-6989586621679313263"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#isSubsequenceOf"><span class="hs-identifier hs-type">isSubsequenceOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679313263"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313262"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313263"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313263"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-2373"></span><span id="isSubsequenceOf"><span class="annot"><span class="annottext">isSubsequenceOf :: Stream m a -&gt; Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#isSubsequenceOf"><span class="hs-identifier hs-var hs-var">isSubsequenceOf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313261"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313261"><span class="hs-identifier hs-var">stepa</span></a></span></span><span> </span><span id="local-6989586621679313260"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313260"><span class="hs-identifier hs-var">ta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313259"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313259"><span class="hs-identifier hs-var">stepb</span></a></span></span><span> </span><span id="local-6989586621679313258"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313258"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313257"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313260"><span class="hs-identifier hs-var">ta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313258"><span class="hs-identifier hs-var">tb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2374"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2375"></span><span>    </span><span id="local-6989586621679313257"><span class="annot"><span class="annottext">go :: (s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313257"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313256"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313256"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313255"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313255"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2376"></span><span>        </span><span id="local-6989586621679313254"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313254"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313261"><span class="hs-identifier hs-var">stepa</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313256"><span class="hs-identifier hs-var">sa</span></a></span><span>
</span><span id="line-2377"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313254"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2378"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313253"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313253"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313252"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313252"><span class="hs-identifier hs-var">sa'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313257"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313252"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313255"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313253"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2379"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313251"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313251"><span class="hs-identifier hs-var">sa'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313257"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313251"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313255"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2380"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2381"></span><span>
</span><span id="line-2382"></span><span>    </span><span class="annot"><a href="#local-6989586621679313257"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313250"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313250"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313249"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313249"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313248"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313248"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2383"></span><span>        </span><span id="local-6989586621679313247"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313247"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313259"><span class="hs-identifier hs-var">stepb</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313249"><span class="hs-identifier hs-var">sb</span></a></span><span>
</span><span id="line-2384"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313247"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2385"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313246"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313246"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679313245"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313245"><span class="hs-identifier hs-var">sb'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2386"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313248"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313246"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-2387"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313257"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313250"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313245"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2388"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313257"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313250"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313245"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313248"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2389"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313244"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313244"><span class="hs-identifier hs-var">sb'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m Bool
</span><a href="#local-6989586621679313257"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313250"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313244"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313248"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2390"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2391"></span><span>
</span><span id="line-2392"></span><span class="hs-pragma">{-# INLINE_NORMAL stripPrefix #-}</span><span>
</span><span id="line-2393"></span><span id="local-6989586621679313242"><span id="local-6989586621679313243"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#stripPrefix"><span class="hs-identifier hs-type">stripPrefix</span></a></span><span>
</span><span id="line-2394"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679313243"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313242"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2395"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313242"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313243"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313242"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313243"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313242"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313242"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313243"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-2396"></span><span id="stripPrefix"><span class="annot"><span class="annottext">stripPrefix :: Stream m a -&gt; Stream m a -&gt; m (Maybe (Stream m a))
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#stripPrefix"><span class="hs-identifier hs-var hs-var">stripPrefix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313241"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313241"><span class="hs-identifier hs-var">stepa</span></a></span></span><span> </span><span id="local-6989586621679313240"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313240"><span class="hs-identifier hs-var">ta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313239"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313239"><span class="hs-identifier hs-var">stepb</span></a></span></span><span> </span><span id="local-6989586621679313238"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313238"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679313237"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313240"><span class="hs-identifier hs-var">ta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313238"><span class="hs-identifier hs-var">tb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2397"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2398"></span><span>    </span><span id="local-6989586621679313237"><span class="annot"><span class="annottext">go :: (s, s, Maybe a) -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679313237"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313236"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313236"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313235"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313235"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2399"></span><span>        </span><span id="local-6989586621679313234"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313234"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313241"><span class="hs-identifier hs-var">stepa</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313236"><span class="hs-identifier hs-var">sa</span></a></span><span>
</span><span id="line-2400"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313234"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2401"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313233"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313233"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313232"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313232"><span class="hs-identifier hs-var">sa'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679313237"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313232"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313235"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313233"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2402"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313231"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313231"><span class="hs-identifier hs-var">sa'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679313237"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313231"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313235"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2403"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a) -&gt; m (Maybe (Stream m a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Stream m a) -&gt; m (Maybe (Stream m a)))
-&gt; Maybe (Stream m a) -&gt; m (Maybe (Stream m a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Maybe (Stream m a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313239"><span class="hs-identifier hs-var">stepb</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313235"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2404"></span><span>
</span><span id="line-2405"></span><span>    </span><span class="annot"><a href="#local-6989586621679313237"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313230"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313230"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679313229"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313229"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679313228"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313228"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2406"></span><span>        </span><span id="local-6989586621679313227"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313227"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313239"><span class="hs-identifier hs-var">stepb</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313229"><span class="hs-identifier hs-var">sb</span></a></span><span>
</span><span id="line-2407"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313227"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2408"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313226"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313226"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679313225"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313225"><span class="hs-identifier hs-var">sb'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2409"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313228"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313226"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-2410"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679313237"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313230"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313225"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2411"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a) -&gt; m (Maybe (Stream m a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2412"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313224"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313224"><span class="hs-identifier hs-var">sb'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679313237"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313230"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313224"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313228"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2413"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a) -&gt; m (Maybe (Stream m a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2414"></span><span>
</span><span id="line-2415"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2416"></span><span class="hs-comment">-- Map and Fold</span><span>
</span><span id="line-2417"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2418"></span><span>
</span><span id="line-2419"></span><span class="hs-comment">-- | Execute a monadic action for each element of the 'Stream'</span><span>
</span><span id="line-2420"></span><span class="hs-pragma">{-# INLINE_NORMAL mapM_ #-}</span><span>
</span><span id="line-2421"></span><span id="local-6989586621679313221"><span id="local-6989586621679313222"><span id="local-6989586621679313223"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mapM_"><span class="hs-identifier hs-type">mapM_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313223"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679313222"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313223"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313221"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313223"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313222"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679313223"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-2422"></span><span id="mapM_"><span class="annot"><span class="annottext">mapM_ :: (a -&gt; m b) -&gt; Stream m a -&gt; m ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mapM_"><span class="hs-identifier hs-var hs-var">mapM_</span></a></span></span><span> </span><span id="local-6989586621679313220"><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679313220"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; Stream m a -&gt; m ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#drain"><span class="hs-identifier hs-var">drain</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream m b -&gt; m ())
-&gt; (Stream m a -&gt; Stream m b) -&gt; Stream m a -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m b) -&gt; Stream m a -&gt; Stream m b
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679313220"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-2423"></span><span>
</span><span id="line-2424"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2425"></span><span class="hs-comment">-- Stream transformations using Unfolds</span><span>
</span><span id="line-2426"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2427"></span><span>
</span><span id="line-2428"></span><span class="hs-comment">-- Define a unique structure to use in inspection testing</span><span>
</span><span id="line-2429"></span><span class="hs-keyword">data</span><span> </span><span id="ConcatMapUState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUState"><span class="hs-identifier hs-var">ConcatMapUState</span></a></span></span><span> </span><span id="local-6989586621679315613"><span class="annot"><a href="#local-6989586621679315613"><span class="hs-identifier hs-type">o</span></a></span></span><span> </span><span id="local-6989586621679315612"><span class="annot"><a href="#local-6989586621679315612"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2430"></span><span>      </span><span id="ConcatMapUOuter"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUOuter"><span class="hs-identifier hs-var">ConcatMapUOuter</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315613"><span class="hs-identifier hs-type">o</span></a></span><span>
</span><span id="line-2431"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ConcatMapUInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUInner"><span class="hs-identifier hs-var">ConcatMapUInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315613"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315612"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-2432"></span><span>
</span><span id="line-2433"></span><span class="hs-comment">-- | @concatMapU unfold stream@ uses @unfold@ to map the input stream elements</span><span>
</span><span id="line-2434"></span><span class="hs-comment">-- to streams and then flattens the generated streams into a single output</span><span>
</span><span id="line-2435"></span><span class="hs-comment">-- stream.</span><span>
</span><span id="line-2436"></span><span>
</span><span id="line-2437"></span><span class="hs-comment">-- This is like 'concatMap' but uses an unfold with an explicit state to</span><span>
</span><span id="line-2438"></span><span class="hs-comment">-- generate the stream instead of a 'Stream' type generator. This allows better</span><span>
</span><span id="line-2439"></span><span class="hs-comment">-- optimization via fusion.  This can be many times more efficient than</span><span>
</span><span id="line-2440"></span><span class="hs-comment">-- 'concatMap'.</span><span>
</span><span id="line-2441"></span><span>
</span><span id="line-2442"></span><span class="hs-pragma">{-# INLINE_NORMAL concatMapU #-}</span><span>
</span><span id="line-2443"></span><span id="local-6989586621679313215"><span id="local-6989586621679313216"><span id="local-6989586621679313217"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#concatMapU"><span class="hs-identifier hs-type">concatMapU</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313216"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313215"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313216"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313215"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-2444"></span><span id="concatMapU"><span class="annot"><span class="annottext">concatMapU :: Unfold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#concatMapU"><span class="hs-identifier hs-var hs-var">concatMapU</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679313214"><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313214"><span class="hs-identifier hs-var">istep</span></a></span></span><span> </span><span id="local-6989586621679313213"><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679313213"><span class="hs-identifier hs-var">inject</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313212"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313212"><span class="hs-identifier hs-var">ostep</span></a></span></span><span> </span><span id="local-6989586621679313211"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313211"><span class="hs-identifier hs-var">ost</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2445"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; ConcatMapUState s s -&gt; m (Step (ConcatMapUState s s) b))
-&gt; ConcatMapUState s s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; ConcatMapUState s s -&gt; m (Step (ConcatMapUState s s) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; ConcatMapUState s s -&gt; m (Step (ConcatMapUState s s) b)
</span><a href="#local-6989586621679313210"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ConcatMapUState s s
forall o i. o -&gt; ConcatMapUState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUOuter"><span class="hs-identifier hs-var">ConcatMapUOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313211"><span class="hs-identifier hs-var">ost</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2446"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2447"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2448"></span><span>    </span><span id="local-6989586621679313210"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; ConcatMapUState s s -&gt; m (Step (ConcatMapUState s s) b)
</span><a href="#local-6989586621679313210"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313209"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313209"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUOuter"><span class="hs-identifier hs-type">ConcatMapUOuter</span></a></span><span> </span><span id="local-6989586621679313208"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313208"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2449"></span><span>        </span><span id="local-6989586621679313207"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313207"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313212"><span class="hs-identifier hs-var">ostep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313209"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313208"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-2450"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313207"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2451"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313206"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313206"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313205"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313205"><span class="hs-identifier hs-var">o'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2452"></span><span>                </span><span id="local-6989586621679313204"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313204"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679313213"><span class="hs-identifier hs-var">inject</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313206"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2453"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313204"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (ConcatMapUState s s) b)
-&gt; m (Step (ConcatMapUState s s) b)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConcatMapUState s s -&gt; Step (ConcatMapUState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ConcatMapUState s s
forall o i. o -&gt; i -&gt; ConcatMapUState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUInner"><span class="hs-identifier hs-var">ConcatMapUInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313205"><span class="hs-identifier hs-var">o'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313204"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2454"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313203"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313203"><span class="hs-identifier hs-var">o'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b))
-&gt; Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatMapUState s s -&gt; Step (ConcatMapUState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ConcatMapUState s s
forall o i. o -&gt; ConcatMapUState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUOuter"><span class="hs-identifier hs-var">ConcatMapUOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313203"><span class="hs-identifier hs-var">o'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2455"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b))
-&gt; Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (ConcatMapUState s s) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2456"></span><span>
</span><span id="line-2457"></span><span>    </span><span class="annot"><a href="#local-6989586621679313210"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUInner"><span class="hs-identifier hs-type">ConcatMapUInner</span></a></span><span> </span><span id="local-6989586621679313202"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313202"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621679313201"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313201"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2458"></span><span>        </span><span id="local-6989586621679313200"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313200"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313214"><span class="hs-identifier hs-var">istep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313201"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-2459"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b))
-&gt; Step (ConcatMapUState s s) b -&gt; m (Step (ConcatMapUState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313200"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2460"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313199"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313199"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313198"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313198"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; ConcatMapUState s s -&gt; Step (ConcatMapUState s s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313199"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ConcatMapUState s s
forall o i. o -&gt; i -&gt; ConcatMapUState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUInner"><span class="hs-identifier hs-var">ConcatMapUInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313202"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313198"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2461"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313197"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313197"><span class="hs-identifier hs-var">i'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatMapUState s s -&gt; Step (ConcatMapUState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ConcatMapUState s s
forall o i. o -&gt; i -&gt; ConcatMapUState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUInner"><span class="hs-identifier hs-var">ConcatMapUInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313202"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313197"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2462"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatMapUState s s -&gt; Step (ConcatMapUState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ConcatMapUState s s
forall o i. o -&gt; ConcatMapUState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatMapUOuter"><span class="hs-identifier hs-var">ConcatMapUOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313202"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2463"></span><span>
</span><span id="line-2464"></span><span class="hs-keyword">data</span><span> </span><span id="ConcatUnfoldInterleaveState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveState"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveState</span></a></span></span><span> </span><span id="local-6989586621679315603"><span class="annot"><a href="#local-6989586621679315603"><span class="hs-identifier hs-type">o</span></a></span></span><span> </span><span id="local-6989586621679315602"><span class="annot"><a href="#local-6989586621679315602"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2465"></span><span>      </span><span id="ConcatUnfoldInterleaveOuter"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315603"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315602"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2466"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ConcatUnfoldInterleaveInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInner"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315603"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315602"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2467"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ConcatUnfoldInterleaveInnerL"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315602"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315602"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2468"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ConcatUnfoldInterleaveInnerR"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerR</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315602"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679315602"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2469"></span><span>
</span><span id="line-2470"></span><span class="hs-comment">-- XXX use arrays to store state instead of lists.</span><span>
</span><span id="line-2471"></span><span class="hs-comment">-- XXX In general we can use different scheduling strategies e.g. how to</span><span>
</span><span id="line-2472"></span><span class="hs-comment">-- schedule the outer vs inner loop or assigning weights to different streams</span><span>
</span><span id="line-2473"></span><span class="hs-comment">-- or outer and inner loops.</span><span>
</span><span id="line-2474"></span><span>
</span><span id="line-2475"></span><span class="hs-comment">-- After a yield, switch to the next stream. Do not switch streams on Skip.</span><span>
</span><span id="line-2476"></span><span class="hs-comment">-- Yield from outer stream switches to the inner stream.</span><span>
</span><span id="line-2477"></span><span class="hs-comment">--</span><span>
</span><span id="line-2478"></span><span class="hs-comment">-- There are two choices here, (1) exhaust the outer stream first and then</span><span>
</span><span id="line-2479"></span><span class="hs-comment">-- start yielding from the inner streams, this is much simpler to implement,</span><span>
</span><span id="line-2480"></span><span class="hs-comment">-- (2) yield at least one element from an inner stream before going back to</span><span>
</span><span id="line-2481"></span><span class="hs-comment">-- outer stream and opening the next stream from it.</span><span>
</span><span id="line-2482"></span><span class="hs-comment">--</span><span>
</span><span id="line-2483"></span><span class="hs-comment">-- Ideally, we need some scheduling bias to inner streams vs outer stream.</span><span>
</span><span id="line-2484"></span><span class="hs-comment">-- Maybe we can configure the behavior.</span><span>
</span><span id="line-2485"></span><span class="hs-comment">--</span><span>
</span><span id="line-2486"></span><span class="hs-pragma">{-# INLINE_NORMAL concatUnfoldInterleave #-}</span><span>
</span><span id="line-2487"></span><span id="local-6989586621679313190"><span id="local-6989586621679313191"><span id="local-6989586621679313192"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#concatUnfoldInterleave"><span class="hs-identifier hs-type">concatUnfoldInterleave</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313192"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313192"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313191"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313190"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313192"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313191"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313192"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313190"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-2488"></span><span id="concatUnfoldInterleave"><span class="annot"><span class="annottext">concatUnfoldInterleave :: Unfold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#concatUnfoldInterleave"><span class="hs-identifier hs-var hs-var">concatUnfoldInterleave</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679313189"><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313189"><span class="hs-identifier hs-var">istep</span></a></span></span><span> </span><span id="local-6989586621679313188"><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679313188"><span class="hs-identifier hs-var">inject</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313187"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313187"><span class="hs-identifier hs-var">ostep</span></a></span></span><span> </span><span id="local-6989586621679313186"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313186"><span class="hs-identifier hs-var">ost</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2489"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; ConcatUnfoldInterleaveState s s
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; ConcatUnfoldInterleaveState s s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; ConcatUnfoldInterleaveState s s
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; ConcatUnfoldInterleaveState s s
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
</span><a href="#local-6989586621679313185"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313186"><span class="hs-identifier hs-var">ost</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2490"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2491"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2492"></span><span>    </span><span id="local-6989586621679313185"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; ConcatUnfoldInterleaveState s s
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
</span><a href="#local-6989586621679313185"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313184"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313184"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span id="local-6989586621679313183"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313183"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621679313182"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313182"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2493"></span><span>        </span><span id="local-6989586621679313181"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313181"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313187"><span class="hs-identifier hs-var">ostep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313184"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313183"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-2494"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313181"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2495"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313180"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313180"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313179"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313179"><span class="hs-identifier hs-var">o'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2496"></span><span>                </span><span id="local-6989586621679313178"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313178"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679313188"><span class="hs-identifier hs-var">inject</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313180"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2497"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313178"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInner"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313179"><span class="hs-identifier hs-var">o'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313178"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313182"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2498"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313177"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313177"><span class="hs-identifier hs-var">o'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313177"><span class="hs-identifier hs-var">o'</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313182"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2499"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313182"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2500"></span><span>
</span><span id="line-2501"></span><span>    </span><span class="annot"><a href="#local-6989586621679313185"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInner"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Step (ConcatUnfoldInterleaveState s s) b)
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-2502"></span><span>    </span><span class="annot"><a href="#local-6989586621679313185"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInner"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInner</span></a></span><span> </span><span id="local-6989586621679313176"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313176"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313175"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313175"><span class="hs-identifier hs-var">st</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679313174"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313174"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2503"></span><span>        </span><span id="local-6989586621679313173"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313173"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313189"><span class="hs-identifier hs-var">istep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313175"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2504"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313173"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2505"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313172"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313172"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313171"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313171"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b
-&gt; ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313172"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313176"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313171"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313174"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2506"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313170"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313170"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInner"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313176"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313170"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313174"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2507"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313176"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313174"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2508"></span><span>
</span><span id="line-2509"></span><span>    </span><span class="annot"><a href="#local-6989586621679313185"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2510"></span><span>    </span><span class="annot"><a href="#local-6989586621679313185"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679313169"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313169"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2511"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313169"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2512"></span><span>
</span><span id="line-2513"></span><span>    </span><span class="annot"><a href="#local-6989586621679313185"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313168"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313168"><span class="hs-identifier hs-var">st</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679313167"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313167"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313166"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313166"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2514"></span><span>        </span><span id="local-6989586621679313165"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313165"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313189"><span class="hs-identifier hs-var">istep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313168"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2515"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313165"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2516"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313164"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313164"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313163"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313163"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b
-&gt; ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313164"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313167"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313163"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313166"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2517"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313162"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313162"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313162"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313167"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313166"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2518"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313167"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313166"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2519"></span><span>
</span><span id="line-2520"></span><span>    </span><span class="annot"><a href="#local-6989586621679313185"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2521"></span><span>    </span><span class="annot"><a href="#local-6989586621679313185"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span id="local-6989586621679313161"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313161"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2522"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313161"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2523"></span><span>
</span><span id="line-2524"></span><span>    </span><span class="annot"><a href="#local-6989586621679313185"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span id="local-6989586621679313160"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313160"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313159"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313159"><span class="hs-identifier hs-var">st</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679313158"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313158"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2525"></span><span>        </span><span id="local-6989586621679313157"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313157"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313189"><span class="hs-identifier hs-var">istep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313159"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2526"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313157"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2527"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313156"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313156"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313155"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313155"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b
-&gt; ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313156"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313155"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313160"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313158"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2528"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313154"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313154"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313160"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313154"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313158"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2529"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313160"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313158"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2530"></span><span>
</span><span id="line-2531"></span><span class="hs-comment">-- XXX In general we can use different scheduling strategies e.g. how to</span><span>
</span><span id="line-2532"></span><span class="hs-comment">-- schedule the outer vs inner loop or assigning weights to different streams</span><span>
</span><span id="line-2533"></span><span class="hs-comment">-- or outer and inner loops.</span><span>
</span><span id="line-2534"></span><span class="hs-comment">--</span><span>
</span><span id="line-2535"></span><span class="hs-comment">-- This could be inefficient if the tasks are too small.</span><span>
</span><span id="line-2536"></span><span class="hs-comment">--</span><span>
</span><span id="line-2537"></span><span class="hs-comment">-- Compared to concatUnfoldInterleave this one switches streams on Skips.</span><span>
</span><span id="line-2538"></span><span class="hs-comment">--</span><span>
</span><span id="line-2539"></span><span class="hs-pragma">{-# INLINE_NORMAL concatUnfoldRoundrobin #-}</span><span>
</span><span id="line-2540"></span><span id="local-6989586621679313151"><span id="local-6989586621679313152"><span id="local-6989586621679313153"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#concatUnfoldRoundrobin"><span class="hs-identifier hs-type">concatUnfoldRoundrobin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313153"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313153"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313152"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313151"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313153"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313152"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313153"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313151"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-2541"></span><span id="concatUnfoldRoundrobin"><span class="annot"><span class="annottext">concatUnfoldRoundrobin :: Unfold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#concatUnfoldRoundrobin"><span class="hs-identifier hs-var hs-var">concatUnfoldRoundrobin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679313150"><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313150"><span class="hs-identifier hs-var">istep</span></a></span></span><span> </span><span id="local-6989586621679313149"><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679313149"><span class="hs-identifier hs-var">inject</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313148"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313148"><span class="hs-identifier hs-var">ostep</span></a></span></span><span> </span><span id="local-6989586621679313147"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313147"><span class="hs-identifier hs-var">ost</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2542"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; ConcatUnfoldInterleaveState s s
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; ConcatUnfoldInterleaveState s s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; ConcatUnfoldInterleaveState s s
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; ConcatUnfoldInterleaveState s s
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
</span><a href="#local-6989586621679313146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313147"><span class="hs-identifier hs-var">ost</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2543"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2544"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2545"></span><span>    </span><span id="local-6989586621679313146"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; ConcatUnfoldInterleaveState s s
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
</span><a href="#local-6989586621679313146"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313145"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313145"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span id="local-6989586621679313144"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313144"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621679313143"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313143"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2546"></span><span>        </span><span id="local-6989586621679313142"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313142"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313148"><span class="hs-identifier hs-var">ostep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313145"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313144"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-2547"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313142"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2548"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313141"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313141"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313140"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313140"><span class="hs-identifier hs-var">o'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2549"></span><span>                </span><span id="local-6989586621679313139"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313139"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679313149"><span class="hs-identifier hs-var">inject</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313141"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2550"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313139"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInner"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313140"><span class="hs-identifier hs-var">o'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313139"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313143"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2551"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313138"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313138"><span class="hs-identifier hs-var">o'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInner"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313138"><span class="hs-identifier hs-var">o'</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313143"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2552"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313143"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2553"></span><span>
</span><span id="line-2554"></span><span>    </span><span class="annot"><a href="#local-6989586621679313146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInner"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInner</span></a></span><span> </span><span id="local-6989586621679313137"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313137"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2555"></span><span>            </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313137"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2556"></span><span>
</span><span id="line-2557"></span><span>    </span><span class="annot"><a href="#local-6989586621679313146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInner"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInner</span></a></span><span> </span><span id="local-6989586621679313136"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313136"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313135"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313135"><span class="hs-identifier hs-var">st</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679313134"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313134"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2558"></span><span>        </span><span id="local-6989586621679313133"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313133"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313150"><span class="hs-identifier hs-var">istep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313135"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2559"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313133"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2560"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313132"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313132"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313131"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313131"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b
-&gt; ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313132"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313136"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313131"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313134"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2561"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313130"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313130"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313136"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313130"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313134"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2562"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. o -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveOuter"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveOuter</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313136"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313134"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2563"></span><span>
</span><span id="line-2564"></span><span>    </span><span class="annot"><a href="#local-6989586621679313146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2565"></span><span>    </span><span class="annot"><a href="#local-6989586621679313146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679313129"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313129"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2566"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313129"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2567"></span><span>
</span><span id="line-2568"></span><span>    </span><span class="annot"><a href="#local-6989586621679313146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313128"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313128"><span class="hs-identifier hs-var">st</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679313127"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313127"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679313126"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313126"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2569"></span><span>        </span><span id="local-6989586621679313125"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313125"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313150"><span class="hs-identifier hs-var">istep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313128"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2570"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313125"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2571"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313124"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313124"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313123"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313123"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b
-&gt; ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313124"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313127"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313123"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313126"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2572"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313122"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313122"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313127"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313122"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313126"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2573"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313127"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313126"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2574"></span><span>
</span><span id="line-2575"></span><span>    </span><span class="annot"><a href="#local-6989586621679313146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2576"></span><span>    </span><span class="annot"><a href="#local-6989586621679313146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span id="local-6989586621679313121"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313121"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2577"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerL"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerL</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313121"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2578"></span><span>
</span><span id="line-2579"></span><span>    </span><span class="annot"><a href="#local-6989586621679313146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-type">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span id="local-6989586621679313120"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313120"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679313119"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313119"><span class="hs-identifier hs-var">st</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679313118"><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313118"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2580"></span><span>        </span><span id="local-6989586621679313117"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313117"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s b)
</span><a href="#local-6989586621679313150"><span class="hs-identifier hs-var">istep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313119"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2581"></span><span>        </span><span class="annot"><span class="annottext">Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ConcatUnfoldInterleaveState s s) b
 -&gt; m (Step (ConcatUnfoldInterleaveState s s) b))
-&gt; Step (ConcatUnfoldInterleaveState s s) b
-&gt; m (Step (ConcatUnfoldInterleaveState s s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679313117"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2582"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313116"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313116"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679313115"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313115"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b
-&gt; ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679313116"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313115"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313120"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313118"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2583"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313114"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313114"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313114"><span class="hs-identifier hs-var">s</span></a></span><span class="annot"><span class="annottext">s -&gt; [s] -&gt; [s]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313120"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313118"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2584"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConcatUnfoldInterleaveState s s
-&gt; Step (ConcatUnfoldInterleaveState s s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[s] -&gt; [s] -&gt; ConcatUnfoldInterleaveState s s
forall o i. [i] -&gt; [i] -&gt; ConcatUnfoldInterleaveState o i
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ConcatUnfoldInterleaveInnerR"><span class="hs-identifier hs-var">ConcatUnfoldInterleaveInnerR</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313120"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">[s]
</span><a href="#local-6989586621679313118"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2585"></span><span>
</span><span id="line-2586"></span><span class="hs-keyword">data</span><span> </span><span id="AppendState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendState"><span class="hs-identifier hs-var">AppendState</span></a></span></span><span> </span><span id="local-6989586621679315589"><span class="annot"><a href="#local-6989586621679315589"><span class="hs-identifier hs-type">s1</span></a></span></span><span> </span><span id="local-6989586621679315588"><span class="annot"><a href="#local-6989586621679315588"><span class="hs-identifier hs-type">s2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AppendFirst"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendFirst"><span class="hs-identifier hs-var">AppendFirst</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315589"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="AppendSecond"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendSecond"><span class="hs-identifier hs-var">AppendSecond</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315588"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2587"></span><span>
</span><span id="line-2588"></span><span class="hs-comment">-- Note that this could be much faster compared to the CPS stream. However, as</span><span>
</span><span id="line-2589"></span><span class="hs-comment">-- the number of streams being composed increases this may become expensive.</span><span>
</span><span id="line-2590"></span><span class="hs-comment">-- Need to see where the breaking point is between the two.</span><span>
</span><span id="line-2591"></span><span class="hs-comment">--</span><span>
</span><span id="line-2592"></span><span class="hs-pragma">{-# INLINE_NORMAL append #-}</span><span>
</span><span id="line-2593"></span><span id="local-6989586621679313110"><span id="local-6989586621679313111"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#append"><span class="hs-identifier hs-type">append</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313111"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313111"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313110"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313111"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313110"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313111"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313110"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-2594"></span><span id="append"><span class="annot"><span class="annottext">append :: Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#append"><span class="hs-identifier hs-var hs-var">append</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313109"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313109"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679313108"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313108"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313107"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313107"><span class="hs-identifier hs-var">step2</span></a></span></span><span> </span><span id="local-6989586621679313106"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313106"><span class="hs-identifier hs-var">state2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2595"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; AppendState s s -&gt; m (Step (AppendState s s) a))
-&gt; AppendState s s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; AppendState s s -&gt; m (Step (AppendState s s) a)
</span><a href="#local-6989586621679313105"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AppendState s s
forall s1 s2. s1 -&gt; AppendState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendFirst"><span class="hs-identifier hs-var">AppendFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313108"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2596"></span><span>
</span><span id="line-2597"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2598"></span><span>
</span><span id="line-2599"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2600"></span><span>    </span><span id="local-6989586621679313105"><span class="annot"><span class="annottext">step :: State Stream m a -&gt; AppendState s s -&gt; m (Step (AppendState s s) a)
</span><a href="#local-6989586621679313105"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313104"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313104"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendFirst"><span class="hs-identifier hs-type">AppendFirst</span></a></span><span> </span><span id="local-6989586621679313103"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313103"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2601"></span><span>        </span><span id="local-6989586621679313102"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313102"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313109"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313104"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313103"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2602"></span><span>        </span><span class="annot"><span class="annottext">Step (AppendState s s) a -&gt; m (Step (AppendState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (AppendState s s) a -&gt; m (Step (AppendState s s) a))
-&gt; Step (AppendState s s) a -&gt; m (Step (AppendState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313102"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2603"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313101"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313101"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313100"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313100"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; AppendState s s -&gt; Step (AppendState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313101"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AppendState s s
forall s1 s2. s1 -&gt; AppendState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendFirst"><span class="hs-identifier hs-var">AppendFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313100"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2604"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313099"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313099"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AppendState s s -&gt; Step (AppendState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AppendState s s
forall s1 s2. s1 -&gt; AppendState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendFirst"><span class="hs-identifier hs-var">AppendFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313099"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2605"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AppendState s s -&gt; Step (AppendState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AppendState s s
forall s1 s2. s2 -&gt; AppendState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendSecond"><span class="hs-identifier hs-var">AppendSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313106"><span class="hs-identifier hs-var">state2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2606"></span><span>
</span><span id="line-2607"></span><span>    </span><span class="annot"><a href="#local-6989586621679313105"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679313098"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313098"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendSecond"><span class="hs-identifier hs-type">AppendSecond</span></a></span><span> </span><span id="local-6989586621679313097"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313097"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2608"></span><span>        </span><span id="local-6989586621679313096"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313096"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313107"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313098"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313097"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2609"></span><span>        </span><span class="annot"><span class="annottext">Step (AppendState s s) a -&gt; m (Step (AppendState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (AppendState s s) a -&gt; m (Step (AppendState s s) a))
-&gt; Step (AppendState s s) a -&gt; m (Step (AppendState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313096"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2610"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313095"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313095"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313094"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313094"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; AppendState s s -&gt; Step (AppendState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313095"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AppendState s s
forall s1 s2. s2 -&gt; AppendState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendSecond"><span class="hs-identifier hs-var">AppendSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313094"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2611"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313093"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313093"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AppendState s s -&gt; Step (AppendState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AppendState s s
forall s1 s2. s2 -&gt; AppendState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#AppendSecond"><span class="hs-identifier hs-var">AppendSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313093"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2612"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (AppendState s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2613"></span><span>
</span><span id="line-2614"></span><span class="hs-keyword">data</span><span> </span><span id="InterleaveState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveState"><span class="hs-identifier hs-var">InterleaveState</span></a></span></span><span> </span><span id="local-6989586621679315582"><span class="annot"><a href="#local-6989586621679315582"><span class="hs-identifier hs-type">s1</span></a></span></span><span> </span><span id="local-6989586621679315581"><span class="annot"><a href="#local-6989586621679315581"><span class="hs-identifier hs-type">s2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InterleaveFirst"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315582"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315581"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="InterleaveSecond"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-var">InterleaveSecond</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315582"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315581"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2615"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterleaveSecondOnly"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-var">InterleaveSecondOnly</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315581"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="InterleaveFirstOnly"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315582"><span class="hs-identifier hs-type">s1</span></a></span><span>
</span><span id="line-2616"></span><span>
</span><span id="line-2617"></span><span class="hs-pragma">{-# INLINE_NORMAL interleave #-}</span><span>
</span><span id="line-2618"></span><span id="local-6989586621679313087"><span id="local-6989586621679313088"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interleave"><span class="hs-identifier hs-type">interleave</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313088"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313088"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313087"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313088"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313087"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313088"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313087"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-2619"></span><span id="interleave"><span class="annot"><span class="annottext">interleave :: Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#interleave"><span class="hs-identifier hs-var hs-var">interleave</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313086"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313086"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679313085"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313085"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313084"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313084"><span class="hs-identifier hs-var">step2</span></a></span></span><span> </span><span id="local-6989586621679313083"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313083"><span class="hs-identifier hs-var">state2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2620"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a))
-&gt; InterleaveState s s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a)
</span><a href="#local-6989586621679313082"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313085"><span class="hs-identifier hs-var">state1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313083"><span class="hs-identifier hs-var">state2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2621"></span><span>
</span><span id="line-2622"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2623"></span><span>
</span><span id="line-2624"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2625"></span><span>    </span><span id="local-6989586621679313082"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a)
</span><a href="#local-6989586621679313082"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313081"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313081"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-type">InterleaveFirst</span></a></span><span> </span><span id="local-6989586621679313080"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313080"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679313079"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313079"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2626"></span><span>        </span><span id="local-6989586621679313078"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313078"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313086"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313081"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313080"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2627"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313078"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2628"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313077"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313077"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313076"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313076"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313077"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-var">InterleaveSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313076"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313079"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2629"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313075"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313075"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313075"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313079"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2630"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-var">InterleaveSecondOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313079"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2631"></span><span>
</span><span id="line-2632"></span><span>    </span><span class="annot"><a href="#local-6989586621679313082"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679313074"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313074"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-type">InterleaveSecond</span></a></span><span> </span><span id="local-6989586621679313073"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313073"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679313072"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313072"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2633"></span><span>        </span><span id="local-6989586621679313071"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313071"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313084"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313074"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313072"><span class="hs-identifier hs-var">st2</span></a></span><span>
</span><span id="line-2634"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313071"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2635"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313070"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313070"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313069"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313069"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313070"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313073"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313069"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2636"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313068"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313068"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-var">InterleaveSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313073"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313068"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2637"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313073"><span class="hs-identifier hs-var">st1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2638"></span><span>
</span><span id="line-2639"></span><span>    </span><span class="annot"><a href="#local-6989586621679313082"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679313067"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313067"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-type">InterleaveFirstOnly</span></a></span><span> </span><span id="local-6989586621679313066"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313066"><span class="hs-identifier hs-var">st1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2640"></span><span>        </span><span id="local-6989586621679313065"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313065"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313086"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313067"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313066"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2641"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313065"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2642"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313064"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313064"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313063"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313063"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313064"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313063"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2643"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313062"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313062"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313062"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2644"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2645"></span><span>
</span><span id="line-2646"></span><span>    </span><span class="annot"><a href="#local-6989586621679313082"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679313061"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313061"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-type">InterleaveSecondOnly</span></a></span><span> </span><span id="local-6989586621679313060"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313060"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2647"></span><span>        </span><span id="local-6989586621679313059"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313059"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313084"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313061"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313060"><span class="hs-identifier hs-var">st2</span></a></span><span>
</span><span id="line-2648"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313059"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2649"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313058"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313058"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313057"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313057"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313058"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-var">InterleaveSecondOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313057"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2650"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313056"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313056"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-var">InterleaveSecondOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313056"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2651"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2652"></span><span>
</span><span id="line-2653"></span><span class="hs-pragma">{-# INLINE_NORMAL interleaveMin #-}</span><span>
</span><span id="line-2654"></span><span id="local-6989586621679313054"><span id="local-6989586621679313055"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interleaveMin"><span class="hs-identifier hs-type">interleaveMin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313055"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313055"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313054"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313055"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313054"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313055"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313054"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-2655"></span><span id="interleaveMin"><span class="annot"><span class="annottext">interleaveMin :: Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#interleaveMin"><span class="hs-identifier hs-var hs-var">interleaveMin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313053"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313053"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679313052"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313052"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313051"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313051"><span class="hs-identifier hs-var">step2</span></a></span></span><span> </span><span id="local-6989586621679313050"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313050"><span class="hs-identifier hs-var">state2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2656"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a))
-&gt; InterleaveState s s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a)
</span><a href="#local-6989586621679313049"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313052"><span class="hs-identifier hs-var">state1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313050"><span class="hs-identifier hs-var">state2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2657"></span><span>
</span><span id="line-2658"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2659"></span><span>
</span><span id="line-2660"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2661"></span><span>    </span><span id="local-6989586621679313049"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a)
</span><a href="#local-6989586621679313049"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313048"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313048"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-type">InterleaveFirst</span></a></span><span> </span><span id="local-6989586621679313047"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313047"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679313046"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313046"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2662"></span><span>        </span><span id="local-6989586621679313045"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313045"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313053"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313048"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313047"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2663"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313045"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2664"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313044"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313044"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313043"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313043"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313044"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-var">InterleaveSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313043"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313046"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2665"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313042"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313042"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313042"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313046"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2666"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2667"></span><span>
</span><span id="line-2668"></span><span>    </span><span class="annot"><a href="#local-6989586621679313049"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679313041"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313041"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-type">InterleaveSecond</span></a></span><span> </span><span id="local-6989586621679313040"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313040"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679313039"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313039"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2669"></span><span>        </span><span id="local-6989586621679313038"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313038"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313051"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313041"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313039"><span class="hs-identifier hs-var">st2</span></a></span><span>
</span><span id="line-2670"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313038"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2671"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313037"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313037"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313036"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313036"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313037"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313040"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313036"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2672"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313035"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313035"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-var">InterleaveSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313040"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313035"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2673"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2674"></span><span>
</span><span id="line-2675"></span><span>    </span><span class="annot"><a href="#local-6989586621679313049"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-type">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">m (Step (InterleaveState s s) a)
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-2676"></span><span>    </span><span class="annot"><a href="#local-6989586621679313049"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-type">InterleaveSecondOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">m (Step (InterleaveState s s) a)
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-2677"></span><span>
</span><span id="line-2678"></span><span class="hs-pragma">{-# INLINE_NORMAL interleaveSuffix #-}</span><span>
</span><span id="line-2679"></span><span id="local-6989586621679313033"><span id="local-6989586621679313034"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interleaveSuffix"><span class="hs-identifier hs-type">interleaveSuffix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313034"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313034"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313033"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313034"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313033"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313034"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313033"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-2680"></span><span id="interleaveSuffix"><span class="annot"><span class="annottext">interleaveSuffix :: Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#interleaveSuffix"><span class="hs-identifier hs-var hs-var">interleaveSuffix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313032"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313032"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679313031"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313031"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313030"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313030"><span class="hs-identifier hs-var">step2</span></a></span></span><span> </span><span id="local-6989586621679313029"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313029"><span class="hs-identifier hs-var">state2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2681"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a))
-&gt; InterleaveState s s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a)
</span><a href="#local-6989586621679313028"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313031"><span class="hs-identifier hs-var">state1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313029"><span class="hs-identifier hs-var">state2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2682"></span><span>
</span><span id="line-2683"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2684"></span><span>
</span><span id="line-2685"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2686"></span><span>    </span><span id="local-6989586621679313028"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a)
</span><a href="#local-6989586621679313028"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679313027"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313027"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-type">InterleaveFirst</span></a></span><span> </span><span id="local-6989586621679313026"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313026"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679313025"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313025"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2687"></span><span>        </span><span id="local-6989586621679313024"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313024"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313032"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313027"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313026"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2688"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313024"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2689"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313023"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313023"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313022"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313022"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313023"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-var">InterleaveSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313022"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313025"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2690"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313021"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313021"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313021"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313025"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2691"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2692"></span><span>
</span><span id="line-2693"></span><span>    </span><span class="annot"><a href="#local-6989586621679313028"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679313020"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313020"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-type">InterleaveSecond</span></a></span><span> </span><span id="local-6989586621679313019"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313019"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679313018"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313018"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2694"></span><span>        </span><span id="local-6989586621679313017"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313017"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313030"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313020"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313018"><span class="hs-identifier hs-var">st2</span></a></span><span>
</span><span id="line-2695"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313017"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2696"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313016"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313016"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313015"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313015"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313016"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313019"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313015"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2697"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313014"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313014"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-var">InterleaveSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313019"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313014"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2698"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313019"><span class="hs-identifier hs-var">st1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2699"></span><span>
</span><span id="line-2700"></span><span>    </span><span class="annot"><a href="#local-6989586621679313028"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679313013"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313013"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-type">InterleaveFirstOnly</span></a></span><span> </span><span id="local-6989586621679313012"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313012"><span class="hs-identifier hs-var">st1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2701"></span><span>        </span><span id="local-6989586621679313011"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313011"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313032"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679313013"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313012"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2702"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679313011"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2703"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679313010"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313010"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679313009"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313009"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679313010"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313009"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2704"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679313008"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313008"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679313008"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2705"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2706"></span><span>
</span><span id="line-2707"></span><span>    </span><span class="annot"><a href="#local-6989586621679313028"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-type">InterleaveSecondOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">m (Step (InterleaveState s s) a)
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-2708"></span><span>
</span><span id="line-2709"></span><span class="hs-keyword">data</span><span> </span><span id="InterleaveInfixState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixState"><span class="hs-identifier hs-var">InterleaveInfixState</span></a></span></span><span> </span><span id="local-6989586621679315567"><span class="annot"><a href="#local-6989586621679315567"><span class="hs-identifier hs-type">s1</span></a></span></span><span> </span><span id="local-6989586621679315566"><span class="annot"><a href="#local-6989586621679315566"><span class="hs-identifier hs-type">s2</span></a></span></span><span> </span><span id="local-6989586621679315565"><span class="annot"><a href="#local-6989586621679315565"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-2710"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="InterleaveInfixFirst"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirst"><span class="hs-identifier hs-var">InterleaveInfixFirst</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315567"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315566"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2711"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterleaveInfixSecondBuf"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixSecondBuf"><span class="hs-identifier hs-var">InterleaveInfixSecondBuf</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315567"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315566"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2712"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterleaveInfixSecondYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixSecondYield"><span class="hs-identifier hs-var">InterleaveInfixSecondYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315567"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315566"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315565"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-2713"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterleaveInfixFirstYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirstYield"><span class="hs-identifier hs-var">InterleaveInfixFirstYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315567"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315566"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315565"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-2714"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterleaveInfixFirstOnly"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirstOnly"><span class="hs-identifier hs-var">InterleaveInfixFirstOnly</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315567"><span class="hs-identifier hs-type">s1</span></a></span><span>
</span><span id="line-2715"></span><span>
</span><span id="line-2716"></span><span class="hs-pragma">{-# INLINE_NORMAL interleaveInfix #-}</span><span>
</span><span id="line-2717"></span><span id="local-6989586621679313001"><span id="local-6989586621679313002"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interleaveInfix"><span class="hs-identifier hs-type">interleaveInfix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679313002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313001"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313001"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679313001"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-2718"></span><span id="interleaveInfix"><span class="annot"><span class="annottext">interleaveInfix :: Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#interleaveInfix"><span class="hs-identifier hs-var hs-var">interleaveInfix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679313000"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313000"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312999"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312999"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312998"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312998"><span class="hs-identifier hs-var">step2</span></a></span></span><span> </span><span id="local-6989586621679312997"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312997"><span class="hs-identifier hs-var">state2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2719"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; InterleaveInfixState s s a
 -&gt; m (Step (InterleaveInfixState s s a) a))
-&gt; InterleaveInfixState s s a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; InterleaveInfixState s s a
-&gt; m (Step (InterleaveInfixState s s a) a)
</span><a href="#local-6989586621679312996"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; s2 -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirst"><span class="hs-identifier hs-var">InterleaveInfixFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312999"><span class="hs-identifier hs-var">state1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312997"><span class="hs-identifier hs-var">state2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2720"></span><span>
</span><span id="line-2721"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2722"></span><span>
</span><span id="line-2723"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2724"></span><span>    </span><span id="local-6989586621679312996"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; InterleaveInfixState s s a
-&gt; m (Step (InterleaveInfixState s s a) a)
</span><a href="#local-6989586621679312996"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312995"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312995"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirst"><span class="hs-identifier hs-type">InterleaveInfixFirst</span></a></span><span> </span><span id="local-6989586621679312994"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312994"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679312993"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312993"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2725"></span><span>        </span><span id="local-6989586621679312992"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312992"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313000"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312995"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312994"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2726"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveInfixState s s a) a
 -&gt; m (Step (InterleaveInfixState s s a) a))
-&gt; Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312992"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2727"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312991"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312991"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312990"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312990"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; InterleaveInfixState s s a
-&gt; Step (InterleaveInfixState s s a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312991"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; s2 -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixSecondBuf"><span class="hs-identifier hs-var">InterleaveInfixSecondBuf</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312990"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312993"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2728"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312989"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312989"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveInfixState s s a -&gt; Step (InterleaveInfixState s s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; s2 -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirst"><span class="hs-identifier hs-var">InterleaveInfixFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312989"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312993"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2729"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveInfixState s s a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2730"></span><span>
</span><span id="line-2731"></span><span>    </span><span class="annot"><a href="#local-6989586621679312996"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312988"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312988"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixSecondBuf"><span class="hs-identifier hs-type">InterleaveInfixSecondBuf</span></a></span><span> </span><span id="local-6989586621679312987"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312987"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679312986"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312986"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2732"></span><span>        </span><span id="local-6989586621679312985"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312985"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312998"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312988"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312986"><span class="hs-identifier hs-var">st2</span></a></span><span>
</span><span id="line-2733"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveInfixState s s a) a
 -&gt; m (Step (InterleaveInfixState s s a) a))
-&gt; Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312985"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2734"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312984"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312984"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312983"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312983"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveInfixState s s a -&gt; Step (InterleaveInfixState s s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; a -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; s2 -&gt; a -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixSecondYield"><span class="hs-identifier hs-var">InterleaveInfixSecondYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312987"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312983"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312984"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2735"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312982"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312982"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveInfixState s s a -&gt; Step (InterleaveInfixState s s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; s2 -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixSecondBuf"><span class="hs-identifier hs-var">InterleaveInfixSecondBuf</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312987"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312982"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2736"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveInfixState s s a -&gt; Step (InterleaveInfixState s s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirstOnly"><span class="hs-identifier hs-var">InterleaveInfixFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312987"><span class="hs-identifier hs-var">st1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2737"></span><span>
</span><span id="line-2738"></span><span>    </span><span class="annot"><a href="#local-6989586621679312996"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312981"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312981"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixSecondYield"><span class="hs-identifier hs-type">InterleaveInfixSecondYield</span></a></span><span> </span><span id="local-6989586621679312980"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312980"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679312979"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312979"><span class="hs-identifier hs-var">st2</span></a></span></span><span> </span><span id="local-6989586621679312978"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312978"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2739"></span><span>        </span><span id="local-6989586621679312977"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312977"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313000"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312981"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312980"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2740"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveInfixState s s a) a
 -&gt; m (Step (InterleaveInfixState s s a) a))
-&gt; Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312977"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2741"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312976"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312976"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312975"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312975"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; InterleaveInfixState s s a
-&gt; Step (InterleaveInfixState s s a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312978"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; a -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; s2 -&gt; a -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirstYield"><span class="hs-identifier hs-var">InterleaveInfixFirstYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312975"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312979"><span class="hs-identifier hs-var">st2</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312976"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2742"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312974"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312974"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveInfixState s s a -&gt; Step (InterleaveInfixState s s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; a -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; s2 -&gt; a -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixSecondYield"><span class="hs-identifier hs-var">InterleaveInfixSecondYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312974"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312979"><span class="hs-identifier hs-var">st2</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312978"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2743"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveInfixState s s a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2744"></span><span>
</span><span id="line-2745"></span><span>    </span><span class="annot"><a href="#local-6989586621679312996"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirstYield"><span class="hs-identifier hs-type">InterleaveInfixFirstYield</span></a></span><span> </span><span id="local-6989586621679312973"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312973"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679312972"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312972"><span class="hs-identifier hs-var">st2</span></a></span></span><span> </span><span id="local-6989586621679312971"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312971"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2746"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveInfixState s s a) a
 -&gt; m (Step (InterleaveInfixState s s a) a))
-&gt; Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
-&gt; InterleaveInfixState s s a
-&gt; Step (InterleaveInfixState s s a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312971"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; s2 -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixSecondBuf"><span class="hs-identifier hs-var">InterleaveInfixSecondBuf</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312973"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312972"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2747"></span><span>
</span><span id="line-2748"></span><span>    </span><span class="annot"><a href="#local-6989586621679312996"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312970"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312970"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirstOnly"><span class="hs-identifier hs-type">InterleaveInfixFirstOnly</span></a></span><span> </span><span id="local-6989586621679312969"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312969"><span class="hs-identifier hs-var">st1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2749"></span><span>        </span><span id="local-6989586621679312968"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312968"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679313000"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312970"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312969"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2750"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveInfixState s s a) a
 -&gt; m (Step (InterleaveInfixState s s a) a))
-&gt; Step (InterleaveInfixState s s a) a
-&gt; m (Step (InterleaveInfixState s s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312968"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2751"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312967"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312967"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312966"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312966"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; InterleaveInfixState s s a
-&gt; Step (InterleaveInfixState s s a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312967"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirstOnly"><span class="hs-identifier hs-var">InterleaveInfixFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312966"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2752"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312965"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312965"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveInfixState s s a -&gt; Step (InterleaveInfixState s s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveInfixState s s a
forall s1 s2 a. s1 -&gt; InterleaveInfixState s1 s2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveInfixFirstOnly"><span class="hs-identifier hs-var">InterleaveInfixFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312965"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2753"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveInfixState s s a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2754"></span><span>
</span><span id="line-2755"></span><span class="hs-pragma">{-# INLINE_NORMAL roundRobin #-}</span><span>
</span><span id="line-2756"></span><span id="local-6989586621679312963"><span id="local-6989586621679312964"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#roundRobin"><span class="hs-identifier hs-type">roundRobin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312964"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312964"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312963"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312964"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312963"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312964"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312963"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-2757"></span><span id="roundRobin"><span class="annot"><span class="annottext">roundRobin :: Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#roundRobin"><span class="hs-identifier hs-var hs-var">roundRobin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312962"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312962"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312961"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312961"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312960"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312960"><span class="hs-identifier hs-var">step2</span></a></span></span><span> </span><span id="local-6989586621679312959"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312959"><span class="hs-identifier hs-var">state2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2758"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a))
-&gt; InterleaveState s s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a)
</span><a href="#local-6989586621679312958"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312961"><span class="hs-identifier hs-var">state1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312959"><span class="hs-identifier hs-var">state2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2759"></span><span>
</span><span id="line-2760"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2761"></span><span>
</span><span id="line-2762"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2763"></span><span>    </span><span id="local-6989586621679312958"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; InterleaveState s s -&gt; m (Step (InterleaveState s s) a)
</span><a href="#local-6989586621679312958"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312957"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312957"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-type">InterleaveFirst</span></a></span><span> </span><span id="local-6989586621679312956"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312956"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679312955"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312955"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2764"></span><span>        </span><span id="local-6989586621679312954"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312954"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312962"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312957"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312956"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2765"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312954"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2766"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312953"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312953"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312952"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312952"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312953"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-var">InterleaveSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312952"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312955"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2767"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312951"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312951"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-var">InterleaveSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312951"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312955"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2768"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-var">InterleaveSecondOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312955"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2769"></span><span>
</span><span id="line-2770"></span><span>    </span><span class="annot"><a href="#local-6989586621679312958"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312950"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312950"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecond"><span class="hs-identifier hs-type">InterleaveSecond</span></a></span><span> </span><span id="local-6989586621679312949"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312949"><span class="hs-identifier hs-var">st1</span></a></span></span><span> </span><span id="local-6989586621679312948"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312948"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2771"></span><span>        </span><span id="local-6989586621679312947"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312947"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312960"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312950"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312948"><span class="hs-identifier hs-var">st2</span></a></span><span>
</span><span id="line-2772"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312947"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2773"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312946"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312946"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312945"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312945"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312946"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312949"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312945"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2774"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312944"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312944"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirst"><span class="hs-identifier hs-var">InterleaveFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312949"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312944"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2775"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312949"><span class="hs-identifier hs-var">st1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2776"></span><span>
</span><span id="line-2777"></span><span>    </span><span class="annot"><a href="#local-6989586621679312958"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312943"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312943"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-type">InterleaveSecondOnly</span></a></span><span> </span><span id="local-6989586621679312942"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312942"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2778"></span><span>        </span><span id="local-6989586621679312941"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312941"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312960"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312943"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312942"><span class="hs-identifier hs-var">st2</span></a></span><span>
</span><span id="line-2779"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312941"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2780"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312940"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312940"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312939"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312939"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312940"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-var">InterleaveSecondOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312939"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2781"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312938"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312938"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s2 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveSecondOnly"><span class="hs-identifier hs-var">InterleaveSecondOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312938"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2782"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2783"></span><span>
</span><span id="line-2784"></span><span>    </span><span class="annot"><a href="#local-6989586621679312958"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312937"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312937"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-type">InterleaveFirstOnly</span></a></span><span> </span><span id="local-6989586621679312936"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312936"><span class="hs-identifier hs-var">st1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2785"></span><span>        </span><span id="local-6989586621679312935"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312935"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312962"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312937"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312936"><span class="hs-identifier hs-var">st1</span></a></span><span>
</span><span id="line-2786"></span><span>        </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a))
-&gt; Step (InterleaveState s s) a -&gt; m (Step (InterleaveState s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312935"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2787"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312934"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312934"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312933"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312933"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312934"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312933"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2788"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312932"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312932"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterleaveState s s -&gt; Step (InterleaveState s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterleaveState s s
forall s1 s2. s1 -&gt; InterleaveState s1 s2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterleaveFirstOnly"><span class="hs-identifier hs-var">InterleaveFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312932"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2789"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterleaveState s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2790"></span><span>
</span><span id="line-2791"></span><span class="hs-keyword">data</span><span> </span><span id="ICUState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUState"><span class="hs-identifier hs-var">ICUState</span></a></span></span><span> </span><span id="local-6989586621679315549"><span class="annot"><a href="#local-6989586621679315549"><span class="hs-identifier hs-type">s1</span></a></span></span><span> </span><span id="local-6989586621679315548"><span class="annot"><a href="#local-6989586621679315548"><span class="hs-identifier hs-type">s2</span></a></span></span><span> </span><span id="local-6989586621679315547"><span class="annot"><a href="#local-6989586621679315547"><span class="hs-identifier hs-type">i1</span></a></span></span><span> </span><span id="local-6989586621679315546"><span class="annot"><a href="#local-6989586621679315546"><span class="hs-identifier hs-type">i2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2792"></span><span>      </span><span id="ICUFirst"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirst"><span class="hs-identifier hs-var">ICUFirst</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315549"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315548"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2793"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICUSecond"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecond"><span class="hs-identifier hs-var">ICUSecond</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315549"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315548"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2794"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICUSecondOnly"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecondOnly"><span class="hs-identifier hs-var">ICUSecondOnly</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315548"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2795"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICUFirstOnly"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnly"><span class="hs-identifier hs-var">ICUFirstOnly</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315549"><span class="hs-identifier hs-type">s1</span></a></span><span>
</span><span id="line-2796"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICUFirstInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstInner"><span class="hs-identifier hs-var">ICUFirstInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315549"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315548"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315547"><span class="hs-identifier hs-type">i1</span></a></span><span>
</span><span id="line-2797"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICUSecondInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecondInner"><span class="hs-identifier hs-var">ICUSecondInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315549"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315548"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315546"><span class="hs-identifier hs-type">i2</span></a></span><span>
</span><span id="line-2798"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICUFirstOnlyInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnlyInner"><span class="hs-identifier hs-var">ICUFirstOnlyInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315549"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315547"><span class="hs-identifier hs-type">i1</span></a></span><span>
</span><span id="line-2799"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICUSecondOnlyInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecondOnlyInner"><span class="hs-identifier hs-var">ICUSecondOnlyInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315548"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315546"><span class="hs-identifier hs-type">i2</span></a></span><span>
</span><span id="line-2800"></span><span>
</span><span id="line-2801"></span><span class="hs-comment">-- | Interleave streams (full streams, not the elements) unfolded from two</span><span>
</span><span id="line-2802"></span><span class="hs-comment">-- input streams and concat. Stop when the first stream stops. If the second</span><span>
</span><span id="line-2803"></span><span class="hs-comment">-- stream ends before the first one then first stream still keeps running alone</span><span>
</span><span id="line-2804"></span><span class="hs-comment">-- without any interleaving with the second stream.</span><span>
</span><span id="line-2805"></span><span class="hs-comment">--</span><span>
</span><span id="line-2806"></span><span class="hs-comment">--    [a1, a2, ... an]                   [b1, b2 ...]</span><span>
</span><span id="line-2807"></span><span class="hs-comment">-- =&gt; [streamA1, streamA2, ... streamAn] [streamB1, streamB2, ...]</span><span>
</span><span id="line-2808"></span><span class="hs-comment">-- =&gt; [streamA1, streamB1, streamA2...StreamAn, streamBn]</span><span>
</span><span id="line-2809"></span><span class="hs-comment">-- =&gt; [a11, a12, ...a1j, b11, b12, ...b1k, a21, a22, ...]</span><span>
</span><span id="line-2810"></span><span class="hs-comment">--</span><span>
</span><span id="line-2811"></span><span class="hs-pragma">{-# INLINE_NORMAL gintercalateSuffix #-}</span><span>
</span><span id="line-2812"></span><span id="local-6989586621679312920"><span id="local-6989586621679312921"><span id="local-6989586621679312922"><span id="local-6989586621679312923"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#gintercalateSuffix"><span class="hs-identifier hs-type">gintercalateSuffix</span></a></span><span>
</span><span id="line-2813"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312923"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-2814"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312923"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312922"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312921"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312923"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312922"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312923"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312920"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312921"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312923"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312920"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312923"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312921"><span class="hs-identifier hs-type">c</span></a></span></span></span></span></span><span>
</span><span id="line-2815"></span><span id="gintercalateSuffix"><span class="annot"><span class="annottext">gintercalateSuffix :: Unfold m a c
-&gt; Stream m a -&gt; Unfold m b c -&gt; Stream m b -&gt; Stream m c
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#gintercalateSuffix"><span class="hs-identifier hs-var hs-var">gintercalateSuffix</span></a></span></span><span>
</span><span id="line-2816"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679312919"><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312919"><span class="hs-identifier hs-var">istep1</span></a></span></span><span> </span><span id="local-6989586621679312918"><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679312918"><span class="hs-identifier hs-var">inject1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312917"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312917"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312916"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312916"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2817"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679312915"><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312915"><span class="hs-identifier hs-var">istep2</span></a></span></span><span> </span><span id="local-6989586621679312914"><span class="annot"><span class="annottext">b -&gt; m s
</span><a href="#local-6989586621679312914"><span class="hs-identifier hs-var">inject2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312913"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312913"><span class="hs-identifier hs-var">step2</span></a></span></span><span> </span><span id="local-6989586621679312912"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312912"><span class="hs-identifier hs-var">state2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2818"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m c
 -&gt; ICUState s s s s -&gt; m (Step (ICUState s s s s) c))
-&gt; ICUState s s s s -&gt; Stream m c
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m c
-&gt; ICUState s s s s -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; ICUState s s s s -&gt; m (Step (ICUState s s s s) c)
</span><a href="#local-6989586621679312911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirst"><span class="hs-identifier hs-var">ICUFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312916"><span class="hs-identifier hs-var">state1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312912"><span class="hs-identifier hs-var">state2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2819"></span><span>
</span><span id="line-2820"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2821"></span><span>
</span><span id="line-2822"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2823"></span><span>    </span><span id="local-6989586621679312911"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; ICUState s s s s -&gt; m (Step (ICUState s s s s) c)
</span><a href="#local-6989586621679312911"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312910"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312910"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirst"><span class="hs-identifier hs-type">ICUFirst</span></a></span><span> </span><span id="local-6989586621679312909"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312909"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312908"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312908"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2824"></span><span>        </span><span id="local-6989586621679312907"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312907"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312917"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312910"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312909"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-2825"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312907"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2826"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312906"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312906"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312905"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312905"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2827"></span><span>                </span><span id="local-6989586621679312904"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312904"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679312918"><span class="hs-identifier hs-var">inject1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312906"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2828"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312904"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step (ICUState s s s s) c) -&gt; m (Step (ICUState s s s s) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; i1 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstInner"><span class="hs-identifier hs-var">ICUFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312905"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312908"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312904"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2829"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312903"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312903"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c))
-&gt; Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirst"><span class="hs-identifier hs-var">ICUFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312903"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312908"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2830"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2831"></span><span>
</span><span id="line-2832"></span><span>    </span><span class="annot"><a href="#local-6989586621679312911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312902"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312902"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnly"><span class="hs-identifier hs-type">ICUFirstOnly</span></a></span><span> </span><span id="local-6989586621679312901"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312901"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2833"></span><span>        </span><span id="local-6989586621679312900"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312900"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312917"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312902"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312901"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-2834"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312900"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2835"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312899"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312899"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312898"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312898"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2836"></span><span>                </span><span id="local-6989586621679312897"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312897"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679312918"><span class="hs-identifier hs-var">inject1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312899"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2837"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312897"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step (ICUState s s s s) c) -&gt; m (Step (ICUState s s s s) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; i1 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnlyInner"><span class="hs-identifier hs-var">ICUFirstOnlyInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312898"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312897"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2838"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312896"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312896"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c))
-&gt; Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnly"><span class="hs-identifier hs-var">ICUFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312896"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2839"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2840"></span><span>
</span><span id="line-2841"></span><span>    </span><span class="annot"><a href="#local-6989586621679312911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstInner"><span class="hs-identifier hs-type">ICUFirstInner</span></a></span><span> </span><span id="local-6989586621679312895"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312895"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312894"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312894"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span id="local-6989586621679312893"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312893"><span class="hs-identifier hs-var">i1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2842"></span><span>        </span><span id="local-6989586621679312892"><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312892"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312919"><span class="hs-identifier hs-var">istep1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312893"><span class="hs-identifier hs-var">i1</span></a></span><span>
</span><span id="line-2843"></span><span>        </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c))
-&gt; Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312892"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2844"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312891"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312891"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312890"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312890"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312891"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; i1 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstInner"><span class="hs-identifier hs-var">ICUFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312895"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312894"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312890"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2845"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312889"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312889"><span class="hs-identifier hs-var">i'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; i1 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstInner"><span class="hs-identifier hs-var">ICUFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312895"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312894"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312889"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2846"></span><span>            </span><span class="annot"><span class="annottext">Step s c
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecond"><span class="hs-identifier hs-var">ICUSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312895"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312894"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2847"></span><span>
</span><span id="line-2848"></span><span>    </span><span class="annot"><a href="#local-6989586621679312911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnlyInner"><span class="hs-identifier hs-type">ICUFirstOnlyInner</span></a></span><span> </span><span id="local-6989586621679312888"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312888"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312887"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312887"><span class="hs-identifier hs-var">i1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2849"></span><span>        </span><span id="local-6989586621679312886"><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312886"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312919"><span class="hs-identifier hs-var">istep1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312887"><span class="hs-identifier hs-var">i1</span></a></span><span>
</span><span id="line-2850"></span><span>        </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c))
-&gt; Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312886"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2851"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312885"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312885"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312884"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312884"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312885"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; i1 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnlyInner"><span class="hs-identifier hs-var">ICUFirstOnlyInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312888"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312884"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2852"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312883"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312883"><span class="hs-identifier hs-var">i'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; i1 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnlyInner"><span class="hs-identifier hs-var">ICUFirstOnlyInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312888"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312883"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2853"></span><span>            </span><span class="annot"><span class="annottext">Step s c
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnly"><span class="hs-identifier hs-var">ICUFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312888"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2854"></span><span>
</span><span id="line-2855"></span><span>    </span><span class="annot"><a href="#local-6989586621679312911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312882"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312882"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecond"><span class="hs-identifier hs-type">ICUSecond</span></a></span><span> </span><span id="local-6989586621679312881"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312881"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312880"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312880"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2856"></span><span>        </span><span id="local-6989586621679312879"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312879"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312913"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m b
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312882"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312880"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-2857"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312879"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2858"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312878"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312878"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312877"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312877"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2859"></span><span>                </span><span id="local-6989586621679312876"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312876"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; m s
</span><a href="#local-6989586621679312914"><span class="hs-identifier hs-var">inject2</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312878"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2860"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312876"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step (ICUState s s s s) c) -&gt; m (Step (ICUState s s s s) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; i2 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecondInner"><span class="hs-identifier hs-var">ICUSecondInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312881"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312877"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312876"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2861"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312875"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312875"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c))
-&gt; Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecond"><span class="hs-identifier hs-var">ICUSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312881"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312875"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2862"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c))
-&gt; Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirstOnly"><span class="hs-identifier hs-var">ICUFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312881"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2863"></span><span>
</span><span id="line-2864"></span><span>    </span><span class="annot"><a href="#local-6989586621679312911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecondInner"><span class="hs-identifier hs-type">ICUSecondInner</span></a></span><span> </span><span id="local-6989586621679312874"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312874"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312873"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312873"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span id="local-6989586621679312872"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312872"><span class="hs-identifier hs-var">i2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2865"></span><span>        </span><span id="local-6989586621679312871"><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312871"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312915"><span class="hs-identifier hs-var">istep2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312872"><span class="hs-identifier hs-var">i2</span></a></span><span>
</span><span id="line-2866"></span><span>        </span><span class="annot"><span class="annottext">Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c))
-&gt; Step (ICUState s s s s) c -&gt; m (Step (ICUState s s s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312871"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2867"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312870"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312870"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312869"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312869"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312870"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; i2 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecondInner"><span class="hs-identifier hs-var">ICUSecondInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312874"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312873"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312869"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2868"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312868"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312868"><span class="hs-identifier hs-var">i'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; i2 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecondInner"><span class="hs-identifier hs-var">ICUSecondInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312874"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312873"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312868"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2869"></span><span>            </span><span class="annot"><span class="annottext">Step s c
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICUState s s s s -&gt; Step (ICUState s s s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICUState s s s s
forall s1 s2 i1 i2. s1 -&gt; s2 -&gt; ICUState s1 s2 i1 i2
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUFirst"><span class="hs-identifier hs-var">ICUFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312874"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312873"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2870"></span><span>
</span><span id="line-2871"></span><span>    </span><span class="annot"><a href="#local-6989586621679312911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecondOnly"><span class="hs-identifier hs-type">ICUSecondOnly</span></a></span><span> </span><span id="local-6989586621679312867"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312867"><span class="hs-identifier hs-var">_s2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Step (ICUState s s s s) c)
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-2872"></span><span>    </span><span class="annot"><a href="#local-6989586621679312911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICUSecondOnlyInner"><span class="hs-identifier hs-type">ICUSecondOnlyInner</span></a></span><span> </span><span id="local-6989586621679312866"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312866"><span class="hs-identifier hs-var">_s2</span></a></span></span><span> </span><span id="local-6989586621679312865"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312865"><span class="hs-identifier hs-var">_i2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Step (ICUState s s s s) c)
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-2873"></span><span>
</span><span id="line-2874"></span><span class="hs-keyword">data</span><span> </span><span id="InterposeSuffixState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixState"><span class="hs-identifier hs-var">InterposeSuffixState</span></a></span></span><span> </span><span id="local-6989586621679315537"><span class="annot"><a href="#local-6989586621679315537"><span class="hs-identifier hs-type">s1</span></a></span></span><span> </span><span id="local-6989586621679315536"><span class="annot"><a href="#local-6989586621679315536"><span class="hs-identifier hs-type">i1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2875"></span><span>      </span><span id="InterposeSuffixFirst"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirst"><span class="hs-identifier hs-var">InterposeSuffixFirst</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315537"><span class="hs-identifier hs-type">s1</span></a></span><span>
</span><span id="line-2876"></span><span>    </span><span class="hs-comment">-- | InterposeSuffixFirstYield s1 i1</span><span>
</span><span id="line-2877"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterposeSuffixFirstInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirstInner"><span class="hs-identifier hs-var">InterposeSuffixFirstInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315537"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315536"><span class="hs-identifier hs-type">i1</span></a></span><span>
</span><span id="line-2878"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterposeSuffixSecond"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixSecond"><span class="hs-identifier hs-var">InterposeSuffixSecond</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315537"><span class="hs-identifier hs-type">s1</span></a></span><span>
</span><span id="line-2879"></span><span>
</span><span id="line-2880"></span><span class="hs-comment">-- Note that if an unfolded layer turns out to be nil we still emit the</span><span>
</span><span id="line-2881"></span><span class="hs-comment">-- separator effect. An alternate behavior could be to emit the separator</span><span>
</span><span id="line-2882"></span><span class="hs-comment">-- effect only if at least one element has been yielded by the unfolding.</span><span>
</span><span id="line-2883"></span><span class="hs-comment">-- However, that becomes a bit complicated, so we have chosen the former</span><span>
</span><span id="line-2884"></span><span class="hs-comment">-- behvaior for now.</span><span>
</span><span id="line-2885"></span><span class="hs-pragma">{-# INLINE_NORMAL interposeSuffix #-}</span><span>
</span><span id="line-2886"></span><span id="local-6989586621679312859"><span id="local-6989586621679312860"><span id="local-6989586621679312861"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interposeSuffix"><span class="hs-identifier hs-type">interposeSuffix</span></a></span><span>
</span><span id="line-2887"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312861"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-2888"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312861"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312860"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312861"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312859"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312860"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312861"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312859"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312861"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312860"><span class="hs-identifier hs-type">c</span></a></span></span></span></span><span>
</span><span id="line-2889"></span><span id="interposeSuffix"><span class="annot"><span class="annottext">interposeSuffix :: m c -&gt; Unfold m b c -&gt; Stream m b -&gt; Stream m c
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#interposeSuffix"><span class="hs-identifier hs-var hs-var">interposeSuffix</span></a></span></span><span>
</span><span id="line-2890"></span><span>    </span><span id="local-6989586621679312858"><span class="annot"><span class="annottext">m c
</span><a href="#local-6989586621679312858"><span class="hs-identifier hs-var">action</span></a></span></span><span>
</span><span id="line-2891"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679312857"><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312857"><span class="hs-identifier hs-var">istep1</span></a></span></span><span> </span><span id="local-6989586621679312856"><span class="annot"><span class="annottext">b -&gt; m s
</span><a href="#local-6989586621679312856"><span class="hs-identifier hs-var">inject1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312855"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312855"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312854"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312854"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2892"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m c
 -&gt; InterposeSuffixState s s
 -&gt; m (Step (InterposeSuffixState s s) c))
-&gt; InterposeSuffixState s s -&gt; Stream m c
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m c
-&gt; InterposeSuffixState s s
-&gt; m (Step (InterposeSuffixState s s) c)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; InterposeSuffixState s s
-&gt; m (Step (InterposeSuffixState s s) c)
</span><a href="#local-6989586621679312853"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterposeSuffixState s s
forall s1 i1. s1 -&gt; InterposeSuffixState s1 i1
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirst"><span class="hs-identifier hs-var">InterposeSuffixFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312854"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2893"></span><span>
</span><span id="line-2894"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2895"></span><span>
</span><span id="line-2896"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2897"></span><span>    </span><span id="local-6989586621679312853"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; InterposeSuffixState s s
-&gt; m (Step (InterposeSuffixState s s) c)
</span><a href="#local-6989586621679312853"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312852"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312852"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirst"><span class="hs-identifier hs-type">InterposeSuffixFirst</span></a></span><span> </span><span id="local-6989586621679312851"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312851"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2898"></span><span>        </span><span id="local-6989586621679312850"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312850"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312855"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m b
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312852"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312851"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-2899"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312850"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2900"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312849"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312849"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312848"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312848"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2901"></span><span>                </span><span id="local-6989586621679312847"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312847"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; m s
</span><a href="#local-6989586621679312856"><span class="hs-identifier hs-var">inject1</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312849"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2902"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312847"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (InterposeSuffixState s s) c)
-&gt; m (Step (InterposeSuffixState s s) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (InterposeSuffixState s s) c
-&gt; m (Step (InterposeSuffixState s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InterposeSuffixState s s -&gt; Step (InterposeSuffixState s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterposeSuffixState s s
forall s1 i1. s1 -&gt; i1 -&gt; InterposeSuffixState s1 i1
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirstInner"><span class="hs-identifier hs-var">InterposeSuffixFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312848"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312847"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2903"></span><span>                </span><span class="hs-comment">-- i `seq` return (Skip (InterposeSuffixFirstYield s i))</span><span>
</span><span id="line-2904"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312846"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312846"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterposeSuffixState s s) c
-&gt; m (Step (InterposeSuffixState s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterposeSuffixState s s) c
 -&gt; m (Step (InterposeSuffixState s s) c))
-&gt; Step (InterposeSuffixState s s) c
-&gt; m (Step (InterposeSuffixState s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InterposeSuffixState s s -&gt; Step (InterposeSuffixState s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterposeSuffixState s s
forall s1 i1. s1 -&gt; InterposeSuffixState s1 i1
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirst"><span class="hs-identifier hs-var">InterposeSuffixFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312846"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2905"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterposeSuffixState s s) c
-&gt; m (Step (InterposeSuffixState s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (InterposeSuffixState s s) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2906"></span><span>
</span><span id="line-2907"></span><span>    </span><span class="hs-comment">{-
    step _ (InterposeSuffixFirstYield s1 i1) = do
        r &lt;- istep1 i1
        return $ case r of
            Yield x i' -&gt; Yield x (InterposeSuffixFirstInner s1 i')
            Skip i'    -&gt; Skip (InterposeSuffixFirstYield s1 i')
            Stop       -&gt; Skip (InterposeSuffixFirst s1)
    -}</span><span>
</span><span id="line-2915"></span><span>
</span><span id="line-2916"></span><span>    </span><span class="annot"><a href="#local-6989586621679312853"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirstInner"><span class="hs-identifier hs-type">InterposeSuffixFirstInner</span></a></span><span> </span><span id="local-6989586621679312845"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312845"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312844"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312844"><span class="hs-identifier hs-var">i1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2917"></span><span>        </span><span id="local-6989586621679312843"><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312843"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312857"><span class="hs-identifier hs-var">istep1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312844"><span class="hs-identifier hs-var">i1</span></a></span><span>
</span><span id="line-2918"></span><span>        </span><span class="annot"><span class="annottext">Step (InterposeSuffixState s s) c
-&gt; m (Step (InterposeSuffixState s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterposeSuffixState s s) c
 -&gt; m (Step (InterposeSuffixState s s) c))
-&gt; Step (InterposeSuffixState s s) c
-&gt; m (Step (InterposeSuffixState s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312843"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2919"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312842"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312842"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312841"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312841"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; InterposeSuffixState s s -&gt; Step (InterposeSuffixState s s) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312842"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterposeSuffixState s s
forall s1 i1. s1 -&gt; i1 -&gt; InterposeSuffixState s1 i1
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirstInner"><span class="hs-identifier hs-var">InterposeSuffixFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312845"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312841"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2920"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312840"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312840"><span class="hs-identifier hs-var">i'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterposeSuffixState s s -&gt; Step (InterposeSuffixState s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterposeSuffixState s s
forall s1 i1. s1 -&gt; i1 -&gt; InterposeSuffixState s1 i1
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirstInner"><span class="hs-identifier hs-var">InterposeSuffixFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312845"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312840"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2921"></span><span>            </span><span class="annot"><span class="annottext">Step s c
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterposeSuffixState s s -&gt; Step (InterposeSuffixState s s) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterposeSuffixState s s
forall s1 i1. s1 -&gt; InterposeSuffixState s1 i1
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixSecond"><span class="hs-identifier hs-var">InterposeSuffixSecond</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312845"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2922"></span><span>
</span><span id="line-2923"></span><span>    </span><span class="annot"><a href="#local-6989586621679312853"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixSecond"><span class="hs-identifier hs-type">InterposeSuffixSecond</span></a></span><span> </span><span id="local-6989586621679312839"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312839"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2924"></span><span>        </span><span id="local-6989586621679312838"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312838"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m c
</span><a href="#local-6989586621679312858"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-2925"></span><span>        </span><span class="annot"><span class="annottext">Step (InterposeSuffixState s s) c
-&gt; m (Step (InterposeSuffixState s s) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterposeSuffixState s s) c
 -&gt; m (Step (InterposeSuffixState s s) c))
-&gt; Step (InterposeSuffixState s s) c
-&gt; m (Step (InterposeSuffixState s s) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">c -&gt; InterposeSuffixState s s -&gt; Step (InterposeSuffixState s s) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312838"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterposeSuffixState s s
forall s1 i1. s1 -&gt; InterposeSuffixState s1 i1
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSuffixFirst"><span class="hs-identifier hs-var">InterposeSuffixFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312839"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2926"></span><span>
</span><span id="line-2927"></span><span class="hs-keyword">data</span><span> </span><span id="ICALState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALState"><span class="hs-identifier hs-var">ICALState</span></a></span></span><span> </span><span id="local-6989586621679315522"><span class="annot"><a href="#local-6989586621679315522"><span class="hs-identifier hs-type">s1</span></a></span></span><span> </span><span id="local-6989586621679315521"><span class="annot"><a href="#local-6989586621679315521"><span class="hs-identifier hs-type">s2</span></a></span></span><span> </span><span id="local-6989586621679315520"><span class="annot"><a href="#local-6989586621679315520"><span class="hs-identifier hs-type">i1</span></a></span></span><span> </span><span id="local-6989586621679315519"><span class="annot"><a href="#local-6989586621679315519"><span class="hs-identifier hs-type">i2</span></a></span></span><span> </span><span id="local-6989586621679315518"><span class="annot"><a href="#local-6989586621679315518"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2928"></span><span>      </span><span id="ICALFirst"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirst"><span class="hs-identifier hs-var">ICALFirst</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315522"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315521"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2929"></span><span>    </span><span class="hs-comment">-- | ICALFirstYield s1 s2 i1</span><span>
</span><span id="line-2930"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICALFirstInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInner"><span class="hs-identifier hs-var">ICALFirstInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315522"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315521"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315520"><span class="hs-identifier hs-type">i1</span></a></span><span>
</span><span id="line-2931"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICALFirstOnly"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnly"><span class="hs-identifier hs-var">ICALFirstOnly</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315522"><span class="hs-identifier hs-type">s1</span></a></span><span>
</span><span id="line-2932"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICALFirstOnlyInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnlyInner"><span class="hs-identifier hs-var">ICALFirstOnlyInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315522"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315520"><span class="hs-identifier hs-type">i1</span></a></span><span>
</span><span id="line-2933"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICALSecondInject"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALSecondInject"><span class="hs-identifier hs-var">ICALSecondInject</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315522"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315521"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-2934"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICALFirstInject"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInject"><span class="hs-identifier hs-var">ICALFirstInject</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315522"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315521"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315519"><span class="hs-identifier hs-type">i2</span></a></span><span>
</span><span id="line-2935"></span><span>    </span><span class="hs-comment">-- | ICALFirstBuf s1 s2 i1 i2</span><span>
</span><span id="line-2936"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ICALSecondInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALSecondInner"><span class="hs-identifier hs-var">ICALSecondInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315522"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315521"><span class="hs-identifier hs-type">s2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315520"><span class="hs-identifier hs-type">i1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315519"><span class="hs-identifier hs-type">i2</span></a></span><span>
</span><span id="line-2937"></span><span>    </span><span class="hs-comment">-- -- | ICALSecondInner s1 s2 i1 i2 a</span><span>
</span><span id="line-2938"></span><span>    </span><span class="hs-comment">-- -- | ICALFirstResume s1 s2 i1 i2 a</span><span>
</span><span id="line-2939"></span><span>
</span><span id="line-2940"></span><span class="hs-comment">-- | Interleave streams (full streams, not the elements) unfolded from two</span><span>
</span><span id="line-2941"></span><span class="hs-comment">-- input streams and concat. Stop when the first stream stops. If the second</span><span>
</span><span id="line-2942"></span><span class="hs-comment">-- stream ends before the first one then first stream still keeps running alone</span><span>
</span><span id="line-2943"></span><span class="hs-comment">-- without any interleaving with the second stream.</span><span>
</span><span id="line-2944"></span><span class="hs-comment">--</span><span>
</span><span id="line-2945"></span><span class="hs-comment">--    [a1, a2, ... an]                   [b1, b2 ...]</span><span>
</span><span id="line-2946"></span><span class="hs-comment">-- =&gt; [streamA1, streamA2, ... streamAn] [streamB1, streamB2, ...]</span><span>
</span><span id="line-2947"></span><span class="hs-comment">-- =&gt; [streamA1, streamB1, streamA2...StreamAn, streamBn]</span><span>
</span><span id="line-2948"></span><span class="hs-comment">-- =&gt; [a11, a12, ...a1j, b11, b12, ...b1k, a21, a22, ...]</span><span>
</span><span id="line-2949"></span><span class="hs-comment">--</span><span>
</span><span id="line-2950"></span><span class="hs-pragma">{-# INLINE_NORMAL gintercalate #-}</span><span>
</span><span id="line-2951"></span><span id="local-6989586621679312827"><span id="local-6989586621679312828"><span id="local-6989586621679312829"><span id="local-6989586621679312830"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#gintercalate"><span class="hs-identifier hs-type">gintercalate</span></a></span><span>
</span><span id="line-2952"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312830"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-2953"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312830"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312829"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312828"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312830"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312829"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312830"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312827"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312828"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312830"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312827"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312830"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312828"><span class="hs-identifier hs-type">c</span></a></span></span></span></span></span><span>
</span><span id="line-2954"></span><span id="gintercalate"><span class="annot"><span class="annottext">gintercalate :: Unfold m a c
-&gt; Stream m a -&gt; Unfold m b c -&gt; Stream m b -&gt; Stream m c
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#gintercalate"><span class="hs-identifier hs-var hs-var">gintercalate</span></a></span></span><span>
</span><span id="line-2955"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679312826"><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312826"><span class="hs-identifier hs-var">istep1</span></a></span></span><span> </span><span id="local-6989586621679312825"><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679312825"><span class="hs-identifier hs-var">inject1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312824"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312824"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312823"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312823"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2956"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679312822"><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312822"><span class="hs-identifier hs-var">istep2</span></a></span></span><span> </span><span id="local-6989586621679312821"><span class="annot"><span class="annottext">b -&gt; m s
</span><a href="#local-6989586621679312821"><span class="hs-identifier hs-var">inject2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312820"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312820"><span class="hs-identifier hs-var">step2</span></a></span></span><span> </span><span id="local-6989586621679312819"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312819"><span class="hs-identifier hs-var">state2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2957"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m c
 -&gt; ICALState s s s s Any -&gt; m (Step (ICALState s s s s Any) c))
-&gt; ICALState s s s s Any -&gt; Stream m c
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m c
-&gt; ICALState s s s s Any -&gt; m (Step (ICALState s s s s Any) c)
forall (m :: * -&gt; *) a a a.
State Stream m a
-&gt; ICALState s s s s a -&gt; m (Step (ICALState s s s s a) c)
</span><a href="#local-6989586621679312818"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICALState s s s s Any
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirst"><span class="hs-identifier hs-var">ICALFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312823"><span class="hs-identifier hs-var">state1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312819"><span class="hs-identifier hs-var">state2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2958"></span><span>
</span><span id="line-2959"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2960"></span><span>
</span><span id="line-2961"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-2962"></span><span>    </span><span id="local-6989586621679312818"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; ICALState s s s s a -&gt; m (Step (ICALState s s s s a) c)
</span><a href="#local-6989586621679312818"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312817"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312817"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirst"><span class="hs-identifier hs-type">ICALFirst</span></a></span><span> </span><span id="local-6989586621679312816"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312816"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312815"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312815"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2963"></span><span>        </span><span id="local-6989586621679312814"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312814"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312824"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312817"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312816"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-2964"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312814"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2965"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312813"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312813"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312812"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312812"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2966"></span><span>                </span><span id="local-6989586621679312811"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312811"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679312825"><span class="hs-identifier hs-var">inject1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312813"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2967"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312811"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (ICALState s s s s a) c)
-&gt; m (Step (ICALState s s s s a) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; i1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInner"><span class="hs-identifier hs-var">ICALFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312812"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312815"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312811"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2968"></span><span>                </span><span class="hs-comment">-- i `seq` return (Skip (ICALFirstYield s s2 i))</span><span>
</span><span id="line-2969"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312810"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312810"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c))
-&gt; Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirst"><span class="hs-identifier hs-var">ICALFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312810"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312815"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2970"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2971"></span><span>
</span><span id="line-2972"></span><span>    </span><span class="hs-comment">{-
    step _ (ICALFirstYield s1 s2 i1) = do
        r &lt;- istep1 i1
        return $ case r of
            Yield x i' -&gt; Yield x (ICALFirstInner s1 s2 i')
            Skip i'    -&gt; Skip (ICALFirstYield s1 s2 i')
            Stop       -&gt; Skip (ICALFirst s1 s2)
    -}</span><span>
</span><span id="line-2980"></span><span>
</span><span id="line-2981"></span><span>    </span><span class="annot"><a href="#local-6989586621679312818"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInner"><span class="hs-identifier hs-type">ICALFirstInner</span></a></span><span> </span><span id="local-6989586621679312809"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312809"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312808"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312808"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span id="local-6989586621679312807"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312807"><span class="hs-identifier hs-var">i1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2982"></span><span>        </span><span id="local-6989586621679312806"><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312806"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312826"><span class="hs-identifier hs-var">istep1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312807"><span class="hs-identifier hs-var">i1</span></a></span><span>
</span><span id="line-2983"></span><span>        </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c))
-&gt; Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312806"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2984"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312805"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312805"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312804"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312804"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312805"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; i1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInner"><span class="hs-identifier hs-var">ICALFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312809"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312808"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312804"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2985"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312803"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312803"><span class="hs-identifier hs-var">i'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; i1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInner"><span class="hs-identifier hs-var">ICALFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312809"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312808"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312803"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2986"></span><span>            </span><span class="annot"><span class="annottext">Step s c
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALSecondInject"><span class="hs-identifier hs-var">ICALSecondInject</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312809"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312808"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2987"></span><span>
</span><span id="line-2988"></span><span>    </span><span class="annot"><a href="#local-6989586621679312818"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312802"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312802"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnly"><span class="hs-identifier hs-type">ICALFirstOnly</span></a></span><span> </span><span id="local-6989586621679312801"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312801"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2989"></span><span>        </span><span id="local-6989586621679312800"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312800"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312824"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312802"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312801"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-2990"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312800"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2991"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312799"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312799"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312798"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312798"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2992"></span><span>                </span><span id="local-6989586621679312797"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312797"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679312825"><span class="hs-identifier hs-var">inject1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312799"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2993"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312797"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (ICALState s s s s a) c)
-&gt; m (Step (ICALState s s s s a) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; i1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnlyInner"><span class="hs-identifier hs-var">ICALFirstOnlyInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312798"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312797"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2994"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312796"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312796"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c))
-&gt; Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnly"><span class="hs-identifier hs-var">ICALFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312796"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2995"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-2996"></span><span>
</span><span id="line-2997"></span><span>    </span><span class="annot"><a href="#local-6989586621679312818"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnlyInner"><span class="hs-identifier hs-type">ICALFirstOnlyInner</span></a></span><span> </span><span id="local-6989586621679312795"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312795"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312794"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312794"><span class="hs-identifier hs-var">i1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2998"></span><span>        </span><span id="local-6989586621679312793"><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312793"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312826"><span class="hs-identifier hs-var">istep1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312794"><span class="hs-identifier hs-var">i1</span></a></span><span>
</span><span id="line-2999"></span><span>        </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c))
-&gt; Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312793"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3000"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312792"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312792"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312791"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312791"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312792"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; i1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnlyInner"><span class="hs-identifier hs-var">ICALFirstOnlyInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312795"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312791"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3001"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312790"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312790"><span class="hs-identifier hs-var">i'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; i1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnlyInner"><span class="hs-identifier hs-var">ICALFirstOnlyInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312795"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312790"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3002"></span><span>            </span><span class="annot"><span class="annottext">Step s c
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnly"><span class="hs-identifier hs-var">ICALFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312795"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3003"></span><span>
</span><span id="line-3004"></span><span>    </span><span class="hs-comment">-- We inject the second stream even before checking if the first stream</span><span>
</span><span id="line-3005"></span><span>    </span><span class="hs-comment">-- would yield any more elements. There is no clear choice whether we</span><span>
</span><span id="line-3006"></span><span>    </span><span class="hs-comment">-- should do this before or after that. Doing it after may make the state</span><span>
</span><span id="line-3007"></span><span>    </span><span class="hs-comment">-- machine a bit simpler though.</span><span>
</span><span id="line-3008"></span><span>    </span><span class="annot"><a href="#local-6989586621679312818"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312789"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312789"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALSecondInject"><span class="hs-identifier hs-type">ICALSecondInject</span></a></span><span> </span><span id="local-6989586621679312788"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312788"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312787"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312787"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3009"></span><span>        </span><span id="local-6989586621679312786"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312786"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312820"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m b
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312789"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312787"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-3010"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312786"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3011"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312785"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312785"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312784"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312784"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3012"></span><span>                </span><span id="local-6989586621679312783"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312783"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; m s
</span><a href="#local-6989586621679312821"><span class="hs-identifier hs-var">inject2</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312785"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-3013"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312783"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (ICALState s s s s a) c)
-&gt; m (Step (ICALState s s s s a) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; i2 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInject"><span class="hs-identifier hs-var">ICALFirstInject</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312788"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312784"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312783"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3014"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312782"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312782"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c))
-&gt; Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALSecondInject"><span class="hs-identifier hs-var">ICALSecondInject</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312788"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312782"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3015"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c))
-&gt; Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstOnly"><span class="hs-identifier hs-var">ICALFirstOnly</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312788"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3016"></span><span>
</span><span id="line-3017"></span><span>    </span><span class="annot"><a href="#local-6989586621679312818"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312781"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312781"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInject"><span class="hs-identifier hs-type">ICALFirstInject</span></a></span><span> </span><span id="local-6989586621679312780"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312780"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312779"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312779"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span id="local-6989586621679312778"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312778"><span class="hs-identifier hs-var">i2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3018"></span><span>        </span><span id="local-6989586621679312777"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312777"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312824"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312781"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312780"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-3019"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312777"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3020"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312776"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312776"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312775"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312775"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3021"></span><span>                </span><span id="local-6989586621679312774"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312774"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m s
</span><a href="#local-6989586621679312825"><span class="hs-identifier hs-var">inject1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312776"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-3022"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312774"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (ICALState s s s s a) c)
-&gt; m (Step (ICALState s s s s a) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a.
s1 -&gt; s2 -&gt; i1 -&gt; i2 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALSecondInner"><span class="hs-identifier hs-var">ICALSecondInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312775"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312779"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312774"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312778"><span class="hs-identifier hs-var">i2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3023"></span><span>                </span><span class="hs-comment">-- i `seq` return (Skip (ICALFirstBuf s s2 i i2))</span><span>
</span><span id="line-3024"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312773"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312773"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c))
-&gt; Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; i2 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInject"><span class="hs-identifier hs-var">ICALFirstInject</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312773"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312779"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312778"><span class="hs-identifier hs-var">i2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3025"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3026"></span><span>
</span><span id="line-3027"></span><span>    </span><span class="hs-comment">{-
    step _ (ICALFirstBuf s1 s2 i1 i2) = do
        r &lt;- istep1 i1
        return $ case r of
            Yield x i' -&gt; Skip (ICALSecondInner s1 s2 i' i2 x)
            Skip i'    -&gt; Skip (ICALFirstBuf s1 s2 i' i2)
            Stop       -&gt; Stop

    step _ (ICALSecondInner s1 s2 i1 i2 v) = do
        r &lt;- istep2 i2
        return $ case r of
            Yield x i' -&gt; Yield x (ICALSecondInner s1 s2 i1 i' v)
            Skip i'    -&gt; Skip (ICALSecondInner s1 s2 i1 i' v)
            Stop       -&gt; Skip (ICALFirstResume s1 s2 i1 i2 v)
    -}</span><span>
</span><span id="line-3042"></span><span>
</span><span id="line-3043"></span><span>    </span><span class="annot"><a href="#local-6989586621679312818"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALSecondInner"><span class="hs-identifier hs-type">ICALSecondInner</span></a></span><span> </span><span id="local-6989586621679312772"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312772"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312771"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312771"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span id="local-6989586621679312770"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312770"><span class="hs-identifier hs-var">i1</span></a></span></span><span> </span><span id="local-6989586621679312769"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312769"><span class="hs-identifier hs-var">i2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3044"></span><span>        </span><span id="local-6989586621679312768"><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312768"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312822"><span class="hs-identifier hs-var">istep2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312769"><span class="hs-identifier hs-var">i2</span></a></span><span>
</span><span id="line-3045"></span><span>        </span><span class="annot"><span class="annottext">Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c))
-&gt; Step (ICALState s s s s a) c -&gt; m (Step (ICALState s s s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312768"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3046"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312767"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312767"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312766"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312766"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312767"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a.
s1 -&gt; s2 -&gt; i1 -&gt; i2 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALSecondInner"><span class="hs-identifier hs-var">ICALSecondInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312772"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312771"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312770"><span class="hs-identifier hs-var">i1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312766"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3047"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312765"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312765"><span class="hs-identifier hs-var">i'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a.
s1 -&gt; s2 -&gt; i1 -&gt; i2 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALSecondInner"><span class="hs-identifier hs-var">ICALSecondInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312772"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312771"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312770"><span class="hs-identifier hs-var">i1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312765"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3048"></span><span>            </span><span class="annot"><span class="annottext">Step s c
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ICALState s s s s a -&gt; Step (ICALState s s s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s -&gt; ICALState s s s s a
forall s1 s2 i1 i2 a. s1 -&gt; s2 -&gt; i1 -&gt; ICALState s1 s2 i1 i2 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ICALFirstInner"><span class="hs-identifier hs-var">ICALFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312772"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312771"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312770"><span class="hs-identifier hs-var">i1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3049"></span><span>            </span><span class="hs-comment">-- Stop       -&gt; Skip (ICALFirstResume s1 s2 i1 i2)</span><span>
</span><span id="line-3050"></span><span>
</span><span id="line-3051"></span><span>    </span><span class="hs-comment">{-
    step _ (ICALFirstResume s1 s2 i1 i2 x) = do
        return $ Yield x (ICALFirstInner s1 s2 i1 i2)
    -}</span><span>
</span><span id="line-3055"></span><span>
</span><span id="line-3056"></span><span class="hs-keyword">data</span><span> </span><span id="InterposeState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeState"><span class="hs-identifier hs-var">InterposeState</span></a></span></span><span> </span><span id="local-6989586621679315507"><span class="annot"><a href="#local-6989586621679315507"><span class="hs-identifier hs-type">s1</span></a></span></span><span> </span><span id="local-6989586621679315506"><span class="annot"><a href="#local-6989586621679315506"><span class="hs-identifier hs-type">i1</span></a></span></span><span> </span><span id="local-6989586621679315505"><span class="annot"><a href="#local-6989586621679315505"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3057"></span><span>      </span><span id="InterposeFirst"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirst"><span class="hs-identifier hs-var">InterposeFirst</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315507"><span class="hs-identifier hs-type">s1</span></a></span><span>
</span><span id="line-3058"></span><span>    </span><span class="hs-comment">-- | InterposeFirstYield s1 i1</span><span>
</span><span id="line-3059"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterposeFirstInner"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInner"><span class="hs-identifier hs-var">InterposeFirstInner</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315507"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315506"><span class="hs-identifier hs-type">i1</span></a></span><span>
</span><span id="line-3060"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterposeFirstInject"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInject"><span class="hs-identifier hs-var">InterposeFirstInject</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315507"><span class="hs-identifier hs-type">s1</span></a></span><span>
</span><span id="line-3061"></span><span>    </span><span class="hs-comment">-- | InterposeFirstBuf s1 i1</span><span>
</span><span id="line-3062"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InterposeSecondYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSecondYield"><span class="hs-identifier hs-var">InterposeSecondYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315507"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315506"><span class="hs-identifier hs-type">i1</span></a></span><span>
</span><span id="line-3063"></span><span>    </span><span class="hs-comment">-- -- | InterposeSecondYield s1 i1 a</span><span>
</span><span id="line-3064"></span><span>    </span><span class="hs-comment">-- -- | InterposeFirstResume s1 i1 a</span><span>
</span><span id="line-3065"></span><span>
</span><span id="line-3066"></span><span class="hs-comment">-- Note that this only interposes the pure values, we may run many effects to</span><span>
</span><span id="line-3067"></span><span class="hs-comment">-- generate those values as some effects may not generate anything (Skip).</span><span>
</span><span id="line-3068"></span><span class="hs-pragma">{-# INLINE_NORMAL interpose #-}</span><span>
</span><span id="line-3069"></span><span id="local-6989586621679312758"><span id="local-6989586621679312759"><span id="local-6989586621679312760"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#interpose"><span class="hs-identifier hs-type">interpose</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312760"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312760"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312759"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312760"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312758"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312759"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312760"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312758"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312760"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312759"><span class="hs-identifier hs-type">c</span></a></span></span></span></span><span>
</span><span id="line-3070"></span><span id="interpose"><span class="annot"><span class="annottext">interpose :: m c -&gt; Unfold m b c -&gt; Stream m b -&gt; Stream m c
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#interpose"><span class="hs-identifier hs-var hs-var">interpose</span></a></span></span><span>
</span><span id="line-3071"></span><span>    </span><span id="local-6989586621679312757"><span class="annot"><span class="annottext">m c
</span><a href="#local-6989586621679312757"><span class="hs-identifier hs-var">action</span></a></span></span><span>
</span><span id="line-3072"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Types.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679312756"><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312756"><span class="hs-identifier hs-var">istep1</span></a></span></span><span> </span><span id="local-6989586621679312755"><span class="annot"><span class="annottext">b -&gt; m s
</span><a href="#local-6989586621679312755"><span class="hs-identifier hs-var">inject1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312754"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312754"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312753"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312753"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3073"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m c
 -&gt; InterposeState s s Any -&gt; m (Step (InterposeState s s Any) c))
-&gt; InterposeState s s Any -&gt; Stream m c
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m c
-&gt; InterposeState s s Any -&gt; m (Step (InterposeState s s Any) c)
forall (m :: * -&gt; *) a a a.
State Stream m a
-&gt; InterposeState s s a -&gt; m (Step (InterposeState s s a) c)
</span><a href="#local-6989586621679312752"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterposeState s s Any
forall s1 i1 a. s1 -&gt; InterposeState s1 i1 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirst"><span class="hs-identifier hs-var">InterposeFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312753"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3074"></span><span>
</span><span id="line-3075"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3076"></span><span>
</span><span id="line-3077"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-3078"></span><span>    </span><span id="local-6989586621679312752"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; InterposeState s s a -&gt; m (Step (InterposeState s s a) c)
</span><a href="#local-6989586621679312752"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312751"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312751"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirst"><span class="hs-identifier hs-type">InterposeFirst</span></a></span><span> </span><span id="local-6989586621679312750"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312750"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3079"></span><span>        </span><span id="local-6989586621679312749"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312749"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312754"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m b
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312751"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312750"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-3080"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312749"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3081"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312748"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312748"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312747"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312747"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3082"></span><span>                </span><span id="local-6989586621679312746"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312746"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; m s
</span><a href="#local-6989586621679312755"><span class="hs-identifier hs-var">inject1</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312748"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-3083"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312746"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (InterposeState s s a) c)
-&gt; m (Step (InterposeState s s a) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c -&gt; m (Step (InterposeState s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InterposeState s s a -&gt; Step (InterposeState s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterposeState s s a
forall s1 i1 a. s1 -&gt; i1 -&gt; InterposeState s1 i1 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInner"><span class="hs-identifier hs-var">InterposeFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312747"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312746"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3084"></span><span>                </span><span class="hs-comment">-- i `seq` return (Skip (InterposeFirstYield s i))</span><span>
</span><span id="line-3085"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312745"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312745"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c -&gt; m (Step (InterposeState s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterposeState s s a) c
 -&gt; m (Step (InterposeState s s a) c))
-&gt; Step (InterposeState s s a) c
-&gt; m (Step (InterposeState s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InterposeState s s a -&gt; Step (InterposeState s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterposeState s s a
forall s1 i1 a. s1 -&gt; InterposeState s1 i1 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirst"><span class="hs-identifier hs-var">InterposeFirst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312745"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3086"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c -&gt; m (Step (InterposeState s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3087"></span><span>
</span><span id="line-3088"></span><span>    </span><span class="hs-comment">{-
    step _ (InterposeFirstYield s1 i1) = do
        r &lt;- istep1 i1
        return $ case r of
            Yield x i' -&gt; Yield x (InterposeFirstInner s1 i')
            Skip i'    -&gt; Skip (InterposeFirstYield s1 i')
            Stop       -&gt; Skip (InterposeFirst s1)
    -}</span><span>
</span><span id="line-3096"></span><span>
</span><span id="line-3097"></span><span>    </span><span class="annot"><a href="#local-6989586621679312752"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInner"><span class="hs-identifier hs-type">InterposeFirstInner</span></a></span><span> </span><span id="local-6989586621679312744"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312744"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312743"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312743"><span class="hs-identifier hs-var">i1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3098"></span><span>        </span><span id="local-6989586621679312742"><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312742"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s c)
</span><a href="#local-6989586621679312756"><span class="hs-identifier hs-var">istep1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312743"><span class="hs-identifier hs-var">i1</span></a></span><span>
</span><span id="line-3099"></span><span>        </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c -&gt; m (Step (InterposeState s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterposeState s s a) c
 -&gt; m (Step (InterposeState s s a) c))
-&gt; Step (InterposeState s s a) c
-&gt; m (Step (InterposeState s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s c
</span><a href="#local-6989586621679312742"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3100"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312741"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312741"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312740"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312740"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; InterposeState s s a -&gt; Step (InterposeState s s a) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312741"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterposeState s s a
forall s1 i1 a. s1 -&gt; i1 -&gt; InterposeState s1 i1 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInner"><span class="hs-identifier hs-var">InterposeFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312744"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312740"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3101"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312739"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312739"><span class="hs-identifier hs-var">i'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterposeState s s a -&gt; Step (InterposeState s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterposeState s s a
forall s1 i1 a. s1 -&gt; i1 -&gt; InterposeState s1 i1 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInner"><span class="hs-identifier hs-var">InterposeFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312744"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312739"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3102"></span><span>            </span><span class="annot"><span class="annottext">Step s c
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterposeState s s a -&gt; Step (InterposeState s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterposeState s s a
forall s1 i1 a. s1 -&gt; InterposeState s1 i1 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInject"><span class="hs-identifier hs-var">InterposeFirstInject</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312744"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3103"></span><span>
</span><span id="line-3104"></span><span>    </span><span class="annot"><a href="#local-6989586621679312752"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312738"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312738"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInject"><span class="hs-identifier hs-type">InterposeFirstInject</span></a></span><span> </span><span id="local-6989586621679312737"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312737"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3105"></span><span>        </span><span id="local-6989586621679312736"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312736"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312754"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m b
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312738"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312737"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-3106"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312736"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3107"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312735"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312735"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312734"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312734"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3108"></span><span>                </span><span id="local-6989586621679312733"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312733"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; m s
</span><a href="#local-6989586621679312755"><span class="hs-identifier hs-var">inject1</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312735"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-3109"></span><span>                </span><span class="hs-comment">-- i `seq` return (Skip (InterposeFirstBuf s i))</span><span>
</span><span id="line-3110"></span><span>                </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312733"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">s
-&gt; m (Step (InterposeState s s a) c)
-&gt; m (Step (InterposeState s s a) c)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c -&gt; m (Step (InterposeState s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InterposeState s s a -&gt; Step (InterposeState s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterposeState s s a
forall s1 i1 a. s1 -&gt; i1 -&gt; InterposeState s1 i1 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSecondYield"><span class="hs-identifier hs-var">InterposeSecondYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312734"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312733"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3111"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312732"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312732"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c -&gt; m (Step (InterposeState s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterposeState s s a) c
 -&gt; m (Step (InterposeState s s a) c))
-&gt; Step (InterposeState s s a) c
-&gt; m (Step (InterposeState s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InterposeState s s a -&gt; Step (InterposeState s s a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; InterposeState s s a
forall s1 i1 a. s1 -&gt; InterposeState s1 i1 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInject"><span class="hs-identifier hs-var">InterposeFirstInject</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312732"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3112"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c -&gt; m (Step (InterposeState s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3113"></span><span>
</span><span id="line-3114"></span><span>    </span><span class="hs-comment">{-
    step _ (InterposeFirstBuf s1 i1) = do
        r &lt;- istep1 i1
        return $ case r of
            Yield x i' -&gt; Skip (InterposeSecondYield s1 i' x)
            Skip i'    -&gt; Skip (InterposeFirstBuf s1 i')
            Stop       -&gt; Stop
    -}</span><span>
</span><span id="line-3122"></span><span>
</span><span id="line-3123"></span><span>    </span><span class="hs-comment">{-
    step _ (InterposeSecondYield s1 i1 v) = do
        r &lt;- action
        return $ Yield r (InterposeFirstResume s1 i1 v)
    -}</span><span>
</span><span id="line-3128"></span><span>    </span><span class="annot"><a href="#local-6989586621679312752"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeSecondYield"><span class="hs-identifier hs-type">InterposeSecondYield</span></a></span><span> </span><span id="local-6989586621679312731"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312731"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312730"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312730"><span class="hs-identifier hs-var">i1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3129"></span><span>        </span><span id="local-6989586621679312729"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312729"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m c
</span><a href="#local-6989586621679312757"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-3130"></span><span>        </span><span class="annot"><span class="annottext">Step (InterposeState s s a) c -&gt; m (Step (InterposeState s s a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (InterposeState s s a) c
 -&gt; m (Step (InterposeState s s a) c))
-&gt; Step (InterposeState s s a) c
-&gt; m (Step (InterposeState s s a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">c -&gt; InterposeState s s a -&gt; Step (InterposeState s s a) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312729"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; InterposeState s s a
forall s1 i1 a. s1 -&gt; i1 -&gt; InterposeState s1 i1 a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterposeFirstInner"><span class="hs-identifier hs-var">InterposeFirstInner</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312731"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312730"><span class="hs-identifier hs-var">i1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3131"></span><span>
</span><span id="line-3132"></span><span>    </span><span class="hs-comment">{-
    step _ (InterposeFirstResume s1 i1 v) = do
        return $ Yield v (InterposeFirstInner s1 i1)
    -}</span><span>
</span><span id="line-3136"></span><span>
</span><span id="line-3137"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3138"></span><span class="hs-comment">-- Exceptions</span><span>
</span><span id="line-3139"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3140"></span><span>
</span><span id="line-3141"></span><span class="hs-keyword">data</span><span> </span><span id="GbracketState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GbracketState"><span class="hs-identifier hs-var">GbracketState</span></a></span></span><span> </span><span id="local-6989586621679315497"><span class="annot"><a href="#local-6989586621679315497"><span class="hs-identifier hs-type">s1</span></a></span></span><span> </span><span id="local-6989586621679315496"><span class="annot"><a href="#local-6989586621679315496"><span class="hs-identifier hs-type">s2</span></a></span></span><span> </span><span id="local-6989586621679315495"><span class="annot"><a href="#local-6989586621679315495"><span class="hs-identifier hs-type">v</span></a></span></span><span>
</span><span id="line-3142"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="GBracketInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketInit"><span class="hs-identifier hs-var">GBracketInit</span></a></span></span><span>
</span><span id="line-3143"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GBracketNormal"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketNormal"><span class="hs-identifier hs-var">GBracketNormal</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315497"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315495"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-3144"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GBracketException"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketException"><span class="hs-identifier hs-var">GBracketException</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315496"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-3145"></span><span>
</span><span id="line-3146"></span><span class="hs-comment">-- | The most general bracketing and exception combinator. All other</span><span>
</span><span id="line-3147"></span><span class="hs-comment">-- combinators can be expressed in terms of this combinator. This can also be</span><span>
</span><span id="line-3148"></span><span class="hs-comment">-- used for cases which are not covered by the standard combinators.</span><span>
</span><span id="line-3149"></span><span class="hs-comment">--</span><span>
</span><span id="line-3150"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-3151"></span><span class="hs-comment">--</span><span>
</span><span id="line-3152"></span><span class="hs-pragma">{-# INLINE_NORMAL gbracket_ #-}</span><span>
</span><span id="line-3153"></span><span id="local-6989586621679315429"><span id="local-6989586621679315430"><span id="local-6989586621679315431"><span id="local-6989586621679315432"><span id="local-6989586621679315433"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket_"><span class="hs-identifier hs-type">gbracket_</span></a></span><span>
</span><span id="line-3154"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315433"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3155"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315432"><span class="hs-identifier hs-type">c</span></a></span><span>                                  </span><span class="hs-comment">-- ^ before</span><span>
</span><span id="line-3156"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679315502"><span class="annot"><a href="#local-6989586621679315502"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679315433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315502"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621679315431"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315502"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- ^ try (exception handling)</span><span>
</span><span id="line-3157"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315432"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315430"><span class="hs-identifier hs-type">d</span></a></span><span class="hs-special">)</span><span>                           </span><span class="hs-comment">-- ^ after, on normal stop</span><span>
</span><span id="line-3158"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315432"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315431"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315429"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315429"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ on exception</span><span>
</span><span id="line-3159"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315432"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315429"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>                    </span><span class="hs-comment">-- ^ stream generator</span><span>
</span><span id="line-3160"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315429"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span></span><span>
</span><span id="line-3161"></span><span id="gbracket_"><span class="annot"><span class="annottext">gbracket_ :: m c
-&gt; (forall s. m s -&gt; m (Either e s))
-&gt; (c -&gt; m d)
-&gt; (c -&gt; e -&gt; Stream m b -&gt; Stream m b)
-&gt; (c -&gt; Stream m b)
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket_"><span class="hs-identifier hs-var hs-var">gbracket_</span></a></span></span><span> </span><span id="local-6989586621679312725"><span class="annot"><span class="annottext">m c
</span><a href="#local-6989586621679312725"><span class="hs-identifier hs-var">bef</span></a></span></span><span> </span><span id="local-6989586621679312724"><span class="annot"><span class="annottext">forall s. m s -&gt; m (Either e s)
</span><a href="#local-6989586621679312724"><span class="hs-identifier hs-var">exc</span></a></span></span><span> </span><span id="local-6989586621679312723"><span class="annot"><span class="annottext">c -&gt; m d
</span><a href="#local-6989586621679312723"><span class="hs-identifier hs-var">aft</span></a></span></span><span> </span><span id="local-6989586621679312722"><span class="annot"><span class="annottext">c -&gt; e -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679312722"><span class="hs-identifier hs-var">fexc</span></a></span></span><span> </span><span id="local-6989586621679312721"><span class="annot"><span class="annottext">c -&gt; Stream m b
</span><a href="#local-6989586621679312721"><span class="hs-identifier hs-var">fnormal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3162"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; GbracketState (Stream m b) (Stream m b) c
 -&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b))
-&gt; GbracketState (Stream m b) (Stream m b) c -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; GbracketState (Stream m b) (Stream m b) c
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
</span><a href="#local-6989586621679312720"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">GbracketState (Stream m b) (Stream m b) c
forall s1 s2 v. GbracketState s1 s2 v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketInit"><span class="hs-identifier hs-var">GBracketInit</span></a></span><span>
</span><span id="line-3163"></span><span>
</span><span id="line-3164"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3165"></span><span>
</span><span id="line-3166"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-3167"></span><span>    </span><span id="local-6989586621679312720"><span class="annot"><span class="annottext">step :: State Stream m b
-&gt; GbracketState (Stream m b) (Stream m b) c
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
</span><a href="#local-6989586621679312720"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">GbracketState (Stream m b) (Stream m b) c
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketInit"><span class="hs-identifier hs-var">GBracketInit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3168"></span><span>        </span><span id="local-6989586621679312719"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312719"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m c
</span><a href="#local-6989586621679312725"><span class="hs-identifier hs-var">bef</span></a></span><span>
</span><span id="line-3169"></span><span>        </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (GbracketState (Stream m b) (Stream m b) c) b
 -&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b))
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GbracketState (Stream m b) (Stream m b) c
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(GbracketState (Stream m b) (Stream m b) c
 -&gt; Step (GbracketState (Stream m b) (Stream m b) c) b)
-&gt; GbracketState (Stream m b) (Stream m b) c
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; c -&gt; GbracketState (Stream m b) (Stream m b) c
forall s1 s2 v. s1 -&gt; v -&gt; GbracketState s1 s2 v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketNormal"><span class="hs-identifier hs-var">GBracketNormal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">c -&gt; Stream m b
</span><a href="#local-6989586621679312721"><span class="hs-identifier hs-var">fnormal</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312719"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312719"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-3170"></span><span>
</span><span id="line-3171"></span><span>    </span><span class="annot"><a href="#local-6989586621679312720"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312718"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679312718"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketNormal"><span class="hs-identifier hs-type">GBracketNormal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-type">UnStream</span></a></span><span> </span><span id="local-6989586621679312717"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312717"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312716"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312716"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679312715"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312715"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3172"></span><span>        </span><span id="local-6989586621679312714"><span class="annot"><span class="annottext">Either e (Step s b)
</span><a href="#local-6989586621679312714"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Step s b) -&gt; m (Either e (Step s b))
forall s. m s -&gt; m (Either e s)
</span><a href="#local-6989586621679312724"><span class="hs-identifier hs-var">exc</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Step s b) -&gt; m (Either e (Step s b)))
-&gt; m (Step s b) -&gt; m (Either e (Step s b))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312717"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679312718"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312716"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3173"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either e (Step s b)
</span><a href="#local-6989586621679312714"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3174"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679312713"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312713"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312713"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3175"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312712"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312712"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312711"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312711"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3176"></span><span>                    </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (GbracketState (Stream m b) (Stream m b) c) b
 -&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b))
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b
-&gt; GbracketState (Stream m b) (Stream m b) c
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312712"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b -&gt; c -&gt; GbracketState (Stream m b) (Stream m b) c
forall s1 s2 v. s1 -&gt; v -&gt; GbracketState s1 s2 v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketNormal"><span class="hs-identifier hs-var">GBracketNormal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312717"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312711"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312715"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3177"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312710"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312710"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (GbracketState (Stream m b) (Stream m b) c) b
 -&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b))
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GbracketState (Stream m b) (Stream m b) c
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b -&gt; c -&gt; GbracketState (Stream m b) (Stream m b) c
forall s1 s2 v. s1 -&gt; v -&gt; GbracketState s1 s2 v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketNormal"><span class="hs-identifier hs-var">GBracketNormal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312717"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312710"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312715"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3178"></span><span>                </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; m d
</span><a href="#local-6989586621679312723"><span class="hs-identifier hs-var">aft</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312715"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">m d
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3179"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679312709"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679312709"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3180"></span><span>                </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (GbracketState (Stream m b) (Stream m b) c) b
 -&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b))
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GbracketState (Stream m b) (Stream m b) c
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b -&gt; GbracketState (Stream m b) (Stream m b) c
forall s1 s2 v. s2 -&gt; GbracketState s1 s2 v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketException"><span class="hs-identifier hs-var">GBracketException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">c -&gt; e -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679312722"><span class="hs-identifier hs-var">fexc</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312715"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679312709"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-var">UnStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312717"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312716"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3181"></span><span>    </span><span class="annot"><a href="#local-6989586621679312720"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312708"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679312708"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketException"><span class="hs-identifier hs-type">GBracketException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-type">UnStream</span></a></span><span> </span><span id="local-6989586621679312707"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312707"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312706"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312706"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3182"></span><span>        </span><span id="local-6989586621679312705"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312705"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312707"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679312708"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312706"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3183"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312705"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3184"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312704"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312704"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312703"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312703"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (GbracketState (Stream m b) (Stream m b) c) b
 -&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b))
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b
-&gt; GbracketState (Stream m b) (Stream m b) c
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312704"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b -&gt; GbracketState (Stream m b) (Stream m b) c
forall s1 s2 v. s2 -&gt; GbracketState s1 s2 v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketException"><span class="hs-identifier hs-var">GBracketException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312707"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312703"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3185"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312702"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312702"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (GbracketState (Stream m b) (Stream m b) c) b
 -&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b))
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GbracketState (Stream m b) (Stream m b) c
-&gt; Step (GbracketState (Stream m b) (Stream m b) c) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b -&gt; GbracketState (Stream m b) (Stream m b) c
forall s1 s2 v. s2 -&gt; GbracketState s1 s2 v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketException"><span class="hs-identifier hs-var">GBracketException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312707"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312702"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3186"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
-&gt; m (Step (GbracketState (Stream m b) (Stream m b) c) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (GbracketState (Stream m b) (Stream m b) c) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3187"></span><span>
</span><span id="line-3188"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3189"></span><span class="hs-comment">-- Finalizers</span><span>
</span><span id="line-3190"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3191"></span><span>
</span><span id="line-3192"></span><span class="hs-comment">-- | Make a finalizer from a monadic action @m a@ that can run in IO monad.</span><span>
</span><span id="line-3193"></span><span id="local-6989586621679315479"><span id="local-6989586621679315480"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mkIOFinalizer"><span class="hs-identifier hs-type">mkIOFinalizer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679315480"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315480"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315479"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315480"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-3194"></span><span id="mkIOFinalizer"><span class="annot"><span class="annottext">mkIOFinalizer :: m b -&gt; m (IO ())
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mkIOFinalizer"><span class="hs-identifier hs-var hs-var">mkIOFinalizer</span></a></span></span><span> </span><span id="local-6989586621679312700"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312700"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3195"></span><span>    </span><span id="local-6989586621679312699"><span class="annot"><span class="annottext">RunInIO m
</span><a href="#local-6989586621679312699"><span class="hs-identifier hs-var">mrun</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (RunInIO m)
forall (m :: * -&gt; *). MonadBaseControl IO m =&gt; m (RunInIO m)
</span><a href="Streamly.Internal.Data.SVar.html#captureMonadState"><span class="hs-identifier hs-var">captureMonadState</span></a></span><span>
</span><span id="line-3196"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; m (IO ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m (IO ())) -&gt; IO () -&gt; m (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3197"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3198"></span><span>            </span><span class="annot"><span class="annottext">StM m b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RunInIO m -&gt; m b -&gt; IO (StM m b)
forall (m :: * -&gt; *). RunInIO m -&gt; forall b. m b -&gt; IO (StM m b)
</span><a href="Streamly.Internal.Data.SVar.html#runInIO"><span class="hs-identifier hs-var hs-var">runInIO</span></a></span><span> </span><span class="annot"><span class="annottext">RunInIO m
</span><a href="#local-6989586621679312699"><span class="hs-identifier hs-var">mrun</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312700"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-3199"></span><span>            </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-3200"></span><span>
</span><span id="line-3201"></span><span class="hs-comment">-- | Run an IO action stored in a finalized IORef.</span><span>
</span><span id="line-3202"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runIORefFinalizerGC"><span class="hs-identifier hs-type">runIORefFinalizerGC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-3203"></span><span id="runIORefFinalizerGC"><span class="annot"><span class="annottext">runIORefFinalizerGC :: IORef (Maybe (IO ())) -&gt; IO ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runIORefFinalizerGC"><span class="hs-identifier hs-var hs-var">runIORefFinalizerGC</span></a></span></span><span> </span><span id="local-6989586621679312695"><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312695"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3204"></span><span>    </span><span id="local-6989586621679312694"><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621679312694"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; IO (Maybe (IO ()))
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312695"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-3205"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621679312694"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3206"></span><span>        </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-3207"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679312693"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679312693"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679312693"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-3208"></span><span>
</span><span id="line-3209"></span><span class="hs-comment">-- | Create an IORef holding a finalizer that is called automatically when</span><span>
</span><span id="line-3210"></span><span class="hs-comment">-- the IORef is garbage collected. The IORef can be written to with a 'Nothing'</span><span>
</span><span id="line-3211"></span><span class="hs-comment">-- value to deactivate the finalizer.</span><span>
</span><span id="line-3212"></span><span class="hs-comment">--</span><span>
</span><span id="line-3213"></span><span class="hs-comment">-- Note: The finalizer is always run with the state of the monad captured at</span><span>
</span><span id="line-3214"></span><span class="hs-comment">-- the time of calling newFinalizedIORef. To run it on garbage collection we</span><span>
</span><span id="line-3215"></span><span class="hs-comment">-- have no option but to take a snapshot of the monadic state at some point of</span><span>
</span><span id="line-3216"></span><span class="hs-comment">-- time. For normal case we could run it with the current state of the monad</span><span>
</span><span id="line-3217"></span><span class="hs-comment">-- but we want to keep both the cases consistent.</span><span>
</span><span id="line-3218"></span><span class="hs-comment">--</span><span>
</span><span id="line-3219"></span><span id="local-6989586621679315454"><span id="local-6989586621679315455"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#newFinalizedIORef"><span class="hs-identifier hs-type">newFinalizedIORef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679315455"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679315455"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3220"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315455"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315454"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315455"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-3221"></span><span id="newFinalizedIORef"><span class="annot"><span class="annottext">newFinalizedIORef :: m a -&gt; m (IORef (Maybe (IO ())))
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#newFinalizedIORef"><span class="hs-identifier hs-var hs-var">newFinalizedIORef</span></a></span></span><span> </span><span id="local-6989586621679312692"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679312692"><span class="hs-identifier hs-var">finalizer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3222"></span><span>    </span><span id="local-6989586621679312691"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679312691"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m a -&gt; m (IO ())
forall (m :: * -&gt; *) b. MonadBaseControl IO m =&gt; m b -&gt; m (IO ())
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mkIOFinalizer"><span class="hs-identifier hs-var">mkIOFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679312692"><span class="hs-identifier hs-var">finalizer</span></a></span><span>
</span><span id="line-3223"></span><span>    </span><span id="local-6989586621679312690"><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312690"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef (Maybe (IO ()))) -&gt; m (IORef (Maybe (IO ())))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef (Maybe (IO ()))) -&gt; m (IORef (Maybe (IO ()))))
-&gt; IO (IORef (Maybe (IO ()))) -&gt; m (IORef (Maybe (IO ())))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IO ()) -&gt; IO (IORef (Maybe (IO ())))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (IO ()) -&gt; IO (IORef (Maybe (IO ()))))
-&gt; Maybe (IO ()) -&gt; IO (IORef (Maybe (IO ())))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Maybe (IO ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679312691"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-3224"></span><span>    </span><span class="annot"><span class="annottext">Weak (IORef (Maybe (IO ())))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Weak (IORef (Maybe (IO ()))))
-&gt; m (Weak (IORef (Maybe (IO ()))))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Weak (IORef (Maybe (IO ()))))
 -&gt; m (Weak (IORef (Maybe (IO ())))))
-&gt; IO (Weak (IORef (Maybe (IO ()))))
-&gt; m (Weak (IORef (Maybe (IO ()))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; IO () -&gt; IO (Weak (IORef (Maybe (IO ()))))
forall a. IORef a -&gt; IO () -&gt; IO (Weak (IORef a))
</span><span class="hs-identifier hs-var">mkWeakIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312690"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; IO ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runIORefFinalizerGC"><span class="hs-identifier hs-var">runIORefFinalizerGC</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312690"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3225"></span><span>    </span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; m (IORef (Maybe (IO ())))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312690"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-3226"></span><span>
</span><span id="line-3227"></span><span class="hs-comment">-- | Run the finalizer stored in an IORef and deactivate it so that it is run</span><span>
</span><span id="line-3228"></span><span class="hs-comment">-- only once. Note, the action runs with async exceptions masked.</span><span>
</span><span id="line-3229"></span><span class="hs-comment">--</span><span>
</span><span id="line-3230"></span><span id="local-6989586621679315452"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runIORefFinalizer"><span class="hs-identifier hs-type">runIORefFinalizer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679315452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-3231"></span><span id="runIORefFinalizer"><span class="annot"><span class="annottext">runIORefFinalizer :: IORef (Maybe (IO ())) -&gt; m ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runIORefFinalizer"><span class="hs-identifier hs-var hs-var">runIORefFinalizer</span></a></span></span><span> </span><span id="local-6989586621679312689"><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312689"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3232"></span><span>    </span><span id="local-6989586621679312688"><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621679312688"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; IO (Maybe (IO ()))
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312689"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-3233"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621679312688"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3234"></span><span>        </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-3235"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679312687"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679312687"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3236"></span><span>            </span><span class="hs-comment">-- if an async exception comes after writing 'Nothing' then the</span><span>
</span><span id="line-3237"></span><span>            </span><span class="hs-comment">-- finalizing action will never be run. We need to do this</span><span>
</span><span id="line-3238"></span><span>            </span><span class="hs-comment">-- atomically wrt async exceptions.</span><span>
</span><span id="line-3239"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3240"></span><span>                </span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; Maybe (IO ()) -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312689"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3241"></span><span>                </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679312687"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-3242"></span><span>
</span><span id="line-3243"></span><span class="hs-comment">-- | Run an action clearing the finalizer IORef atomically wrt async</span><span>
</span><span id="line-3244"></span><span class="hs-comment">-- exceptions. The action is run with async exceptions masked.</span><span>
</span><span id="line-3245"></span><span id="local-6989586621679315450"><span id="local-6989586621679315451"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#withIORefFinalizer"><span class="hs-identifier hs-type">withIORefFinalizer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679315451"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3246"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315451"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315450"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315451"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315450"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-3247"></span><span id="withIORefFinalizer"><span class="annot"><span class="annottext">withIORefFinalizer :: IORef (Maybe (IO ())) -&gt; m a -&gt; m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#withIORefFinalizer"><span class="hs-identifier hs-var hs-var">withIORefFinalizer</span></a></span></span><span> </span><span id="local-6989586621679312686"><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312686"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621679312685"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679312685"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3248"></span><span>    </span><span class="annot"><span class="annottext">(RunInBase m IO -&gt; IO (StM m a)) -&gt; m a
forall (b :: * -&gt; *) (m :: * -&gt; *) a.
MonadBaseControl b m =&gt;
(RunInBase m b -&gt; b (StM m a)) -&gt; m a
</span><span class="hs-identifier hs-var">control</span></span><span> </span><span class="annot"><span class="annottext">((RunInBase m IO -&gt; IO (StM m a)) -&gt; m a)
-&gt; (RunInBase m IO -&gt; IO (StM m a)) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679312684"><span class="annot"><span class="annottext">RunInBase m IO
</span><a href="#local-6989586621679312684"><span class="hs-identifier hs-var">runinio</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3249"></span><span>        </span><span class="annot"><span class="annottext">IO (StM m a) -&gt; IO (StM m a)
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(IO (StM m a) -&gt; IO (StM m a)) -&gt; IO (StM m a) -&gt; IO (StM m a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3250"></span><span>            </span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; Maybe (IO ()) -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312686"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3251"></span><span>            </span><span class="annot"><span class="annottext">m a -&gt; IO (StM m a)
RunInBase m IO
</span><a href="#local-6989586621679312684"><span class="hs-identifier hs-var">runinio</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679312685"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-3252"></span><span>
</span><span id="line-3253"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3254"></span><span>
</span><span id="line-3255"></span><span class="hs-keyword">data</span><span> </span><span id="GbracketIOState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GbracketIOState"><span class="hs-identifier hs-var">GbracketIOState</span></a></span></span><span> </span><span id="local-6989586621679315463"><span class="annot"><a href="#local-6989586621679315463"><span class="hs-identifier hs-type">s1</span></a></span></span><span> </span><span id="local-6989586621679315462"><span class="annot"><a href="#local-6989586621679315462"><span class="hs-identifier hs-type">s2</span></a></span></span><span> </span><span id="local-6989586621679315461"><span class="annot"><a href="#local-6989586621679315461"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span id="local-6989586621679315460"><span class="annot"><a href="#local-6989586621679315460"><span class="hs-identifier hs-type">wref</span></a></span></span><span>
</span><span id="line-3256"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="GBracketIOInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIOInit"><span class="hs-identifier hs-var">GBracketIOInit</span></a></span></span><span>
</span><span id="line-3257"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GBracketIONormal"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIONormal"><span class="hs-identifier hs-var">GBracketIONormal</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315463"><span class="hs-identifier hs-type">s1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315461"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315460"><span class="hs-identifier hs-type">wref</span></a></span><span>
</span><span id="line-3258"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GBracketIOException"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIOException"><span class="hs-identifier hs-var">GBracketIOException</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315462"><span class="hs-identifier hs-type">s2</span></a></span><span>
</span><span id="line-3259"></span><span>
</span><span id="line-3260"></span><span class="hs-comment">-- | The most general bracketing and exception combinator. All other</span><span>
</span><span id="line-3261"></span><span class="hs-comment">-- combinators can be expressed in terms of this combinator. This can also be</span><span>
</span><span id="line-3262"></span><span class="hs-comment">-- used for cases which are not covered by the standard combinators.</span><span>
</span><span id="line-3263"></span><span class="hs-comment">--</span><span>
</span><span id="line-3264"></span><span class="hs-comment">-- | It uses a finalizer to make sure we run the finalizing action</span><span>
</span><span id="line-3265"></span><span class="hs-comment">-- when the stream is garbage collected.</span><span>
</span><span id="line-3266"></span><span class="hs-comment">--</span><span>
</span><span id="line-3267"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-3268"></span><span class="hs-comment">--</span><span>
</span><span id="line-3269"></span><span class="hs-pragma">{-# INLINE_NORMAL gbracket #-}</span><span>
</span><span id="line-3270"></span><span id="local-6989586621679315402"><span id="local-6989586621679315403"><span id="local-6989586621679315404"><span id="local-6989586621679315405"><span id="local-6989586621679315406"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket"><span class="hs-identifier hs-type">gbracket</span></a></span><span>
</span><span id="line-3271"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3272"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315405"><span class="hs-identifier hs-type">c</span></a></span><span>                                  </span><span class="hs-comment">-- ^ before</span><span>
</span><span id="line-3273"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679315468"><span class="annot"><a href="#local-6989586621679315468"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315468"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621679315404"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315468"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- ^ try (exception handling)</span><span>
</span><span id="line-3274"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315405"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315403"><span class="hs-identifier hs-type">d</span></a></span><span class="hs-special">)</span><span>                           </span><span class="hs-comment">-- ^ after, on normal stop or GC</span><span>
</span><span id="line-3275"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315405"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315404"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315402"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315402"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ on exception</span><span>
</span><span id="line-3276"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315405"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315402"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>                    </span><span class="hs-comment">-- ^ stream generator</span><span>
</span><span id="line-3277"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315402"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span></span><span>
</span><span id="line-3278"></span><span id="gbracket"><span class="annot"><span class="annottext">gbracket :: m c
-&gt; (forall s. m s -&gt; m (Either e s))
-&gt; (c -&gt; m d)
-&gt; (c -&gt; e -&gt; Stream m b -&gt; m (Stream m b))
-&gt; (c -&gt; Stream m b)
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket"><span class="hs-identifier hs-var hs-var">gbracket</span></a></span></span><span> </span><span id="local-6989586621679312680"><span class="annot"><span class="annottext">m c
</span><a href="#local-6989586621679312680"><span class="hs-identifier hs-var">bef</span></a></span></span><span> </span><span id="local-6989586621679312679"><span class="annot"><span class="annottext">forall s. m s -&gt; m (Either e s)
</span><a href="#local-6989586621679312679"><span class="hs-identifier hs-var">exc</span></a></span></span><span> </span><span id="local-6989586621679312678"><span class="annot"><span class="annottext">c -&gt; m d
</span><a href="#local-6989586621679312678"><span class="hs-identifier hs-var">aft</span></a></span></span><span> </span><span id="local-6989586621679312677"><span class="annot"><span class="annottext">c -&gt; e -&gt; Stream m b -&gt; m (Stream m b)
</span><a href="#local-6989586621679312677"><span class="hs-identifier hs-var">fexc</span></a></span></span><span> </span><span id="local-6989586621679312676"><span class="annot"><span class="annottext">c -&gt; Stream m b
</span><a href="#local-6989586621679312676"><span class="hs-identifier hs-var">fnormal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3279"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; GbracketIOState
      (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
 -&gt; m (Step
         (GbracketIOState
            (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
         b))
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
</span><a href="#local-6989586621679312675"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">GbracketIOState (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
forall s1 s2 v wref. GbracketIOState s1 s2 v wref
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIOInit"><span class="hs-identifier hs-var">GBracketIOInit</span></a></span><span>
</span><span id="line-3280"></span><span>
</span><span id="line-3281"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3282"></span><span>
</span><span id="line-3283"></span><span>    </span><span class="hs-comment">-- If the stream is never evaluated the &quot;aft&quot; action will never be</span><span>
</span><span id="line-3284"></span><span>    </span><span class="hs-comment">-- called. For that to occur we will need the user of this API to pass a</span><span>
</span><span id="line-3285"></span><span>    </span><span class="hs-comment">-- weak pointer to us.</span><span>
</span><span id="line-3286"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-3287"></span><span>    </span><span id="local-6989586621679312675"><span class="annot"><span class="annottext">step :: State Stream m b
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
</span><a href="#local-6989586621679312675"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">GbracketIOState (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIOInit"><span class="hs-identifier hs-var">GBracketIOInit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3288"></span><span>        </span><span class="hs-comment">-- We mask asynchronous exceptions to make the execution</span><span>
</span><span id="line-3289"></span><span>        </span><span class="hs-comment">-- of 'bef' and the registration of 'aft' atomic.</span><span>
</span><span id="line-3290"></span><span>        </span><span class="hs-comment">-- A similar thing is done in the resourcet package: https://git.io/JvKV3</span><span>
</span><span id="line-3291"></span><span>        </span><span class="hs-comment">-- Tutorial: https://markkarpov.com/tutorial/exceptions.html</span><span>
</span><span id="line-3292"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679312674"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312674"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312673"><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312673"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IO (StM m (c, IORef (Maybe (IO ()))))
 -&gt; IO (StM m (c, IORef (Maybe (IO ())))))
-&gt; m (c, IORef (Maybe (IO ()))) -&gt; m (c, IORef (Maybe (IO ())))
forall (b :: * -&gt; *) (m :: * -&gt; *) a c.
MonadBaseControl b m =&gt;
(b (StM m a) -&gt; b (StM m c)) -&gt; m a -&gt; m c
</span><span class="hs-identifier hs-var">liftBaseOp_</span></span><span> </span><span class="annot"><span class="annottext">IO (StM m (c, IORef (Maybe (IO ()))))
-&gt; IO (StM m (c, IORef (Maybe (IO ()))))
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m (c, IORef (Maybe (IO ()))) -&gt; m (c, IORef (Maybe (IO ()))))
-&gt; m (c, IORef (Maybe (IO ()))) -&gt; m (c, IORef (Maybe (IO ())))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3293"></span><span>            </span><span id="local-6989586621679312672"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312672"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m c
</span><a href="#local-6989586621679312680"><span class="hs-identifier hs-var">bef</span></a></span><span>
</span><span id="line-3294"></span><span>            </span><span id="local-6989586621679312671"><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312671"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m d -&gt; m (IORef (Maybe (IO ())))
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
m a -&gt; m (IORef (Maybe (IO ())))
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#newFinalizedIORef"><span class="hs-identifier hs-var">newFinalizedIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">c -&gt; m d
</span><a href="#local-6989586621679312678"><span class="hs-identifier hs-var">aft</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312672"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3295"></span><span>            </span><span class="annot"><span class="annottext">(c, IORef (Maybe (IO ()))) -&gt; m (c, IORef (Maybe (IO ())))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312672"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312671"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3296"></span><span>        </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step
   (GbracketIOState
      (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
   b
 -&gt; m (Step
         (GbracketIOState
            (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
         b))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GbracketIOState (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(GbracketIOState
   (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
 -&gt; Step
      (GbracketIOState
         (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
      b)
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m b
-&gt; c
-&gt; IORef (Maybe (IO ()))
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
forall s1 s2 v wref.
s1 -&gt; v -&gt; wref -&gt; GbracketIOState s1 s2 v wref
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIONormal"><span class="hs-identifier hs-var">GBracketIONormal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">c -&gt; Stream m b
</span><a href="#local-6989586621679312676"><span class="hs-identifier hs-var">fnormal</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312674"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312674"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312673"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-3297"></span><span>
</span><span id="line-3298"></span><span>    </span><span class="annot"><a href="#local-6989586621679312675"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312670"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679312670"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIONormal"><span class="hs-identifier hs-type">GBracketIONormal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-type">UnStream</span></a></span><span> </span><span id="local-6989586621679312669"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312669"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312668"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312668"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679312667"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312667"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679312666"><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312666"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3299"></span><span>        </span><span id="local-6989586621679312665"><span class="annot"><span class="annottext">Either e (Step s b)
</span><a href="#local-6989586621679312665"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Step s b) -&gt; m (Either e (Step s b))
forall s. m s -&gt; m (Either e s)
</span><a href="#local-6989586621679312679"><span class="hs-identifier hs-var">exc</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Step s b) -&gt; m (Either e (Step s b)))
-&gt; m (Step s b) -&gt; m (Either e (Step s b))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312669"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679312670"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312668"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3300"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either e (Step s b)
</span><a href="#local-6989586621679312665"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3301"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679312664"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312664"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312664"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3302"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312663"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312663"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312662"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312662"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3303"></span><span>                    </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step
   (GbracketIOState
      (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
   b
 -&gt; m (Step
         (GbracketIOState
            (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
         b))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312663"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b
-&gt; c
-&gt; IORef (Maybe (IO ()))
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
forall s1 s2 v wref.
s1 -&gt; v -&gt; wref -&gt; GbracketIOState s1 s2 v wref
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIONormal"><span class="hs-identifier hs-var">GBracketIONormal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312669"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312662"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312667"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312666"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3304"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312661"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312661"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3305"></span><span>                    </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step
   (GbracketIOState
      (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
   b
 -&gt; m (Step
         (GbracketIOState
            (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
         b))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GbracketIOState (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b
-&gt; c
-&gt; IORef (Maybe (IO ()))
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
forall s1 s2 v wref.
s1 -&gt; v -&gt; wref -&gt; GbracketIOState s1 s2 v wref
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIONormal"><span class="hs-identifier hs-var">GBracketIONormal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312669"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312661"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312667"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312666"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3306"></span><span>                </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3307"></span><span>                    </span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; m ()
forall (m :: * -&gt; *). MonadIO m =&gt; IORef (Maybe (IO ())) -&gt; m ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runIORefFinalizer"><span class="hs-identifier hs-var">runIORefFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312666"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-3308"></span><span>                    </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3309"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679312660"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679312660"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3310"></span><span>                </span><span class="hs-comment">-- Clearing of finalizer and running of exception handler must</span><span>
</span><span id="line-3311"></span><span>                </span><span class="hs-comment">-- be atomic wrt async exceptions. Otherwise if we have cleared</span><span>
</span><span id="line-3312"></span><span>                </span><span class="hs-comment">-- the finalizer and have not run the exception handler then we</span><span>
</span><span id="line-3313"></span><span>                </span><span class="hs-comment">-- may leak the resource.</span><span>
</span><span id="line-3314"></span><span>                </span><span id="local-6989586621679312659"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679312659"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; m (Stream m b) -&gt; m (Stream m b)
forall (m :: * -&gt; *) a.
MonadBaseControl IO m =&gt;
IORef (Maybe (IO ())) -&gt; m a -&gt; m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#withIORefFinalizer"><span class="hs-identifier hs-var">withIORefFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312666"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">c -&gt; e -&gt; Stream m b -&gt; m (Stream m b)
</span><a href="#local-6989586621679312677"><span class="hs-identifier hs-var">fexc</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679312667"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679312660"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-var">UnStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312669"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312668"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3315"></span><span>                </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step
   (GbracketIOState
      (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
   b
 -&gt; m (Step
         (GbracketIOState
            (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
         b))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GbracketIOState (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
forall s1 s2 v wref. s2 -&gt; GbracketIOState s1 s2 v wref
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIOException"><span class="hs-identifier hs-var">GBracketIOException</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679312659"><span class="hs-identifier hs-var">stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3316"></span><span>    </span><span class="annot"><a href="#local-6989586621679312675"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312658"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679312658"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIOException"><span class="hs-identifier hs-type">GBracketIOException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-type">UnStream</span></a></span><span> </span><span id="local-6989586621679312657"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312657"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312656"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312656"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3317"></span><span>        </span><span id="local-6989586621679312655"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312655"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312657"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679312658"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312656"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3318"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679312655"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3319"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312654"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312654"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312653"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312653"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3320"></span><span>                </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step
   (GbracketIOState
      (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
   b
 -&gt; m (Step
         (GbracketIOState
            (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
         b))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312654"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
forall s1 s2 v wref. s2 -&gt; GbracketIOState s1 s2 v wref
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIOException"><span class="hs-identifier hs-var">GBracketIOException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312657"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312653"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3321"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312652"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312652"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step
   (GbracketIOState
      (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
   b
 -&gt; m (Step
         (GbracketIOState
            (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
         b))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GbracketIOState (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
-&gt; Step
     (GbracketIOState
        (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
     b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b
-&gt; GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ())))
forall s1 s2 v wref. s2 -&gt; GbracketIOState s1 s2 v wref
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#GBracketIOException"><span class="hs-identifier hs-var">GBracketIOException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m b -&gt; s -&gt; m (Step s b)) -&gt; s -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679312657"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312652"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3322"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
-&gt; m (Step
        (GbracketIOState
           (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
        b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step
  (GbracketIOState
     (Stream m b) (Stream m b) c (IORef (Maybe (IO ()))))
  b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3323"></span><span>
</span><span id="line-3324"></span><span class="hs-comment">-- | Run a side effect before the stream yields its first element.</span><span>
</span><span id="line-3325"></span><span class="hs-pragma">{-# INLINE_NORMAL before #-}</span><span>
</span><span id="line-3326"></span><span id="local-6989586621679312649"><span id="local-6989586621679312650"><span id="local-6989586621679312651"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#before"><span class="hs-identifier hs-type">before</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312650"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312649"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312649"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3327"></span><span id="before"><span class="annot"><span class="annottext">before :: m b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#before"><span class="hs-identifier hs-var hs-var">before</span></a></span></span><span> </span><span id="local-6989586621679312648"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312648"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312647"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312647"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312646"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312646"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a))
-&gt; Maybe s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679312645"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3328"></span><span>
</span><span id="line-3329"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3330"></span><span>
</span><span id="line-3331"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3332"></span><span>    </span><span id="local-6989586621679312645"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; Maybe s -&gt; m (Step (Maybe s) a)
</span><a href="#local-6989586621679312645"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312648"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; m (Step (Maybe s) a) -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312646"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3333"></span><span>
</span><span id="line-3334"></span><span>    </span><span class="annot"><a href="#local-6989586621679312645"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312644"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312644"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679312643"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312643"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3335"></span><span>        </span><span id="local-6989586621679312642"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312642"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312647"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312644"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312643"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3336"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312642"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3337"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312641"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312641"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312640"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312640"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe s -&gt; Step (Maybe s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312641"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312640"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3338"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312639"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312639"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s) a -&gt; m (Step (Maybe s) a))
-&gt; Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe s -&gt; Step (Maybe s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312639"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3339"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a -&gt; m (Step (Maybe s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3340"></span><span>
</span><span id="line-3341"></span><span class="hs-comment">-- | Run a side effect whenever the stream stops normally.</span><span>
</span><span id="line-3342"></span><span class="hs-pragma">{-# INLINE_NORMAL after_ #-}</span><span>
</span><span id="line-3343"></span><span id="local-6989586621679312636"><span id="local-6989586621679312637"><span id="local-6989586621679312638"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#after_"><span class="hs-identifier hs-type">after_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312638"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312638"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312637"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312638"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312636"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312638"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312636"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3344"></span><span id="after_"><span class="annot"><span class="annottext">after_ :: m b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#after_"><span class="hs-identifier hs-var hs-var">after_</span></a></span></span><span> </span><span id="local-6989586621679312635"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312635"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312634"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312634"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312633"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312633"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312632"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312633"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-3345"></span><span>
</span><span id="line-3346"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3347"></span><span>
</span><span id="line-3348"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3349"></span><span>    </span><span id="local-6989586621679312632"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312632"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312631"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312631"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span id="local-6989586621679312630"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312630"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3350"></span><span>        </span><span id="local-6989586621679312629"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312629"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312634"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312631"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312630"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3351"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312629"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3352"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312628"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312628"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312627"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312627"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; Step s a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312628"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312627"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3353"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312626"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312626"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Step s a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312626"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3354"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312635"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; m (Step s a) -&gt; m (Step s a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step s a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3355"></span><span>
</span><span id="line-3356"></span><span class="hs-pragma">{-# INLINE_NORMAL after #-}</span><span>
</span><span id="line-3357"></span><span id="local-6989586621679312623"><span id="local-6989586621679312624"><span id="local-6989586621679312625"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#after"><span class="hs-identifier hs-type">after</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679312625"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679312625"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3358"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312625"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312624"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312625"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312623"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312625"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312623"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3359"></span><span id="after"><span class="annot"><span class="annottext">after :: m b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#after"><span class="hs-identifier hs-var hs-var">after</span></a></span></span><span> </span><span id="local-6989586621679312622"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312622"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312621"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312621"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312620"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312620"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; Maybe (s, IORef (Maybe (IO ())))
 -&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a))
-&gt; Maybe (s, IORef (Maybe (IO ()))) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; Maybe (s, IORef (Maybe (IO ())))
-&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a)
</span><a href="#local-6989586621679312619"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (s, IORef (Maybe (IO ())))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3360"></span><span>
</span><span id="line-3361"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3362"></span><span>
</span><span id="line-3363"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3364"></span><span>    </span><span id="local-6989586621679312619"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; Maybe (s, IORef (Maybe (IO ())))
-&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a)
</span><a href="#local-6989586621679312619"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, IORef (Maybe (IO ())))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3365"></span><span>        </span><span id="local-6989586621679312618"><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312618"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m b -&gt; m (IORef (Maybe (IO ())))
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
m a -&gt; m (IORef (Maybe (IO ())))
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#newFinalizedIORef"><span class="hs-identifier hs-var">newFinalizedIORef</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312622"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-3366"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (s, IORef (Maybe (IO ())))) a
-&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, IORef (Maybe (IO ())))) a
 -&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a))
-&gt; Step (Maybe (s, IORef (Maybe (IO ())))) a
-&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, IORef (Maybe (IO ())))
-&gt; Step (Maybe (s, IORef (Maybe (IO ())))) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (s, IORef (Maybe (IO ())))
 -&gt; Step (Maybe (s, IORef (Maybe (IO ())))) a)
-&gt; Maybe (s, IORef (Maybe (IO ())))
-&gt; Step (Maybe (s, IORef (Maybe (IO ())))) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, IORef (Maybe (IO ()))) -&gt; Maybe (s, IORef (Maybe (IO ())))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312620"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312618"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3367"></span><span>    </span><span class="annot"><a href="#local-6989586621679312619"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312617"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312617"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312616"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312616"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312615"><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312615"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3368"></span><span>        </span><span id="local-6989586621679312614"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312614"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312621"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312617"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312616"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3369"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312614"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3370"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312613"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312613"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312612"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312612"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, IORef (Maybe (IO ())))) a
-&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, IORef (Maybe (IO ())))) a
 -&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a))
-&gt; Step (Maybe (s, IORef (Maybe (IO ())))) a
-&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
-&gt; Maybe (s, IORef (Maybe (IO ())))
-&gt; Step (Maybe (s, IORef (Maybe (IO ())))) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312613"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, IORef (Maybe (IO ()))) -&gt; Maybe (s, IORef (Maybe (IO ())))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312612"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312615"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3371"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312611"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312611"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, IORef (Maybe (IO ())))) a
-&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, IORef (Maybe (IO ())))) a
 -&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a))
-&gt; Step (Maybe (s, IORef (Maybe (IO ())))) a
-&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, IORef (Maybe (IO ())))
-&gt; Step (Maybe (s, IORef (Maybe (IO ())))) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, IORef (Maybe (IO ()))) -&gt; Maybe (s, IORef (Maybe (IO ())))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312611"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312615"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3372"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3373"></span><span>                </span><span class="annot"><span class="annottext">IORef (Maybe (IO ())) -&gt; m ()
forall (m :: * -&gt; *). MonadIO m =&gt; IORef (Maybe (IO ())) -&gt; m ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runIORefFinalizer"><span class="hs-identifier hs-var">runIORefFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (IO ()))
</span><a href="#local-6989586621679312615"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-3374"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, IORef (Maybe (IO ())))) a
-&gt; m (Step (Maybe (s, IORef (Maybe (IO ())))) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, IORef (Maybe (IO ())))) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3375"></span><span>
</span><span id="line-3376"></span><span class="hs-comment">-- XXX These combinators are expensive due to the call to</span><span>
</span><span id="line-3377"></span><span class="hs-comment">-- onException/handle/try on each step. Therefore, when possible, they should</span><span>
</span><span id="line-3378"></span><span class="hs-comment">-- be called in an outer loop where we perform less iterations. For example, we</span><span>
</span><span id="line-3379"></span><span class="hs-comment">-- cannot call them on each iteration in a char stream, instead we can call</span><span>
</span><span id="line-3380"></span><span class="hs-comment">-- them when doing an IO on an array.</span><span>
</span><span id="line-3381"></span><span class="hs-comment">--</span><span>
</span><span id="line-3382"></span><span class="hs-comment">-- XXX For high performance error checks in busy streams we may need another</span><span>
</span><span id="line-3383"></span><span class="hs-comment">-- Error constructor in step.</span><span>
</span><span id="line-3384"></span><span class="hs-comment">--</span><span>
</span><span id="line-3385"></span><span class="hs-comment">-- | Run a side effect whenever the stream aborts due to an exception. The</span><span>
</span><span id="line-3386"></span><span class="hs-comment">-- exception is not caught, simply rethrown.</span><span>
</span><span id="line-3387"></span><span class="hs-pragma">{-# INLINE_NORMAL onException #-}</span><span>
</span><span id="line-3388"></span><span id="local-6989586621679312608"><span id="local-6989586621679312609"><span id="local-6989586621679312610"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#onException"><span class="hs-identifier hs-type">onException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679312610"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312610"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312609"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312610"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312608"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312610"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312608"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3389"></span><span id="onException"><span class="annot"><span class="annottext">onException :: m b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#onException"><span class="hs-identifier hs-var hs-var">onException</span></a></span></span><span> </span><span id="local-6989586621679312607"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312607"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span id="local-6989586621679312606"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312606"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3390"></span><span>    </span><span class="annot"><span class="annottext">m ()
-&gt; (forall s. m s -&gt; m (Either SomeException s))
-&gt; (() -&gt; m ())
-&gt; (() -&gt; SomeException -&gt; Stream m a -&gt; Stream m a)
-&gt; (() -&gt; Stream m a)
-&gt; Stream m a
forall (m :: * -&gt; *) c e d b.
Monad m =&gt;
m c
-&gt; (forall s. m s -&gt; m (Either e s))
-&gt; (c -&gt; m d)
-&gt; (c -&gt; e -&gt; Stream m b -&gt; Stream m b)
-&gt; (c -&gt; Stream m b)
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket_"><span class="hs-identifier hs-var">gbracket_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall s. m s -&gt; m (Either SomeException s)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">MC.try</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-3391"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312604"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679312604"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.SomeException</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m Any -&gt; Stream m a
forall (m :: * -&gt; *) b a. Monad m =&gt; m b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#nilM"><span class="hs-identifier hs-var">nilM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312607"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; m Any -&gt; m Any
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m Any
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">MC.throwM</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679312604"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3392"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312606"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3393"></span><span>
</span><span id="line-3394"></span><span class="hs-pragma">{-# INLINE_NORMAL _onException #-}</span><span>
</span><span id="line-3395"></span><span id="local-6989586621679312600"><span id="local-6989586621679312601"><span id="local-6989586621679312602"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#_onException"><span class="hs-identifier hs-type">_onException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679312602"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312602"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312601"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312602"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312600"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312602"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312600"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3396"></span><span id="_onException"><span class="annot"><span class="annottext">_onException :: m b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#_onException"><span class="hs-identifier hs-var hs-var">_onException</span></a></span></span><span> </span><span id="local-6989586621679312599"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312599"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312598"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312598"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312597"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312597"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312596"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312597"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-3397"></span><span>
</span><span id="line-3398"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3399"></span><span>
</span><span id="line-3400"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3401"></span><span>    </span><span id="local-6989586621679312596"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312596"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312595"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312595"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span id="local-6989586621679312594"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312594"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3402"></span><span>        </span><span id="local-6989586621679312593"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312593"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312598"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312595"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312594"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">m (Step s a) -&gt; m b -&gt; m (Step s a)
forall (m :: * -&gt; *) a b. MonadCatch m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`MC.onException`</span></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312599"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-3403"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312593"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3404"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312591"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312591"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312590"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312590"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; Step s a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312591"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312590"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3405"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312589"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312589"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Step s a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312589"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3406"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step s a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3407"></span><span>
</span><span id="line-3408"></span><span class="hs-comment">-- XXX bracket is like concatMap, it generates a stream and then flattens it.</span><span>
</span><span id="line-3409"></span><span class="hs-comment">-- Like concatMap it has 10x worse performance compared to linear fused</span><span>
</span><span id="line-3410"></span><span class="hs-comment">-- compositions.</span><span>
</span><span id="line-3411"></span><span class="hs-comment">--</span><span>
</span><span id="line-3412"></span><span class="hs-comment">-- | Run the first action before the stream starts and remember its output,</span><span>
</span><span id="line-3413"></span><span class="hs-comment">-- generate a stream using the output, run the second action providing the</span><span>
</span><span id="line-3414"></span><span class="hs-comment">-- remembered value as an argument whenever the stream ends normally or due to</span><span>
</span><span id="line-3415"></span><span class="hs-comment">-- an exception.</span><span>
</span><span id="line-3416"></span><span class="hs-pragma">{-# INLINE_NORMAL bracket_ #-}</span><span>
</span><span id="line-3417"></span><span id="local-6989586621679315387"><span id="local-6989586621679315388"><span id="local-6989586621679315389"><span id="local-6989586621679315390"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#bracket_"><span class="hs-identifier hs-type">bracket_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679315390"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315390"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315389"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315389"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315390"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315388"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315389"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315390"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315387"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315390"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315387"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-3418"></span><span id="bracket_"><span class="annot"><span class="annottext">bracket_ :: m b -&gt; (b -&gt; m c) -&gt; (b -&gt; Stream m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#bracket_"><span class="hs-identifier hs-var hs-var">bracket_</span></a></span></span><span> </span><span id="local-6989586621679312588"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312588"><span class="hs-identifier hs-var">bef</span></a></span></span><span> </span><span id="local-6989586621679312587"><span class="annot"><span class="annottext">b -&gt; m c
</span><a href="#local-6989586621679312587"><span class="hs-identifier hs-var">aft</span></a></span></span><span> </span><span id="local-6989586621679312586"><span class="annot"><span class="annottext">b -&gt; Stream m a
</span><a href="#local-6989586621679312586"><span class="hs-identifier hs-var">bet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3419"></span><span>    </span><span class="annot"><span class="annottext">m b
-&gt; (forall s. m s -&gt; m (Either SomeException s))
-&gt; (b -&gt; m c)
-&gt; (b -&gt; SomeException -&gt; Stream m a -&gt; Stream m a)
-&gt; (b -&gt; Stream m a)
-&gt; Stream m a
forall (m :: * -&gt; *) c e d b.
Monad m =&gt;
m c
-&gt; (forall s. m s -&gt; m (Either e s))
-&gt; (c -&gt; m d)
-&gt; (c -&gt; e -&gt; Stream m b -&gt; Stream m b)
-&gt; (c -&gt; Stream m b)
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket_"><span class="hs-identifier hs-var">gbracket_</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312588"><span class="hs-identifier hs-var">bef</span></a></span><span> </span><span class="annot"><span class="annottext">forall s. m s -&gt; m (Either SomeException s)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">MC.try</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; m c
</span><a href="#local-6989586621679312587"><span class="hs-identifier hs-var">aft</span></a></span><span>
</span><span id="line-3420"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312585"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312585"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312584"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679312584"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m Any -&gt; Stream m a
forall (m :: * -&gt; *) b a. Monad m =&gt; m b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#nilM"><span class="hs-identifier hs-var">nilM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; m c
</span><a href="#local-6989586621679312587"><span class="hs-identifier hs-var">aft</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312585"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m c -&gt; m Any -&gt; m Any
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m Any
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">MC.throwM</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679312584"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m a
</span><a href="#local-6989586621679312586"><span class="hs-identifier hs-var">bet</span></a></span><span>
</span><span id="line-3421"></span><span>
</span><span id="line-3422"></span><span class="hs-comment">-- | Run the first action before the stream starts and remember its output,</span><span>
</span><span id="line-3423"></span><span class="hs-comment">-- generate a stream using the output, run the second action providing the</span><span>
</span><span id="line-3424"></span><span class="hs-comment">-- remembered value as an argument whenever the stream ends normally or due to</span><span>
</span><span id="line-3425"></span><span class="hs-comment">-- an exception or gets garbage collected.</span><span>
</span><span id="line-3426"></span><span class="hs-comment">--</span><span>
</span><span id="line-3427"></span><span class="hs-pragma">{-# INLINE_NORMAL bracket #-}</span><span>
</span><span id="line-3428"></span><span id="local-6989586621679315377"><span id="local-6989586621679315378"><span id="local-6989586621679315379"><span id="local-6989586621679315381"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#bracket"><span class="hs-identifier hs-type">bracket</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315381"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679315381"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3429"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315379"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315379"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315378"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315379"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315377"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315377"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-3430"></span><span id="bracket"><span class="annot"><span class="annottext">bracket :: m b -&gt; (b -&gt; m c) -&gt; (b -&gt; Stream m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#bracket"><span class="hs-identifier hs-var hs-var">bracket</span></a></span></span><span> </span><span id="local-6989586621679312583"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312583"><span class="hs-identifier hs-var">bef</span></a></span></span><span> </span><span id="local-6989586621679312582"><span class="annot"><span class="annottext">b -&gt; m c
</span><a href="#local-6989586621679312582"><span class="hs-identifier hs-var">aft</span></a></span></span><span> </span><span id="local-6989586621679312581"><span class="annot"><span class="annottext">b -&gt; Stream m a
</span><a href="#local-6989586621679312581"><span class="hs-identifier hs-var">bet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3431"></span><span>    </span><span class="annot"><span class="annottext">m b
-&gt; (forall s. m s -&gt; m (Either SomeException s))
-&gt; (b -&gt; m c)
-&gt; (b -&gt; SomeException -&gt; Stream m a -&gt; m (Stream m a))
-&gt; (b -&gt; Stream m a)
-&gt; Stream m a
forall (m :: * -&gt; *) c e d b.
(MonadIO m, MonadBaseControl IO m) =&gt;
m c
-&gt; (forall s. m s -&gt; m (Either e s))
-&gt; (c -&gt; m d)
-&gt; (c -&gt; e -&gt; Stream m b -&gt; m (Stream m b))
-&gt; (c -&gt; Stream m b)
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket"><span class="hs-identifier hs-var">gbracket</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312583"><span class="hs-identifier hs-var">bef</span></a></span><span> </span><span class="annot"><span class="annottext">forall s. m s -&gt; m (Either SomeException s)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">MC.try</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; m c
</span><a href="#local-6989586621679312582"><span class="hs-identifier hs-var">aft</span></a></span><span>
</span><span id="line-3432"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312580"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312580"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312579"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679312579"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m c
</span><a href="#local-6989586621679312582"><span class="hs-identifier hs-var">aft</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312580"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m c -&gt; m (Stream m a) -&gt; m (Stream m a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m (Stream m a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m Any -&gt; Stream m a
forall (m :: * -&gt; *) b a. Monad m =&gt; m b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#nilM"><span class="hs-identifier hs-var">nilM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; m Any
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">MC.throwM</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679312579"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m a
</span><a href="#local-6989586621679312581"><span class="hs-identifier hs-var">bet</span></a></span><span>
</span><span id="line-3433"></span><span>
</span><span id="line-3434"></span><span class="hs-keyword">data</span><span> </span><span id="BracketState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#BracketState"><span class="hs-identifier hs-var">BracketState</span></a></span></span><span> </span><span id="local-6989586621679315396"><span class="annot"><a href="#local-6989586621679315396"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679315395"><span class="annot"><a href="#local-6989586621679315395"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BracketInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#BracketInit"><span class="hs-identifier hs-var">BracketInit</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="BracketRun"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#BracketRun"><span class="hs-identifier hs-var">BracketRun</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315396"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315395"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-3435"></span><span>
</span><span id="line-3436"></span><span class="hs-pragma">{-# INLINE_NORMAL _bracket #-}</span><span>
</span><span id="line-3437"></span><span id="local-6989586621679312572"><span id="local-6989586621679312573"><span id="local-6989586621679312574"><span id="local-6989586621679312575"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#_bracket"><span class="hs-identifier hs-type">_bracket</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679312575"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312575"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312574"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312574"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312575"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312573"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312574"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312575"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312572"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312575"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312572"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-3438"></span><span id="_bracket"><span class="annot"><span class="annottext">_bracket :: m b -&gt; (b -&gt; m c) -&gt; (b -&gt; Stream m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#_bracket"><span class="hs-identifier hs-var hs-var">_bracket</span></a></span></span><span> </span><span id="local-6989586621679312571"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312571"><span class="hs-identifier hs-var">bef</span></a></span></span><span> </span><span id="local-6989586621679312570"><span class="annot"><span class="annottext">b -&gt; m c
</span><a href="#local-6989586621679312570"><span class="hs-identifier hs-var">aft</span></a></span></span><span> </span><span id="local-6989586621679312569"><span class="annot"><span class="annottext">b -&gt; Stream m a
</span><a href="#local-6989586621679312569"><span class="hs-identifier hs-var">bet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; BracketState (Stream m a) b
 -&gt; m (Step (BracketState (Stream m a) b) a))
-&gt; BracketState (Stream m a) b -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; BracketState (Stream m a) b
-&gt; m (Step (BracketState (Stream m a) b) a)
</span><a href="#local-6989586621679312568"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">BracketState (Stream m a) b
forall s v. BracketState s v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#BracketInit"><span class="hs-identifier hs-var">BracketInit</span></a></span><span>
</span><span id="line-3439"></span><span>
</span><span id="line-3440"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3441"></span><span>
</span><span id="line-3442"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3443"></span><span>    </span><span id="local-6989586621679312568"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; BracketState (Stream m a) b
-&gt; m (Step (BracketState (Stream m a) b) a)
</span><a href="#local-6989586621679312568"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BracketState (Stream m a) b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#BracketInit"><span class="hs-identifier hs-var">BracketInit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312571"><span class="hs-identifier hs-var">bef</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (BracketState (Stream m a) b) a))
-&gt; m (Step (BracketState (Stream m a) b) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679312567"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312567"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (BracketState (Stream m a) b) a
-&gt; m (Step (BracketState (Stream m a) b) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BracketState (Stream m a) b -&gt; Step (BracketState (Stream m a) b) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; b -&gt; BracketState (Stream m a) b
forall s v. s -&gt; v -&gt; BracketState s v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#BracketRun"><span class="hs-identifier hs-var">BracketRun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Stream m a
</span><a href="#local-6989586621679312569"><span class="hs-identifier hs-var">bet</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312567"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312567"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3444"></span><span>
</span><span id="line-3445"></span><span>    </span><span class="hs-comment">-- NOTE: It is important to use UnStream instead of the Stream pattern</span><span>
</span><span id="line-3446"></span><span>    </span><span class="hs-comment">-- here, otherwise we get huge perf degradation, see note in concatMap.</span><span>
</span><span id="line-3447"></span><span>    </span><span class="annot"><a href="#local-6989586621679312568"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312566"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312566"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#BracketRun"><span class="hs-identifier hs-type">BracketRun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-type">UnStream</span></a></span><span> </span><span id="local-6989586621679312565"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312565"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312564"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312564"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679312563"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312563"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3448"></span><span>        </span><span class="hs-comment">-- res &lt;- step gst state `MC.onException` aft v</span><span>
</span><span id="line-3449"></span><span>        </span><span id="local-6989586621679312562"><span class="annot"><span class="annottext">Either SomeException (Step s a)
</span><a href="#local-6989586621679312562"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Step s a) -&gt; m (Either SomeException (Step s a))
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">MC.try</span></span><span> </span><span class="annot"><span class="annottext">(m (Step s a) -&gt; m (Either SomeException (Step s a)))
-&gt; m (Step s a) -&gt; m (Either SomeException (Step s a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312565"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312566"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312564"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-3450"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException (Step s a)
</span><a href="#local-6989586621679312562"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3451"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312561"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679312561"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m c
</span><a href="#local-6989586621679312570"><span class="hs-identifier hs-var">aft</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312563"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">m c -&gt; m Any -&gt; m Any
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m Any
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">MC.throwM</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679312561"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">m Any
-&gt; m (Step (BracketState (Stream m a) b) a)
-&gt; m (Step (BracketState (Stream m a) b) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Step (BracketState (Stream m a) b) a
-&gt; m (Step (BracketState (Stream m a) b) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (BracketState (Stream m a) b) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3452"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679312560"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312560"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312560"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3453"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312559"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312559"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312558"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312558"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (BracketState (Stream m a) b) a
-&gt; m (Step (BracketState (Stream m a) b) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (BracketState (Stream m a) b) a
 -&gt; m (Step (BracketState (Stream m a) b) a))
-&gt; Step (BracketState (Stream m a) b) a
-&gt; m (Step (BracketState (Stream m a) b) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
-&gt; BracketState (Stream m a) b
-&gt; Step (BracketState (Stream m a) b) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312559"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; b -&gt; BracketState (Stream m a) b
forall s v. s -&gt; v -&gt; BracketState s v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#BracketRun"><span class="hs-identifier hs-var">BracketRun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312565"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312558"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312563"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3454"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312557"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312557"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (BracketState (Stream m a) b) a
-&gt; m (Step (BracketState (Stream m a) b) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (BracketState (Stream m a) b) a
 -&gt; m (Step (BracketState (Stream m a) b) a))
-&gt; Step (BracketState (Stream m a) b) a
-&gt; m (Step (BracketState (Stream m a) b) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BracketState (Stream m a) b -&gt; Step (BracketState (Stream m a) b) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; b -&gt; BracketState (Stream m a) b
forall s v. s -&gt; v -&gt; BracketState s v
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#BracketRun"><span class="hs-identifier hs-var">BracketRun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312565"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312557"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312563"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3455"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m c
</span><a href="#local-6989586621679312570"><span class="hs-identifier hs-var">aft</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312563"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">m c
-&gt; m (Step (BracketState (Stream m a) b) a)
-&gt; m (Step (BracketState (Stream m a) b) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Step (BracketState (Stream m a) b) a
-&gt; m (Step (BracketState (Stream m a) b) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (BracketState (Stream m a) b) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3456"></span><span>
</span><span id="line-3457"></span><span class="hs-comment">-- | Run a side effect whenever the stream stops normally or aborts due to an</span><span>
</span><span id="line-3458"></span><span class="hs-comment">-- exception.</span><span>
</span><span id="line-3459"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#finally_"><span class="hs-pragma hs-type">finally_</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3460"></span><span id="local-6989586621679312554"><span id="local-6989586621679312555"><span id="local-6989586621679312556"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#finally_"><span class="hs-identifier hs-type">finally_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679312556"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312556"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312555"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312556"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312554"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312556"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312554"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3461"></span><span class="hs-comment">-- finally action xs = after action $ onException action xs</span><span>
</span><span id="line-3462"></span><span id="finally_"><span class="annot"><span class="annottext">finally_ :: m b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#finally_"><span class="hs-identifier hs-var hs-var">finally_</span></a></span></span><span> </span><span id="local-6989586621679312553"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312553"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span id="local-6989586621679312552"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312552"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; (() -&gt; m b) -&gt; (() -&gt; Stream m a) -&gt; Stream m a
forall (m :: * -&gt; *) b c a.
MonadCatch m =&gt;
m b -&gt; (b -&gt; m c) -&gt; (b -&gt; Stream m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#bracket_"><span class="hs-identifier hs-var">bracket_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312553"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; () -&gt; Stream m a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312552"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3463"></span><span>
</span><span id="line-3464"></span><span class="hs-comment">-- | Run a side effect whenever the stream stops normally or aborts due to an</span><span>
</span><span id="line-3465"></span><span class="hs-comment">-- exception or gets garbage collected.</span><span>
</span><span id="line-3466"></span><span class="hs-comment">--</span><span>
</span><span id="line-3467"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#finally"><span class="hs-pragma hs-type">finally</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3468"></span><span id="local-6989586621679312548"><span id="local-6989586621679312549"><span id="local-6989586621679312550"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#finally"><span class="hs-identifier hs-type">finally</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312550"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679312550"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312550"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312549"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312550"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312548"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312550"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312548"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3469"></span><span id="finally"><span class="annot"><span class="annottext">finally :: m b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#finally"><span class="hs-identifier hs-var hs-var">finally</span></a></span></span><span> </span><span id="local-6989586621679312547"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312547"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span id="local-6989586621679312546"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312546"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; (() -&gt; m b) -&gt; (() -&gt; Stream m a) -&gt; Stream m a
forall (m :: * -&gt; *) b c a.
(MonadAsync m, MonadCatch m) =&gt;
m b -&gt; (b -&gt; m c) -&gt; (b -&gt; Stream m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#bracket"><span class="hs-identifier hs-var">bracket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312547"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; () -&gt; Stream m a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312546"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3470"></span><span>
</span><span id="line-3471"></span><span class="hs-comment">-- | When evaluating a stream if an exception occurs, stream</span><span>
</span><span id="line-3472"></span><span class="hs-comment">-- evaluation aborts and the specified exception handler is run with</span><span>
</span><span id="line-3473"></span><span class="hs-comment">-- the exception and the Stream which threw the exception as argument.</span><span>
</span><span id="line-3474"></span><span class="hs-comment">--</span><span>
</span><span id="line-3475"></span><span class="hs-pragma">{-# INLINE_NORMAL ghandle #-}</span><span>
</span><span id="line-3476"></span><span id="local-6989586621679312543"><span id="local-6989586621679312544"><span id="local-6989586621679312545"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#ghandle"><span class="hs-identifier hs-type">ghandle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679312545"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621679312544"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3477"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312544"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312543"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312543"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312543"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312543"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3478"></span><span id="ghandle"><span class="annot"><span class="annottext">ghandle :: (e -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#ghandle"><span class="hs-identifier hs-var hs-var">ghandle</span></a></span></span><span> </span><span id="local-6989586621679312542"><span class="annot"><span class="annottext">e -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679312542"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679312541"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312541"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3479"></span><span>    </span><span class="annot"><span class="annottext">m ()
-&gt; (forall s. m s -&gt; m (Either e s))
-&gt; (() -&gt; m ())
-&gt; (() -&gt; e -&gt; Stream m a -&gt; Stream m a)
-&gt; (() -&gt; Stream m a)
-&gt; Stream m a
forall (m :: * -&gt; *) c e d b.
Monad m =&gt;
m c
-&gt; (forall s. m s -&gt; m (Either e s))
-&gt; (c -&gt; m d)
-&gt; (c -&gt; e -&gt; Stream m b -&gt; Stream m b)
-&gt; (c -&gt; Stream m b)
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket_"><span class="hs-identifier hs-var">gbracket_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall s. m s -&gt; m (Either e s)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">MC.try</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">e -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679312542"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312541"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3480"></span><span>
</span><span id="line-3481"></span><span class="hs-comment">-- | When evaluating a stream if an exception occurs, stream evaluation aborts</span><span>
</span><span id="line-3482"></span><span class="hs-comment">-- and the specified exception handler is run with the exception as argument.</span><span>
</span><span id="line-3483"></span><span class="hs-pragma">{-# INLINE_NORMAL handle #-}</span><span>
</span><span id="line-3484"></span><span id="local-6989586621679312538"><span id="local-6989586621679312539"><span id="local-6989586621679312540"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#handle"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679312540"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621679312539"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3485"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312539"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312540"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312538"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312540"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312538"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312540"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312538"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3486"></span><span id="handle"><span class="annot"><span class="annottext">handle :: (e -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#handle"><span class="hs-identifier hs-var hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679312537"><span class="annot"><span class="annottext">e -&gt; Stream m a
</span><a href="#local-6989586621679312537"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679312536"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312536"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3487"></span><span>    </span><span class="annot"><span class="annottext">m ()
-&gt; (forall s. m s -&gt; m (Either e s))
-&gt; (() -&gt; m ())
-&gt; (() -&gt; e -&gt; Stream m a -&gt; Stream m a)
-&gt; (() -&gt; Stream m a)
-&gt; Stream m a
forall (m :: * -&gt; *) c e d b.
Monad m =&gt;
m c
-&gt; (forall s. m s -&gt; m (Either e s))
-&gt; (c -&gt; m d)
-&gt; (c -&gt; e -&gt; Stream m b -&gt; Stream m b)
-&gt; (c -&gt; Stream m b)
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#gbracket_"><span class="hs-identifier hs-var">gbracket_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall s. m s -&gt; m (Either e s)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">MC.try</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679312535"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679312535"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">e -&gt; Stream m a
</span><a href="#local-6989586621679312537"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679312535"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312536"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3488"></span><span>
</span><span id="line-3489"></span><span class="hs-pragma">{-# INLINE_NORMAL _handle #-}</span><span>
</span><span id="line-3490"></span><span id="local-6989586621679312531"><span id="local-6989586621679312532"><span id="local-6989586621679312533"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#_handle"><span class="hs-identifier hs-type">_handle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679312533"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621679312532"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3491"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312532"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312533"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312531"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312533"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312531"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312533"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312531"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3492"></span><span id="_handle"><span class="annot"><span class="annottext">_handle :: (e -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#_handle"><span class="hs-identifier hs-var hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679312530"><span class="annot"><span class="annottext">e -&gt; Stream m a
</span><a href="#local-6989586621679312530"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312529"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312529"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312528"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312528"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; Either s (Stream m a) -&gt; m (Step (Either s (Stream m a)) a))
-&gt; Either s (Stream m a) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; Either s (Stream m a) -&gt; m (Step (Either s (Stream m a)) a)
</span><a href="#local-6989586621679312527"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Either s (Stream m a)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312528"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3493"></span><span>
</span><span id="line-3494"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3495"></span><span>
</span><span id="line-3496"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3497"></span><span>    </span><span id="local-6989586621679312527"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; Either s (Stream m a) -&gt; m (Step (Either s (Stream m a)) a)
</span><a href="#local-6989586621679312527"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312526"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312526"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679312525"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312525"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3498"></span><span>        </span><span id="local-6989586621679312524"><span class="annot"><span class="annottext">Either e (Step s a)
</span><a href="#local-6989586621679312524"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Step s a) -&gt; m (Either e (Step s a))
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">MC.try</span></span><span> </span><span class="annot"><span class="annottext">(m (Step s a) -&gt; m (Either e (Step s a)))
-&gt; m (Step s a) -&gt; m (Either e (Step s a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312529"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312526"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312525"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3499"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either e (Step s a)
</span><a href="#local-6989586621679312524"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3500"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679312523"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679312523"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either s (Stream m a)) a
 -&gt; m (Step (Either s (Stream m a)) a))
-&gt; Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either s (Stream m a) -&gt; Step (Either s (Stream m a)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Either s (Stream m a) -&gt; Step (Either s (Stream m a)) a)
-&gt; Either s (Stream m a) -&gt; Step (Either s (Stream m a)) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Either s (Stream m a)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">e -&gt; Stream m a
</span><a href="#local-6989586621679312530"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679312523"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3501"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679312522"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312522"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312522"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3502"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312521"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312521"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312520"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312520"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either s (Stream m a)) a
 -&gt; m (Step (Either s (Stream m a)) a))
-&gt; Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Either s (Stream m a) -&gt; Step (Either s (Stream m a)) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312521"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Either s (Stream m a)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312520"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3503"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312519"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312519"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either s (Stream m a)) a
 -&gt; m (Step (Either s (Stream m a)) a))
-&gt; Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either s (Stream m a) -&gt; Step (Either s (Stream m a)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Either s (Stream m a)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312519"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3504"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Either s (Stream m a)) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3505"></span><span>
</span><span id="line-3506"></span><span>    </span><span class="annot"><a href="#local-6989586621679312527"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312518"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312518"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-type">UnStream</span></a></span><span> </span><span id="local-6989586621679312517"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312517"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312516"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312516"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3507"></span><span>        </span><span id="local-6989586621679312515"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312515"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312517"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312518"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312516"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3508"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312515"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3509"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312514"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312514"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312513"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312513"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either s (Stream m a)) a
 -&gt; m (Step (Either s (Stream m a)) a))
-&gt; Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Either s (Stream m a) -&gt; Step (Either s (Stream m a)) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312514"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Either s (Stream m a)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312517"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312513"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3510"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312512"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312512"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either s (Stream m a)) a
 -&gt; m (Step (Either s (Stream m a)) a))
-&gt; Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either s (Stream m a) -&gt; Step (Either s (Stream m a)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Either s (Stream m a)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312517"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312512"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3511"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s (Stream m a)) a
-&gt; m (Step (Either s (Stream m a)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Either s (Stream m a)) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3512"></span><span>
</span><span id="line-3513"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-3514"></span><span class="hs-comment">-- General transformation</span><span>
</span><span id="line-3515"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-3516"></span><span>
</span><span id="line-3517"></span><span class="hs-pragma">{-# INLINE_NORMAL transform #-}</span><span>
</span><span id="line-3518"></span><span id="local-6989586621679312509"><span id="local-6989586621679312510"><span id="local-6989586621679312511"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#transform"><span class="hs-identifier hs-type">transform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312511"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312511"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312510"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312509"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312511"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312510"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312511"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312509"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3519"></span><span id="transform"><span class="annot"><span class="annottext">transform :: Pipe m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#transform"><span class="hs-identifier hs-var hs-var">transform</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a></span><span> </span><span id="local-6989586621679312507"><span class="annot"><span class="annottext">s1 -&gt; a -&gt; m (Step (PipeState s1 s2) b)
</span><a href="#local-6989586621679312507"><span class="hs-identifier hs-var">pstep1</span></a></span></span><span> </span><span id="local-6989586621679312506"><span class="annot"><span class="annottext">s2 -&gt; m (Step (PipeState s1 s2) b)
</span><a href="#local-6989586621679312506"><span class="hs-identifier hs-var">pstep2</span></a></span></span><span> </span><span id="local-6989586621679312505"><span class="annot"><span class="annottext">s1
</span><a href="#local-6989586621679312505"><span class="hs-identifier hs-var">pstate</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312504"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312504"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312503"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312503"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3520"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; (PipeState s1 s2, s) -&gt; m (Step (PipeState s1 s2, s) b))
-&gt; (PipeState s1 s2, s) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; (PipeState s1 s2, s) -&gt; m (Step (PipeState s1 s2, s) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; (PipeState s1 s2, s) -&gt; m (Step (PipeState s1 s2, s) b)
</span><a href="#local-6989586621679312502"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s1 -&gt; PipeState s1 s2
forall s1 s2. s1 -&gt; PipeState s1 s2
</span><a href="Streamly.Internal.Data.Pipe.Types.html#Consume"><span class="hs-identifier hs-var">Consume</span></a></span><span> </span><span class="annot"><span class="annottext">s1
</span><a href="#local-6989586621679312505"><span class="hs-identifier hs-var">pstate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312503"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3521"></span><span>
</span><span id="line-3522"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3523"></span><span>
</span><span id="line-3524"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3525"></span><span>
</span><span id="line-3526"></span><span>    </span><span id="local-6989586621679312502"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; (PipeState s1 s2, s) -&gt; m (Step (PipeState s1 s2, s) b)
</span><a href="#local-6989586621679312502"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312500"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312500"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#Consume"><span class="hs-identifier hs-type">Consume</span></a></span><span> </span><span id="local-6989586621679312499"><span class="annot"><span class="annottext">s1
</span><a href="#local-6989586621679312499"><span class="hs-identifier hs-var">pst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312498"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312498"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s1
</span><a href="#local-6989586621679312499"><span class="hs-identifier hs-var">pst</span></a></span><span> </span><span class="annot"><span class="annottext">s1
-&gt; m (Step (PipeState s1 s2, s) b)
-&gt; m (Step (PipeState s1 s2, s) b)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3527"></span><span>        </span><span id="local-6989586621679312497"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312497"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312504"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312500"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312498"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3528"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312497"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3529"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312496"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312496"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312495"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312495"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3530"></span><span>                </span><span id="local-6989586621679312494"><span class="annot"><span class="annottext">Step (PipeState s1 s2) b
</span><a href="#local-6989586621679312494"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s1 -&gt; a -&gt; m (Step (PipeState s1 s2) b)
</span><a href="#local-6989586621679312507"><span class="hs-identifier hs-var">pstep1</span></a></span><span> </span><span class="annot"><span class="annottext">s1
</span><a href="#local-6989586621679312499"><span class="hs-identifier hs-var">pst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312496"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3531"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step (PipeState s1 s2) b
</span><a href="#local-6989586621679312494"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3532"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#Yield"><span class="hs-identifier hs-type">Pipe.Yield</span></a></span><span> </span><span id="local-6989586621679312492"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312492"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679312491"><span class="annot"><span class="annottext">PipeState s1 s2
</span><a href="#local-6989586621679312491"><span class="hs-identifier hs-var">pst'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b))
-&gt; Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; (PipeState s1 s2, s) -&gt; Step (PipeState s1 s2, s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312492"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipeState s1 s2
</span><a href="#local-6989586621679312491"><span class="hs-identifier hs-var">pst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312495"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3533"></span><span>                    </span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#Continue"><span class="hs-identifier hs-type">Pipe.Continue</span></a></span><span> </span><span id="local-6989586621679312489"><span class="annot"><span class="annottext">PipeState s1 s2
</span><a href="#local-6989586621679312489"><span class="hs-identifier hs-var">pst'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b))
-&gt; Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PipeState s1 s2, s) -&gt; Step (PipeState s1 s2, s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipeState s1 s2
</span><a href="#local-6989586621679312489"><span class="hs-identifier hs-var">pst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312495"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3534"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312488"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312488"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b))
-&gt; Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PipeState s1 s2, s) -&gt; Step (PipeState s1 s2, s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s1 -&gt; PipeState s1 s2
forall s1 s2. s1 -&gt; PipeState s1 s2
</span><a href="Streamly.Internal.Data.Pipe.Types.html#Consume"><span class="hs-identifier hs-var">Consume</span></a></span><span> </span><span class="annot"><span class="annottext">s1
</span><a href="#local-6989586621679312499"><span class="hs-identifier hs-var">pst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312488"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3535"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (PipeState s1 s2, s) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3536"></span><span>
</span><span id="line-3537"></span><span>    </span><span class="annot"><a href="#local-6989586621679312502"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#Produce"><span class="hs-identifier hs-type">Produce</span></a></span><span> </span><span id="local-6989586621679312486"><span class="annot"><span class="annottext">s2
</span><a href="#local-6989586621679312486"><span class="hs-identifier hs-var">pst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312485"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312485"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s2
</span><a href="#local-6989586621679312486"><span class="hs-identifier hs-var">pst</span></a></span><span> </span><span class="annot"><span class="annottext">s2
-&gt; m (Step (PipeState s1 s2, s) b)
-&gt; m (Step (PipeState s1 s2, s) b)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3538"></span><span>        </span><span id="local-6989586621679312484"><span class="annot"><span class="annottext">Step (PipeState s1 s2) b
</span><a href="#local-6989586621679312484"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s2 -&gt; m (Step (PipeState s1 s2) b)
</span><a href="#local-6989586621679312506"><span class="hs-identifier hs-var">pstep2</span></a></span><span> </span><span class="annot"><span class="annottext">s2
</span><a href="#local-6989586621679312486"><span class="hs-identifier hs-var">pst</span></a></span><span>
</span><span id="line-3539"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step (PipeState s1 s2) b
</span><a href="#local-6989586621679312484"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3540"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#Yield"><span class="hs-identifier hs-type">Pipe.Yield</span></a></span><span> </span><span id="local-6989586621679312483"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312483"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679312482"><span class="annot"><span class="annottext">PipeState s1 s2
</span><a href="#local-6989586621679312482"><span class="hs-identifier hs-var">pst'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b))
-&gt; Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; (PipeState s1 s2, s) -&gt; Step (PipeState s1 s2, s) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312483"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipeState s1 s2
</span><a href="#local-6989586621679312482"><span class="hs-identifier hs-var">pst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312485"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3541"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Pipe.Types.html#Continue"><span class="hs-identifier hs-type">Pipe.Continue</span></a></span><span> </span><span id="local-6989586621679312481"><span class="annot"><span class="annottext">PipeState s1 s2
</span><a href="#local-6989586621679312481"><span class="hs-identifier hs-var">pst'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b))
-&gt; Step (PipeState s1 s2, s) b -&gt; m (Step (PipeState s1 s2, s) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PipeState s1 s2, s) -&gt; Step (PipeState s1 s2, s) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipeState s1 s2
</span><a href="#local-6989586621679312481"><span class="hs-identifier hs-var">pst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312485"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3542"></span><span>
</span><span id="line-3543"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3544"></span><span class="hs-comment">-- Transformation by Folding (Scans)</span><span>
</span><span id="line-3545"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3546"></span><span>
</span><span id="line-3547"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3548"></span><span class="hs-comment">-- Prescans</span><span>
</span><span id="line-3549"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3550"></span><span>
</span><span id="line-3551"></span><span class="hs-comment">-- XXX Is a prescan useful, discarding the last step does not sound useful?  I</span><span>
</span><span id="line-3552"></span><span class="hs-comment">-- am not sure about the utility of this function, so this is implemented but</span><span>
</span><span id="line-3553"></span><span class="hs-comment">-- not exposed. We can expose it if someone provides good reasons why this is</span><span>
</span><span id="line-3554"></span><span class="hs-comment">-- useful.</span><span>
</span><span id="line-3555"></span><span class="hs-comment">--</span><span>
</span><span id="line-3556"></span><span class="hs-comment">-- XXX We have to execute the stream one step ahead to know that we are at the</span><span>
</span><span id="line-3557"></span><span class="hs-comment">-- last step.  The vector implementation of prescan executes the last fold step</span><span>
</span><span id="line-3558"></span><span class="hs-comment">-- but does not yield the result. This means we have executed the effect but</span><span>
</span><span id="line-3559"></span><span class="hs-comment">-- discarded value. This does not sound right. In this implementation we are</span><span>
</span><span id="line-3560"></span><span class="hs-comment">-- not executing the last fold step.</span><span>
</span><span id="line-3561"></span><span class="hs-pragma">{-# INLINE_NORMAL prescanlM' #-}</span><span>
</span><span id="line-3562"></span><span id="local-6989586621679315341"><span id="local-6989586621679315342"><span id="local-6989586621679315343"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#prescanlM%27"><span class="hs-identifier hs-type">prescanlM'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315342"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315341"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315342"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315342"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315341"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315342"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3563"></span><span id="prescanlM%27"><span class="annot"><span class="annottext">prescanlM' :: (b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#prescanlM%27"><span class="hs-identifier hs-var hs-var">prescanlM'</span></a></span></span><span> </span><span id="local-6989586621679312480"><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312480"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679312479"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312479"><span class="hs-identifier hs-var">mz</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312478"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312478"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312477"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312477"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b -&gt; (s, m b) -&gt; m (Step (s, m b) b))
-&gt; (s, m b) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; (s, m b) -&gt; m (Step (s, m b) b)
forall (m :: * -&gt; *) a.
State Stream m a -&gt; (s, m b) -&gt; m (Step (s, m b) b)
</span><a href="#local-6989586621679312476"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312477"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312479"><span class="hs-identifier hs-var">mz</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3564"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3565"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3566"></span><span>    </span><span id="local-6989586621679312476"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, m b) -&gt; m (Step (s, m b) b)
</span><a href="#local-6989586621679312476"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312475"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312475"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312474"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312474"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312473"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312473"><span class="hs-identifier hs-var">prev</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3567"></span><span>        </span><span id="local-6989586621679312472"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312472"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312478"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312475"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312474"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3568"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312472"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3569"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312471"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312471"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312470"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312470"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3570"></span><span>                </span><span id="local-6989586621679312469"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312469"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312473"><span class="hs-identifier hs-var">prev</span></a></span><span>
</span><span id="line-3571"></span><span>                </span><span class="annot"><span class="annottext">Step (s, m b) b -&gt; m (Step (s, m b) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, m b) b -&gt; m (Step (s, m b) b))
-&gt; Step (s, m b) b -&gt; m (Step (s, m b) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; (s, m b) -&gt; Step (s, m b) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312469"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312470"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312480"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312469"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312471"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3572"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312468"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312468"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, m b) b -&gt; m (Step (s, m b) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, m b) b -&gt; m (Step (s, m b) b))
-&gt; Step (s, m b) b -&gt; m (Step (s, m b) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, m b) -&gt; Step (s, m b) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312468"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312473"><span class="hs-identifier hs-var">prev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3573"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, m b) b -&gt; m (Step (s, m b) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, m b) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3574"></span><span>
</span><span id="line-3575"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#prescanl%27"><span class="hs-pragma hs-type">prescanl'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3576"></span><span id="local-6989586621679312465"><span id="local-6989586621679312466"><span id="local-6989586621679312467"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#prescanl%27"><span class="hs-identifier hs-type">prescanl'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312467"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312466"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312465"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312466"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312466"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312467"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312465"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312467"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312466"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3577"></span><span id="prescanl%27"><span class="annot"><span class="annottext">prescanl' :: (b -&gt; a -&gt; b) -&gt; b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#prescanl%27"><span class="hs-identifier hs-var hs-var">prescanl'</span></a></span></span><span> </span><span id="local-6989586621679312464"><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679312464"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679312463"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312463"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#prescanlM%27"><span class="hs-identifier hs-var">prescanlM'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312462"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312462"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312461"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312461"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679312464"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312462"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312461"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312463"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3578"></span><span>
</span><span id="line-3579"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3580"></span><span class="hs-comment">-- Monolithic postscans (postscan followed by a map)</span><span>
</span><span id="line-3581"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3582"></span><span>
</span><span id="line-3583"></span><span class="hs-comment">-- The performance of a modular postscan followed by a map seems to be</span><span>
</span><span id="line-3584"></span><span class="hs-comment">-- equivalent to this monolithic scan followed by map therefore we may not need</span><span>
</span><span id="line-3585"></span><span class="hs-comment">-- this implementation. We just have it for performance comparison and in case</span><span>
</span><span id="line-3586"></span><span class="hs-comment">-- modular version does not perform well in some situation.</span><span>
</span><span id="line-3587"></span><span class="hs-comment">--</span><span>
</span><span id="line-3588"></span><span class="hs-pragma">{-# INLINE_NORMAL postscanlMx' #-}</span><span>
</span><span id="line-3589"></span><span id="local-6989586621679315326"><span id="local-6989586621679315327"><span id="local-6989586621679315328"><span id="local-6989586621679315329"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlMx%27"><span class="hs-identifier hs-type">postscanlMx'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315329"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3590"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315328"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315327"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315329"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315328"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315329"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315328"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315328"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315329"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315326"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315329"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315327"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315329"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315326"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span><span>
</span><span id="line-3591"></span><span id="postscanlMx%27"><span class="annot"><span class="annottext">postscanlMx' :: (x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlMx%27"><span class="hs-identifier hs-var hs-var">postscanlMx'</span></a></span></span><span> </span><span id="local-6989586621679312460"><span class="annot"><span class="annottext">x -&gt; a -&gt; m x
</span><a href="#local-6989586621679312460"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312459"><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679312459"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span id="local-6989586621679312458"><span class="annot"><span class="annottext">x -&gt; m b
</span><a href="#local-6989586621679312458"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312457"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312457"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312456"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312456"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3592"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b -&gt; (s, m x) -&gt; m (Step (s, m x) b))
-&gt; (s, m x) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; (s, m x) -&gt; m (Step (s, m x) b)
forall (m :: * -&gt; *) a.
State Stream m a -&gt; (s, m x) -&gt; m (Step (s, m x) b)
</span><a href="#local-6989586621679312455"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312456"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679312459"><span class="hs-identifier hs-var">begin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3593"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3594"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3595"></span><span>    </span><span id="local-6989586621679312455"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, m x) -&gt; m (Step (s, m x) b)
</span><a href="#local-6989586621679312455"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312454"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312454"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312453"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312453"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312452"><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679312452"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3596"></span><span>        </span><span id="local-6989586621679312451"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312451"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312457"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312454"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312453"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3597"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312451"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3598"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312450"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312450"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312449"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312449"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3599"></span><span>                </span><span id="local-6989586621679312448"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312448"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679312452"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-3600"></span><span>                </span><span id="local-6989586621679312447"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312447"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">x -&gt; a -&gt; m x
</span><a href="#local-6989586621679312460"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312448"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312450"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3601"></span><span>                </span><span id="local-6989586621679312446"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312446"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">x -&gt; m b
</span><a href="#local-6989586621679312458"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312447"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-3602"></span><span>                </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312446"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m (Step (s, m x) b) -&gt; m (Step (s, m x) b)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312447"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; m (Step (s, m x) b) -&gt; m (Step (s, m x) b)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (s, m x) b -&gt; m (Step (s, m x) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; (s, m x) -&gt; Step (s, m x) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312446"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312449"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">x -&gt; m x
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312447"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3603"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312445"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312445"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, m x) b -&gt; m (Step (s, m x) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, m x) b -&gt; m (Step (s, m x) b))
-&gt; Step (s, m x) b -&gt; m (Step (s, m x) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, m x) -&gt; Step (s, m x) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312445"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679312452"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3604"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, m x) b -&gt; m (Step (s, m x) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, m x) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3605"></span><span>
</span><span id="line-3606"></span><span class="hs-pragma">{-# INLINE_NORMAL postscanlx' #-}</span><span>
</span><span id="line-3607"></span><span id="local-6989586621679312441"><span id="local-6989586621679312442"><span id="local-6989586621679312443"><span id="local-6989586621679312444"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlx%27"><span class="hs-identifier hs-type">postscanlx'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312444"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3608"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312443"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312442"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312443"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312443"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312443"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312441"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312444"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312442"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312444"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312441"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span><span>
</span><span id="line-3609"></span><span id="postscanlx%27"><span class="annot"><span class="annottext">postscanlx' :: (x -&gt; a -&gt; x) -&gt; x -&gt; (x -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlx%27"><span class="hs-identifier hs-var hs-var">postscanlx'</span></a></span></span><span> </span><span id="local-6989586621679312440"><span class="annot"><span class="annottext">x -&gt; a -&gt; x
</span><a href="#local-6989586621679312440"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312439"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312439"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span id="local-6989586621679312438"><span class="annot"><span class="annottext">x -&gt; b
</span><a href="#local-6989586621679312438"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span id="local-6989586621679312437"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312437"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3610"></span><span>    </span><span class="annot"><span class="annottext">(x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream m a -&gt; Stream m b
forall (m :: * -&gt; *) x a b.
Monad m =&gt;
(x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlMx%27"><span class="hs-identifier hs-var">postscanlMx'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312436"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312436"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679312435"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312435"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">x -&gt; m x
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x -&gt; a -&gt; x
</span><a href="#local-6989586621679312440"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312436"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312435"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x -&gt; m x
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312439"><span class="hs-identifier hs-var">begin</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(b -&gt; m b) -&gt; (x -&gt; b) -&gt; x -&gt; m b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; b
</span><a href="#local-6989586621679312438"><span class="hs-identifier hs-var">done</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312437"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3611"></span><span>
</span><span id="line-3612"></span><span class="hs-comment">-- XXX do we need consM strict to evaluate the begin value?</span><span>
</span><span id="line-3613"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlMx%27"><span class="hs-pragma hs-type">scanlMx'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3614"></span><span id="local-6989586621679312431"><span id="local-6989586621679312432"><span id="local-6989586621679312433"><span id="local-6989586621679312434"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlMx%27"><span class="hs-identifier hs-type">scanlMx'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312434"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3615"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312433"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312432"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312433"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312433"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312433"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312431"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312432"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312431"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span><span>
</span><span id="line-3616"></span><span id="scanlMx%27"><span class="annot"><span class="annottext">scanlMx' :: (x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlMx%27"><span class="hs-identifier hs-var hs-var">scanlMx'</span></a></span></span><span> </span><span id="local-6989586621679312430"><span class="annot"><span class="annottext">x -&gt; a -&gt; m x
</span><a href="#local-6989586621679312430"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312429"><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679312429"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span id="local-6989586621679312428"><span class="annot"><span class="annottext">x -&gt; m b
</span><a href="#local-6989586621679312428"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span id="local-6989586621679312427"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312427"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3617"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679312429"><span class="hs-identifier hs-var">begin</span></a></span><span> </span><span class="annot"><span class="annottext">m x -&gt; (x -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679312426"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312426"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312426"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; m b
</span><a href="#local-6989586621679312428"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312426"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m b -&gt; Stream m b -&gt; Stream m b
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#consM"><span class="hs-operator hs-var">`consM`</span></a></span><span> </span><span class="annot"><span class="annottext">(x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream m a -&gt; Stream m b
forall (m :: * -&gt; *) x a b.
Monad m =&gt;
(x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlMx%27"><span class="hs-identifier hs-var">postscanlMx'</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; a -&gt; m x
</span><a href="#local-6989586621679312430"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679312429"><span class="hs-identifier hs-var">begin</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; m b
</span><a href="#local-6989586621679312428"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312427"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3618"></span><span>
</span><span id="line-3619"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlx%27"><span class="hs-pragma hs-type">scanlx'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3620"></span><span id="local-6989586621679312422"><span id="local-6989586621679312423"><span id="local-6989586621679312424"><span id="local-6989586621679312425"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlx%27"><span class="hs-identifier hs-type">scanlx'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312425"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3621"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312424"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312423"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312424"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312424"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312424"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312422"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312425"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312423"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312425"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312422"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span><span>
</span><span id="line-3622"></span><span id="scanlx%27"><span class="annot"><span class="annottext">scanlx' :: (x -&gt; a -&gt; x) -&gt; x -&gt; (x -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlx%27"><span class="hs-identifier hs-var hs-var">scanlx'</span></a></span></span><span> </span><span id="local-6989586621679312421"><span class="annot"><span class="annottext">x -&gt; a -&gt; x
</span><a href="#local-6989586621679312421"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312420"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312420"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span id="local-6989586621679312419"><span class="annot"><span class="annottext">x -&gt; b
</span><a href="#local-6989586621679312419"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span id="local-6989586621679312418"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312418"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3623"></span><span>    </span><span class="annot"><span class="annottext">(x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream m a -&gt; Stream m b
forall (m :: * -&gt; *) x a b.
Monad m =&gt;
(x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlMx%27"><span class="hs-identifier hs-var">scanlMx'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312417"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312417"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679312416"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312416"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">x -&gt; m x
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x -&gt; a -&gt; x
</span><a href="#local-6989586621679312421"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312417"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312416"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x -&gt; m x
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679312420"><span class="hs-identifier hs-var">begin</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(b -&gt; m b) -&gt; (x -&gt; b) -&gt; x -&gt; m b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; b
</span><a href="#local-6989586621679312419"><span class="hs-identifier hs-var">done</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312418"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3624"></span><span>
</span><span id="line-3625"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3626"></span><span class="hs-comment">-- postscans</span><span>
</span><span id="line-3627"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3628"></span><span>
</span><span id="line-3629"></span><span class="hs-pragma">{-# INLINE_NORMAL postscanlM' #-}</span><span>
</span><span id="line-3630"></span><span id="local-6989586621679312413"><span id="local-6989586621679312414"><span id="local-6989586621679312415"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlM%27"><span class="hs-identifier hs-type">postscanlM'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312415"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312414"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312413"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312415"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312414"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312415"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312414"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312415"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312413"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312415"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312414"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3631"></span><span id="postscanlM%27"><span class="annot"><span class="annottext">postscanlM' :: (b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlM%27"><span class="hs-identifier hs-var hs-var">postscanlM'</span></a></span></span><span> </span><span id="local-6989586621679312412"><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312412"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312411"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312411"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312410"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312410"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312409"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312409"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3632"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b))
-&gt; Maybe (s, b) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a.
State Stream m a -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
</span><a href="#local-6989586621679312408"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3633"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3634"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3635"></span><span>    </span><span id="local-6989586621679312408"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
</span><a href="#local-6989586621679312408"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3636"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679312407"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312407"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312411"><span class="hs-identifier hs-var">begin</span></a></span><span>
</span><span id="line-3637"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312409"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312407"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3638"></span><span>
</span><span id="line-3639"></span><span>    </span><span class="annot"><a href="#local-6989586621679312408"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312406"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312406"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312405"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312405"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312404"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312404"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-3640"></span><span>        </span><span id="local-6989586621679312403"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312403"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312410"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312406"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312405"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3641"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312403"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3642"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312402"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312402"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312401"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312401"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3643"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621679312400"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312400"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312412"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312404"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312402"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3644"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312400"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312401"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312400"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3645"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312399"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312399"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312399"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312404"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3646"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3647"></span><span>
</span><span id="line-3648"></span><span class="hs-pragma">{-# INLINE_NORMAL postscanl' #-}</span><span>
</span><span id="line-3649"></span><span id="local-6989586621679312396"><span id="local-6989586621679312397"><span id="local-6989586621679312398"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanl%27"><span class="hs-identifier hs-type">postscanl'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312398"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312397"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312396"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312397"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312397"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312398"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312396"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312398"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312397"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3650"></span><span id="postscanl%27"><span class="annot"><span class="annottext">postscanl' :: (a -&gt; b -&gt; a) -&gt; a -&gt; Stream m b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanl%27"><span class="hs-identifier hs-var hs-var">postscanl'</span></a></span></span><span> </span><span id="local-6989586621679312395"><span class="annot"><span class="annottext">a -&gt; b -&gt; a
</span><a href="#local-6989586621679312395"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679312394"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312394"><span class="hs-identifier hs-var">seed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; b -&gt; m a) -&gt; m a -&gt; Stream m b -&gt; Stream m a
forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlM%27"><span class="hs-identifier hs-var">postscanlM'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312393"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312393"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312392"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312392"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b -&gt; a
</span><a href="#local-6989586621679312395"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312393"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312392"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312394"><span class="hs-identifier hs-var">seed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3651"></span><span>
</span><span id="line-3652"></span><span class="hs-comment">-- We can possibly have the &quot;done&quot; function as a Maybe to provide an option to</span><span>
</span><span id="line-3653"></span><span class="hs-comment">-- emit or not emit the accumulator when the stream stops.</span><span>
</span><span id="line-3654"></span><span class="hs-comment">--</span><span>
</span><span id="line-3655"></span><span class="hs-comment">-- TBD: use a single Yield point</span><span>
</span><span id="line-3656"></span><span class="hs-comment">--</span><span>
</span><span id="line-3657"></span><span class="hs-pragma">{-# INLINE_NORMAL postscanlMAfter' #-}</span><span>
</span><span id="line-3658"></span><span id="local-6989586621679315280"><span id="local-6989586621679315281"><span id="local-6989586621679315282"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlMAfter%27"><span class="hs-identifier hs-type">postscanlMAfter'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315282"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3659"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315281"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315280"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315281"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315281"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315281"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315281"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315280"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315281"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3660"></span><span id="postscanlMAfter%27"><span class="annot"><span class="annottext">postscanlMAfter' :: (b -&gt; a -&gt; m b) -&gt; m b -&gt; (b -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlMAfter%27"><span class="hs-identifier hs-var hs-var">postscanlMAfter'</span></a></span></span><span> </span><span id="local-6989586621679312391"><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312391"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312390"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312390"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679312389"><span class="annot"><span class="annottext">b -&gt; m b
</span><a href="#local-6989586621679312389"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312388"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312388"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312387"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312387"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3661"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe (s, m b) -&gt; m (Step (Maybe (s, m b)) b))
-&gt; Maybe (s, m b) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; Maybe (s, m b) -&gt; m (Step (Maybe (s, m b)) b)
forall (m :: * -&gt; *) a.
State Stream m a -&gt; Maybe (s, m b) -&gt; m (Step (Maybe (s, m b)) b)
</span><a href="#local-6989586621679312386"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, m b) -&gt; Maybe (s, m b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312387"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312390"><span class="hs-identifier hs-var">initial</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3662"></span><span>
</span><span id="line-3663"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3664"></span><span>
</span><span id="line-3665"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-3666"></span><span>    </span><span id="local-6989586621679312386"><span class="annot"><span class="annottext">step :: State Stream m a -&gt; Maybe (s, m b) -&gt; m (Step (Maybe (s, m b)) b)
</span><a href="#local-6989586621679312386"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312385"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312385"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312384"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312384"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312383"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312383"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3667"></span><span>        </span><span id="local-6989586621679312382"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312382"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312388"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312385"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312384"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3668"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312382"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3669"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312381"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312381"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312380"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312380"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3670"></span><span>                </span><span id="local-6989586621679312379"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312379"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312383"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-3671"></span><span>                </span><span id="local-6989586621679312378"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312378"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312391"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312379"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312381"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3672"></span><span>                </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312378"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m (Step (Maybe (s, m b)) b) -&gt; m (Step (Maybe (s, m b)) b)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, m b)) b -&gt; m (Step (Maybe (s, m b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Maybe (s, m b) -&gt; Step (Maybe (s, m b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312378"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, m b) -&gt; Maybe (s, m b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312380"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312378"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3673"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312377"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312377"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, m b)) b -&gt; m (Step (Maybe (s, m b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, m b)) b -&gt; m (Step (Maybe (s, m b)) b))
-&gt; Step (Maybe (s, m b)) b -&gt; m (Step (Maybe (s, m b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, m b) -&gt; Step (Maybe (s, m b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (s, m b) -&gt; Step (Maybe (s, m b)) b)
-&gt; Maybe (s, m b) -&gt; Step (Maybe (s, m b)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, m b) -&gt; Maybe (s, m b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312377"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312383"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3674"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312383"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; (b -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
</span><a href="#local-6989586621679312389"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">m b
-&gt; (b -&gt; m (Step (Maybe (s, m b)) b))
-&gt; m (Step (Maybe (s, m b)) b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679312376"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312376"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, m b)) b -&gt; m (Step (Maybe (s, m b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Maybe (s, m b) -&gt; Step (Maybe (s, m b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312376"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (s, m b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-3675"></span><span>    </span><span class="annot"><a href="#local-6989586621679312386"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, m b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, m b)) b -&gt; m (Step (Maybe (s, m b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, m b)) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3676"></span><span>
</span><span id="line-3677"></span><span class="hs-pragma">{-# INLINE_NORMAL postscanlM #-}</span><span>
</span><span id="line-3678"></span><span id="local-6989586621679312373"><span id="local-6989586621679312374"><span id="local-6989586621679312375"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlM"><span class="hs-identifier hs-type">postscanlM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312375"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312374"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312373"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312375"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312374"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312375"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312374"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312375"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312373"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312375"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312374"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3679"></span><span id="postscanlM"><span class="annot"><span class="annottext">postscanlM :: (b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlM"><span class="hs-identifier hs-var hs-var">postscanlM</span></a></span></span><span> </span><span id="local-6989586621679312372"><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312372"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312371"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312371"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312370"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312370"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312369"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312369"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b))
-&gt; Maybe (s, b) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a.
State Stream m a -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
</span><a href="#local-6989586621679312368"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3680"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3681"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3682"></span><span>    </span><span id="local-6989586621679312368"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
</span><a href="#local-6989586621679312368"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3683"></span><span>        </span><span id="local-6989586621679312367"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312367"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312371"><span class="hs-identifier hs-var">begin</span></a></span><span>
</span><span id="line-3684"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312369"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312367"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3685"></span><span>
</span><span id="line-3686"></span><span>    </span><span class="annot"><a href="#local-6989586621679312368"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312366"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312366"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312365"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312365"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312364"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312364"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3687"></span><span>        </span><span id="local-6989586621679312363"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312363"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312370"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312366"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312365"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3688"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312363"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3689"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312362"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312362"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312361"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312361"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3690"></span><span>                </span><span id="local-6989586621679312360"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312360"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312372"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312364"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312362"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3691"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312360"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312361"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312360"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3692"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312359"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312359"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312359"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312364"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3693"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3694"></span><span>
</span><span id="line-3695"></span><span class="hs-pragma">{-# INLINE_NORMAL postscanl #-}</span><span>
</span><span id="line-3696"></span><span id="local-6989586621679312356"><span id="local-6989586621679312357"><span id="local-6989586621679312358"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanl"><span class="hs-identifier hs-type">postscanl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312358"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312357"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312356"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312357"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312357"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312358"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312356"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312358"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312357"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3697"></span><span id="postscanl"><span class="annot"><span class="annottext">postscanl :: (a -&gt; b -&gt; a) -&gt; a -&gt; Stream m b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanl"><span class="hs-identifier hs-var hs-var">postscanl</span></a></span></span><span> </span><span id="local-6989586621679312355"><span class="annot"><span class="annottext">a -&gt; b -&gt; a
</span><a href="#local-6989586621679312355"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679312354"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312354"><span class="hs-identifier hs-var">seed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; b -&gt; m a) -&gt; m a -&gt; Stream m b -&gt; Stream m a
forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlM"><span class="hs-identifier hs-var">postscanlM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312353"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312353"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312352"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312352"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b -&gt; a
</span><a href="#local-6989586621679312355"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312353"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312352"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312354"><span class="hs-identifier hs-var">seed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3698"></span><span>
</span><span id="line-3699"></span><span class="hs-pragma">{-# INLINE_NORMAL scanlM' #-}</span><span>
</span><span id="line-3700"></span><span id="local-6989586621679312349"><span id="local-6989586621679312350"><span id="local-6989586621679312351"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlM%27"><span class="hs-identifier hs-type">scanlM'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312351"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312350"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312349"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312351"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312350"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312351"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312350"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312351"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312349"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312351"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312350"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3701"></span><span id="scanlM%27"><span class="annot"><span class="annottext">scanlM' :: (b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlM%27"><span class="hs-identifier hs-var hs-var">scanlM'</span></a></span></span><span> </span><span id="local-6989586621679312348"><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312348"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312347"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312347"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312346"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312346"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312345"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312345"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b))
-&gt; Maybe (s, b) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a.
State Stream m a -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
</span><a href="#local-6989586621679312344"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3702"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3703"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3704"></span><span>    </span><span id="local-6989586621679312344"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
</span><a href="#local-6989586621679312344"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3705"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679312343"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312343"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312347"><span class="hs-identifier hs-var">begin</span></a></span><span>
</span><span id="line-3706"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312343"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312345"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312343"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3707"></span><span>    </span><span class="annot"><a href="#local-6989586621679312344"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312342"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312342"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312341"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312341"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312340"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312340"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-3708"></span><span>        </span><span id="local-6989586621679312339"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312339"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312346"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312342"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312341"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3709"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312339"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3710"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312338"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312338"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312337"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312337"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3711"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621679312336"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312336"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312348"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312340"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312338"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3712"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312336"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312337"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312336"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3713"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312335"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312335"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312335"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312340"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3714"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3715"></span><span>
</span><span id="line-3716"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlMAfter%27"><span class="hs-pragma hs-type">scanlMAfter'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3717"></span><span id="local-6989586621679312332"><span id="local-6989586621679312333"><span id="local-6989586621679312334"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlMAfter%27"><span class="hs-identifier hs-type">scanlMAfter'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312334"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3718"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312333"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312332"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312334"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312333"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312334"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312333"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312333"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312334"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312333"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312334"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312332"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312334"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312333"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3719"></span><span id="scanlMAfter%27"><span class="annot"><span class="annottext">scanlMAfter' :: (b -&gt; a -&gt; m b) -&gt; m b -&gt; (b -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlMAfter%27"><span class="hs-identifier hs-var hs-var">scanlMAfter'</span></a></span></span><span> </span><span id="local-6989586621679312331"><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312331"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312330"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312330"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679312329"><span class="annot"><span class="annottext">b -&gt; m b
</span><a href="#local-6989586621679312329"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span id="local-6989586621679312328"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312328"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3720"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312330"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; (b -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679312327"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312327"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312327"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312327"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m b -&gt; Stream m b -&gt; Stream m b
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#consM"><span class="hs-operator hs-var">`consM`</span></a></span><span>
</span><span id="line-3721"></span><span>        </span><span class="annot"><span class="annottext">(b -&gt; a -&gt; m b) -&gt; m b -&gt; (b -&gt; m b) -&gt; Stream m a -&gt; Stream m b
forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; (b -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#postscanlMAfter%27"><span class="hs-identifier hs-var">postscanlMAfter'</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312331"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312330"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
</span><a href="#local-6989586621679312329"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679312328"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3722"></span><span>
</span><span id="line-3723"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl%27"><span class="hs-pragma hs-type">scanl'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3724"></span><span id="local-6989586621679312324"><span id="local-6989586621679312325"><span id="local-6989586621679312326"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl%27"><span class="hs-identifier hs-type">scanl'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312326"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312325"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312324"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312325"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312325"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312326"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312324"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312326"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312325"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3725"></span><span id="scanl%27"><span class="annot"><span class="annottext">scanl' :: (b -&gt; a -&gt; b) -&gt; b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl%27"><span class="hs-identifier hs-var hs-var">scanl'</span></a></span></span><span> </span><span id="local-6989586621679312323"><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679312323"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679312322"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312322"><span class="hs-identifier hs-var">seed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlM%27"><span class="hs-identifier hs-var">scanlM'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312321"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312321"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312320"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312320"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679312323"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312321"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312320"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312322"><span class="hs-identifier hs-var">seed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3726"></span><span>
</span><span id="line-3727"></span><span class="hs-pragma">{-# INLINE_NORMAL scanlM #-}</span><span>
</span><span id="line-3728"></span><span id="local-6989586621679312317"><span id="local-6989586621679312318"><span id="local-6989586621679312319"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlM"><span class="hs-identifier hs-type">scanlM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312318"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312317"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312318"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312318"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312317"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312318"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3729"></span><span id="scanlM"><span class="annot"><span class="annottext">scanlM :: (b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlM"><span class="hs-identifier hs-var hs-var">scanlM</span></a></span></span><span> </span><span id="local-6989586621679312316"><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312316"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312315"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312315"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312314"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312314"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312313"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312313"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b))
-&gt; Maybe (s, b) -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a.
State Stream m a -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
</span><a href="#local-6989586621679312312"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3730"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3731"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3732"></span><span>    </span><span id="local-6989586621679312312"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; Maybe (s, b) -&gt; m (Step (Maybe (s, b)) b)
</span><a href="#local-6989586621679312312"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3733"></span><span>        </span><span id="local-6989586621679312311"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312311"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679312315"><span class="hs-identifier hs-var">begin</span></a></span><span>
</span><span id="line-3734"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312311"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312313"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312311"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3735"></span><span>    </span><span class="annot"><a href="#local-6989586621679312312"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312310"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312310"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312309"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312309"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312308"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312308"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3736"></span><span>        </span><span id="local-6989586621679312307"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312307"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312314"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312310"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312309"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3737"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312307"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3738"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312306"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312306"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312305"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312305"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3739"></span><span>                </span><span id="local-6989586621679312304"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312304"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; a -&gt; m b
</span><a href="#local-6989586621679312316"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312308"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312306"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3740"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312304"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312305"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312304"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3741"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312303"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312303"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, b) -&gt; Step (Maybe (s, b)) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, b) -&gt; Maybe (s, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312303"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312308"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3742"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b))
-&gt; Step (Maybe (s, b)) b -&gt; m (Step (Maybe (s, b)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, b)) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3743"></span><span>
</span><span id="line-3744"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl"><span class="hs-pragma hs-type">scanl</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3745"></span><span id="local-6989586621679312300"><span id="local-6989586621679312301"><span id="local-6989586621679312302"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl"><span class="hs-identifier hs-type">scanl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312302"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312301"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312300"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312301"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312301"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312302"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312300"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312302"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312301"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3746"></span><span id="scanl"><span class="annot"><span class="annottext">scanl :: (b -&gt; a -&gt; b) -&gt; b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl"><span class="hs-identifier hs-var hs-var">scanl</span></a></span></span><span> </span><span id="local-6989586621679312299"><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679312299"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679312298"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312298"><span class="hs-identifier hs-var">seed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanlM"><span class="hs-identifier hs-var">scanlM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312297"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312297"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679312296"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312296"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679312299"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312297"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312296"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312298"><span class="hs-identifier hs-var">seed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3747"></span><span>
</span><span id="line-3748"></span><span class="hs-pragma">{-# INLINE_NORMAL scanl1M #-}</span><span>
</span><span id="line-3749"></span><span id="local-6989586621679315261"><span id="local-6989586621679315262"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1M"><span class="hs-identifier hs-type">scanl1M</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315261"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315261"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315261"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315261"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315261"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-3750"></span><span id="scanl1M"><span class="annot"><span class="annottext">scanl1M :: (a -&gt; a -&gt; m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1M"><span class="hs-identifier hs-var hs-var">scanl1M</span></a></span></span><span> </span><span id="local-6989586621679312295"><span class="annot"><span class="annottext">a -&gt; a -&gt; m a
</span><a href="#local-6989586621679312295"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312294"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312294"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312293"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312293"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; (s, Maybe a) -&gt; m (Step (s, Maybe a) a))
-&gt; (s, Maybe a) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; (s, Maybe a) -&gt; m (Step (s, Maybe a) a)
</span><a href="#local-6989586621679312292"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312293"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-3751"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3752"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3753"></span><span>    </span><span id="local-6989586621679312292"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, Maybe a) -&gt; m (Step (s, Maybe a) a)
</span><a href="#local-6989586621679312292"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312291"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312291"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312290"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312290"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3754"></span><span>        </span><span id="local-6989586621679312289"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312289"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312294"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312291"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312290"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3755"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312289"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3756"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312288"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312288"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312287"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312287"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312288"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312287"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312288"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3757"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312286"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312286"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312286"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-3758"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3759"></span><span>
</span><span id="line-3760"></span><span>    </span><span class="annot"><a href="#local-6989586621679312292"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312285"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312285"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312284"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312284"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679312283"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312283"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3761"></span><span>        </span><span id="local-6989586621679312282"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312282"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312294"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312285"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312284"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3762"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312282"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3763"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312281"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312281"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679312280"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312280"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3764"></span><span>                </span><span id="local-6989586621679312279"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312279"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; m a
</span><a href="#local-6989586621679312295"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312283"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312281"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-3765"></span><span>                </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312279"><span class="hs-identifier hs-var">z</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312280"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312279"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3766"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312278"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312278"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312278"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312283"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3767"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3768"></span><span>
</span><span id="line-3769"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1"><span class="hs-pragma hs-type">scanl1</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3770"></span><span id="local-6989586621679312276"><span id="local-6989586621679312277"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1"><span class="hs-identifier hs-type">scanl1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312277"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312276"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312276"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312276"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312277"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312276"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312277"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312276"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-3771"></span><span id="scanl1"><span class="annot"><span class="annottext">scanl1 :: (a -&gt; a -&gt; a) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1"><span class="hs-identifier hs-var hs-var">scanl1</span></a></span></span><span> </span><span id="local-6989586621679312275"><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="#local-6989586621679312275"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; a -&gt; m a) -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; a -&gt; m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1M"><span class="hs-identifier hs-var">scanl1M</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312274"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312274"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312273"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312273"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="#local-6989586621679312275"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312274"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312273"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3772"></span><span>
</span><span id="line-3773"></span><span class="hs-pragma">{-# INLINE_NORMAL scanl1M' #-}</span><span>
</span><span id="line-3774"></span><span id="local-6989586621679312271"><span id="local-6989586621679312272"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1M%27"><span class="hs-identifier hs-type">scanl1M'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312272"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312271"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312271"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312272"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312271"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312272"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312271"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312272"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312271"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-3775"></span><span id="scanl1M%27"><span class="annot"><span class="annottext">scanl1M' :: (a -&gt; a -&gt; m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1M%27"><span class="hs-identifier hs-var hs-var">scanl1M'</span></a></span></span><span> </span><span id="local-6989586621679312270"><span class="annot"><span class="annottext">a -&gt; a -&gt; m a
</span><a href="#local-6989586621679312270"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312269"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312269"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312268"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312268"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; (s, Maybe a) -&gt; m (Step (s, Maybe a) a))
-&gt; (s, Maybe a) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; (s, Maybe a) -&gt; m (Step (s, Maybe a) a)
</span><a href="#local-6989586621679312267"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312268"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-3776"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3777"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3778"></span><span>    </span><span id="local-6989586621679312267"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, Maybe a) -&gt; m (Step (s, Maybe a) a)
</span><a href="#local-6989586621679312267"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312266"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312266"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312265"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312265"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3779"></span><span>        </span><span id="local-6989586621679312264"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312264"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312269"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312266"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312265"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3780"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312264"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3781"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312263"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312263"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312262"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312262"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312263"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m (Step (s, Maybe a) a) -&gt; m (Step (s, Maybe a) a)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312263"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312262"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312263"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3782"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312261"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312261"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312261"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-3783"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3784"></span><span>
</span><span id="line-3785"></span><span>    </span><span class="annot"><a href="#local-6989586621679312267"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312260"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312260"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312259"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312259"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679312258"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312258"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312258"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m (Step (s, Maybe a) a) -&gt; m (Step (s, Maybe a) a)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3786"></span><span>        </span><span id="local-6989586621679312257"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312257"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312269"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312260"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312259"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3787"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312257"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3788"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312256"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312256"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679312255"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312255"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3789"></span><span>                </span><span id="local-6989586621679312254"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312254"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; m a
</span><a href="#local-6989586621679312270"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312258"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312256"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-3790"></span><span>                </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312254"><span class="hs-identifier hs-var">z</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m (Step (s, Maybe a) a) -&gt; m (Step (s, Maybe a) a)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312254"><span class="hs-identifier hs-var">z</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312255"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312254"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3791"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312253"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312253"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312253"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312258"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3792"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3793"></span><span>
</span><span id="line-3794"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1%27"><span class="hs-pragma hs-type">scanl1'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3795"></span><span id="local-6989586621679312251"><span id="local-6989586621679312252"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1%27"><span class="hs-identifier hs-type">scanl1'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312252"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312251"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312251"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312251"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312252"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312251"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312252"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312251"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-3796"></span><span id="scanl1%27"><span class="annot"><span class="annottext">scanl1' :: (a -&gt; a -&gt; a) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1%27"><span class="hs-identifier hs-var hs-var">scanl1'</span></a></span></span><span> </span><span id="local-6989586621679312250"><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="#local-6989586621679312250"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; a -&gt; m a) -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; a -&gt; m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#scanl1M%27"><span class="hs-identifier hs-var">scanl1M'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312249"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312249"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312248"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312248"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="#local-6989586621679312250"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312249"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312248"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3797"></span><span>
</span><span id="line-3798"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3799"></span><span class="hs-comment">-- Stateful map/scan</span><span>
</span><span id="line-3800"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3801"></span><span>
</span><span id="line-3802"></span><span class="hs-keyword">data</span><span> </span><span id="RollingMapState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapState"><span class="hs-identifier hs-var">RollingMapState</span></a></span></span><span> </span><span id="local-6989586621679315248"><span class="annot"><a href="#local-6989586621679315248"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679315247"><span class="annot"><a href="#local-6989586621679315247"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RollingMapInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapInit"><span class="hs-identifier hs-var">RollingMapInit</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315248"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="RollingMapGo"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapGo"><span class="hs-identifier hs-var">RollingMapGo</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315248"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315247"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3803"></span><span>
</span><span id="line-3804"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#rollingMapM"><span class="hs-pragma hs-type">rollingMapM</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3805"></span><span id="local-6989586621679315241"><span id="local-6989586621679315242"><span id="local-6989586621679315243"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#rollingMapM"><span class="hs-identifier hs-type">rollingMapM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315243"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315242"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315242"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315243"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315241"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315243"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315242"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315243"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315241"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3806"></span><span id="rollingMapM"><span class="annot"><span class="annottext">rollingMapM :: (a -&gt; a -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#rollingMapM"><span class="hs-identifier hs-var hs-var">rollingMapM</span></a></span></span><span> </span><span id="local-6989586621679312245"><span class="annot"><span class="annottext">a -&gt; a -&gt; m b
</span><a href="#local-6989586621679312245"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312244"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312244"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679312243"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312243"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m b
 -&gt; RollingMapState s a -&gt; m (Step (RollingMapState s a) b))
-&gt; RollingMapState s a -&gt; Stream m b
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
-&gt; RollingMapState s a -&gt; m (Step (RollingMapState s a) b)
forall (m :: * -&gt; *) a.
State Stream m a
-&gt; RollingMapState s a -&gt; m (Step (RollingMapState s a) b)
</span><a href="#local-6989586621679312242"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; RollingMapState s a
forall s a. s -&gt; RollingMapState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapInit"><span class="hs-identifier hs-var">RollingMapInit</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312243"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3807"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3808"></span><span>    </span><span id="local-6989586621679312242"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; RollingMapState s a -&gt; m (Step (RollingMapState s a) b)
</span><a href="#local-6989586621679312242"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312241"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312241"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapInit"><span class="hs-identifier hs-type">RollingMapInit</span></a></span><span> </span><span id="local-6989586621679312240"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312240"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3809"></span><span>        </span><span id="local-6989586621679312239"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312239"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312244"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312241"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312240"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3810"></span><span>        </span><span class="annot"><span class="annottext">Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b))
-&gt; Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312239"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3811"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312238"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312238"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312237"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312237"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RollingMapState s a -&gt; Step (RollingMapState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(RollingMapState s a -&gt; Step (RollingMapState s a) b)
-&gt; RollingMapState s a -&gt; Step (RollingMapState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; RollingMapState s a
forall s a. s -&gt; a -&gt; RollingMapState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapGo"><span class="hs-identifier hs-var">RollingMapGo</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312237"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312238"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3812"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312236"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312236"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RollingMapState s a -&gt; Step (RollingMapState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(RollingMapState s a -&gt; Step (RollingMapState s a) b)
-&gt; RollingMapState s a -&gt; Step (RollingMapState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; RollingMapState s a
forall s a. s -&gt; RollingMapState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapInit"><span class="hs-identifier hs-var">RollingMapInit</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312236"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3813"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (RollingMapState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3814"></span><span>
</span><span id="line-3815"></span><span>    </span><span class="annot"><a href="#local-6989586621679312242"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679312235"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312235"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapGo"><span class="hs-identifier hs-type">RollingMapGo</span></a></span><span> </span><span id="local-6989586621679312234"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312234"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621679312233"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312233"><span class="hs-identifier hs-var">x1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3816"></span><span>        </span><span id="local-6989586621679312232"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312232"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312244"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312235"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312234"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-3817"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312232"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3818"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312231"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312231"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312230"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312230"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3819"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621679312229"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312229"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; m b
</span><a href="#local-6989586621679312245"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312231"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312233"><span class="hs-identifier hs-var">x1</span></a></span><span>
</span><span id="line-3820"></span><span>                </span><span class="annot"><span class="annottext">Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b))
-&gt; Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; RollingMapState s a -&gt; Step (RollingMapState s a) b
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679312229"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">(RollingMapState s a -&gt; Step (RollingMapState s a) b)
-&gt; RollingMapState s a -&gt; Step (RollingMapState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; RollingMapState s a
forall s a. s -&gt; a -&gt; RollingMapState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapGo"><span class="hs-identifier hs-var">RollingMapGo</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312230"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312231"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3821"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312228"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312228"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b))
-&gt; Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RollingMapState s a -&gt; Step (RollingMapState s a) b
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(RollingMapState s a -&gt; Step (RollingMapState s a) b)
-&gt; RollingMapState s a -&gt; Step (RollingMapState s a) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; RollingMapState s a
forall s a. s -&gt; a -&gt; RollingMapState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#RollingMapGo"><span class="hs-identifier hs-var">RollingMapGo</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312228"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312233"><span class="hs-identifier hs-var">x1</span></a></span><span>
</span><span id="line-3822"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b))
-&gt; Step (RollingMapState s a) b -&gt; m (Step (RollingMapState s a) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (RollingMapState s a) b
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3823"></span><span>
</span><span id="line-3824"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#rollingMap"><span class="hs-pragma hs-type">rollingMap</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3825"></span><span id="local-6989586621679312225"><span id="local-6989586621679312226"><span id="local-6989586621679312227"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#rollingMap"><span class="hs-identifier hs-type">rollingMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312227"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312226"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312226"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312225"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312227"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312226"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312227"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312225"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-3826"></span><span id="rollingMap"><span class="annot"><span class="annottext">rollingMap :: (a -&gt; a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#rollingMap"><span class="hs-identifier hs-var hs-var">rollingMap</span></a></span></span><span> </span><span id="local-6989586621679312224"><span class="annot"><span class="annottext">a -&gt; a -&gt; b
</span><a href="#local-6989586621679312224"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; a -&gt; m b) -&gt; Stream m a -&gt; Stream m b
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; a -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#rollingMapM"><span class="hs-identifier hs-var">rollingMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679312223"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312223"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312222"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312222"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(b -&gt; m b) -&gt; b -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; b
</span><a href="#local-6989586621679312224"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312223"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312222"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3827"></span><span>
</span><span id="line-3828"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3829"></span><span class="hs-comment">-- Tapping/Distributing</span><span>
</span><span id="line-3830"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-3831"></span><span>
</span><span id="line-3832"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tap"><span class="hs-pragma hs-type">tap</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3833"></span><span id="local-6989586621679312219"><span id="local-6989586621679312220"><span id="local-6989586621679312221"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tap"><span class="hs-identifier hs-type">tap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312221"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312221"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312220"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312219"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312221"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312220"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312221"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312220"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3834"></span><span id="tap"><span class="annot"><span class="annottext">tap :: Fold m a b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#tap"><span class="hs-identifier hs-var hs-var">tap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679312218"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679312218"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312217"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679312217"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679312216"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679312216"><span class="hs-identifier hs-var">extract</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312215"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312215"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312214"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312214"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; Maybe (s, s) -&gt; m (Step (Maybe (s, s)) a))
-&gt; Maybe (s, s) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Maybe (s, s) -&gt; m (Step (Maybe (s, s)) a)
</span><a href="#local-6989586621679312213"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (s, s)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3835"></span><span>
</span><span id="line-3836"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3837"></span><span>
</span><span id="line-3838"></span><span>    </span><span id="local-6989586621679312213"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; Maybe (s, s) -&gt; m (Step (Maybe (s, s)) a)
</span><a href="#local-6989586621679312213"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, s)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3839"></span><span>        </span><span id="local-6989586621679312212"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312212"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679312217"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-3840"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a))
-&gt; Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, s) -&gt; Step (Maybe (s, s)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, s) -&gt; Maybe (s, s)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312212"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312214"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3841"></span><span>
</span><span id="line-3842"></span><span>    </span><span class="annot"><a href="#local-6989586621679312213"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312211"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312211"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312210"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312210"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312209"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312209"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312210"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step (Maybe (s, s)) a) -&gt; m (Step (Maybe (s, s)) a)
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3843"></span><span>        </span><span id="local-6989586621679312208"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312208"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312215"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312211"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312209"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3844"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312208"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3845"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312207"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312207"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312206"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312206"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3846"></span><span>                </span><span id="local-6989586621679312205"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312205"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679312218"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312210"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312207"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3847"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a))
-&gt; Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe (s, s) -&gt; Step (Maybe (s, s)) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312207"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, s) -&gt; Maybe (s, s)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312205"><span class="hs-identifier hs-var">acc'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312206"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3848"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312204"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312204"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a))
-&gt; Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, s) -&gt; Step (Maybe (s, s)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, s) -&gt; Maybe (s, s)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312210"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312204"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3849"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3850"></span><span>                </span><span class="annot"><span class="annottext">m b -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m b -&gt; m ()) -&gt; m b -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679312216"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312210"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-3851"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a))
-&gt; Step (Maybe (s, s)) a -&gt; m (Step (Maybe (s, s)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, s)) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3852"></span><span>
</span><span id="line-3853"></span><span class="hs-pragma">{-# INLINE_NORMAL tapOffsetEvery #-}</span><span>
</span><span id="line-3854"></span><span id="local-6989586621679312201"><span id="local-6989586621679312202"><span id="local-6989586621679312203"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tapOffsetEvery"><span class="hs-identifier hs-type">tapOffsetEvery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312203"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3855"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312203"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312202"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312201"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312203"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312202"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312203"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312202"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3856"></span><span id="tapOffsetEvery"><span class="annot"><span class="annottext">tapOffsetEvery :: Int -&gt; Int -&gt; Fold m a b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#tapOffsetEvery"><span class="hs-identifier hs-var hs-var">tapOffsetEvery</span></a></span></span><span> </span><span id="local-6989586621679312200"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312200"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621679312199"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312199"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679312198"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679312198"><span class="hs-identifier hs-var">fstep</span></a></span></span><span> </span><span id="local-6989586621679312197"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679312197"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679312196"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679312196"><span class="hs-identifier hs-var">extract</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312195"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312195"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312194"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312194"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3857"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; Maybe (s, s, Int) -&gt; m (Step (Maybe (s, s, Int)) a))
-&gt; Maybe (s, s, Int) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; Maybe (s, s, Int) -&gt; m (Step (Maybe (s, s, Int)) a)
</span><a href="#local-6989586621679312193"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (s, s, Int)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3858"></span><span>
</span><span id="line-3859"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3860"></span><span>
</span><span id="line-3861"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3862"></span><span>    </span><span id="local-6989586621679312193"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; Maybe (s, s, Int) -&gt; m (Step (Maybe (s, s, Int)) a)
</span><a href="#local-6989586621679312193"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, s, Int)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3863"></span><span>        </span><span id="local-6989586621679312192"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312192"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679312197"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-3864"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a))
-&gt; Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, s, Int) -&gt; Step (Maybe (s, s, Int)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, s, Int) -&gt; Maybe (s, s, Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312192"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312194"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312200"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312199"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3865"></span><span>
</span><span id="line-3866"></span><span>    </span><span class="annot"><a href="#local-6989586621679312193"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312190"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312190"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312189"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312189"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312188"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312188"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312187"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312187"><span class="hs-identifier hs-var">count</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312187"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3867"></span><span>        </span><span id="local-6989586621679312186"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312186"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312195"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312190"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312188"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3868"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312186"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3869"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312185"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312185"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312184"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312184"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3870"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621679312183"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312183"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679312198"><span class="hs-identifier hs-var">fstep</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312189"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312185"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3871"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a))
-&gt; Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe (s, s, Int) -&gt; Step (Maybe (s, s, Int)) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312185"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, s, Int) -&gt; Maybe (s, s, Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312183"><span class="hs-identifier hs-var">acc'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312184"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312199"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3872"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312182"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312182"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a))
-&gt; Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, s, Int) -&gt; Step (Maybe (s, s, Int)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, s, Int) -&gt; Maybe (s, s, Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312189"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312182"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312187"><span class="hs-identifier hs-var">count</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3873"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3874"></span><span>                </span><span class="annot"><span class="annottext">m b -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m b -&gt; m ()) -&gt; m b -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679312196"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312189"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-3875"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a))
-&gt; Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, s, Int)) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3876"></span><span>
</span><span id="line-3877"></span><span>    </span><span class="annot"><a href="#local-6989586621679312193"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312181"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312181"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312180"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312180"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312179"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312179"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312178"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312178"><span class="hs-identifier hs-var">count</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3878"></span><span>        </span><span id="local-6989586621679312177"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312177"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312195"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312181"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312179"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3879"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312177"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3880"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312176"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312176"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312175"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312175"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a))
-&gt; Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe (s, s, Int) -&gt; Step (Maybe (s, s, Int)) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312176"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, s, Int) -&gt; Maybe (s, s, Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312180"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312175"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312178"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3881"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312174"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312174"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a))
-&gt; Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (s, s, Int) -&gt; Step (Maybe (s, s, Int)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s, s, Int) -&gt; Maybe (s, s, Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312180"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312174"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312178"><span class="hs-identifier hs-var">count</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3882"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3883"></span><span>                </span><span class="annot"><span class="annottext">m b -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m b -&gt; m ()) -&gt; m b -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679312196"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312180"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-3884"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a))
-&gt; Step (Maybe (s, s, Int)) a -&gt; m (Step (Maybe (s, s, Int)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (s, s, Int)) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3885"></span><span>
</span><span id="line-3886"></span><span class="hs-pragma">{-# INLINE_NORMAL pollCounts #-}</span><span>
</span><span id="line-3887"></span><span id="local-6989586621679312171"><span id="local-6989586621679312172"><span id="local-6989586621679312173"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#pollCounts"><span class="hs-identifier hs-type">pollCounts</span></a></span><span>
</span><span id="line-3888"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312173"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-3889"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312172"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-3890"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312173"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312173"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-3891"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312173"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><a href="#local-6989586621679312171"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-3892"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312173"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312172"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3893"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312173"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312172"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3894"></span><span id="pollCounts"><span class="annot"><span class="annottext">pollCounts :: (a -&gt; Bool)
-&gt; (Stream m Int -&gt; Stream m Int)
-&gt; Fold m Int b
-&gt; Stream m a
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#pollCounts"><span class="hs-identifier hs-var hs-var">pollCounts</span></a></span></span><span> </span><span id="local-6989586621679312170"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679312170"><span class="hs-identifier hs-var">predicate</span></a></span></span><span> </span><span id="local-6989586621679312169"><span class="annot"><span class="annottext">Stream m Int -&gt; Stream m Int
</span><a href="#local-6989586621679312169"><span class="hs-identifier hs-var">transf</span></a></span></span><span> </span><span id="local-6989586621679312168"><span class="annot"><span class="annottext">Fold m Int b
</span><a href="#local-6989586621679312168"><span class="hs-identifier hs-var">fld</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312167"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312167"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312166"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312166"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; Maybe (IORef Int, ThreadId, s)
 -&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a))
-&gt; Maybe (IORef Int, ThreadId, s) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; Maybe (IORef Int, ThreadId, s)
-&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a)
</span><a href="#local-6989586621679312165"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int, ThreadId, s)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3895"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3896"></span><span>
</span><span id="line-3897"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3898"></span><span>    </span><span id="local-6989586621679312165"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; Maybe (IORef Int, ThreadId, s)
-&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a)
</span><a href="#local-6989586621679312165"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int, ThreadId, s)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3899"></span><span>        </span><span class="hs-comment">-- As long as we are using an &quot;Int&quot; for counts lockfree reads from</span><span>
</span><span id="line-3900"></span><span>        </span><span class="hs-comment">-- Var should work correctly on both 32-bit and 64-bit machines.</span><span>
</span><span id="line-3901"></span><span>        </span><span class="hs-comment">-- However, an Int on a 32-bit machine may overflow quickly.</span><span>
</span><span id="line-3902"></span><span>        </span><span id="local-6989586621679312164"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312164"><span class="hs-identifier hs-var">countVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef Int) -&gt; m (IORef Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef Int) -&gt; m (IORef Int))
-&gt; IO (IORef Int) -&gt; m (IORef Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (IORef Int)
forall a. Prim a =&gt; a -&gt; IO (IORef a)
</span><a href="Streamly.Internal.Data.IORef.Prim.html#newIORef"><span class="hs-identifier hs-var">Prim.newIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-3903"></span><span>        </span><span id="local-6989586621679312162"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312162"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ThreadId
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m) =&gt;
m () -&gt; m ThreadId
</span><a href="Streamly.Internal.Data.SVar.html#forkManaged"><span class="hs-identifier hs-var">forkManaged</span></a></span><span>
</span><span id="line-3904"></span><span>            </span><span class="annot"><span class="annottext">(m () -&gt; m ThreadId) -&gt; m () -&gt; m ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m b -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m b -&gt; m ()) -&gt; m b -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fold m Int b -&gt; Stream m Int -&gt; m b
forall (m :: * -&gt; *) a b.
Monad m =&gt;
Fold m a b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runFold"><span class="hs-identifier hs-var">runFold</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m Int b
</span><a href="#local-6989586621679312168"><span class="hs-identifier hs-var">fld</span></a></span><span>
</span><span id="line-3905"></span><span>            </span><span class="annot"><span class="annottext">(Stream m Int -&gt; m b) -&gt; Stream m Int -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m Int -&gt; Stream m Int
</span><a href="#local-6989586621679312169"><span class="hs-identifier hs-var">transf</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream m Int -&gt; Stream m Int) -&gt; Stream m Int -&gt; Stream m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; Stream m Int
forall (m :: * -&gt; *) a.
(MonadIO m, Prim a) =&gt;
IORef a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromPrimIORef"><span class="hs-identifier hs-var">fromPrimIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312164"><span class="hs-identifier hs-var">countVar</span></a></span><span>
</span><span id="line-3906"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s)) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (IORef Int, ThreadId, s)) a
 -&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a))
-&gt; Step (Maybe (IORef Int, ThreadId, s)) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int, ThreadId, s)
-&gt; Step (Maybe (IORef Int, ThreadId, s)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IORef Int, ThreadId, s) -&gt; Maybe (IORef Int, ThreadId, s)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312164"><span class="hs-identifier hs-var">countVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312162"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312166"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3907"></span><span>
</span><span id="line-3908"></span><span>    </span><span class="annot"><a href="#local-6989586621679312165"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312160"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312160"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312159"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312159"><span class="hs-identifier hs-var">countVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312158"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312158"><span class="hs-identifier hs-var">tid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312157"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312157"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3909"></span><span>        </span><span id="local-6989586621679312156"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312156"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312167"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312160"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312157"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3910"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312156"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3911"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312155"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312155"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312154"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312154"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3912"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679312170"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312155"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; (Int -&gt; Int) -&gt; IO ()
forall a. Prim a =&gt; IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><a href="Streamly.Internal.Data.IORef.Prim.html#modifyIORef%27"><span class="hs-identifier hs-var">Prim.modifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312159"><span class="hs-identifier hs-var">countVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-3913"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s)) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (IORef Int, ThreadId, s)) a
 -&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a))
-&gt; Step (Maybe (IORef Int, ThreadId, s)) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
-&gt; Maybe (IORef Int, ThreadId, s)
-&gt; Step (Maybe (IORef Int, ThreadId, s)) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312155"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IORef Int, ThreadId, s) -&gt; Maybe (IORef Int, ThreadId, s)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312159"><span class="hs-identifier hs-var">countVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312158"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312154"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3914"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312152"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312152"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s)) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (IORef Int, ThreadId, s)) a
 -&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a))
-&gt; Step (Maybe (IORef Int, ThreadId, s)) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int, ThreadId, s)
-&gt; Step (Maybe (IORef Int, ThreadId, s)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IORef Int, ThreadId, s) -&gt; Maybe (IORef Int, ThreadId, s)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312159"><span class="hs-identifier hs-var">countVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312158"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312152"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3915"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3916"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; IO ()
</span><span class="hs-identifier hs-var">killThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312158"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-3917"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s)) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s)) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3918"></span><span>
</span><span id="line-3919"></span><span class="hs-pragma">{-# INLINE_NORMAL tapRate #-}</span><span>
</span><span id="line-3920"></span><span id="local-6989586621679312149"><span id="local-6989586621679312150"><span id="local-6989586621679312151"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tapRate"><span class="hs-identifier hs-type">tapRate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-3921"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312151"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679312151"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3922"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-3923"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312151"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312150"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3924"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312151"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312149"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3925"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312151"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312149"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-3926"></span><span id="tapRate"><span class="annot"><span class="annottext">tapRate :: Double -&gt; (Int -&gt; m b) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#tapRate"><span class="hs-identifier hs-var hs-var">tapRate</span></a></span></span><span> </span><span id="local-6989586621679312148"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679312148"><span class="hs-identifier hs-var">samplingRate</span></a></span></span><span> </span><span id="local-6989586621679312147"><span class="annot"><span class="annottext">Int -&gt; m b
</span><a href="#local-6989586621679312147"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312146"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312146"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312145"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312145"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; Maybe (IORef Int, ThreadId, s, IORef ())
 -&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a))
-&gt; Maybe (IORef Int, ThreadId, s, IORef ()) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; Maybe (IORef Int, ThreadId, s, IORef ())
-&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a)
</span><a href="#local-6989586621679312144"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int, ThreadId, s, IORef ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3927"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3928"></span><span>    </span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="#local-6989586621679312143"><span class="hs-pragma hs-type">loop</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3929"></span><span>    </span><span id="local-6989586621679312143"><span class="annot"><span class="annottext">loop :: IORef Int -&gt; Int -&gt; m b
</span><a href="#local-6989586621679312143"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679312142"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312142"><span class="hs-identifier hs-var">countVar</span></a></span></span><span> </span><span id="local-6989586621679312141"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312141"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3930"></span><span>        </span><span id="local-6989586621679312140"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312140"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-3931"></span><span>            </span><span class="annot"><span class="annottext">m Int -&gt; (AsyncException -&gt; m Int) -&gt; m Int
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">MC.catch</span></span><span>
</span><span id="line-3932"></span><span>                </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double -&gt; Int
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">round</span></span><span> </span><span class="annot"><span class="annottext">(Double -&gt; Int) -&gt; Double -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679312148"><span class="hs-identifier hs-var">samplingRate</span></a></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">1000000</span></span><span class="hs-special">)</span><span>
</span><span id="line-3933"></span><span>                    </span><span id="local-6989586621679312137"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312137"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int -&gt; m Int
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; m Int) -&gt; IO Int -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. Prim a =&gt; IORef a -&gt; IO a
</span><a href="Streamly.Internal.Data.IORef.Prim.html#readIORef"><span class="hs-identifier hs-var">Prim.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312142"><span class="hs-identifier hs-var">countVar</span></a></span><span>
</span><span id="line-3934"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679312136"><span class="annot"><span class="annottext">diff :: Int
</span><a href="#local-6989586621679312136"><span class="hs-identifier hs-var hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312137"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312141"><span class="hs-identifier hs-var">prev</span></a></span><span>
</span><span id="line-3935"></span><span>                    </span><span class="annot"><span class="annottext">m b -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m b -&gt; m ()) -&gt; m b -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m b
</span><a href="#local-6989586621679312147"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312136"><span class="hs-identifier hs-var">diff</span></a></span><span>
</span><span id="line-3936"></span><span>                    </span><span class="annot"><span class="annottext">Int -&gt; m Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312137"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3937"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679312135"><span class="annot"><span class="annottext">AsyncException
</span><a href="#local-6989586621679312135"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AsyncException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3938"></span><span>                     </span><span id="local-6989586621679312134"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312134"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int -&gt; m Int
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; m Int) -&gt; IO Int -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. Prim a =&gt; IORef a -&gt; IO a
</span><a href="Streamly.Internal.Data.IORef.Prim.html#readIORef"><span class="hs-identifier hs-var">Prim.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312142"><span class="hs-identifier hs-var">countVar</span></a></span><span>
</span><span id="line-3939"></span><span>                     </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679312133"><span class="annot"><span class="annottext">diff :: Int
</span><a href="#local-6989586621679312133"><span class="hs-identifier hs-var hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312134"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312141"><span class="hs-identifier hs-var">prev</span></a></span><span>
</span><span id="line-3940"></span><span>                     </span><span class="annot"><span class="annottext">m b -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m b -&gt; m ()) -&gt; m b -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m b
</span><a href="#local-6989586621679312147"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312133"><span class="hs-identifier hs-var">diff</span></a></span><span>
</span><span id="line-3941"></span><span>                     </span><span class="annot"><span class="annottext">SomeException -&gt; m Int
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AsyncException -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">MC.toException</span></span><span> </span><span class="annot"><span class="annottext">AsyncException
</span><a href="#local-6989586621679312135"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3942"></span><span>        </span><span class="annot"><span class="annottext">IORef Int -&gt; Int -&gt; m b
</span><a href="#local-6989586621679312143"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312142"><span class="hs-identifier hs-var">countVar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312140"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-3943"></span><span>
</span><span id="line-3944"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3945"></span><span>    </span><span id="local-6989586621679312144"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; Maybe (IORef Int, ThreadId, s, IORef ())
-&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a)
</span><a href="#local-6989586621679312144"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int, ThreadId, s, IORef ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3946"></span><span>        </span><span id="local-6989586621679312131"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312131"><span class="hs-identifier hs-var">countVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef Int) -&gt; m (IORef Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef Int) -&gt; m (IORef Int))
-&gt; IO (IORef Int) -&gt; m (IORef Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (IORef Int)
forall a. Prim a =&gt; a -&gt; IO (IORef a)
</span><a href="Streamly.Internal.Data.IORef.Prim.html#newIORef"><span class="hs-identifier hs-var">Prim.newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-3947"></span><span>        </span><span id="local-6989586621679312130"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312130"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ThreadId
forall (m :: * -&gt; *). MonadBaseControl IO m =&gt; m () -&gt; m ThreadId
</span><a href="Streamly.Internal.Data.SVar.html#fork"><span class="hs-identifier hs-var">fork</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ThreadId) -&gt; m () -&gt; m ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; Int -&gt; m ()
forall b. IORef Int -&gt; Int -&gt; m b
</span><a href="#local-6989586621679312143"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312131"><span class="hs-identifier hs-var">countVar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-3948"></span><span>        </span><span id="local-6989586621679312128"><span class="annot"><span class="annottext">IORef ()
</span><a href="#local-6989586621679312128"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef ()) -&gt; m (IORef ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef ()) -&gt; m (IORef ())) -&gt; IO (IORef ()) -&gt; m (IORef ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; IO (IORef ())
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-3949"></span><span>        </span><span class="annot"><span class="annottext">Weak (IORef ())
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Weak (IORef ())) -&gt; m (Weak (IORef ()))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Weak (IORef ())) -&gt; m (Weak (IORef ())))
-&gt; IO (Weak (IORef ())) -&gt; m (Weak (IORef ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef () -&gt; IO () -&gt; IO (Weak (IORef ()))
forall a. IORef a -&gt; IO () -&gt; IO (Weak (IORef a))
</span><span class="hs-identifier hs-var">mkWeakIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef ()
</span><a href="#local-6989586621679312128"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; IO ()
</span><span class="hs-identifier hs-var">killThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312130"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3950"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
 -&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a))
-&gt; Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int, ThreadId, s, IORef ())
-&gt; Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IORef Int, ThreadId, s, IORef ())
-&gt; Maybe (IORef Int, ThreadId, s, IORef ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312131"><span class="hs-identifier hs-var">countVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312130"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312145"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IORef ()
</span><a href="#local-6989586621679312128"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3951"></span><span>
</span><span id="line-3952"></span><span>    </span><span class="annot"><a href="#local-6989586621679312144"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312127"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312127"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312126"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312126"><span class="hs-identifier hs-var">countVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312125"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312125"><span class="hs-identifier hs-var">tid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312124"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312124"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312123"><span class="annot"><span class="annottext">IORef ()
</span><a href="#local-6989586621679312123"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3953"></span><span>        </span><span id="local-6989586621679312122"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312122"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312146"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312127"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312124"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3954"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312122"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3955"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312121"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312121"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312120"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312120"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3956"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; (Int -&gt; Int) -&gt; IO ()
forall a. Prim a =&gt; IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><a href="Streamly.Internal.Data.IORef.Prim.html#modifyIORef%27"><span class="hs-identifier hs-var">Prim.modifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312126"><span class="hs-identifier hs-var">countVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-3957"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
 -&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a))
-&gt; Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
-&gt; Maybe (IORef Int, ThreadId, s, IORef ())
-&gt; Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312121"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IORef Int, ThreadId, s, IORef ())
-&gt; Maybe (IORef Int, ThreadId, s, IORef ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312126"><span class="hs-identifier hs-var">countVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312125"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312120"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IORef ()
</span><a href="#local-6989586621679312123"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3958"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312119"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312119"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
 -&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a))
-&gt; Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int, ThreadId, s, IORef ())
-&gt; Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IORef Int, ThreadId, s, IORef ())
-&gt; Maybe (IORef Int, ThreadId, s, IORef ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679312126"><span class="hs-identifier hs-var">countVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312125"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312119"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IORef ()
</span><a href="#local-6989586621679312123"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3959"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3960"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; IO ()
</span><span class="hs-identifier hs-var">killThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679312125"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-3961"></span><span>                </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
-&gt; m (Step (Maybe (IORef Int, ThreadId, s, IORef ())) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int, ThreadId, s, IORef ())) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3962"></span><span>
</span><span id="line-3963"></span><span>
</span><span id="line-3964"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-3965"></span><span class="hs-comment">-- Filtering</span><span>
</span><span id="line-3966"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-3967"></span><span>
</span><span id="line-3968"></span><span class="hs-pragma">{-# INLINE_NORMAL takeWhileM #-}</span><span>
</span><span id="line-3969"></span><span id="local-6989586621679315199"><span id="local-6989586621679315200"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhileM"><span class="hs-identifier hs-type">takeWhileM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315200"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315199"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315200"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315200"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315199"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315200"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315199"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-3970"></span><span id="takeWhileM"><span class="annot"><span class="annottext">takeWhileM :: (a -&gt; m Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhileM"><span class="hs-identifier hs-var hs-var">takeWhileM</span></a></span></span><span> </span><span id="local-6989586621679312118"><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679312118"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312117"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312117"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312116"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312116"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312115"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312116"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-3971"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3972"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3973"></span><span>    </span><span id="local-6989586621679312115"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312115"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312114"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312114"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span id="local-6989586621679312113"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312113"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3974"></span><span>        </span><span id="local-6989586621679312112"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312112"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312117"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312114"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312113"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3975"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312112"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3976"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312111"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312111"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312110"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312110"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3977"></span><span>                </span><span id="local-6989586621679312109"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679312109"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679312118"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312111"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3978"></span><span>                </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679312109"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; Step s a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312111"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312110"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Step s a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3979"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312108"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312108"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Step s a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312108"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-3980"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step s a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3981"></span><span>
</span><span id="line-3982"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhile"><span class="hs-pragma hs-type">takeWhile</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3983"></span><span id="local-6989586621679316117"><span id="local-6989586621679316118"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhile"><span class="hs-identifier hs-type">takeWhile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679316118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679316117"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316117"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679316117"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-3984"></span><span id="takeWhile"><span class="annot"><span class="annottext">takeWhile :: (a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhile"><span class="hs-identifier hs-var hs-var">takeWhile</span></a></span></span><span> </span><span id="local-6989586621679312107"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679312107"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m Bool) -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; m Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#takeWhileM"><span class="hs-identifier hs-var">takeWhileM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; (a -&gt; Bool) -&gt; a -&gt; m Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679312107"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3985"></span><span>
</span><span id="line-3986"></span><span class="hs-pragma">{-# INLINE_NORMAL drop #-}</span><span>
</span><span id="line-3987"></span><span id="local-6989586621679312105"><span id="local-6989586621679312106"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#drop"><span class="hs-identifier hs-type">drop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312106"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312106"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312105"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312106"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312105"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-3988"></span><span id="drop"><span class="annot"><span class="annottext">drop :: Int -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#drop"><span class="hs-identifier hs-var hs-var">drop</span></a></span></span><span> </span><span id="local-6989586621679312104"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312104"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312103"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312103"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312102"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312102"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; (s, Maybe Int) -&gt; m (Step (s, Maybe Int) a))
-&gt; (s, Maybe Int) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; (s, Maybe Int) -&gt; m (Step (s, Maybe Int) a)
forall a.
(Ord a, Num a) =&gt;
State Stream m a -&gt; (s, Maybe a) -&gt; m (Step (s, Maybe a) a)
</span><a href="#local-6989586621679312101"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312102"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679312104"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3989"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3990"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-3991"></span><span>    </span><span id="local-6989586621679312101"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, Maybe a) -&gt; m (Step (s, Maybe a) a)
</span><a href="#local-6989586621679312101"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312100"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312100"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312099"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312099"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679312098"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312098"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3992"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312098"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3993"></span><span>          </span><span id="local-6989586621679312097"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312097"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312103"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312100"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312099"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-3994"></span><span>          </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3995"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312097"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3996"></span><span>              </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679312096"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312096"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312096"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312098"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3997"></span><span>              </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312095"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312095"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312095"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312098"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3998"></span><span>              </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-3999"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312099"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4000"></span><span>
</span><span id="line-4001"></span><span>    </span><span class="annot"><a href="#local-6989586621679312101"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312094"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312094"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679312093"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312093"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4002"></span><span>      </span><span id="local-6989586621679312092"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312092"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312103"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312094"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312093"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4003"></span><span>      </span><span class="annot"><span class="annottext">Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a))
-&gt; Step (s, Maybe a) a -&gt; m (Step (s, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-4004"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312092"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4005"></span><span>          </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312091"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312091"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312090"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312090"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312091"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312090"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4006"></span><span>          </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679312089"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312089"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, Maybe a) -&gt; Step (s, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312089"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4007"></span><span>          </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4008"></span><span>
</span><span id="line-4009"></span><span class="hs-keyword">data</span><span> </span><span id="DropWhileState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileState"><span class="hs-identifier hs-var">DropWhileState</span></a></span></span><span> </span><span id="local-6989586621679315189"><span class="annot"><a href="#local-6989586621679315189"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679315188"><span class="annot"><a href="#local-6989586621679315188"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-4010"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="DropWhileDrop"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileDrop"><span class="hs-identifier hs-var">DropWhileDrop</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315189"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4011"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DropWhileYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileYield"><span class="hs-identifier hs-var">DropWhileYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315188"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315189"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4012"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DropWhileNext"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileNext"><span class="hs-identifier hs-var">DropWhileNext</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315189"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4013"></span><span>
</span><span id="line-4014"></span><span class="hs-pragma">{-# INLINE_NORMAL dropWhileM #-}</span><span>
</span><span id="line-4015"></span><span id="local-6989586621679312084"><span id="local-6989586621679312085"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#dropWhileM"><span class="hs-identifier hs-type">dropWhileM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312085"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312084"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312085"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312085"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312084"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312085"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312084"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4016"></span><span id="dropWhileM"><span class="annot"><span class="annottext">dropWhileM :: (a -&gt; m Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#dropWhileM"><span class="hs-identifier hs-var hs-var">dropWhileM</span></a></span></span><span> </span><span id="local-6989586621679312083"><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679312083"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312082"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312082"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312081"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312081"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; DropWhileState s a -&gt; m (Step (DropWhileState s a) a))
-&gt; DropWhileState s a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; DropWhileState s a -&gt; m (Step (DropWhileState s a) a)
forall a.
State Stream m a
-&gt; DropWhileState s a -&gt; m (Step (DropWhileState s a) a)
</span><a href="#local-6989586621679312080"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; DropWhileState s a
forall s a. s -&gt; DropWhileState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileDrop"><span class="hs-identifier hs-var">DropWhileDrop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312081"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4017"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4018"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4019"></span><span>    </span><span id="local-6989586621679312080"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; DropWhileState s a -&gt; m (Step (DropWhileState s a) a)
</span><a href="#local-6989586621679312080"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312079"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312079"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileDrop"><span class="hs-identifier hs-type">DropWhileDrop</span></a></span><span> </span><span id="local-6989586621679312078"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312078"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4020"></span><span>        </span><span id="local-6989586621679312077"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312077"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312082"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312079"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312078"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4021"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312077"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4022"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312076"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312076"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312075"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312075"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4023"></span><span>                </span><span id="local-6989586621679312074"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679312074"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679312083"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312076"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-4024"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679312074"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-4025"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a))
-&gt; Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DropWhileState s a -&gt; Step (DropWhileState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; DropWhileState s a
forall s a. s -&gt; DropWhileState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileDrop"><span class="hs-identifier hs-var">DropWhileDrop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312075"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4026"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a))
-&gt; Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DropWhileState s a -&gt; Step (DropWhileState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; s -&gt; DropWhileState s a
forall s a. a -&gt; s -&gt; DropWhileState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileYield"><span class="hs-identifier hs-var">DropWhileYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312076"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312075"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4027"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312073"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312073"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a))
-&gt; Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DropWhileState s a -&gt; Step (DropWhileState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; DropWhileState s a
forall s a. s -&gt; DropWhileState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileDrop"><span class="hs-identifier hs-var">DropWhileDrop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312073"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4028"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4029"></span><span>
</span><span id="line-4030"></span><span>    </span><span class="annot"><a href="#local-6989586621679312080"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312072"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312072"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileNext"><span class="hs-identifier hs-type">DropWhileNext</span></a></span><span> </span><span id="local-6989586621679312071"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312071"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-4031"></span><span>        </span><span id="local-6989586621679312070"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312070"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312082"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312072"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312071"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4032"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312070"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4033"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312069"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312069"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312068"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312068"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a))
-&gt; Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DropWhileState s a -&gt; Step (DropWhileState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; s -&gt; DropWhileState s a
forall s a. a -&gt; s -&gt; DropWhileState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileYield"><span class="hs-identifier hs-var">DropWhileYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312069"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312068"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4034"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312067"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312067"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a))
-&gt; Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DropWhileState s a -&gt; Step (DropWhileState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; DropWhileState s a
forall s a. s -&gt; DropWhileState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileNext"><span class="hs-identifier hs-var">DropWhileNext</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312067"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4035"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4036"></span><span>
</span><span id="line-4037"></span><span>    </span><span class="annot"><a href="#local-6989586621679312080"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileYield"><span class="hs-identifier hs-type">DropWhileYield</span></a></span><span> </span><span id="local-6989586621679312066"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312066"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312065"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312065"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a))
-&gt; Step (DropWhileState s a) a -&gt; m (Step (DropWhileState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; DropWhileState s a -&gt; Step (DropWhileState s a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312066"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; DropWhileState s a
forall s a. s -&gt; DropWhileState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropWhileNext"><span class="hs-identifier hs-var">DropWhileNext</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312065"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4038"></span><span>
</span><span id="line-4039"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#dropWhile"><span class="hs-pragma hs-type">dropWhile</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4040"></span><span id="local-6989586621679312063"><span id="local-6989586621679312064"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#dropWhile"><span class="hs-identifier hs-type">dropWhile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312064"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312063"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312064"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312063"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312064"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312063"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4041"></span><span id="dropWhile"><span class="annot"><span class="annottext">dropWhile :: (a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#dropWhile"><span class="hs-identifier hs-var hs-var">dropWhile</span></a></span></span><span> </span><span id="local-6989586621679312062"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679312062"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m Bool) -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; m Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#dropWhileM"><span class="hs-identifier hs-var">dropWhileM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; (a -&gt; Bool) -&gt; a -&gt; m Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679312062"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4042"></span><span>
</span><span id="line-4043"></span><span class="hs-pragma">{-# INLINE_NORMAL filterM #-}</span><span>
</span><span id="line-4044"></span><span id="local-6989586621679312060"><span id="local-6989586621679312061"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#filterM"><span class="hs-identifier hs-type">filterM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312061"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312060"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312061"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312061"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312060"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312061"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312060"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4045"></span><span id="filterM"><span class="annot"><span class="annottext">filterM :: (a -&gt; m Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#filterM"><span class="hs-identifier hs-var hs-var">filterM</span></a></span></span><span> </span><span id="local-6989586621679312059"><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679312059"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312058"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312058"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312057"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312057"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312056"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312057"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-4046"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4047"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4048"></span><span>    </span><span id="local-6989586621679312056"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312056"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312055"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312055"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span id="local-6989586621679312054"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312054"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4049"></span><span>        </span><span id="local-6989586621679312053"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312053"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312058"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312055"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312054"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4050"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312053"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4051"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312052"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312052"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312051"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312051"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4052"></span><span>                </span><span id="local-6989586621679312050"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679312050"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679312059"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312052"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-4053"></span><span>                </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679312050"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-4054"></span><span>                         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; Step s a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312052"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312051"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4055"></span><span>                         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">s -&gt; Step s a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312051"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4056"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312049"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312049"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Step s a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312049"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4057"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step s a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4058"></span><span>
</span><span id="line-4059"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#filter"><span class="hs-pragma hs-type">filter</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4060"></span><span id="local-6989586621679312047"><span id="local-6989586621679312048"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#filter"><span class="hs-identifier hs-type">filter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312048"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312047"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312048"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312047"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312048"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312047"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4061"></span><span id="filter"><span class="annot"><span class="annottext">filter :: (a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#filter"><span class="hs-identifier hs-var hs-var">filter</span></a></span></span><span> </span><span id="local-6989586621679312046"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679312046"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m Bool) -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; m Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#filterM"><span class="hs-identifier hs-var">filterM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; (a -&gt; Bool) -&gt; a -&gt; m Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679312046"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4062"></span><span>
</span><span id="line-4063"></span><span class="hs-pragma">{-# INLINE_NORMAL uniq #-}</span><span>
</span><span id="line-4064"></span><span id="local-6989586621679312044"><span id="local-6989586621679312045"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#uniq"><span class="hs-identifier hs-type">uniq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679312045"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312044"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312044"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312045"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312044"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312045"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4065"></span><span id="uniq"><span class="annot"><span class="annottext">uniq :: Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#uniq"><span class="hs-identifier hs-var hs-var">uniq</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312043"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312043"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312042"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312042"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; (Maybe a, s) -&gt; m (Step (Maybe a, s) a))
-&gt; (Maybe a, s) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; (Maybe a, s) -&gt; m (Step (Maybe a, s) a)
</span><a href="#local-6989586621679312041"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312042"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4066"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4067"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4068"></span><span>    </span><span id="local-6989586621679312041"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (Maybe a, s) -&gt; m (Step (Maybe a, s) a)
</span><a href="#local-6989586621679312041"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312040"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312040"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312039"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312039"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4069"></span><span>        </span><span id="local-6989586621679312038"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312038"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312043"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312040"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312039"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4070"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312038"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4071"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312037"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312037"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312036"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312036"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a))
-&gt; Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe a, s) -&gt; Step (Maybe a, s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312037"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312037"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312036"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4072"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679312035"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312035"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a))
-&gt; Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Maybe a, s) -&gt; Step (Maybe a, s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312035"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4073"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe a, s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4074"></span><span>    </span><span class="annot"><a href="#local-6989586621679312041"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312034"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312034"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679312033"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312033"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679312032"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312032"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4075"></span><span>         </span><span id="local-6989586621679312031"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312031"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312043"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312034"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312032"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4076"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312031"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4077"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312030"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312030"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679312029"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312029"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312033"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312030"><span class="hs-identifier hs-var">y</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a))
-&gt; Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Maybe a, s) -&gt; Step (Maybe a, s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312033"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312029"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4078"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a))
-&gt; Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (Maybe a, s) -&gt; Step (Maybe a, s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312030"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312030"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312029"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4079"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>  </span><span id="local-6989586621679312028"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312028"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a))
-&gt; Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Maybe a, s) -&gt; Step (Maybe a, s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312033"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312028"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4080"></span><span>             </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe a, s) a -&gt; m (Step (Maybe a, s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe a, s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4081"></span><span>
</span><span id="line-4082"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4083"></span><span class="hs-comment">-- Transformation by Mapping</span><span>
</span><span id="line-4084"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4085"></span><span>
</span><span id="line-4086"></span><span class="hs-pragma">{-# INLINE_NORMAL sequence #-}</span><span>
</span><span id="line-4087"></span><span id="local-6989586621679312026"><span id="local-6989586621679312027"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#sequence"><span class="hs-identifier hs-type">sequence</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679312027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312026"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312026"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4088"></span><span id="sequence"><span class="annot"><span class="annottext">sequence :: Stream m (m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#sequence"><span class="hs-identifier hs-var hs-var">sequence</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312025"><span class="annot"><span class="annottext">State Stream m (m a) -&gt; s -&gt; m (Step s (m a))
</span><a href="#local-6989586621679312025"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312024"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312024"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
forall (m :: * -&gt; *) a. State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312023"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312024"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-4089"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4090"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4091"></span><span>    </span><span id="local-6989586621679312023"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312023"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312022"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312022"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span id="local-6989586621679312021"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312021"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4092"></span><span>         </span><span id="local-6989586621679312020"><span class="annot"><span class="annottext">Step s (m a)
</span><a href="#local-6989586621679312020"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m (m a) -&gt; s -&gt; m (Step s (m a))
</span><a href="#local-6989586621679312025"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m (m a)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312022"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312021"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4093"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s (m a)
</span><a href="#local-6989586621679312020"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4094"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312019"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679312019"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312018"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312018"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679312019"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m (Step s a)) -&gt; m (Step s a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679312017"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312017"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; s -&gt; Step s a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312017"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312018"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4095"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312016"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312016"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step s a -&gt; m (Step s a)) -&gt; Step s a -&gt; m (Step s a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Step s a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312016"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4096"></span><span>             </span><span class="annot"><span class="annottext">Step s (m a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step s a -&gt; m (Step s a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step s a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4097"></span><span>
</span><span id="line-4098"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4099"></span><span class="hs-comment">-- Inserting</span><span>
</span><span id="line-4100"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4101"></span><span>
</span><span id="line-4102"></span><span class="hs-keyword">data</span><span> </span><span id="LoopState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#LoopState"><span class="hs-identifier hs-var">LoopState</span></a></span></span><span> </span><span id="local-6989586621679315167"><span class="annot"><a href="#local-6989586621679315167"><span class="hs-identifier hs-type">x</span></a></span></span><span> </span><span id="local-6989586621679315168"><span class="annot"><a href="#local-6989586621679315168"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FirstYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FirstYield"><span class="hs-identifier hs-var">FirstYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315168"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4103"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span id="InterspersingYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterspersingYield"><span class="hs-identifier hs-var">InterspersingYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315168"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4104"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span id="YieldAndCarry"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#YieldAndCarry"><span class="hs-identifier hs-var">YieldAndCarry</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315167"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315168"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4105"></span><span>
</span><span id="line-4106"></span><span class="hs-pragma">{-# INLINE_NORMAL intersperseM #-}</span><span>
</span><span id="line-4107"></span><span id="local-6989586621679312011"><span id="local-6989586621679312012"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseM"><span class="hs-identifier hs-type">intersperseM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679312012"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679312012"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312011"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312012"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312011"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312012"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679312011"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4108"></span><span id="intersperseM"><span class="annot"><span class="annottext">intersperseM :: m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseM"><span class="hs-identifier hs-var hs-var">intersperseM</span></a></span></span><span> </span><span id="local-6989586621679312010"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679312010"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679312009"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312009"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679312008"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312008"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; LoopState a s -&gt; m (Step (LoopState a s) a))
-&gt; LoopState a s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; LoopState a s -&gt; m (Step (LoopState a s) a)
</span><a href="#local-6989586621679312007"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; LoopState a s
forall x s. s -&gt; LoopState x s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FirstYield"><span class="hs-identifier hs-var">FirstYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312008"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4109"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4110"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4111"></span><span>    </span><span id="local-6989586621679312007"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; LoopState a s -&gt; m (Step (LoopState a s) a)
</span><a href="#local-6989586621679312007"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679312006"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312006"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#FirstYield"><span class="hs-identifier hs-type">FirstYield</span></a></span><span> </span><span id="local-6989586621679312005"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312005"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4112"></span><span>        </span><span id="local-6989586621679312004"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312004"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312009"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312006"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312005"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4113"></span><span>        </span><span class="annot"><span class="annottext">Step (LoopState a s) a -&gt; m (Step (LoopState a s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (LoopState a s) a -&gt; m (Step (LoopState a s) a))
-&gt; Step (LoopState a s) a -&gt; m (Step (LoopState a s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-4114"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679312004"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4115"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679312003"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312003"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679312002"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312002"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LoopState a s -&gt; Step (LoopState a s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; s -&gt; LoopState a s
forall x s. x -&gt; s -&gt; LoopState x s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#YieldAndCarry"><span class="hs-identifier hs-var">YieldAndCarry</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679312003"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312002"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4116"></span><span>                </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679312001"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312001"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LoopState a s -&gt; Step (LoopState a s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; LoopState a s
forall x s. s -&gt; LoopState x s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#FirstYield"><span class="hs-identifier hs-var">FirstYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679312001"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4117"></span><span>                </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (LoopState a s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4118"></span><span>
</span><span id="line-4119"></span><span>    </span><span class="annot"><a href="#local-6989586621679312007"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679312000"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312000"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#InterspersingYield"><span class="hs-identifier hs-type">InterspersingYield</span></a></span><span> </span><span id="local-6989586621679311999"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311999"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4120"></span><span>        </span><span id="local-6989586621679311998"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311998"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679312009"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679312000"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311999"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4121"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311998"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4122"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311997"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311997"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311996"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311996"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4123"></span><span>                </span><span id="local-6989586621679311995"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311995"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679312010"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-4124"></span><span>                </span><span class="annot"><span class="annottext">Step (LoopState a s) a -&gt; m (Step (LoopState a s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (LoopState a s) a -&gt; m (Step (LoopState a s) a))
-&gt; Step (LoopState a s) a -&gt; m (Step (LoopState a s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; LoopState a s -&gt; Step (LoopState a s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311995"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; s -&gt; LoopState a s
forall x s. x -&gt; s -&gt; LoopState x s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#YieldAndCarry"><span class="hs-identifier hs-var">YieldAndCarry</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311997"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311996"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4125"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311994"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311994"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (LoopState a s) a -&gt; m (Step (LoopState a s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (LoopState a s) a -&gt; m (Step (LoopState a s) a))
-&gt; Step (LoopState a s) a -&gt; m (Step (LoopState a s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoopState a s -&gt; Step (LoopState a s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(LoopState a s -&gt; Step (LoopState a s) a)
-&gt; LoopState a s -&gt; Step (LoopState a s) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; LoopState a s
forall x s. s -&gt; LoopState x s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterspersingYield"><span class="hs-identifier hs-var">InterspersingYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311994"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4126"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (LoopState a s) a -&gt; m (Step (LoopState a s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (LoopState a s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4127"></span><span>
</span><span id="line-4128"></span><span>    </span><span class="annot"><a href="#local-6989586621679312007"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#YieldAndCarry"><span class="hs-identifier hs-type">YieldAndCarry</span></a></span><span> </span><span id="local-6989586621679311993"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311993"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311992"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311992"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (LoopState a s) a -&gt; m (Step (LoopState a s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (LoopState a s) a -&gt; m (Step (LoopState a s) a))
-&gt; Step (LoopState a s) a -&gt; m (Step (LoopState a s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; LoopState a s -&gt; Step (LoopState a s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311993"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; LoopState a s
forall x s. s -&gt; LoopState x s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#InterspersingYield"><span class="hs-identifier hs-var">InterspersingYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311992"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4129"></span><span>
</span><span id="line-4130"></span><span class="hs-pragma">{-# INLINE_NORMAL intersperseM_ #-}</span><span>
</span><span id="line-4131"></span><span id="local-6989586621679311989"><span id="local-6989586621679311990"><span id="local-6989586621679311991"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseM_"><span class="hs-identifier hs-type">intersperseM_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311991"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311991"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311990"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311991"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311989"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311991"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311989"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-4132"></span><span id="intersperseM_"><span class="annot"><span class="annottext">intersperseM_ :: m b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseM_"><span class="hs-identifier hs-var hs-var">intersperseM_</span></a></span></span><span> </span><span id="local-6989586621679311988"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679311988"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311987"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311987"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679311986"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311986"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; Either (m (), s) s -&gt; m (Step (Either (m (), s) s) a))
-&gt; Either (m (), s) s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; Either (m (), s) s -&gt; m (Step (Either (m (), s) s) a)
</span><a href="#local-6989586621679311985"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(m (), s) -&gt; Either (m (), s) s
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311986"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4133"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4134"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-4135"></span><span>    </span><span id="local-6989586621679311985"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; Either (m (), s) s -&gt; m (Step (Either (m (), s) s) a)
</span><a href="#local-6989586621679311985"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311984"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311984"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311983"><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679311983"><span class="hs-identifier hs-var">eff</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311982"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311982"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4136"></span><span>        </span><span id="local-6989586621679311981"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311981"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311987"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311984"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311982"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4137"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311981"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4138"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311980"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311980"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311979"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311979"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679311983"><span class="hs-identifier hs-var">eff</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
-&gt; m (Step (Either (m (), s) s) a)
-&gt; m (Step (Either (m (), s) s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Step (Either (m (), s) s) a -&gt; m (Step (Either (m (), s) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Either (m (), s) s -&gt; Step (Either (m (), s) s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311980"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Either (m (), s) s
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311979"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4139"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311978"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311978"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either (m (), s) s) a -&gt; m (Step (Either (m (), s) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either (m (), s) s) a -&gt; m (Step (Either (m (), s) s) a))
-&gt; Step (Either (m (), s) s) a -&gt; m (Step (Either (m (), s) s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either (m (), s) s -&gt; Step (Either (m (), s) s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(m (), s) -&gt; Either (m (), s) s
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679311983"><span class="hs-identifier hs-var">eff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311978"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4140"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either (m (), s) s) a -&gt; m (Step (Either (m (), s) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Either (m (), s) s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4141"></span><span>
</span><span id="line-4142"></span><span>    </span><span class="annot"><a href="#local-6989586621679311985"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679311977"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311977"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Either (m (), s) s) a -&gt; m (Step (Either (m (), s) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either (m (), s) s) a -&gt; m (Step (Either (m (), s) s) a))
-&gt; Step (Either (m (), s) s) a -&gt; m (Step (Either (m (), s) s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either (m (), s) s -&gt; Step (Either (m (), s) s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Either (m (), s) s -&gt; Step (Either (m (), s) s) a)
-&gt; Either (m (), s) s -&gt; Step (Either (m (), s) s) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(m (), s) -&gt; Either (m (), s) s
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m b -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679311988"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311977"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4143"></span><span>
</span><span id="line-4144"></span><span class="hs-keyword">data</span><span> </span><span id="SuffixState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixState"><span class="hs-identifier hs-var">SuffixState</span></a></span></span><span> </span><span id="local-6989586621679315156"><span class="annot"><a href="#local-6989586621679315156"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679315155"><span class="annot"><a href="#local-6989586621679315155"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-4145"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="SuffixElem"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixElem"><span class="hs-identifier hs-var">SuffixElem</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315156"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4146"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SuffixSuffix"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSuffix"><span class="hs-identifier hs-var">SuffixSuffix</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315156"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4147"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SuffixYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixYield"><span class="hs-identifier hs-var">SuffixYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315155"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixState"><span class="hs-identifier hs-type">SuffixState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315156"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315155"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4148"></span><span>
</span><span id="line-4149"></span><span class="hs-pragma">{-# INLINE_NORMAL intersperseSuffix #-}</span><span>
</span><span id="line-4150"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseSuffix"><span class="hs-identifier hs-type">intersperseSuffix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679311973"><span class="annot"><a href="#local-6989586621679311973"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679311972"><span class="annot"><a href="#local-6989586621679311972"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311973"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311973"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311972"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311973"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311972"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311973"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311972"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-4151"></span><span id="intersperseSuffix"><span class="annot"><span class="annottext">intersperseSuffix :: m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseSuffix"><span class="hs-identifier hs-var hs-var">intersperseSuffix</span></a></span></span><span> </span><span id="local-6989586621679311971"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679311971"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311970"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311970"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311969"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311969"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; SuffixState s a -&gt; m (Step (SuffixState s a) a))
-&gt; SuffixState s a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; SuffixState s a -&gt; m (Step (SuffixState s a) a)
</span><a href="#local-6989586621679311968"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SuffixState s a
forall s a. s -&gt; SuffixState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixElem"><span class="hs-identifier hs-var">SuffixElem</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311969"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4152"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4153"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4154"></span><span>    </span><span id="local-6989586621679311968"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; SuffixState s a -&gt; m (Step (SuffixState s a) a)
</span><a href="#local-6989586621679311968"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679311967"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311967"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixElem"><span class="hs-identifier hs-type">SuffixElem</span></a></span><span> </span><span id="local-6989586621679311966"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311966"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4155"></span><span>        </span><span id="local-6989586621679311965"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311965"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311970"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311967"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311966"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4156"></span><span>        </span><span class="annot"><span class="annottext">Step (SuffixState s a) a -&gt; m (Step (SuffixState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SuffixState s a) a -&gt; m (Step (SuffixState s a) a))
-&gt; Step (SuffixState s a) a -&gt; m (Step (SuffixState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311965"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4157"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311964"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311964"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311963"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311963"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SuffixState s a -&gt; Step (SuffixState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; SuffixState s a -&gt; SuffixState s a
forall s a. a -&gt; SuffixState s a -&gt; SuffixState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixYield"><span class="hs-identifier hs-var">SuffixYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311964"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SuffixState s a
forall s a. s -&gt; SuffixState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSuffix"><span class="hs-identifier hs-var">SuffixSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311963"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4158"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311962"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311962"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SuffixState s a -&gt; Step (SuffixState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SuffixState s a
forall s a. s -&gt; SuffixState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixElem"><span class="hs-identifier hs-var">SuffixElem</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311962"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4159"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SuffixState s a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4160"></span><span>
</span><span id="line-4161"></span><span>    </span><span class="annot"><a href="#local-6989586621679311968"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSuffix"><span class="hs-identifier hs-type">SuffixSuffix</span></a></span><span> </span><span id="local-6989586621679311961"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311961"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4162"></span><span>        </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679311971"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (SuffixState s a) a))
-&gt; m (Step (SuffixState s a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679311960"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311960"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SuffixState s a) a -&gt; m (Step (SuffixState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SuffixState s a) a -&gt; m (Step (SuffixState s a) a))
-&gt; Step (SuffixState s a) a -&gt; m (Step (SuffixState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SuffixState s a -&gt; Step (SuffixState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; SuffixState s a -&gt; SuffixState s a
forall s a. a -&gt; SuffixState s a -&gt; SuffixState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixYield"><span class="hs-identifier hs-var">SuffixYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311960"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SuffixState s a
forall s a. s -&gt; SuffixState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixElem"><span class="hs-identifier hs-var">SuffixElem</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311961"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4163"></span><span>
</span><span id="line-4164"></span><span>    </span><span class="annot"><a href="#local-6989586621679311968"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixYield"><span class="hs-identifier hs-type">SuffixYield</span></a></span><span> </span><span id="local-6989586621679311959"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311959"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311958"><span class="annot"><span class="annottext">SuffixState s a
</span><a href="#local-6989586621679311958"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SuffixState s a) a -&gt; m (Step (SuffixState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SuffixState s a) a -&gt; m (Step (SuffixState s a) a))
-&gt; Step (SuffixState s a) a -&gt; m (Step (SuffixState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; SuffixState s a -&gt; Step (SuffixState s a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311959"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SuffixState s a
</span><a href="#local-6989586621679311958"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-4165"></span><span>
</span><span id="line-4166"></span><span class="hs-pragma">{-# INLINE_NORMAL intersperseSuffix_ #-}</span><span>
</span><span id="line-4167"></span><span id="local-6989586621679311955"><span id="local-6989586621679311956"><span id="local-6989586621679311957"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseSuffix_"><span class="hs-identifier hs-type">intersperseSuffix_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311957"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311957"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311956"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311957"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311955"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311957"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311955"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-4168"></span><span id="intersperseSuffix_"><span class="annot"><span class="annottext">intersperseSuffix_ :: m b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseSuffix_"><span class="hs-identifier hs-var hs-var">intersperseSuffix_</span></a></span></span><span> </span><span id="local-6989586621679311954"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679311954"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311953"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311953"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679311952"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311952"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; Either s s -&gt; m (Step (Either s s) a))
-&gt; Either s s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Either s s -&gt; m (Step (Either s s) a)
</span><a href="#local-6989586621679311951"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Either s s
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311952"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4169"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4170"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-4171"></span><span>    </span><span id="local-6989586621679311951"><span class="annot"><span class="annottext">step :: State Stream m a -&gt; Either s s -&gt; m (Step (Either s s) a)
</span><a href="#local-6989586621679311951"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311950"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311950"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679311949"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311949"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4172"></span><span>        </span><span id="local-6989586621679311948"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311948"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311953"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311950"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311949"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4173"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311948"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4174"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311947"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311947"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311946"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311946"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s s) a -&gt; m (Step (Either s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either s s) a -&gt; m (Step (Either s s) a))
-&gt; Step (Either s s) a -&gt; m (Step (Either s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Either s s -&gt; Step (Either s s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311947"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Either s s
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311946"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4175"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311945"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311945"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s s) a -&gt; m (Step (Either s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Either s s) a -&gt; m (Step (Either s s) a))
-&gt; Step (Either s s) a -&gt; m (Step (Either s s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either s s -&gt; Step (Either s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Either s s -&gt; Step (Either s s) a)
-&gt; Either s s -&gt; Step (Either s s) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Either s s
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311945"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4176"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Either s s) a -&gt; m (Step (Either s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Either s s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4177"></span><span>
</span><span id="line-4178"></span><span>    </span><span class="annot"><a href="#local-6989586621679311951"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679311944"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311944"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679311954"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; m (Step (Either s s) a) -&gt; m (Step (Either s s) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Step (Either s s) a -&gt; m (Step (Either s s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either s s -&gt; Step (Either s s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Either s s
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311944"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4179"></span><span>
</span><span id="line-4180"></span><span class="hs-keyword">data</span><span> </span><span id="SuffixSpanState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanState"><span class="hs-identifier hs-var">SuffixSpanState</span></a></span></span><span> </span><span id="local-6989586621679315146"><span class="annot"><a href="#local-6989586621679315146"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679315145"><span class="annot"><a href="#local-6989586621679315145"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-4181"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="SuffixSpanElem"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanElem"><span class="hs-identifier hs-var">SuffixSpanElem</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315146"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-4182"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SuffixSpanSuffix"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanSuffix"><span class="hs-identifier hs-var">SuffixSpanSuffix</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315146"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4183"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SuffixSpanYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanYield"><span class="hs-identifier hs-var">SuffixSpanYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315145"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanState"><span class="hs-identifier hs-type">SuffixSpanState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315146"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315145"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4184"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SuffixSpanLast"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanLast"><span class="hs-identifier hs-var">SuffixSpanLast</span></a></span></span><span>
</span><span id="line-4185"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SuffixSpanStop"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanStop"><span class="hs-identifier hs-var">SuffixSpanStop</span></a></span></span><span>
</span><span id="line-4186"></span><span>
</span><span id="line-4187"></span><span class="hs-comment">-- | intersperse after every n items</span><span>
</span><span id="line-4188"></span><span class="hs-pragma">{-# INLINE_NORMAL intersperseSuffixBySpan #-}</span><span>
</span><span id="line-4189"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseSuffixBySpan"><span class="hs-identifier hs-type">intersperseSuffixBySpan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679311938"><span class="annot"><a href="#local-6989586621679311938"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679311937"><span class="annot"><a href="#local-6989586621679311937"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311938"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-4190"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311938"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311937"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311938"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311937"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311938"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311937"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-4191"></span><span id="intersperseSuffixBySpan"><span class="annot"><span class="annottext">intersperseSuffixBySpan :: Int -&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseSuffixBySpan"><span class="hs-identifier hs-var hs-var">intersperseSuffixBySpan</span></a></span></span><span> </span><span id="local-6989586621679311936"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311936"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679311935"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679311935"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311934"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311934"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311933"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311933"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-4192"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; SuffixSpanState s a -&gt; m (Step (SuffixSpanState s a) a))
-&gt; SuffixSpanState s a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; SuffixSpanState s a -&gt; m (Step (SuffixSpanState s a) a)
</span><a href="#local-6989586621679311932"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Int -&gt; SuffixSpanState s a
forall s a. s -&gt; Int -&gt; SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanElem"><span class="hs-identifier hs-var">SuffixSpanElem</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311933"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311936"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4193"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4194"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4195"></span><span>    </span><span id="local-6989586621679311932"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; SuffixSpanState s a -&gt; m (Step (SuffixSpanState s a) a)
</span><a href="#local-6989586621679311932"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679311931"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311931"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanElem"><span class="hs-identifier hs-type">SuffixSpanElem</span></a></span><span> </span><span id="local-6989586621679311930"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311930"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679311929"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311929"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311929"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4196"></span><span>        </span><span id="local-6989586621679311928"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311928"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311934"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311931"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311930"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4197"></span><span>        </span><span class="annot"><span class="annottext">Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a))
-&gt; Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311928"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4198"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311927"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311927"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311926"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311926"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SuffixSpanState s a -&gt; Step (SuffixSpanState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; SuffixSpanState s a -&gt; SuffixSpanState s a
forall s a. a -&gt; SuffixSpanState s a -&gt; SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanYield"><span class="hs-identifier hs-var">SuffixSpanYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311927"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Int -&gt; SuffixSpanState s a
forall s a. s -&gt; Int -&gt; SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanElem"><span class="hs-identifier hs-var">SuffixSpanElem</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311926"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311929"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4199"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311925"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311925"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SuffixSpanState s a -&gt; Step (SuffixSpanState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Int -&gt; SuffixSpanState s a
forall s a. s -&gt; Int -&gt; SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanElem"><span class="hs-identifier hs-var">SuffixSpanElem</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311925"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311929"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4200"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311929"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311936"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (SuffixSpanState s a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SuffixSpanState s a -&gt; Step (SuffixSpanState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">SuffixSpanState s a
forall s a. SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanLast"><span class="hs-identifier hs-var">SuffixSpanLast</span></a></span><span>
</span><span id="line-4201"></span><span>    </span><span class="annot"><a href="#local-6989586621679311932"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanElem"><span class="hs-identifier hs-type">SuffixSpanElem</span></a></span><span> </span><span id="local-6989586621679311924"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311924"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a))
-&gt; Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SuffixSpanState s a -&gt; Step (SuffixSpanState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; SuffixSpanState s a
forall s a. s -&gt; SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanSuffix"><span class="hs-identifier hs-var">SuffixSpanSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311924"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4202"></span><span>
</span><span id="line-4203"></span><span>    </span><span class="annot"><a href="#local-6989586621679311932"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanSuffix"><span class="hs-identifier hs-type">SuffixSpanSuffix</span></a></span><span> </span><span id="local-6989586621679311923"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311923"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4204"></span><span>        </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679311935"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (SuffixSpanState s a) a))
-&gt; m (Step (SuffixSpanState s a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679311922"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311922"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a))
-&gt; Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SuffixSpanState s a -&gt; Step (SuffixSpanState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; SuffixSpanState s a -&gt; SuffixSpanState s a
forall s a. a -&gt; SuffixSpanState s a -&gt; SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanYield"><span class="hs-identifier hs-var">SuffixSpanYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311922"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Int -&gt; SuffixSpanState s a
forall s a. s -&gt; Int -&gt; SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanElem"><span class="hs-identifier hs-var">SuffixSpanElem</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311923"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311936"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4205"></span><span>
</span><span id="line-4206"></span><span>    </span><span class="annot"><a href="#local-6989586621679311932"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanLast"><span class="hs-identifier hs-var">SuffixSpanLast</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4207"></span><span>        </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679311935"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">m a
-&gt; (a -&gt; m (Step (SuffixSpanState s a) a))
-&gt; m (Step (SuffixSpanState s a) a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679311921"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311921"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a))
-&gt; Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SuffixSpanState s a -&gt; Step (SuffixSpanState s a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; SuffixSpanState s a -&gt; SuffixSpanState s a
forall s a. a -&gt; SuffixSpanState s a -&gt; SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanYield"><span class="hs-identifier hs-var">SuffixSpanYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311921"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SuffixSpanState s a
forall s a. SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanStop"><span class="hs-identifier hs-var">SuffixSpanStop</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4208"></span><span>
</span><span id="line-4209"></span><span>    </span><span class="annot"><a href="#local-6989586621679311932"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanYield"><span class="hs-identifier hs-type">SuffixSpanYield</span></a></span><span> </span><span id="local-6989586621679311920"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311920"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311919"><span class="annot"><span class="annottext">SuffixSpanState s a
</span><a href="#local-6989586621679311919"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a))
-&gt; Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; SuffixSpanState s a -&gt; Step (SuffixSpanState s a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311920"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SuffixSpanState s a
</span><a href="#local-6989586621679311919"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-4210"></span><span>
</span><span id="line-4211"></span><span>    </span><span class="annot"><a href="#local-6989586621679311932"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SuffixSpanState s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#SuffixSpanStop"><span class="hs-identifier hs-var">SuffixSpanStop</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (SuffixSpanState s a) a -&gt; m (Step (SuffixSpanState s a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (SuffixSpanState s a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4212"></span><span>
</span><span id="line-4213"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperse"><span class="hs-pragma hs-type">intersperse</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4214"></span><span id="local-6989586621679311917"><span id="local-6989586621679311918"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperse"><span class="hs-identifier hs-type">intersperse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311918"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311917"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311918"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311917"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311918"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311917"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4215"></span><span id="intersperse"><span class="annot"><span class="annottext">intersperse :: a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperse"><span class="hs-identifier hs-var hs-var">intersperse</span></a></span></span><span> </span><span id="local-6989586621679311916"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311916"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#intersperseM"><span class="hs-identifier hs-var">intersperseM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311916"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4216"></span><span>
</span><span id="line-4217"></span><span class="hs-pragma">{-# INLINE_NORMAL insertBy #-}</span><span>
</span><span id="line-4218"></span><span id="local-6989586621679311914"><span id="local-6989586621679311915"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#insertBy"><span class="hs-identifier hs-type">insertBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311915"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679311914"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311914"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ordering</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311914"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311915"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311914"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311915"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311914"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4219"></span><span id="insertBy"><span class="annot"><span class="annottext">insertBy :: (a -&gt; a -&gt; Ordering) -&gt; a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#insertBy"><span class="hs-identifier hs-var hs-var">insertBy</span></a></span></span><span> </span><span id="local-6989586621679311913"><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
</span><a href="#local-6989586621679311913"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span id="local-6989586621679311912"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311912"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311911"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311911"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311910"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311910"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; (s, Bool, Maybe a) -&gt; m (Step (s, Bool, Maybe a) a))
-&gt; (s, Bool, Maybe a) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; (s, Bool, Maybe a) -&gt; m (Step (s, Bool, Maybe a) a)
</span><a href="#local-6989586621679311909"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311910"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4220"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4221"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4222"></span><span>    </span><span id="local-6989586621679311909"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; (s, Bool, Maybe a) -&gt; m (Step (s, Bool, Maybe a) a)
</span><a href="#local-6989586621679311909"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679311908"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311908"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311907"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311907"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4223"></span><span>        </span><span id="local-6989586621679311906"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311906"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311908"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311907"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4224"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311906"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4225"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311905"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311905"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311904"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311904"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
</span><a href="#local-6989586621679311913"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311912"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311905"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4226"></span><span>                </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a))
-&gt; Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Bool, Maybe a) -&gt; Step (s, Bool, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311905"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311904"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4227"></span><span>                </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a))
-&gt; Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Bool, Maybe a) -&gt; Step (s, Bool, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311912"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311904"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311905"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4228"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311903"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311903"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a))
-&gt; Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, Bool, Maybe a) -&gt; Step (s, Bool, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311903"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4229"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a))
-&gt; Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Bool, Maybe a) -&gt; Step (s, Bool, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311912"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311907"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4230"></span><span>
</span><span id="line-4231"></span><span>    </span><span class="annot"><a href="#local-6989586621679311909"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, Bool, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4232"></span><span>
</span><span id="line-4233"></span><span>    </span><span class="annot"><a href="#local-6989586621679311909"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679311902"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311902"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311901"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311901"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679311900"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311900"><span class="hs-identifier hs-var">prev</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4234"></span><span>        </span><span id="local-6989586621679311899"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311899"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311911"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311902"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311901"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4235"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311899"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4236"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311898"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311898"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311897"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311897"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a))
-&gt; Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Bool, Maybe a) -&gt; Step (s, Bool, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311900"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311897"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311898"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4237"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311896"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311896"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a))
-&gt; Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, Bool, Maybe a) -&gt; Step (s, Bool, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311896"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311900"><span class="hs-identifier hs-var">prev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4238"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a))
-&gt; Step (s, Bool, Maybe a) a -&gt; m (Step (s, Bool, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Bool, Maybe a) -&gt; Step (s, Bool, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311900"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311901"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4239"></span><span>
</span><span id="line-4240"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4241"></span><span class="hs-comment">-- Deleting</span><span>
</span><span id="line-4242"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4243"></span><span>
</span><span id="line-4244"></span><span class="hs-pragma">{-# INLINE_NORMAL deleteBy #-}</span><span>
</span><span id="line-4245"></span><span id="local-6989586621679311894"><span id="local-6989586621679311895"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#deleteBy"><span class="hs-identifier hs-type">deleteBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679311894"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311894"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311894"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311894"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311894"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4246"></span><span id="deleteBy"><span class="annot"><span class="annottext">deleteBy :: (a -&gt; a -&gt; Bool) -&gt; a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#deleteBy"><span class="hs-identifier hs-var hs-var">deleteBy</span></a></span></span><span> </span><span id="local-6989586621679311893"><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
</span><a href="#local-6989586621679311893"><span class="hs-identifier hs-var">eq</span></a></span></span><span> </span><span id="local-6989586621679311892"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311892"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311891"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311891"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311890"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311890"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; (s, Bool) -&gt; m (Step (s, Bool) a))
-&gt; (s, Bool) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; (s, Bool) -&gt; m (Step (s, Bool) a)
</span><a href="#local-6989586621679311889"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311890"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-4247"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4248"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4249"></span><span>    </span><span id="local-6989586621679311889"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, Bool) -&gt; m (Step (s, Bool) a)
</span><a href="#local-6989586621679311889"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679311888"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311888"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311887"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311887"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4250"></span><span>        </span><span id="local-6989586621679311886"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311886"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311891"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311888"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311887"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4251"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311886"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4252"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311885"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311885"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679311884"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311884"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool) a -&gt; m (Step (s, Bool) a))
-&gt; Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-4253"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
</span><a href="#local-6989586621679311893"><span class="hs-identifier hs-var">eq</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311892"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311885"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(s, Bool) -&gt; Step (s, Bool) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311884"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Bool) -&gt; Step (s, Bool) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311885"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311884"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-4254"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311883"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311883"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool) a -&gt; m (Step (s, Bool) a))
-&gt; Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, Bool) -&gt; Step (s, Bool) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311883"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-4255"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, Bool) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4256"></span><span>
</span><span id="line-4257"></span><span>    </span><span class="annot"><a href="#local-6989586621679311889"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679311882"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311882"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311881"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311881"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4258"></span><span>        </span><span id="local-6989586621679311880"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311880"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311891"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311882"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311881"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4259"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311880"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4260"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311879"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311879"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679311878"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311878"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool) a -&gt; m (Step (s, Bool) a))
-&gt; Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; (s, Bool) -&gt; Step (s, Bool) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311879"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311878"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-4261"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311877"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311877"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, Bool) a -&gt; m (Step (s, Bool) a))
-&gt; Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, Bool) -&gt; Step (s, Bool) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311877"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-4262"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, Bool) a -&gt; m (Step (s, Bool) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, Bool) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4263"></span><span>
</span><span id="line-4264"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4265"></span><span class="hs-comment">-- Transformation by Map and Filter</span><span>
</span><span id="line-4266"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4267"></span><span>
</span><span id="line-4268"></span><span class="hs-comment">-- XXX Will this always fuse properly?</span><span>
</span><span id="line-4269"></span><span class="hs-pragma">{-# INLINE_NORMAL mapMaybe #-}</span><span>
</span><span id="line-4270"></span><span id="local-6989586621679311874"><span id="local-6989586621679311875"><span id="local-6989586621679311876"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mapMaybe"><span class="hs-identifier hs-type">mapMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311876"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679311875"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679311874"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311876"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311875"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311876"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311874"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-4271"></span><span id="mapMaybe"><span class="annot"><span class="annottext">mapMaybe :: (a -&gt; Maybe b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mapMaybe"><span class="hs-identifier hs-var hs-var">mapMaybe</span></a></span></span><span> </span><span id="local-6989586621679311873"><span class="annot"><span class="annottext">a -&gt; Maybe b
</span><a href="#local-6989586621679311873"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe b -&gt; b) -&gt; Stream m (Maybe b) -&gt; Stream m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe b -&gt; b
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">(Stream m (Maybe b) -&gt; Stream m b)
-&gt; (Stream m a -&gt; Stream m (Maybe b)) -&gt; Stream m a -&gt; Stream m b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Maybe b -&gt; Bool) -&gt; Stream m (Maybe b) -&gt; Stream m (Maybe b)
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe b -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Stream m (Maybe b) -&gt; Stream m (Maybe b))
-&gt; (Stream m a -&gt; Stream m (Maybe b))
-&gt; Stream m a
-&gt; Stream m (Maybe b)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Maybe b) -&gt; Stream m a -&gt; Stream m (Maybe b)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe b
</span><a href="#local-6989586621679311873"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-4272"></span><span>
</span><span id="line-4273"></span><span class="hs-pragma">{-# INLINE_NORMAL mapMaybeM #-}</span><span>
</span><span id="line-4274"></span><span id="local-6989586621679311870"><span id="local-6989586621679311871"><span id="local-6989586621679311872"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mapMaybeM"><span class="hs-identifier hs-type">mapMaybeM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311872"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679311871"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311872"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679311870"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311872"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311871"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311872"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311870"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-4275"></span><span id="mapMaybeM"><span class="annot"><span class="annottext">mapMaybeM :: (a -&gt; m (Maybe b)) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mapMaybeM"><span class="hs-identifier hs-var hs-var">mapMaybeM</span></a></span></span><span> </span><span id="local-6989586621679311869"><span class="annot"><span class="annottext">a -&gt; m (Maybe b)
</span><a href="#local-6989586621679311869"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe b -&gt; b) -&gt; Stream m (Maybe b) -&gt; Stream m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe b -&gt; b
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">(Stream m (Maybe b) -&gt; Stream m b)
-&gt; (Stream m a -&gt; Stream m (Maybe b)) -&gt; Stream m a -&gt; Stream m b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Maybe b -&gt; Bool) -&gt; Stream m (Maybe b) -&gt; Stream m (Maybe b)
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; Bool) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe b -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Stream m (Maybe b) -&gt; Stream m (Maybe b))
-&gt; (Stream m a -&gt; Stream m (Maybe b))
-&gt; Stream m a
-&gt; Stream m (Maybe b)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m (Maybe b)) -&gt; Stream m a -&gt; Stream m (Maybe b)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m (Maybe b)
</span><a href="#local-6989586621679311869"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-4276"></span><span>
</span><span id="line-4277"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4278"></span><span class="hs-comment">-- Zipping</span><span>
</span><span id="line-4279"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4280"></span><span>
</span><span id="line-4281"></span><span class="hs-pragma">{-# INLINE_NORMAL indexed #-}</span><span>
</span><span id="line-4282"></span><span id="local-6989586621679311867"><span id="local-6989586621679311868"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#indexed"><span class="hs-identifier hs-type">indexed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311868"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311868"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311867"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311868"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679311867"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-4283"></span><span id="indexed"><span class="annot"><span class="annottext">indexed :: Stream m a -&gt; Stream m (Int, a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#indexed"><span class="hs-identifier hs-var hs-var">indexed</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311866"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311866"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311865"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311865"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m (Int, a) -&gt; (s, Int) -&gt; m (Step (s, Int) (Int, a)))
-&gt; (s, Int) -&gt; Stream m (Int, a)
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (Int, a) -&gt; (s, Int) -&gt; m (Step (s, Int) (Int, a))
forall b (m :: * -&gt; *) a.
Num b =&gt;
State Stream m a -&gt; (s, b) -&gt; m (Step (s, b) (b, a))
</span><a href="#local-6989586621679311864"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311865"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-4284"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4285"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4286"></span><span>    </span><span id="local-6989586621679311864"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, b) -&gt; m (Step (s, b) (b, a))
</span><a href="#local-6989586621679311864"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679311863"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311863"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311862"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311862"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311861"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311861"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311861"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m (Step (s, b) (b, a)) -&gt; m (Step (s, b) (b, a))
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4287"></span><span>         </span><span id="local-6989586621679311860"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311860"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311866"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311863"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311862"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4288"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311860"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4289"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311859"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311859"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311858"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311858"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a)))
-&gt; Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(b, a) -&gt; (s, b) -&gt; Step (s, b) (b, a)
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311861"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311859"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311858"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311861"><span class="hs-identifier hs-var">i</span></a></span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">b
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-4290"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>    </span><span id="local-6989586621679311857"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311857"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a)))
-&gt; Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, b) -&gt; Step (s, b) (b, a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311857"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311861"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4291"></span><span>             </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, b) (b, a)
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4292"></span><span>
</span><span id="line-4293"></span><span class="hs-pragma">{-# INLINE_NORMAL indexedR #-}</span><span>
</span><span id="line-4294"></span><span id="local-6989586621679311855"><span id="local-6989586621679311856"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#indexedR"><span class="hs-identifier hs-type">indexedR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311856"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311856"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311855"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311856"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679311855"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-4295"></span><span id="indexedR"><span class="annot"><span class="annottext">indexedR :: Int -&gt; Stream m a -&gt; Stream m (Int, a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#indexedR"><span class="hs-identifier hs-var hs-var">indexedR</span></a></span></span><span> </span><span id="local-6989586621679311854"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311854"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311853"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311853"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311852"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311852"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m (Int, a) -&gt; (s, Int) -&gt; m (Step (s, Int) (Int, a)))
-&gt; (s, Int) -&gt; Stream m (Int, a)
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (Int, a) -&gt; (s, Int) -&gt; m (Step (s, Int) (Int, a))
forall b (m :: * -&gt; *) a.
Num b =&gt;
State Stream m a -&gt; (s, b) -&gt; m (Step (s, b) (b, a))
</span><a href="#local-6989586621679311851"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311852"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311854"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4296"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4297"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-4298"></span><span>    </span><span id="local-6989586621679311851"><span class="annot"><span class="annottext">step' :: State Stream m a -&gt; (s, b) -&gt; m (Step (s, b) (b, a))
</span><a href="#local-6989586621679311851"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679311850"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311850"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311849"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311849"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311848"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311848"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311848"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m (Step (s, b) (b, a)) -&gt; m (Step (s, b) (b, a))
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4299"></span><span>         </span><span id="local-6989586621679311847"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311847"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311853"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311850"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311849"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4300"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311847"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4301"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311846"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311846"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311845"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311845"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679311844"><span class="annot"><span class="annottext">i' :: b
</span><a href="#local-6989586621679311844"><span class="hs-identifier hs-var hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311848"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-number">1</span></span><span>
</span><span id="line-4302"></span><span>                          </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a)))
-&gt; Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(b, a) -&gt; (s, b) -&gt; Step (s, b) (b, a)
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311848"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311846"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311845"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311844"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4303"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span>    </span><span id="local-6989586621679311843"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311843"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a)))
-&gt; Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, b) -&gt; Step (s, b) (b, a)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311843"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311848"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4304"></span><span>             </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, b) (b, a) -&gt; m (Step (s, b) (b, a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, b) (b, a)
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4305"></span><span>
</span><span id="line-4306"></span><span class="hs-pragma">{-# INLINE_NORMAL zipWithM #-}</span><span>
</span><span id="line-4307"></span><span id="local-6989586621679315099"><span id="local-6989586621679315100"><span id="local-6989586621679315101"><span id="local-6989586621679315102"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#zipWithM"><span class="hs-identifier hs-type">zipWithM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315102"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-4308"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315101"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315100"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315102"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315099"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315102"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315101"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315102"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315100"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315102"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315099"><span class="hs-identifier hs-type">c</span></a></span></span></span></span></span><span>
</span><span id="line-4309"></span><span id="zipWithM"><span class="annot"><span class="annottext">zipWithM :: (a -&gt; b -&gt; m c) -&gt; Stream m a -&gt; Stream m b -&gt; Stream m c
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#zipWithM"><span class="hs-identifier hs-var hs-var">zipWithM</span></a></span></span><span> </span><span id="local-6989586621679311842"><span class="annot"><span class="annottext">a -&gt; b -&gt; m c
</span><a href="#local-6989586621679311842"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311841"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311841"><span class="hs-identifier hs-var">stepa</span></a></span></span><span> </span><span id="local-6989586621679311840"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311840"><span class="hs-identifier hs-var">ta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311839"><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679311839"><span class="hs-identifier hs-var">stepb</span></a></span></span><span> </span><span id="local-6989586621679311838"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311838"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m c -&gt; (s, s, Maybe a) -&gt; m (Step (s, s, Maybe a) c))
-&gt; (s, s, Maybe a) -&gt; Stream m c
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m c -&gt; (s, s, Maybe a) -&gt; m (Step (s, s, Maybe a) c)
forall (m :: * -&gt; *) a.
State Stream m a -&gt; (s, s, Maybe a) -&gt; m (Step (s, s, Maybe a) c)
</span><a href="#local-6989586621679311837"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311840"><span class="hs-identifier hs-var">ta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311838"><span class="hs-identifier hs-var">tb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4310"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4311"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-4312"></span><span>    </span><span id="local-6989586621679311837"><span class="annot"><span class="annottext">step :: State Stream m a -&gt; (s, s, Maybe a) -&gt; m (Step (s, s, Maybe a) c)
</span><a href="#local-6989586621679311837"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311836"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311836"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311835"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311835"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311834"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311834"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4313"></span><span>        </span><span id="local-6989586621679311833"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311833"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311841"><span class="hs-identifier hs-var">stepa</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311836"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311835"><span class="hs-identifier hs-var">sa</span></a></span><span>
</span><span id="line-4314"></span><span>        </span><span class="annot"><span class="annottext">Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c))
-&gt; Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-4315"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311833"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4316"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311832"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311832"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311831"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311831"><span class="hs-identifier hs-var">sa'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; Step (s, s, Maybe a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311831"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311834"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311832"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4317"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311830"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311830"><span class="hs-identifier hs-var">sa'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; Step (s, s, Maybe a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311830"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311834"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4318"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, s, Maybe a) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4319"></span><span>
</span><span id="line-4320"></span><span>    </span><span class="annot"><a href="#local-6989586621679311837"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679311829"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311829"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311828"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311828"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311827"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311827"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679311826"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311826"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4321"></span><span>        </span><span id="local-6989586621679311825"><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679311825"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m b -&gt; s -&gt; m (Step s b)
</span><a href="#local-6989586621679311839"><span class="hs-identifier hs-var">stepb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State Stream m a -&gt; State Stream m b
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311829"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311827"><span class="hs-identifier hs-var">sb</span></a></span><span>
</span><span id="line-4322"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s b
</span><a href="#local-6989586621679311825"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4323"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311824"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311824"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679311823"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311823"><span class="hs-identifier hs-var">sb'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4324"></span><span>                </span><span id="local-6989586621679311822"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679311822"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; b -&gt; m c
</span><a href="#local-6989586621679311842"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311826"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311824"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-4325"></span><span>                </span><span class="annot"><span class="annottext">Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c))
-&gt; Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">c -&gt; (s, s, Maybe a) -&gt; Step (s, s, Maybe a) c
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679311822"><span class="hs-identifier hs-var">z</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311828"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311823"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4326"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311821"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311821"><span class="hs-identifier hs-var">sb'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c))
-&gt; Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(s, s, Maybe a) -&gt; Step (s, s, Maybe a) c
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311828"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311821"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311826"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4327"></span><span>            </span><span class="annot"><span class="annottext">Step s b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (s, s, Maybe a) c -&gt; m (Step (s, s, Maybe a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (s, s, Maybe a) c
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-cpp">

#if __GLASGOW_HASKELL__ &gt;= 801
</span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;zipWithM xs xs&quot;</span></span><span>
</span><span id="line-4331"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679311820"><span class="annot"><a href="#local-6989586621679311820"><span class="hs-pragma hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679311819"><span class="annot"><a href="#local-6989586621679311819"><span class="hs-pragma hs-var">xs</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#zipWithM"><span class="hs-pragma hs-type">zipWithM</span></a></span><span> </span><span class="hs-pragma">@</span><span class="annot"><span class="hs-pragma hs-type">Identity</span></span><span> </span><span class="annot"><a href="#local-6989586621679311820"><span class="hs-pragma hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311819"><span class="hs-pragma hs-type">xs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311819"><span class="hs-pragma hs-type">xs</span></a></span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#mapM"><span class="hs-pragma hs-type">mapM</span></a></span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">\</span><span id="local-6989586621679311818"><span class="annot"><a href="#local-6989586621679311818"><span class="hs-pragma hs-var">x</span></a></span></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311820"><span class="hs-pragma hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311818"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311818"><span class="hs-pragma hs-type">x</span></a></span><span class="hs-pragma">)</span><span> </span><span class="annot"><a href="#local-6989586621679311819"><span class="hs-pragma hs-type">xs</span></a></span><span> </span><span class="hs-pragma">#-}</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-4334"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#zipWith"><span class="hs-pragma hs-type">zipWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4335"></span><span id="local-6989586621679311814"><span id="local-6989586621679311815"><span id="local-6989586621679311816"><span id="local-6989586621679311817"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#zipWith"><span class="hs-identifier hs-type">zipWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311817"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679311816"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311815"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311814"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311817"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311816"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311817"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311815"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311817"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311814"><span class="hs-identifier hs-type">c</span></a></span></span></span></span></span><span>
</span><span id="line-4336"></span><span id="zipWith"><span class="annot"><span class="annottext">zipWith :: (a -&gt; b -&gt; c) -&gt; Stream m a -&gt; Stream m b -&gt; Stream m c
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#zipWith"><span class="hs-identifier hs-var hs-var">zipWith</span></a></span></span><span> </span><span id="local-6989586621679311813"><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621679311813"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; b -&gt; m c) -&gt; Stream m a -&gt; Stream m b -&gt; Stream m c
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; b -&gt; m c) -&gt; Stream m a -&gt; Stream m b -&gt; Stream m c
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#zipWithM"><span class="hs-identifier hs-var">zipWithM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679311812"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311812"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679311811"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311811"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; m c
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b -&gt; c
</span><a href="#local-6989586621679311813"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311812"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679311811"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4337"></span><span>
</span><span id="line-4338"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4339"></span><span class="hs-comment">-- Merging</span><span>
</span><span id="line-4340"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4341"></span><span>
</span><span id="line-4342"></span><span class="hs-pragma">{-# INLINE_NORMAL mergeByM #-}</span><span>
</span><span id="line-4343"></span><span id="local-6989586621679315091"><span id="local-6989586621679315092"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mergeByM"><span class="hs-identifier hs-type">mergeByM</span></a></span><span>
</span><span id="line-4344"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315092"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4345"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679315091"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315091"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315092"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ordering</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315092"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315091"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315092"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315091"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315092"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315091"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4346"></span><span id="mergeByM"><span class="annot"><span class="annottext">mergeByM :: (a -&gt; a -&gt; m Ordering) -&gt; Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mergeByM"><span class="hs-identifier hs-var hs-var">mergeByM</span></a></span></span><span> </span><span id="local-6989586621679311810"><span class="annot"><span class="annottext">a -&gt; a -&gt; m Ordering
</span><a href="#local-6989586621679311810"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311809"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311809"><span class="hs-identifier hs-var">stepa</span></a></span></span><span> </span><span id="local-6989586621679311808"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311808"><span class="hs-identifier hs-var">ta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311807"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311807"><span class="hs-identifier hs-var">stepb</span></a></span></span><span> </span><span id="local-6989586621679311806"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311806"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-4347"></span><span>    </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; (Maybe s, Maybe s, Maybe a, Maybe a)
 -&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a))
-&gt; (Maybe s, Maybe s, Maybe a, Maybe a) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; (Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
</span><a href="#local-6989586621679311805"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311808"><span class="hs-identifier hs-var">ta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311806"><span class="hs-identifier hs-var">tb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4348"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4349"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-4350"></span><span>
</span><span id="line-4351"></span><span>    </span><span class="hs-comment">-- one of the values is missing, and the corresponding stream is running</span><span>
</span><span id="line-4352"></span><span>    </span><span id="local-6989586621679311805"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; (Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
</span><a href="#local-6989586621679311805"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311804"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311804"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679311803"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311803"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311802"><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311802"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311801"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679311801"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4353"></span><span>        </span><span id="local-6989586621679311800"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311800"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311809"><span class="hs-identifier hs-var">stepa</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311804"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311803"><span class="hs-identifier hs-var">sa</span></a></span><span>
</span><span id="line-4354"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe s, Maybe a, Maybe a) a
 -&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a))
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311800"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4355"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311799"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311799"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679311798"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311798"><span class="hs-identifier hs-var">sa'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311798"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311802"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311799"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679311801"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4356"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311797"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311797"><span class="hs-identifier hs-var">sa'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311797"><span class="hs-identifier hs-var">sa'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311802"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679311801"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4357"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311802"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679311801"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4358"></span><span>
</span><span id="line-4359"></span><span>    </span><span class="annot"><a href="#local-6989586621679311805"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679311796"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311796"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311795"><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311795"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679311794"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311794"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311793"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679311793"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4360"></span><span>        </span><span id="local-6989586621679311792"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311792"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311807"><span class="hs-identifier hs-var">stepb</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311796"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311794"><span class="hs-identifier hs-var">sb</span></a></span><span>
</span><span id="line-4361"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe s, Maybe a, Maybe a) a
 -&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a))
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311792"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4362"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311791"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311791"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679311790"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311790"><span class="hs-identifier hs-var">sb'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311795"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311790"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679311793"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311791"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4363"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311789"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311789"><span class="hs-identifier hs-var">sb'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311795"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe s
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311789"><span class="hs-identifier hs-var">sb'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679311793"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4364"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311795"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679311793"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4365"></span><span>
</span><span id="line-4366"></span><span>    </span><span class="hs-comment">-- both the values are available</span><span>
</span><span id="line-4367"></span><span>    </span><span class="annot"><a href="#local-6989586621679311805"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311788"><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311788"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311787"><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311787"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679311786"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311786"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679311785"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311785"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4368"></span><span>        </span><span id="local-6989586621679311784"><span class="annot"><span class="annottext">Ordering
</span><a href="#local-6989586621679311784"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; m Ordering
</span><a href="#local-6989586621679311810"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311786"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311785"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-4369"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe s, Maybe a, Maybe a) a
 -&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a))
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><a href="#local-6989586621679311784"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4370"></span><span>            </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; (Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311785"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311788"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311787"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311786"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4371"></span><span>            </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; (Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311786"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311788"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311787"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311785"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4372"></span><span>
</span><span id="line-4373"></span><span>    </span><span class="hs-comment">-- one of the values is missing, corresponding stream is done</span><span>
</span><span id="line-4374"></span><span>    </span><span class="annot"><a href="#local-6989586621679311805"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311783"><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311783"><span class="hs-identifier hs-var">sb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679311782"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311782"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-4375"></span><span>            </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe s, Maybe a, Maybe a) a
 -&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a))
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
-&gt; (Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311782"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311783"><span class="hs-identifier hs-var">sb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4376"></span><span>
</span><span id="line-4377"></span><span>    </span><span class="annot"><a href="#local-6989586621679311805"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311781"><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311781"><span class="hs-identifier hs-var">sa</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679311780"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311780"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-4378"></span><span>            </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe s, Maybe s, Maybe a, Maybe a) a
 -&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a))
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
-&gt; (Maybe s, Maybe s, Maybe a, Maybe a)
-&gt; Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311780"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><a href="#local-6989586621679311781"><span class="hs-identifier hs-var">sa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4379"></span><span>
</span><span id="line-4380"></span><span>    </span><span class="annot"><a href="#local-6989586621679311805"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe s
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe s, Maybe a, Maybe a) a
-&gt; m (Step (Maybe s, Maybe s, Maybe a, Maybe a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (Maybe s, Maybe s, Maybe a, Maybe a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4381"></span><span>
</span><span id="line-4382"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mergeBy"><span class="hs-pragma hs-type">mergeBy</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4383"></span><span id="local-6989586621679311778"><span id="local-6989586621679311779"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mergeBy"><span class="hs-identifier hs-type">mergeBy</span></a></span><span>
</span><span id="line-4384"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311779"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4385"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679311778"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311778"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ordering</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311779"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311778"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311779"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311778"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311779"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311778"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4386"></span><span id="mergeBy"><span class="annot"><span class="annottext">mergeBy :: (a -&gt; a -&gt; Ordering) -&gt; Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mergeBy"><span class="hs-identifier hs-var hs-var">mergeBy</span></a></span></span><span> </span><span id="local-6989586621679311777"><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
</span><a href="#local-6989586621679311777"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; a -&gt; m Ordering) -&gt; Stream m a -&gt; Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; a -&gt; m Ordering) -&gt; Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mergeByM"><span class="hs-identifier hs-var">mergeByM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679311776"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311776"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679311775"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311775"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; m Ordering
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Ordering -&gt; m Ordering) -&gt; Ordering -&gt; m Ordering
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
</span><a href="#local-6989586621679311777"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311776"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311775"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4387"></span><span>
</span><span id="line-4388"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4389"></span><span class="hs-comment">-- Transformation comprehensions</span><span>
</span><span id="line-4390"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4391"></span><span>
</span><span id="line-4392"></span><span class="hs-pragma">{-# INLINE_NORMAL the #-}</span><span>
</span><span id="line-4393"></span><span id="local-6989586621679311773"><span id="local-6989586621679311774"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#the"><span class="hs-identifier hs-type">the</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679311774"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679311773"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311773"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311774"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311773"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679311774"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-4394"></span><span id="the"><span class="annot"><span class="annottext">the :: Stream m a -&gt; m (Maybe a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#the"><span class="hs-identifier hs-var hs-var">the</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311772"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311772"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311771"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311771"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Maybe a)
</span><a href="#local-6989586621679311770"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311771"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-4395"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4396"></span><span>    </span><span id="local-6989586621679311770"><span class="annot"><span class="annottext">go :: s -&gt; m (Maybe a)
</span><a href="#local-6989586621679311770"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679311769"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311769"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4397"></span><span>        </span><span id="local-6989586621679311768"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311768"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311772"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311769"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4398"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311768"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4399"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311767"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311767"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311766"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311766"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679311765"><span class="hs-identifier hs-var">go'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311767"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311766"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4400"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311764"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311764"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Maybe a)
</span><a href="#local-6989586621679311770"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311764"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4401"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-4402"></span><span>    </span><span id="local-6989586621679311765"><span class="annot"><span class="annottext">go' :: a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679311765"><span class="hs-identifier hs-var hs-var">go'</span></a></span></span><span> </span><span id="local-6989586621679311763"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311763"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679311762"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311762"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4403"></span><span>        </span><span id="local-6989586621679311761"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311761"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311772"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311762"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4404"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311761"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4405"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311760"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311760"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311759"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311759"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311760"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311763"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679311765"><span class="hs-identifier hs-var">go'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311763"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311759"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4406"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-4407"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311758"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311758"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; s -&gt; m (Maybe a)
</span><a href="#local-6989586621679311765"><span class="hs-identifier hs-var">go'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311763"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311758"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4408"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311763"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4409"></span><span>
</span><span id="line-4410"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runFold"><span class="hs-pragma hs-type">runFold</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4411"></span><span id="local-6989586621679315221"><span id="local-6989586621679315222"><span id="local-6989586621679315223"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#runFold"><span class="hs-identifier hs-type">runFold</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679315223"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315223"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315222"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315221"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315223"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315222"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315223"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315221"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-4412"></span><span id="runFold"><span class="annot"><span class="annottext">runFold :: Fold m a b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runFold"><span class="hs-identifier hs-var hs-var">runFold</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span id="local-6989586621679311757"><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679311757"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311756"><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679311756"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span id="local-6989586621679311755"><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679311755"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s -&gt; a -&gt; m s) -&gt; m s -&gt; (s -&gt; m b) -&gt; Stream m a -&gt; m b
forall (m :: * -&gt; *) x a b.
Monad m =&gt;
(x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldlMx%27"><span class="hs-identifier hs-var">foldlMx'</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; a -&gt; m s
</span><a href="#local-6989586621679311757"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">m s
</span><a href="#local-6989586621679311756"><span class="hs-identifier hs-var">begin</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; m b
</span><a href="#local-6989586621679311755"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-4413"></span><span>
</span><span id="line-4414"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-4415"></span><span class="hs-comment">-- Concurrent application and fold</span><span>
</span><span id="line-4416"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-4417"></span><span>
</span><span id="line-4418"></span><span class="hs-comment">-- XXX These functions should be moved to Stream/Parallel.hs</span><span>
</span><span id="line-4419"></span><span class="hs-comment">--</span><span>
</span><span id="line-4420"></span><span class="hs-comment">-- Using StreamD the worker stream producing code can fuse with the code to</span><span>
</span><span id="line-4421"></span><span class="hs-comment">-- queue output to the SVar giving some perf boost.</span><span>
</span><span id="line-4422"></span><span class="hs-comment">--</span><span>
</span><span id="line-4423"></span><span class="hs-comment">-- Note that StreamD can only be used in limited situations, specifically, we</span><span>
</span><span id="line-4424"></span><span class="hs-comment">-- cannot implement joinStreamVarPar using this.</span><span>
</span><span id="line-4425"></span><span class="hs-comment">--</span><span>
</span><span id="line-4426"></span><span class="hs-comment">-- XXX make sure that the SVar passed is a Parallel style SVar.</span><span>
</span><span id="line-4427"></span><span>
</span><span id="line-4428"></span><span class="hs-comment">-- | Fold the supplied stream to the SVar asynchronously using Parallel</span><span>
</span><span id="line-4429"></span><span class="hs-comment">-- concurrency style.</span><span>
</span><span id="line-4430"></span><span class="hs-comment">-- {-# INLINE_NORMAL toSVarParallel #-}</span><span>
</span><span id="line-4431"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#toSVarParallel"><span class="hs-pragma hs-type">toSVarParallel</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4432"></span><span id="local-6989586621679315052"><span id="local-6989586621679315053"><span id="local-6989586621679315054"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#toSVarParallel"><span class="hs-identifier hs-type">toSVarParallel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315054"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-4433"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315053"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315052"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#SVar"><span class="hs-identifier hs-type">SVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315053"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315052"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315052"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-4434"></span><span id="toSVarParallel"><span class="annot"><span class="annottext">toSVarParallel :: State t m a -&gt; SVar t m a -&gt; Stream m a -&gt; m ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#toSVarParallel"><span class="hs-identifier hs-var hs-var">toSVarParallel</span></a></span></span><span> </span><span id="local-6989586621679311754"><span class="annot"><span class="annottext">State t m a
</span><a href="#local-6989586621679311754"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679311753"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span id="local-6989586621679311752"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679311752"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-4435"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; Bool
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; Bool
</span><a href="Streamly.Internal.Data.SVar.html#svarInspectMode"><span class="hs-identifier hs-var hs-var">svarInspectMode</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-4436"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679311751"><span class="hs-identifier hs-var">forkWithDiag</span></a></span><span>
</span><span id="line-4437"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4438"></span><span>        </span><span id="local-6989586621679311750"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679311750"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-4439"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State t m a -&gt; Maybe Count
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
State t m a -&gt; Maybe Count
</span><a href="Streamly.Internal.Data.SVar.html#getYieldLimit"><span class="hs-identifier hs-var">getYieldLimit</span></a></span><span> </span><span class="annot"><span class="annottext">State t m a
</span><a href="#local-6989586621679311754"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4440"></span><span>                    </span><span class="annot"><span class="annottext">Maybe Count
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
forall (m :: * -&gt; *).
MonadBaseControl IO m =&gt;
m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
</span><a href="Streamly.Internal.Data.SVar.html#doFork"><span class="hs-identifier hs-var">doFork</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe WorkerInfo -&gt; m ()
</span><a href="#local-6989586621679311747"><span class="hs-identifier hs-var">work</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WorkerInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4441"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; RunInIO m
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; RunInIO m
</span><a href="Streamly.Internal.Data.SVar.html#svarMrun"><span class="hs-identifier hs-var hs-var">svarMrun</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4442"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; SomeException -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; SomeException -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#handleChildException"><span class="hs-identifier hs-var">handleChildException</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4443"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Count
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
forall (m :: * -&gt; *).
MonadBaseControl IO m =&gt;
m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
</span><a href="Streamly.Internal.Data.SVar.html#doFork"><span class="hs-identifier hs-var">doFork</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe WorkerInfo -&gt; m ()
</span><a href="#local-6989586621679311744"><span class="hs-identifier hs-var">workLim</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WorkerInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-4444"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; RunInIO m
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; RunInIO m
</span><a href="Streamly.Internal.Data.SVar.html#svarMrun"><span class="hs-identifier hs-var hs-var">svarMrun</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4445"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; SomeException -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; SomeException -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#handleChildException"><span class="hs-identifier hs-var">handleChildException</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4446"></span><span>        </span><span class="annot"><span class="annottext">SVar t m a -&gt; ThreadId -&gt; m ()
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadIO m =&gt;
SVar t m a -&gt; ThreadId -&gt; m ()
</span><a href="Streamly.Internal.Data.SVar.html#modifyThread"><span class="hs-identifier hs-var">modifyThread</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679311750"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-4447"></span><span>
</span><span id="line-4448"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4449"></span><span>
</span><span id="line-4450"></span><span>    </span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="#local-6989586621679311747"><span class="hs-pragma hs-type">work</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4451"></span><span>    </span><span id="local-6989586621679311747"><span class="annot"><span class="annottext">work :: Maybe WorkerInfo -&gt; m ()
</span><a href="#local-6989586621679311747"><span class="hs-identifier hs-var hs-var">work</span></a></span></span><span> </span><span id="local-6989586621679311742"><span class="annot"><span class="annottext">Maybe WorkerInfo
</span><a href="#local-6989586621679311742"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fold m a () -&gt; Stream m a -&gt; m ()
forall (m :: * -&gt; *) a b.
Monad m =&gt;
Fold m a b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runFold"><span class="hs-identifier hs-var">runFold</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; Maybe WorkerInfo -&gt; Fold m a ()
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadIO m =&gt;
SVar t m a -&gt; Maybe WorkerInfo -&gt; Fold m a ()
</span><a href="Streamly.Internal.Data.Fold.html#toParallelSVar"><span class="hs-identifier hs-var">FL.toParallelSVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WorkerInfo
</span><a href="#local-6989586621679311742"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679311752"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4452"></span><span>
</span><span id="line-4453"></span><span>    </span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="#local-6989586621679311744"><span class="hs-pragma hs-type">workLim</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4454"></span><span>    </span><span id="local-6989586621679311744"><span class="annot"><span class="annottext">workLim :: Maybe WorkerInfo -&gt; m ()
</span><a href="#local-6989586621679311744"><span class="hs-identifier hs-var hs-var">workLim</span></a></span></span><span> </span><span id="local-6989586621679311740"><span class="annot"><span class="annottext">Maybe WorkerInfo
</span><a href="#local-6989586621679311740"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fold m a () -&gt; Stream m a -&gt; m ()
forall (m :: * -&gt; *) a b.
Monad m =&gt;
Fold m a b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runFold"><span class="hs-identifier hs-var">runFold</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; Maybe WorkerInfo -&gt; Fold m a ()
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadIO m =&gt;
SVar t m a -&gt; Maybe WorkerInfo -&gt; Fold m a ()
</span><a href="Streamly.Internal.Data.Fold.html#toParallelSVarLimited"><span class="hs-identifier hs-var">FL.toParallelSVarLimited</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WorkerInfo
</span><a href="#local-6989586621679311740"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679311752"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-4455"></span><span>
</span><span id="line-4456"></span><span>    </span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="#local-6989586621679311751"><span class="hs-pragma hs-type">forkWithDiag</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4457"></span><span>    </span><span id="local-6989586621679311751"><span class="annot"><span class="annottext">forkWithDiag :: m ()
</span><a href="#local-6989586621679311751"><span class="hs-identifier hs-var hs-var">forkWithDiag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4458"></span><span>        </span><span class="hs-comment">-- We do not use workerCount in case of ParallelVar but still there is</span><span>
</span><span id="line-4459"></span><span>        </span><span class="hs-comment">-- no harm in maintaining it correctly.</span><span>
</span><span id="line-4460"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; (Int -&gt; Int) -&gt; IO ()
forall t. IORef t -&gt; (t -&gt; t) -&gt; IO ()
</span><a href="Streamly.Internal.Data.Atomics.html#atomicModifyIORefCAS_"><span class="hs-identifier hs-var">atomicModifyIORefCAS_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; IORef Int
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; IORef Int
</span><a href="Streamly.Internal.Data.SVar.html#workerCount"><span class="hs-identifier hs-var hs-var">workerCount</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Int) -&gt; IO ()) -&gt; (Int -&gt; Int) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679311737"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311737"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311737"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-4461"></span><span>        </span><span class="annot"><span class="annottext">SVar t m a -&gt; m ()
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadIO m =&gt;
SVar t m a -&gt; m ()
</span><a href="Streamly.Internal.Data.SVar.html#recordMaxWorkers"><span class="hs-identifier hs-var">recordMaxWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-4462"></span><span>        </span><span class="hs-comment">-- This allocation matters when significant number of workers are being</span><span>
</span><span id="line-4463"></span><span>        </span><span class="hs-comment">-- sent. We allocate it only when needed. The overhead increases by 4x.</span><span>
</span><span id="line-4464"></span><span>        </span><span id="local-6989586621679311735"><span class="annot"><span class="annottext">Maybe WorkerInfo
</span><a href="#local-6989586621679311735"><span class="hs-identifier hs-var">winfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-4465"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; Maybe YieldRateInfo
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; Maybe YieldRateInfo
</span><a href="Streamly.Internal.Data.SVar.html#yieldRateInfo"><span class="hs-identifier hs-var hs-var">yieldRateInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4466"></span><span>                </span><span class="annot"><span class="annottext">Maybe YieldRateInfo
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe WorkerInfo -&gt; m (Maybe WorkerInfo)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe WorkerInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-4467"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">YieldRateInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO (Maybe WorkerInfo) -&gt; m (Maybe WorkerInfo)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe WorkerInfo) -&gt; m (Maybe WorkerInfo))
-&gt; IO (Maybe WorkerInfo) -&gt; m (Maybe WorkerInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4468"></span><span>                    </span><span id="local-6989586621679311733"><span class="annot"><span class="annottext">IORef Count
</span><a href="#local-6989586621679311733"><span class="hs-identifier hs-var">cntRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Count -&gt; IO (IORef Count)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Count
</span><span class="hs-number">0</span></span><span>
</span><span id="line-4469"></span><span>                    </span><span id="local-6989586621679311732"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311732"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO AbsTime
</span><a href="Streamly.Internal.Data.Time.Clock.html#getTime"><span class="hs-identifier hs-var">getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="Streamly.Internal.Data.Time.Clock.html#Monotonic"><span class="hs-identifier hs-var">Monotonic</span></a></span><span>
</span><span id="line-4470"></span><span>                    </span><span id="local-6989586621679311731"><span class="annot"><span class="annottext">IORef (Count, AbsTime)
</span><a href="#local-6989586621679311731"><span class="hs-identifier hs-var">lat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Count, AbsTime) -&gt; IO (IORef (Count, AbsTime))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311732"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4471"></span><span>                    </span><span class="annot"><span class="annottext">Maybe WorkerInfo -&gt; IO (Maybe WorkerInfo)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe WorkerInfo -&gt; IO (Maybe WorkerInfo))
-&gt; Maybe WorkerInfo -&gt; IO (Maybe WorkerInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkerInfo -&gt; Maybe WorkerInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">WorkerInfo :: Count -&gt; IORef Count -&gt; IORef (Count, AbsTime) -&gt; WorkerInfo
</span><a href="Streamly.Internal.Data.SVar.html#WorkerInfo"><span class="hs-identifier hs-type">WorkerInfo</span></a></span><span>
</span><span id="line-4472"></span><span>                        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">workerYieldMax :: Count
</span><a href="Streamly.Internal.Data.SVar.html#workerYieldMax"><span class="hs-identifier hs-var">workerYieldMax</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Count
</span><span class="hs-number">0</span></span><span>
</span><span id="line-4473"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">workerYieldCount :: IORef Count
</span><a href="Streamly.Internal.Data.SVar.html#workerYieldCount"><span class="hs-identifier hs-var">workerYieldCount</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef Count
</span><a href="#local-6989586621679311733"><span class="hs-identifier hs-var">cntRef</span></a></span><span>
</span><span id="line-4474"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">workerLatencyStart :: IORef (Count, AbsTime)
</span><a href="Streamly.Internal.Data.SVar.html#workerLatencyStart"><span class="hs-identifier hs-var">workerLatencyStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Count, AbsTime)
</span><a href="#local-6989586621679311731"><span class="hs-identifier hs-var">lat</span></a></span><span>
</span><span id="line-4475"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-4476"></span><span>        </span><span id="local-6989586621679311726"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679311726"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-4477"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State t m a -&gt; Maybe Count
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
State t m a -&gt; Maybe Count
</span><a href="Streamly.Internal.Data.SVar.html#getYieldLimit"><span class="hs-identifier hs-var">getYieldLimit</span></a></span><span> </span><span class="annot"><span class="annottext">State t m a
</span><a href="#local-6989586621679311754"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4478"></span><span>                </span><span class="annot"><span class="annottext">Maybe Count
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
forall (m :: * -&gt; *).
MonadBaseControl IO m =&gt;
m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
</span><a href="Streamly.Internal.Data.SVar.html#doFork"><span class="hs-identifier hs-var">doFork</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe WorkerInfo -&gt; m ()
</span><a href="#local-6989586621679311747"><span class="hs-identifier hs-var">work</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WorkerInfo
</span><a href="#local-6989586621679311735"><span class="hs-identifier hs-var">winfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4479"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; RunInIO m
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; RunInIO m
</span><a href="Streamly.Internal.Data.SVar.html#svarMrun"><span class="hs-identifier hs-var hs-var">svarMrun</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4480"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; SomeException -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; SomeException -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#handleChildException"><span class="hs-identifier hs-var">handleChildException</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4481"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Count
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
forall (m :: * -&gt; *).
MonadBaseControl IO m =&gt;
m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
</span><a href="Streamly.Internal.Data.SVar.html#doFork"><span class="hs-identifier hs-var">doFork</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe WorkerInfo -&gt; m ()
</span><a href="#local-6989586621679311744"><span class="hs-identifier hs-var">workLim</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WorkerInfo
</span><a href="#local-6989586621679311735"><span class="hs-identifier hs-var">winfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4482"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; RunInIO m
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; RunInIO m
</span><a href="Streamly.Internal.Data.SVar.html#svarMrun"><span class="hs-identifier hs-var hs-var">svarMrun</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4483"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; SomeException -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; SomeException -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#handleChildException"><span class="hs-identifier hs-var">handleChildException</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4484"></span><span>        </span><span class="annot"><span class="annottext">SVar t m a -&gt; ThreadId -&gt; m ()
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadIO m =&gt;
SVar t m a -&gt; ThreadId -&gt; m ()
</span><a href="Streamly.Internal.Data.SVar.html#modifyThread"><span class="hs-identifier hs-var">modifyThread</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311753"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679311726"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-4485"></span><span>
</span><span id="line-4486"></span><span class="hs-pragma">{-# INLINE_NORMAL mkParallelD #-}</span><span>
</span><span id="line-4487"></span><span id="local-6989586621679315040"><span id="local-6989586621679315041"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mkParallelD"><span class="hs-identifier hs-type">mkParallelD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315040"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315040"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-4488"></span><span id="mkParallelD"><span class="annot"><span class="annottext">mkParallelD :: Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mkParallelD"><span class="hs-identifier hs-var hs-var">mkParallelD</span></a></span></span><span> </span><span id="local-6989586621679311725"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679311725"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; Maybe (Stream m a) -&gt; m (Step (Maybe (Stream m a)) a))
-&gt; Maybe (Stream m a) -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; Maybe (Stream m a) -&gt; m (Step (Maybe (Stream m a)) a)
</span><a href="#local-6989586621679311724"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-4489"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4490"></span><span>
</span><span id="line-4491"></span><span>    </span><span id="local-6989586621679311724"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; Maybe (Stream m a) -&gt; m (Step (Maybe (Stream m a)) a)
</span><a href="#local-6989586621679311724"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311723"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311723"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4492"></span><span>        </span><span id="local-6989586621679311722"><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311722"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SVarStopStyle -&gt; State Stream m a -&gt; m (SVar Stream m a)
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadAsync m =&gt;
SVarStopStyle -&gt; State t m a -&gt; m (SVar t m a)
</span><a href="Streamly.Internal.Data.SVar.html#newParallelVar"><span class="hs-identifier hs-var">newParallelVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVarStopStyle
</span><a href="Streamly.Internal.Data.SVar.html#StopNone"><span class="hs-identifier hs-var">StopNone</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311723"><span class="hs-identifier hs-var">gst</span></a></span><span>
</span><span id="line-4493"></span><span>        </span><span class="annot"><span class="annottext">State Stream m a -&gt; SVar Stream m a -&gt; Stream m a -&gt; m ()
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadAsync m =&gt;
State t m a -&gt; SVar t m a -&gt; Stream m a -&gt; m ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#toSVarParallel"><span class="hs-identifier hs-var">toSVarParallel</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311723"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311722"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679311725"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-4494"></span><span>        </span><span class="hs-comment">-- XXX use unfold instead?</span><span>
</span><span id="line-4495"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (Stream m a)) a -&gt; m (Step (Maybe (Stream m a)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (Stream m a)) a -&gt; m (Step (Maybe (Stream m a)) a))
-&gt; Step (Maybe (Stream m a)) a -&gt; m (Step (Maybe (Stream m a)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a) -&gt; Step (Maybe (Stream m a)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Stream m a) -&gt; Step (Maybe (Stream m a)) a)
-&gt; Maybe (Stream m a) -&gt; Step (Maybe (Stream m a)) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Maybe (Stream m a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; Maybe (Stream m a))
-&gt; Stream m a -&gt; Maybe (Stream m a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadAsync m =&gt;
SVar t m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromSVar"><span class="hs-identifier hs-var">fromSVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311722"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-4496"></span><span>
</span><span id="line-4497"></span><span>    </span><span class="annot"><a href="#local-6989586621679311724"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679311720"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311720"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#UnStream"><span class="hs-identifier hs-type">UnStream</span></a></span><span> </span><span id="local-6989586621679311719"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311719"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679311718"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311718"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4498"></span><span>        </span><span id="local-6989586621679311717"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311717"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311719"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311720"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311718"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4499"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (Stream m a)) a -&gt; m (Step (Maybe (Stream m a)) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (Stream m a)) a -&gt; m (Step (Maybe (Stream m a)) a))
-&gt; Step (Maybe (Stream m a)) a -&gt; m (Step (Maybe (Stream m a)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311717"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4500"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311716"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311716"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679311715"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311715"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe (Stream m a) -&gt; Step (Maybe (Stream m a)) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311716"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Maybe (Stream m a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; Maybe (Stream m a))
-&gt; Stream m a -&gt; Maybe (Stream m a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311719"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311715"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4501"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311714"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311714"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Stream m a) -&gt; Step (Maybe (Stream m a)) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Maybe (Stream m a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; Maybe (Stream m a))
-&gt; Stream m a -&gt; Maybe (Stream m a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311719"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311714"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4502"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (Maybe (Stream m a)) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4503"></span><span>
</span><span id="line-4504"></span><span class="hs-comment">-- Compare with mkAsync. mkAsync uses an Async style SVar whereas this uses a</span><span>
</span><span id="line-4505"></span><span class="hs-comment">-- parallel style SVar for evaluation. Currently, parallel style cannot use</span><span>
</span><span id="line-4506"></span><span class="hs-comment">-- rate control whereas Async style can use rate control. In async style SVar</span><span>
</span><span id="line-4507"></span><span class="hs-comment">-- the worker thread terminates when the buffer is full whereas in Parallel</span><span>
</span><span id="line-4508"></span><span class="hs-comment">-- style it blocks.</span><span>
</span><span id="line-4509"></span><span class="hs-comment">--</span><span>
</span><span id="line-4510"></span><span class="hs-comment">-- | Make the stream producer and consumer run concurrently by introducing a</span><span>
</span><span id="line-4511"></span><span class="hs-comment">-- buffer between them. The producer thread evaluates the input stream until</span><span>
</span><span id="line-4512"></span><span class="hs-comment">-- the buffer fills, it blocks if the buffer is full until there is space in</span><span>
</span><span id="line-4513"></span><span class="hs-comment">-- the buffer. The consumer consumes the stream lazily from the buffer.</span><span>
</span><span id="line-4514"></span><span class="hs-comment">--</span><span>
</span><span id="line-4515"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-4516"></span><span class="hs-comment">--</span><span>
</span><span id="line-4517"></span><span class="hs-pragma">{-# INLINE_NORMAL mkParallel #-}</span><span>
</span><span id="line-4518"></span><span id="local-6989586621679311711"><span id="local-6989586621679311712"><span id="local-6989586621679311713"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#mkParallel"><span class="hs-identifier hs-type">mkParallel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">K.IsStream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311713"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311712"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311713"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311712"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311711"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311713"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311712"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311711"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-4519"></span><span id="mkParallel"><span class="annot"><span class="annottext">mkParallel :: t m a -&gt; t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mkParallel"><span class="hs-identifier hs-var hs-var">mkParallel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(IsStream t, Monad m) =&gt;
Stream m a -&gt; t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromStreamD"><span class="hs-identifier hs-var">fromStreamD</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; t m a) -&gt; (t m a -&gt; Stream m a) -&gt; t m a -&gt; t m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m a
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#mkParallelD"><span class="hs-identifier hs-var">mkParallelD</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; Stream m a)
-&gt; (t m a -&gt; Stream m a) -&gt; t m a -&gt; Stream m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">t m a -&gt; Stream m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(IsStream t, Monad m) =&gt;
t m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#toStreamD"><span class="hs-identifier hs-var">toStreamD</span></a></span><span>
</span><span id="line-4520"></span><span>
</span><span id="line-4521"></span><span class="hs-comment">-- Note: we can use another API with two callbacks stop and yield if we want</span><span>
</span><span id="line-4522"></span><span class="hs-comment">-- the callback to be able to indicate end of stream.</span><span>
</span><span id="line-4523"></span><span class="hs-comment">--</span><span>
</span><span id="line-4524"></span><span class="hs-comment">-- | Generates a callback and a stream pair. The callback returned is used to</span><span>
</span><span id="line-4525"></span><span class="hs-comment">-- queue values to the stream.  The stream is infinite, there is no way for the</span><span>
</span><span id="line-4526"></span><span class="hs-comment">-- callback to indicate that it is done now.</span><span>
</span><span id="line-4527"></span><span class="hs-comment">--</span><span>
</span><span id="line-4528"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-4529"></span><span class="hs-comment">--</span><span>
</span><span id="line-4530"></span><span class="hs-pragma">{-# INLINE_NORMAL newCallbackStream #-}</span><span>
</span><span id="line-4531"></span><span id="local-6989586621679311708"><span id="local-6989586621679311709"><span id="local-6989586621679311710"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#newCallbackStream"><span class="hs-identifier hs-type">newCallbackStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">K.IsStream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311710"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311709"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311709"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679311708"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311709"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679311710"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311709"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311708"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-4532"></span><span id="newCallbackStream"><span class="annot"><span class="annottext">newCallbackStream :: m (a -&gt; m (), t m a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#newCallbackStream"><span class="hs-identifier hs-var hs-var">newCallbackStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4533"></span><span>    </span><span id="local-6989586621679311707"><span class="annot"><span class="annottext">SVar Any m a
</span><a href="#local-6989586621679311707"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SVarStopStyle -&gt; State Any m a -&gt; m (SVar Any m a)
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadAsync m =&gt;
SVarStopStyle -&gt; State t m a -&gt; m (SVar t m a)
</span><a href="Streamly.Internal.Data.SVar.html#newParallelVar"><span class="hs-identifier hs-var">newParallelVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVarStopStyle
</span><a href="Streamly.Internal.Data.SVar.html#StopNone"><span class="hs-identifier hs-var">StopNone</span></a></span><span> </span><span class="annot"><span class="annottext">State Any m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span>
</span><span id="line-4534"></span><span>
</span><span id="line-4535"></span><span>    </span><span class="hs-comment">-- XXX Add our own thread-id to the SVar as we can not know the callback's</span><span>
</span><span id="line-4536"></span><span>    </span><span class="hs-comment">-- thread-id and the callback is not run in a managed worker. We need to</span><span>
</span><span id="line-4537"></span><span>    </span><span class="hs-comment">-- handle this better.</span><span>
</span><span id="line-4538"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; m ThreadId
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span> </span><span class="annot"><span class="annottext">m ThreadId -&gt; (ThreadId -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SVar Any m a -&gt; ThreadId -&gt; m ()
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadIO m =&gt;
SVar t m a -&gt; ThreadId -&gt; m ()
</span><a href="Streamly.Internal.Data.SVar.html#modifyThread"><span class="hs-identifier hs-var">modifyThread</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Any m a
</span><a href="#local-6989586621679311707"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-4539"></span><span>
</span><span id="line-4540"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679311706"><span class="annot"><span class="annottext">callback :: a -&gt; m ()
</span><a href="#local-6989586621679311706"><span class="hs-identifier hs-var hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621679311705"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311705"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO Int -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; IO ()) -&gt; IO Int -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar Any m a -&gt; ChildEvent a -&gt; IO Int
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; ChildEvent a -&gt; IO Int
</span><a href="Streamly.Internal.Data.SVar.html#send"><span class="hs-identifier hs-var">send</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Any m a
</span><a href="#local-6989586621679311707"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; ChildEvent a
forall a. a -&gt; ChildEvent a
</span><a href="Streamly.Internal.Data.SVar.html#ChildYield"><span class="hs-identifier hs-var">ChildYield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311705"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4541"></span><span>    </span><span class="hs-comment">-- XXX we can return an SVar and then the consumer can unfold from the</span><span>
</span><span id="line-4542"></span><span>    </span><span class="hs-comment">-- SVar?</span><span>
</span><span id="line-4543"></span><span>    </span><span class="annot"><span class="annottext">(a -&gt; m (), t m a) -&gt; m (a -&gt; m (), t m a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m ()
forall (m :: * -&gt; *). MonadIO m =&gt; a -&gt; m ()
</span><a href="#local-6989586621679311706"><span class="hs-identifier hs-var">callback</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(IsStream t, Monad m) =&gt;
Stream m a -&gt; t m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromStreamD"><span class="hs-identifier hs-var">fromStreamD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar Any m a -&gt; Stream m a
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadAsync m =&gt;
SVar t m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromSVar"><span class="hs-identifier hs-var">fromSVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Any m a
</span><a href="#local-6989586621679311707"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4544"></span><span>
</span><span id="line-4545"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-4546"></span><span class="hs-comment">-- Concurrent tap</span><span>
</span><span id="line-4547"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-4548"></span><span>
</span><span id="line-4549"></span><span class="hs-comment">-- | Create an SVar with a fold consumer that will fold any elements sent to it</span><span>
</span><span id="line-4550"></span><span class="hs-comment">-- using the supplied fold function.</span><span>
</span><span id="line-4551"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#newFoldSVar"><span class="hs-pragma hs-type">newFoldSVar</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4552"></span><span id="local-6989586621679314999"><span id="local-6989586621679315000"><span id="local-6989586621679315001"><span id="local-6989586621679315002"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#newFoldSVar"><span class="hs-identifier hs-type">newFoldSVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315001"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315000"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315000"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314999"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679315002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#SVar"><span class="hs-identifier hs-type">SVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315001"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315000"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-4553"></span><span id="newFoldSVar"><span class="annot"><span class="annottext">newFoldSVar :: State t m a -&gt; Fold m a b -&gt; m (SVar t m a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#newFoldSVar"><span class="hs-identifier hs-var hs-var">newFoldSVar</span></a></span></span><span> </span><span id="local-6989586621679311702"><span class="annot"><span class="annottext">State t m a
</span><a href="#local-6989586621679311702"><span class="hs-identifier hs-var">stt</span></a></span></span><span> </span><span id="local-6989586621679311701"><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679311701"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4554"></span><span>    </span><span class="hs-comment">-- Buffer size for the SVar is derived from the current state</span><span>
</span><span id="line-4555"></span><span>    </span><span id="local-6989586621679311700"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311700"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SVarStopStyle -&gt; State t m a -&gt; m (SVar t m a)
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadAsync m =&gt;
SVarStopStyle -&gt; State t m a -&gt; m (SVar t m a)
</span><a href="Streamly.Internal.Data.SVar.html#newParallelVar"><span class="hs-identifier hs-var">newParallelVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVarStopStyle
</span><a href="Streamly.Internal.Data.SVar.html#StopAny"><span class="hs-identifier hs-var">StopAny</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State t m a -&gt; State t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State t m a
</span><a href="#local-6989586621679311702"><span class="hs-identifier hs-var">stt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4556"></span><span>    </span><span class="hs-comment">-- Add the producer thread-id to the SVar.</span><span>
</span><span id="line-4557"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; m ThreadId
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span> </span><span class="annot"><span class="annottext">m ThreadId -&gt; (ThreadId -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; ThreadId -&gt; m ()
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadIO m =&gt;
SVar t m a -&gt; ThreadId -&gt; m ()
</span><a href="Streamly.Internal.Data.SVar.html#modifyThread"><span class="hs-identifier hs-var">modifyThread</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311700"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-4558"></span><span>    </span><span class="annot"><span class="annottext">m ThreadId -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m ThreadId -&gt; m ()) -&gt; m ThreadId -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
forall (m :: * -&gt; *).
MonadBaseControl IO m =&gt;
m () -&gt; RunInIO m -&gt; (SomeException -&gt; IO ()) -&gt; m ThreadId
</span><a href="Streamly.Internal.Data.SVar.html#doFork"><span class="hs-identifier hs-var">doFork</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; m ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *). SVar t m a -&gt; m ()
</span><a href="#local-6989586621679311699"><span class="hs-identifier hs-var">work</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311700"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; RunInIO m
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; RunInIO m
</span><a href="Streamly.Internal.Data.SVar.html#svarMrun"><span class="hs-identifier hs-var hs-var">svarMrun</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311700"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar t m a -&gt; SomeException -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; SomeException -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#handleFoldException"><span class="hs-identifier hs-var">handleFoldException</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311700"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4559"></span><span>    </span><span class="annot"><span class="annottext">SVar t m a -&gt; m (SVar t m a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311700"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-4560"></span><span>
</span><span id="line-4561"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4562"></span><span>
</span><span id="line-4563"></span><span>    </span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="#local-6989586621679311699"><span class="hs-pragma hs-type">work</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4564"></span><span>    </span><span id="local-6989586621679311699"><span class="annot"><span class="annottext">work :: SVar t m a -&gt; m ()
</span><a href="#local-6989586621679311699"><span class="hs-identifier hs-var hs-var">work</span></a></span></span><span> </span><span id="local-6989586621679311697"><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311697"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m b -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m b -&gt; m ()) -&gt; m b -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fold m a b -&gt; Stream m a -&gt; m b
forall (m :: * -&gt; *) a b.
Monad m =&gt;
Fold m a b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#runFold"><span class="hs-identifier hs-var">runFold</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679311701"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream m a -&gt; m b) -&gt; Stream m a -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar t m a -&gt; Stream m a
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a.
MonadAsync m =&gt;
SVar t m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#fromProducer"><span class="hs-identifier hs-var">fromProducer</span></a></span><span> </span><span class="annot"><span class="annottext">SVar t m a
</span><a href="#local-6989586621679311697"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-4565"></span><span>
</span><span id="line-4566"></span><span class="hs-keyword">data</span><span> </span><span id="TapState"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TapState"><span class="hs-identifier hs-var">TapState</span></a></span></span><span> </span><span id="local-6989586621679315018"><span class="annot"><a href="#local-6989586621679315018"><span class="hs-identifier hs-type">sv</span></a></span></span><span> </span><span id="local-6989586621679315017"><span class="annot"><a href="#local-6989586621679315017"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TapInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TapInit"><span class="hs-identifier hs-var">TapInit</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Tapping"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#Tapping"><span class="hs-identifier hs-var">Tapping</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315018"><span class="hs-identifier hs-type">sv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679315017"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="TapDone"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TapDone"><span class="hs-identifier hs-var">TapDone</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679315017"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-4567"></span><span>
</span><span id="line-4568"></span><span class="hs-pragma">{-# INLINE_NORMAL tapAsync #-}</span><span>
</span><span id="line-4569"></span><span id="local-6989586621679311691"><span id="local-6989586621679311692"><span id="local-6989586621679311693"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#tapAsync"><span class="hs-identifier hs-type">tapAsync</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311693"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311693"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311692"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311691"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311693"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311692"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311693"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311692"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-4570"></span><span id="tapAsync"><span class="annot"><span class="annottext">tapAsync :: Fold m a b -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#tapAsync"><span class="hs-identifier hs-var hs-var">tapAsync</span></a></span></span><span> </span><span id="local-6989586621679311690"><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679311690"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311689"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311689"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679311688"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311688"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; TapState (SVar Stream m a) s
 -&gt; m (Step (TapState (SVar Stream m a) s) a))
-&gt; TapState (SVar Stream m a) s -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; TapState (SVar Stream m a) s
-&gt; m (Step (TapState (SVar Stream m a) s) a)
</span><a href="#local-6989586621679311687"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">TapState (SVar Stream m a) s
forall sv st. TapState sv st
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TapInit"><span class="hs-identifier hs-var">TapInit</span></a></span><span>
</span><span id="line-4571"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4572"></span><span>
</span><span id="line-4573"></span><span>    </span><span id="local-6989586621679311686"><span class="annot"><span class="annottext">drainFold :: SVar Stream m a -&gt; m ()
</span><a href="#local-6989586621679311686"><span class="hs-identifier hs-var hs-var">drainFold</span></a></span></span><span> </span><span id="local-6989586621679311685"><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311685"><span class="hs-identifier hs-var">svr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4574"></span><span>            </span><span class="hs-comment">-- In general, a Stop event would come equipped with the result</span><span>
</span><span id="line-4575"></span><span>            </span><span class="hs-comment">-- of the fold. It is not used here but it would be useful in</span><span>
</span><span id="line-4576"></span><span>            </span><span class="hs-comment">-- applicative and distribute.</span><span>
</span><span id="line-4577"></span><span>            </span><span id="local-6989586621679311684"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679311684"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SVar Stream m a -&gt; m Bool
forall (m :: * -&gt; *) a. MonadAsync m =&gt; SVar Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.SVar.html#fromConsumer"><span class="hs-identifier hs-var">fromConsumer</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311685"><span class="hs-identifier hs-var">svr</span></a></span><span>
</span><span id="line-4578"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679311684"><span class="hs-identifier hs-var">done</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4579"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a -&gt; String -&gt; IO () -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; String -&gt; IO () -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#withDiagMVar"><span class="hs-identifier hs-var">withDiagMVar</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311685"><span class="hs-identifier hs-var">svr</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;teeToSVar: waiting to drain&quot;</span></span><span>
</span><span id="line-4580"></span><span>                       </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; IO ()
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar Stream m a -&gt; MVar ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; MVar ()
</span><a href="Streamly.Internal.Data.SVar.html#outputDoorBellFromConsumer"><span class="hs-identifier hs-var hs-var">outputDoorBellFromConsumer</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311685"><span class="hs-identifier hs-var">svr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4581"></span><span>                </span><span class="annot"><span class="annottext">SVar Stream m a -&gt; m ()
</span><a href="#local-6989586621679311686"><span class="hs-identifier hs-var">drainFold</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311685"><span class="hs-identifier hs-var">svr</span></a></span><span>
</span><span id="line-4582"></span><span>
</span><span id="line-4583"></span><span>    </span><span id="local-6989586621679311681"><span class="annot"><span class="annottext">stopFold :: SVar Stream m a -&gt; m ()
</span><a href="#local-6989586621679311681"><span class="hs-identifier hs-var hs-var">stopFold</span></a></span></span><span> </span><span id="local-6989586621679311680"><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311680"><span class="hs-identifier hs-var">svr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4584"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a -&gt; Maybe WorkerInfo -&gt; IO ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
SVar t m a -&gt; Maybe WorkerInfo -&gt; IO ()
</span><a href="Streamly.Internal.Data.SVar.html#sendStop"><span class="hs-identifier hs-var">sendStop</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311680"><span class="hs-identifier hs-var">svr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WorkerInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-4585"></span><span>            </span><span class="hs-comment">-- drain/wait until a stop event arrives from the fold.</span><span>
</span><span id="line-4586"></span><span>            </span><span class="annot"><span class="annottext">SVar Stream m a -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m, MonadThrow m) =&gt;
SVar Stream m a -&gt; m ()
</span><a href="#local-6989586621679311686"><span class="hs-identifier hs-var">drainFold</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311680"><span class="hs-identifier hs-var">svr</span></a></span><span>
</span><span id="line-4587"></span><span>
</span><span id="line-4588"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-4589"></span><span>    </span><span id="local-6989586621679311687"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; TapState (SVar Stream m a) s
-&gt; m (Step (TapState (SVar Stream m a) s) a)
</span><a href="#local-6989586621679311687"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679311678"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311678"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="annot"><span class="annottext">TapState (SVar Stream m a) s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TapInit"><span class="hs-identifier hs-var">TapInit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4590"></span><span>        </span><span id="local-6989586621679311677"><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311677"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; Fold m a b -&gt; m (SVar Stream m a)
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *) a b.
MonadAsync m =&gt;
State t m a -&gt; Fold m a b -&gt; m (SVar t m a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#newFoldSVar"><span class="hs-identifier hs-var">newFoldSVar</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311678"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679311690"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-4591"></span><span>        </span><span class="annot"><span class="annottext">Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (TapState (SVar Stream m a) s) a
 -&gt; m (Step (TapState (SVar Stream m a) s) a))
-&gt; Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TapState (SVar Stream m a) s
-&gt; Step (TapState (SVar Stream m a) s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar Stream m a -&gt; s -&gt; TapState (SVar Stream m a) s
forall sv st. sv -&gt; st -&gt; TapState sv st
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#Tapping"><span class="hs-identifier hs-var">Tapping</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311677"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311688"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4592"></span><span>
</span><span id="line-4593"></span><span>    </span><span class="annot"><a href="#local-6989586621679311687"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679311676"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311676"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#Tapping"><span class="hs-identifier hs-type">Tapping</span></a></span><span> </span><span id="local-6989586621679311675"><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311675"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span id="local-6989586621679311674"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311674"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4594"></span><span>        </span><span id="local-6989586621679311673"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311673"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311689"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311676"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311674"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4595"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311673"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4596"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311672"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311672"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679311671"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311671"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-4597"></span><span>                </span><span id="local-6989586621679311670"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679311670"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SVar Stream m a -&gt; a -&gt; m Bool
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
SVar Stream m a -&gt; a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.SVar.html#pushToFold"><span class="hs-identifier hs-var">pushToFold</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311675"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311672"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-4598"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679311670"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-4599"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4600"></span><span>                    </span><span class="hs-comment">-- XXX we do not need to wait synchronously here</span><span>
</span><span id="line-4601"></span><span>                    </span><span class="annot"><span class="annottext">SVar Stream m a -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m, MonadThrow m) =&gt;
SVar Stream m a -&gt; m ()
</span><a href="#local-6989586621679311681"><span class="hs-identifier hs-var">stopFold</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311675"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-4602"></span><span>                    </span><span class="annot"><span class="annottext">Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (TapState (SVar Stream m a) s) a
 -&gt; m (Step (TapState (SVar Stream m a) s) a))
-&gt; Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
-&gt; TapState (SVar Stream m a) s
-&gt; Step (TapState (SVar Stream m a) s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311672"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; TapState (SVar Stream m a) s
forall sv st. st -&gt; TapState sv st
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TapDone"><span class="hs-identifier hs-var">TapDone</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311671"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4603"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (TapState (SVar Stream m a) s) a
 -&gt; m (Step (TapState (SVar Stream m a) s) a))
-&gt; Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
-&gt; TapState (SVar Stream m a) s
-&gt; Step (TapState (SVar Stream m a) s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311672"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar Stream m a -&gt; s -&gt; TapState (SVar Stream m a) s
forall sv st. sv -&gt; st -&gt; TapState sv st
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#Tapping"><span class="hs-identifier hs-var">Tapping</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311675"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311671"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4604"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311669"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311669"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (TapState (SVar Stream m a) s) a
 -&gt; m (Step (TapState (SVar Stream m a) s) a))
-&gt; Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TapState (SVar Stream m a) s
-&gt; Step (TapState (SVar Stream m a) s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SVar Stream m a -&gt; s -&gt; TapState (SVar Stream m a) s
forall sv st. sv -&gt; st -&gt; TapState sv st
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#Tapping"><span class="hs-identifier hs-var">Tapping</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311675"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311669"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4605"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4606"></span><span>                </span><span class="annot"><span class="annottext">SVar Stream m a -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m, MonadThrow m) =&gt;
SVar Stream m a -&gt; m ()
</span><a href="#local-6989586621679311681"><span class="hs-identifier hs-var">stopFold</span></a></span><span> </span><span class="annot"><span class="annottext">SVar Stream m a
</span><a href="#local-6989586621679311675"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-4607"></span><span>                </span><span class="annot"><span class="annottext">Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (TapState (SVar Stream m a) s) a
 -&gt; m (Step (TapState (SVar Stream m a) s) a))
-&gt; Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Step (TapState (SVar Stream m a) s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4608"></span><span>
</span><span id="line-4609"></span><span>    </span><span class="annot"><a href="#local-6989586621679311687"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679311668"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311668"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TapDone"><span class="hs-identifier hs-type">TapDone</span></a></span><span> </span><span id="local-6989586621679311667"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311667"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4610"></span><span>        </span><span id="local-6989586621679311666"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311666"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311689"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311668"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311667"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4611"></span><span>        </span><span class="annot"><span class="annottext">Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (TapState (SVar Stream m a) s) a
 -&gt; m (Step (TapState (SVar Stream m a) s) a))
-&gt; Step (TapState (SVar Stream m a) s) a
-&gt; m (Step (TapState (SVar Stream m a) s) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311666"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4612"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311665"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311665"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679311664"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311664"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; TapState (SVar Stream m a) s
-&gt; Step (TapState (SVar Stream m a) s) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311665"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; TapState (SVar Stream m a) s
forall sv st. st -&gt; TapState sv st
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TapDone"><span class="hs-identifier hs-var">TapDone</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311664"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4613"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311663"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311663"><span class="hs-identifier hs-var">s</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TapState (SVar Stream m a) s
-&gt; Step (TapState (SVar Stream m a) s) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; TapState (SVar Stream m a) s
forall sv st. st -&gt; TapState sv st
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TapDone"><span class="hs-identifier hs-var">TapDone</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311663"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4614"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (TapState (SVar Stream m a) s) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4615"></span><span>
</span><span id="line-4616"></span><span class="hs-comment">-- XXX Exported from Array again as this fold is specific to Array</span><span>
</span><span id="line-4617"></span><span class="hs-comment">-- | Take last 'n' elements from the stream and discard the rest.</span><span>
</span><span id="line-4618"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#lastN"><span class="hs-pragma hs-type">lastN</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4619"></span><span id="local-6989586621679311661"><span id="local-6989586621679311662"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#lastN"><span class="hs-identifier hs-type">lastN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679311662"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679311661"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311661"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311662"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311662"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-4620"></span><span id="lastN"><span class="annot"><span class="annottext">lastN :: Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#lastN"><span class="hs-identifier hs-var hs-var">lastN</span></a></span></span><span> </span><span id="local-6989586621679311660"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311660"><span class="hs-identifier hs-var">n</span></a></span></span><span>
</span><span id="line-4621"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311660"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() -&gt; Array a) -&gt; Fold m a () -&gt; Fold m a (Array a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array a -&gt; () -&gt; Array a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Array a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Fold m a ()
forall (m :: * -&gt; *) a. Monad m =&gt; Fold m a ()
</span><a href="Streamly.Internal.Data.Fold.html#drain"><span class="hs-identifier hs-var">FL.drain</span></a></span><span>
</span><span id="line-4622"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Array a -&gt; Array a
forall a. Array a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Types.html#unsafeFreeze"><span class="hs-identifier hs-var">A.unsafeFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">(Array a -&gt; Array a) -&gt; Fold m a (Array a) -&gt; Fold m a (Array a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Tuple3' (Ring a) (Ptr a) Int
 -&gt; a -&gt; m (Tuple3' (Ring a) (Ptr a) Int))
-&gt; m (Tuple3' (Ring a) (Ptr a) Int)
-&gt; (Tuple3' (Ring a) (Ptr a) Int -&gt; m (Array a))
-&gt; Fold m a (Array a)
forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m s) -&gt; m s -&gt; (s -&gt; m b) -&gt; Fold m a b
</span><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-var">Fold</span></a></span><span> </span><span class="annot"><span class="annottext">Tuple3' (Ring a) (Ptr a) Int
-&gt; a -&gt; m (Tuple3' (Ring a) (Ptr a) Int)
forall (m :: * -&gt; *) a c.
(MonadIO m, Storable a, Num c) =&gt;
Tuple3' (Ring a) (Ptr a) c -&gt; a -&gt; m (Tuple3' (Ring a) (Ptr a) c)
</span><a href="#local-6989586621679311656"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">m (Tuple3' (Ring a) (Ptr a) Int)
</span><a href="#local-6989586621679311655"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">Tuple3' (Ring a) (Ptr a) Int -&gt; m (Array a)
forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Tuple3' (Ring a) (Ptr a) Int -&gt; m (Array a)
</span><a href="#local-6989586621679311654"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-4623"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4624"></span><span>    </span><span id="local-6989586621679311656"><span class="annot"><span class="annottext">step :: Tuple3' (Ring a) (Ptr a) c -&gt; a -&gt; m (Tuple3' (Ring a) (Ptr a) c)
</span><a href="#local-6989586621679311656"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier hs-type">Tuple3'</span></a></span><span> </span><span id="local-6989586621679311652"><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679311652"><span class="hs-identifier hs-var">rb</span></a></span></span><span> </span><span id="local-6989586621679311651"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679311651"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span id="local-6989586621679311650"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679311650"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679311649"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311649"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4625"></span><span>        </span><span id="local-6989586621679311648"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679311648"><span class="hs-identifier hs-var">rh1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Ptr a) -&gt; m (Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Ptr a) -&gt; m (Ptr a)) -&gt; IO (Ptr a) -&gt; m (Ptr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
forall a. Storable a =&gt; Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
</span><a href="Streamly.Memory.Ring.html#unsafeInsert"><span class="hs-identifier hs-var">RB.unsafeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679311652"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679311651"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311649"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-4626"></span><span>        </span><span class="annot"><span class="annottext">Tuple3' (Ring a) (Ptr a) c -&gt; m (Tuple3' (Ring a) (Ptr a) c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Tuple3' (Ring a) (Ptr a) c -&gt; m (Tuple3' (Ring a) (Ptr a) c))
-&gt; Tuple3' (Ring a) (Ptr a) c -&gt; m (Tuple3' (Ring a) (Ptr a) c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; c -&gt; Tuple3' (Ring a) (Ptr a) c
forall a b c. a -&gt; b -&gt; c -&gt; Tuple3' a b c
</span><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679311652"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679311648"><span class="hs-identifier hs-var">rh1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679311650"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">c -&gt; c -&gt; c
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-4627"></span><span>    </span><span id="local-6989586621679311655"><span class="annot"><span class="annottext">initial :: m (Tuple3' (Ring a) (Ptr a) Int)
</span><a href="#local-6989586621679311655"><span class="hs-identifier hs-var hs-var">initial</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Ring a, Ptr a) -&gt; Tuple3' (Ring a) (Ptr a) Int)
-&gt; m (Ring a, Ptr a) -&gt; m (Tuple3' (Ring a) (Ptr a) Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679311647"><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679311647"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311646"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679311646"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ring a -&gt; Ptr a -&gt; Int -&gt; Tuple3' (Ring a) (Ptr a) Int
forall a b c. a -&gt; b -&gt; c -&gt; Tuple3' a b c
</span><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679311647"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679311646"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Ring a, Ptr a) -&gt; m (Tuple3' (Ring a) (Ptr a) Int))
-&gt; m (Ring a, Ptr a) -&gt; m (Tuple3' (Ring a) (Ptr a) Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Ring a, Ptr a) -&gt; m (Ring a, Ptr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Ring a, Ptr a) -&gt; m (Ring a, Ptr a))
-&gt; IO (Ring a, Ptr a) -&gt; m (Ring a, Ptr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (Ring a, Ptr a)
forall a. Storable a =&gt; Int -&gt; IO (Ring a, Ptr a)
</span><a href="Streamly.Memory.Ring.html#new"><span class="hs-identifier hs-var">RB.new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311660"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-4628"></span><span>    </span><span id="local-6989586621679311654"><span class="annot"><span class="annottext">done :: Tuple3' (Ring a) (Ptr a) Int -&gt; m (Array a)
</span><a href="#local-6989586621679311654"><span class="hs-identifier hs-var hs-var">done</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier hs-type">Tuple3'</span></a></span><span> </span><span id="local-6989586621679311645"><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679311645"><span class="hs-identifier hs-var">rb</span></a></span></span><span> </span><span id="local-6989586621679311644"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679311644"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span id="local-6989586621679311643"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311643"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4629"></span><span>        </span><span id="local-6989586621679311642"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679311642"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Array a) -&gt; m (Array a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Array a) -&gt; m (Array a)) -&gt; IO (Array a) -&gt; m (Array a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (Array a)
forall a. Storable a =&gt; Int -&gt; IO (Array a)
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Mut.Types.html#newArray"><span class="hs-identifier hs-var">MA.newArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311660"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-4630"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; Ptr a
-&gt; (Array a -&gt; a -&gt; m (Array a))
-&gt; Array a
-&gt; Ring a
-&gt; m (Array a)
forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Int -&gt; Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="#local-6989586621679311640"><span class="hs-identifier hs-var">foldFunc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311643"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679311644"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">Array a -&gt; a -&gt; m (Array a)
forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="#local-6989586621679311639"><span class="hs-identifier hs-var">snoc'</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679311642"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679311645"><span class="hs-identifier hs-var">rb</span></a></span><span>
</span><span id="line-4631"></span><span>    </span><span id="local-6989586621679311639"><span class="annot"><span class="annottext">snoc' :: Array a -&gt; a -&gt; m (Array a)
</span><a href="#local-6989586621679311639"><span class="hs-identifier hs-var hs-var">snoc'</span></a></span></span><span> </span><span id="local-6989586621679311638"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679311638"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679311637"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311637"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Array a) -&gt; m (Array a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Array a) -&gt; m (Array a)) -&gt; IO (Array a) -&gt; m (Array a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array a -&gt; a -&gt; IO (Array a)
forall a. Storable a =&gt; Array a -&gt; a -&gt; IO (Array a)
</span><a href="Streamly.Internal.Data.Array.Storable.Foreign.Mut.Types.html#unsafeSnoc"><span class="hs-identifier hs-var">MA.unsafeSnoc</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679311638"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311637"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-4632"></span><span>    </span><span id="local-6989586621679311640"><span class="annot"><span class="annottext">foldFunc :: Int -&gt; Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="#local-6989586621679311640"><span class="hs-identifier hs-var hs-var">foldFunc</span></a></span></span><span> </span><span id="local-6989586621679311635"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311635"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-4633"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311635"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679311660"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="Streamly.Memory.Ring.html#unsafeFoldRingM"><span class="hs-identifier hs-var">RB.unsafeFoldRingM</span></a></span><span>
</span><span id="line-4634"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="Streamly.Memory.Ring.html#unsafeFoldRingFullM"><span class="hs-identifier hs-var">RB.unsafeFoldRingFullM</span></a></span><span>
</span><span id="line-4635"></span><span>
</span><span id="line-4636"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4637"></span><span class="hs-comment">-- Time related</span><span>
</span><span id="line-4638"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-4639"></span><span>
</span><span id="line-4640"></span><span class="hs-comment">-- XXX using getTime in the loop can be pretty expensive especially for</span><span>
</span><span id="line-4641"></span><span class="hs-comment">-- computations where iterations are lightweight. We have the following</span><span>
</span><span id="line-4642"></span><span class="hs-comment">-- options:</span><span>
</span><span id="line-4643"></span><span class="hs-comment">--</span><span>
</span><span id="line-4644"></span><span class="hs-comment">-- 1) Run a timeout thread updating a flag asynchronously and check that</span><span>
</span><span id="line-4645"></span><span class="hs-comment">-- flag here, that way we can have a cheap termination check.</span><span>
</span><span id="line-4646"></span><span class="hs-comment">--</span><span>
</span><span id="line-4647"></span><span class="hs-comment">-- 2) Use COARSE clock to get time with lower resolution but more efficiently.</span><span>
</span><span id="line-4648"></span><span class="hs-comment">--</span><span>
</span><span id="line-4649"></span><span class="hs-comment">-- 3) Use rdtscp/rdtsc to get time directly from the processor, compute the</span><span>
</span><span id="line-4650"></span><span class="hs-comment">-- termination value of rdtsc in the beginning and then in each iteration just</span><span>
</span><span id="line-4651"></span><span class="hs-comment">-- get rdtsc and check if we should terminate.</span><span>
</span><span id="line-4652"></span><span class="hs-comment">--</span><span>
</span><span id="line-4653"></span><span class="hs-keyword">data</span><span> </span><span id="TakeByTime"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTime"><span class="hs-identifier hs-var">TakeByTime</span></a></span></span><span> </span><span id="local-6989586621679314962"><span class="annot"><a href="#local-6989586621679314962"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679314961"><span class="annot"><a href="#local-6989586621679314961"><span class="hs-identifier hs-type">s</span></a></span></span><span>
</span><span id="line-4654"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="TakeByTimeInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeInit"><span class="hs-identifier hs-var">TakeByTimeInit</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679314962"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-4655"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TakeByTimeCheck"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeCheck"><span class="hs-identifier hs-var">TakeByTimeCheck</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679314962"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314961"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4656"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TakeByTimeYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeYield"><span class="hs-identifier hs-var">TakeByTimeYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679314962"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314961"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4657"></span><span>
</span><span id="line-4658"></span><span class="hs-pragma">{-# INLINE_NORMAL takeByTime #-}</span><span>
</span><span id="line-4659"></span><span id="local-6989586621679311629"><span id="local-6989586621679311630"><span id="local-6989586621679311631"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#takeByTime"><span class="hs-identifier hs-type">takeByTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679311631"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#TimeUnit64"><span class="hs-identifier hs-type">TimeUnit64</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311630"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311630"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311629"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311629"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-4660"></span><span id="takeByTime"><span class="annot"><span class="annottext">takeByTime :: t -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#takeByTime"><span class="hs-identifier hs-var hs-var">takeByTime</span></a></span></span><span> </span><span id="local-6989586621679311628"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679311628"><span class="hs-identifier hs-var">duration</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311627"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311627"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679311626"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311626"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; TakeByTime s AbsTime -&gt; m (Step (TakeByTime s AbsTime) a))
-&gt; TakeByTime s AbsTime -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; TakeByTime s AbsTime -&gt; m (Step (TakeByTime s AbsTime) a)
</span><a href="#local-6989586621679311625"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; TakeByTime s AbsTime
forall st s. st -&gt; TakeByTime st s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeInit"><span class="hs-identifier hs-var">TakeByTimeInit</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311626"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4661"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4662"></span><span>
</span><span id="line-4663"></span><span>    </span><span id="local-6989586621679311624"><span class="annot"><span class="annottext">lim :: RelTime64
</span><a href="#local-6989586621679311624"><span class="hs-identifier hs-var hs-var">lim</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; RelTime64
forall a. TimeUnit64 a =&gt; a -&gt; RelTime64
</span><a href="Streamly.Internal.Data.Time.Units.html#toRelTime64"><span class="hs-identifier hs-var">toRelTime64</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679311628"><span class="hs-identifier hs-var">duration</span></a></span><span>
</span><span id="line-4664"></span><span>
</span><span id="line-4665"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-4666"></span><span>    </span><span id="local-6989586621679311625"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; TakeByTime s AbsTime -&gt; m (Step (TakeByTime s AbsTime) a)
</span><a href="#local-6989586621679311625"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeInit"><span class="hs-identifier hs-type">TakeByTimeInit</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RelTime64
</span><a href="#local-6989586621679311624"><span class="hs-identifier hs-var">lim</span></a></span><span> </span><span class="annot"><span class="annottext">RelTime64 -&gt; RelTime64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RelTime64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Step (TakeByTime s AbsTime) a -&gt; m (Step (TakeByTime s AbsTime) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Step (TakeByTime s AbsTime) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4667"></span><span>    </span><span class="annot"><a href="#local-6989586621679311625"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeInit"><span class="hs-identifier hs-type">TakeByTimeInit</span></a></span><span> </span><span id="local-6989586621679311623"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311623"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4668"></span><span>        </span><span id="local-6989586621679311622"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311622"><span class="hs-identifier hs-var">t0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AbsTime -&gt; m AbsTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO AbsTime -&gt; m AbsTime) -&gt; IO AbsTime -&gt; m AbsTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO AbsTime
</span><a href="Streamly.Internal.Data.Time.Clock.html#getTime"><span class="hs-identifier hs-var">getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="Streamly.Internal.Data.Time.Clock.html#Monotonic"><span class="hs-identifier hs-var">Monotonic</span></a></span><span>
</span><span id="line-4669"></span><span>        </span><span class="annot"><span class="annottext">Step (TakeByTime s AbsTime) a -&gt; m (Step (TakeByTime s AbsTime) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (TakeByTime s AbsTime) a
 -&gt; m (Step (TakeByTime s AbsTime) a))
-&gt; Step (TakeByTime s AbsTime) a
-&gt; m (Step (TakeByTime s AbsTime) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TakeByTime s AbsTime -&gt; Step (TakeByTime s AbsTime) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AbsTime -&gt; TakeByTime s AbsTime
forall st s. st -&gt; s -&gt; TakeByTime st s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeYield"><span class="hs-identifier hs-var">TakeByTimeYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311623"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311622"><span class="hs-identifier hs-var">t0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4670"></span><span>    </span><span class="annot"><a href="#local-6989586621679311625"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeCheck"><span class="hs-identifier hs-type">TakeByTimeCheck</span></a></span><span> </span><span id="local-6989586621679311621"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311621"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679311620"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311620"><span class="hs-identifier hs-var">t0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4671"></span><span>        </span><span id="local-6989586621679311619"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311619"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AbsTime -&gt; m AbsTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO AbsTime -&gt; m AbsTime) -&gt; IO AbsTime -&gt; m AbsTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO AbsTime
</span><a href="Streamly.Internal.Data.Time.Clock.html#getTime"><span class="hs-identifier hs-var">getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="Streamly.Internal.Data.Time.Clock.html#Monotonic"><span class="hs-identifier hs-var">Monotonic</span></a></span><span>
</span><span id="line-4672"></span><span>        </span><span class="annot"><span class="annottext">Step (TakeByTime s AbsTime) a -&gt; m (Step (TakeByTime s AbsTime) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (TakeByTime s AbsTime) a
 -&gt; m (Step (TakeByTime s AbsTime) a))
-&gt; Step (TakeByTime s AbsTime) a
-&gt; m (Step (TakeByTime s AbsTime) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-4673"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">AbsTime -&gt; AbsTime -&gt; RelTime64
</span><a href="Streamly.Internal.Data.Time.Units.html#diffAbsTime64"><span class="hs-identifier hs-var">diffAbsTime64</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311619"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311620"><span class="hs-identifier hs-var">t0</span></a></span><span> </span><span class="annot"><span class="annottext">RelTime64 -&gt; RelTime64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">RelTime64
</span><a href="#local-6989586621679311624"><span class="hs-identifier hs-var">lim</span></a></span><span>
</span><span id="line-4674"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (TakeByTime s AbsTime) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4675"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TakeByTime s AbsTime -&gt; Step (TakeByTime s AbsTime) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AbsTime -&gt; TakeByTime s AbsTime
forall st s. st -&gt; s -&gt; TakeByTime st s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeYield"><span class="hs-identifier hs-var">TakeByTimeYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311621"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311620"><span class="hs-identifier hs-var">t0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4676"></span><span>    </span><span class="annot"><a href="#local-6989586621679311625"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679311618"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311618"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeYield"><span class="hs-identifier hs-type">TakeByTimeYield</span></a></span><span> </span><span id="local-6989586621679311617"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311617"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679311616"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311616"><span class="hs-identifier hs-var">t0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4677"></span><span>        </span><span id="local-6989586621679311615"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311615"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311627"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311618"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311617"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4678"></span><span>        </span><span class="annot"><span class="annottext">Step (TakeByTime s AbsTime) a -&gt; m (Step (TakeByTime s AbsTime) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (TakeByTime s AbsTime) a
 -&gt; m (Step (TakeByTime s AbsTime) a))
-&gt; Step (TakeByTime s AbsTime) a
-&gt; m (Step (TakeByTime s AbsTime) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311615"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4679"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311614"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311614"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311613"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311613"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; TakeByTime s AbsTime -&gt; Step (TakeByTime s AbsTime) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311614"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AbsTime -&gt; TakeByTime s AbsTime
forall st s. st -&gt; s -&gt; TakeByTime st s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeCheck"><span class="hs-identifier hs-var">TakeByTimeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311613"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311616"><span class="hs-identifier hs-var">t0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4680"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311612"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311612"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TakeByTime s AbsTime -&gt; Step (TakeByTime s AbsTime) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AbsTime -&gt; TakeByTime s AbsTime
forall st s. st -&gt; s -&gt; TakeByTime st s
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#TakeByTimeCheck"><span class="hs-identifier hs-var">TakeByTimeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311612"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311616"><span class="hs-identifier hs-var">t0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4681"></span><span>             </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (TakeByTime s AbsTime) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4682"></span><span>
</span><span id="line-4683"></span><span class="hs-keyword">data</span><span> </span><span id="DropByTime"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTime"><span class="hs-identifier hs-var">DropByTime</span></a></span></span><span> </span><span id="local-6989586621679314952"><span class="annot"><a href="#local-6989586621679314952"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679314951"><span class="annot"><a href="#local-6989586621679314951"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679314950"><span class="annot"><a href="#local-6989586621679314950"><span class="hs-identifier hs-type">x</span></a></span></span><span>
</span><span id="line-4684"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="DropByTimeInit"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeInit"><span class="hs-identifier hs-var">DropByTimeInit</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679314952"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-4685"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DropByTimeGen"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeGen"><span class="hs-identifier hs-var">DropByTimeGen</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679314952"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314951"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-4686"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DropByTimeCheck"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeCheck"><span class="hs-identifier hs-var">DropByTimeCheck</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679314952"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314951"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679314950"><span class="hs-identifier hs-type">x</span></a></span><span>
</span><span id="line-4687"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DropByTimeYield"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeYield"><span class="hs-identifier hs-var">DropByTimeYield</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679314952"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-4688"></span><span>
</span><span id="line-4689"></span><span class="hs-pragma">{-# INLINE_NORMAL dropByTime #-}</span><span>
</span><span id="line-4690"></span><span id="local-6989586621679311605"><span id="local-6989586621679311606"><span id="local-6989586621679311607"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#dropByTime"><span class="hs-identifier hs-type">dropByTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679311607"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#TimeUnit64"><span class="hs-identifier hs-type">TimeUnit64</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311606"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679311606"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311607"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311605"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311607"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311605"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-4691"></span><span id="dropByTime"><span class="annot"><span class="annottext">dropByTime :: t -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#dropByTime"><span class="hs-identifier hs-var hs-var">dropByTime</span></a></span></span><span> </span><span id="local-6989586621679311604"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679311604"><span class="hs-identifier hs-var">duration</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679311603"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311603"><span class="hs-identifier hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679311602"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311602"><span class="hs-identifier hs-var">state1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m a
 -&gt; DropByTime s AbsTime a -&gt; m (Step (DropByTime s AbsTime a) a))
-&gt; DropByTime s AbsTime a -&gt; Stream m a
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; DropByTime s AbsTime a -&gt; m (Step (DropByTime s AbsTime a) a)
</span><a href="#local-6989586621679311601"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; DropByTime s AbsTime a
forall st s x. st -&gt; DropByTime st s x
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeInit"><span class="hs-identifier hs-var">DropByTimeInit</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311602"><span class="hs-identifier hs-var">state1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4692"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4693"></span><span>
</span><span id="line-4694"></span><span>    </span><span id="local-6989586621679311600"><span class="annot"><span class="annottext">lim :: RelTime64
</span><a href="#local-6989586621679311600"><span class="hs-identifier hs-var hs-var">lim</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; RelTime64
forall a. TimeUnit64 a =&gt; a -&gt; RelTime64
</span><a href="Streamly.Internal.Data.Time.Units.html#toRelTime64"><span class="hs-identifier hs-var">toRelTime64</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679311604"><span class="hs-identifier hs-var">duration</span></a></span><span>
</span><span id="line-4695"></span><span>
</span><span id="line-4696"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-4697"></span><span>    </span><span id="local-6989586621679311601"><span class="annot"><span class="annottext">step :: State Stream m a
-&gt; DropByTime s AbsTime a -&gt; m (Step (DropByTime s AbsTime a) a)
</span><a href="#local-6989586621679311601"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeInit"><span class="hs-identifier hs-type">DropByTimeInit</span></a></span><span> </span><span id="local-6989586621679311599"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311599"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4698"></span><span>        </span><span id="local-6989586621679311598"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311598"><span class="hs-identifier hs-var">t0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AbsTime -&gt; m AbsTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO AbsTime -&gt; m AbsTime) -&gt; IO AbsTime -&gt; m AbsTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO AbsTime
</span><a href="Streamly.Internal.Data.Time.Clock.html#getTime"><span class="hs-identifier hs-var">getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="Streamly.Internal.Data.Time.Clock.html#Monotonic"><span class="hs-identifier hs-var">Monotonic</span></a></span><span>
</span><span id="line-4699"></span><span>        </span><span class="annot"><span class="annottext">Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropByTime s AbsTime a) a
 -&gt; m (Step (DropByTime s AbsTime a) a))
-&gt; Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AbsTime -&gt; DropByTime s AbsTime a
forall st s x. st -&gt; s -&gt; DropByTime st s x
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeGen"><span class="hs-identifier hs-var">DropByTimeGen</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311599"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311598"><span class="hs-identifier hs-var">t0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4700"></span><span>    </span><span class="annot"><a href="#local-6989586621679311601"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679311597"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311597"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeGen"><span class="hs-identifier hs-type">DropByTimeGen</span></a></span><span> </span><span id="local-6989586621679311596"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311596"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679311595"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311595"><span class="hs-identifier hs-var">t0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4701"></span><span>        </span><span id="local-6989586621679311594"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311594"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311603"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311597"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311596"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4702"></span><span>        </span><span class="annot"><span class="annottext">Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropByTime s AbsTime a) a
 -&gt; m (Step (DropByTime s AbsTime a) a))
-&gt; Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311594"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4703"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311593"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311593"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311592"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311592"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AbsTime -&gt; a -&gt; DropByTime s AbsTime a
forall st s x. st -&gt; s -&gt; x -&gt; DropByTime st s x
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeCheck"><span class="hs-identifier hs-var">DropByTimeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311592"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311595"><span class="hs-identifier hs-var">t0</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311593"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4704"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311591"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311591"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; AbsTime -&gt; DropByTime s AbsTime a
forall st s x. st -&gt; s -&gt; DropByTime st s x
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeGen"><span class="hs-identifier hs-var">DropByTimeGen</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311591"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311595"><span class="hs-identifier hs-var">t0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4705"></span><span>             </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (DropByTime s AbsTime a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4706"></span><span>    </span><span class="annot"><a href="#local-6989586621679311601"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeCheck"><span class="hs-identifier hs-type">DropByTimeCheck</span></a></span><span> </span><span id="local-6989586621679311590"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311590"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679311589"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311589"><span class="hs-identifier hs-var">t0</span></a></span></span><span> </span><span id="local-6989586621679311588"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311588"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4707"></span><span>        </span><span id="local-6989586621679311587"><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311587"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AbsTime -&gt; m AbsTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO AbsTime -&gt; m AbsTime) -&gt; IO AbsTime -&gt; m AbsTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO AbsTime
</span><a href="Streamly.Internal.Data.Time.Clock.html#getTime"><span class="hs-identifier hs-var">getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="Streamly.Internal.Data.Time.Clock.html#Monotonic"><span class="hs-identifier hs-var">Monotonic</span></a></span><span>
</span><span id="line-4708"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">AbsTime -&gt; AbsTime -&gt; RelTime64
</span><a href="Streamly.Internal.Data.Time.Units.html#diffAbsTime64"><span class="hs-identifier hs-var">diffAbsTime64</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311587"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311589"><span class="hs-identifier hs-var">t0</span></a></span><span> </span><span class="annot"><span class="annottext">RelTime64 -&gt; RelTime64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">RelTime64
</span><a href="#local-6989586621679311600"><span class="hs-identifier hs-var">lim</span></a></span><span>
</span><span id="line-4709"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropByTime s AbsTime a) a
 -&gt; m (Step (DropByTime s AbsTime a) a))
-&gt; Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a)
-&gt; DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; AbsTime -&gt; DropByTime s AbsTime a
forall st s x. st -&gt; s -&gt; DropByTime st s x
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeGen"><span class="hs-identifier hs-var">DropByTimeGen</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311590"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">AbsTime
</span><a href="#local-6989586621679311589"><span class="hs-identifier hs-var">t0</span></a></span><span>
</span><span id="line-4710"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropByTime s AbsTime a) a
 -&gt; m (Step (DropByTime s AbsTime a) a))
-&gt; Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311588"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a)
-&gt; DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; DropByTime s AbsTime a
forall st s x. st -&gt; DropByTime st s x
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeYield"><span class="hs-identifier hs-var">DropByTimeYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311590"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4711"></span><span>    </span><span class="annot"><a href="#local-6989586621679311601"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679311586"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311586"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeYield"><span class="hs-identifier hs-type">DropByTimeYield</span></a></span><span> </span><span id="local-6989586621679311585"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311585"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4712"></span><span>        </span><span id="local-6989586621679311584"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311584"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679311603"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679311586"><span class="hs-identifier hs-var">gst</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311585"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-4713"></span><span>        </span><span class="annot"><span class="annottext">Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (DropByTime s AbsTime a) a
 -&gt; m (Step (DropByTime s AbsTime a) a))
-&gt; Step (DropByTime s AbsTime a) a
-&gt; m (Step (DropByTime s AbsTime a) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679311584"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4714"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-type">Yield</span></a></span><span> </span><span id="local-6989586621679311583"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311583"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679311582"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311582"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311583"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; DropByTime s AbsTime a
forall st s x. st -&gt; DropByTime st s x
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeYield"><span class="hs-identifier hs-var">DropByTimeYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311582"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4715"></span><span>             </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-type">Skip</span></a></span><span> </span><span id="local-6989586621679311581"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311581"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DropByTime s AbsTime a -&gt; Step (DropByTime s AbsTime a) a
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; DropByTime s AbsTime a
forall st s x. st -&gt; DropByTime st s x
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#DropByTimeYield"><span class="hs-identifier hs-var">DropByTimeYield</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679311581"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4716"></span><span>             </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Step (DropByTime s AbsTime a) a
forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span>
</span><span id="line-4717"></span><span>
</span><span id="line-4718"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#updateTimeVar"><span class="hs-pragma hs-type">updateTimeVar</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4719"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#updateTimeVar"><span class="hs-identifier hs-type">updateTimeVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.IORef.Prim.html#IORef"><span class="hs-identifier hs-type">Prim.IORef</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-4720"></span><span id="updateTimeVar"><span class="annot"><span class="annottext">updateTimeVar :: IORef Int64 -&gt; IO ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#updateTimeVar"><span class="hs-identifier hs-var hs-var">updateTimeVar</span></a></span></span><span> </span><span id="local-6989586621679311579"><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311579"><span class="hs-identifier hs-var">timeVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4721"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#MicroSecond64"><span class="hs-identifier hs-type">MicroSecond64</span></a></span><span> </span><span id="local-6989586621679311577"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679311577"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AbsTime -&gt; MicroSecond64
forall a. TimeUnit a =&gt; AbsTime -&gt; a
</span><a href="Streamly.Internal.Data.Time.Units.html#fromAbsTime"><span class="hs-identifier hs-var">fromAbsTime</span></a></span><span> </span><span class="annot"><span class="annottext">(AbsTime -&gt; MicroSecond64) -&gt; IO AbsTime -&gt; IO MicroSecond64
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO AbsTime
</span><a href="Streamly.Internal.Data.Time.Clock.html#getTime"><span class="hs-identifier hs-var">getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="Streamly.Internal.Data.Time.Clock.html#Monotonic"><span class="hs-identifier hs-var">Monotonic</span></a></span><span>
</span><span id="line-4722"></span><span>    </span><span class="annot"><span class="annottext">IORef Int64 -&gt; (Int64 -&gt; Int64) -&gt; IO ()
forall a. Prim a =&gt; IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><a href="Streamly.Internal.Data.IORef.Prim.html#modifyIORef%27"><span class="hs-identifier hs-var">Prim.modifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311579"><span class="hs-identifier hs-var">timeVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; Int64 -&gt; Int64
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679311577"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4723"></span><span>
</span><span id="line-4724"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#updateWithDelay"><span class="hs-pragma hs-type">updateWithDelay</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4725"></span><span id="local-6989586621679314937"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#updateWithDelay"><span class="hs-identifier hs-type">updateWithDelay</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RealFrac</span></span><span> </span><span class="annot"><a href="#local-6989586621679314937"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679314937"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.IORef.Prim.html#IORef"><span class="hs-identifier hs-type">Prim.IORef</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-4726"></span><span id="updateWithDelay"><span class="annot"><span class="annottext">updateWithDelay :: a -&gt; IORef Int64 -&gt; IO ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#updateWithDelay"><span class="hs-identifier hs-var hs-var">updateWithDelay</span></a></span></span><span> </span><span id="local-6989586621679311575"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311575"><span class="hs-identifier hs-var">precision</span></a></span></span><span> </span><span id="local-6989586621679311574"><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311574"><span class="hs-identifier hs-var">timeVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4727"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Int
forall p a. (Bounded p, RealFrac a, Integral p) =&gt; a -&gt; p
</span><a href="#local-6989586621679311573"><span class="hs-identifier hs-var">delayTime</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311575"><span class="hs-identifier hs-var">precision</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4728"></span><span>    </span><span class="annot"><span class="annottext">IORef Int64 -&gt; IO ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#updateTimeVar"><span class="hs-identifier hs-var">updateTimeVar</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311574"><span class="hs-identifier hs-var">timeVar</span></a></span><span>
</span><span id="line-4729"></span><span>
</span><span id="line-4730"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4731"></span><span>
</span><span id="line-4732"></span><span>    </span><span class="hs-comment">-- Keep the minimum at least a millisecond to avoid high CPU usage</span><span>
</span><span id="line-4733"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679311573"><span class="hs-pragma hs-type">delayTime</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-4734"></span><span>    </span><span id="local-6989586621679311573"><span class="annot"><span class="annottext">delayTime :: a -&gt; p
</span><a href="#local-6989586621679311573"><span class="hs-identifier hs-var hs-var">delayTime</span></a></span></span><span> </span><span id="local-6989586621679311572"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311572"><span class="hs-identifier hs-var">g</span></a></span></span><span>
</span><span id="line-4735"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311571"><span class="hs-identifier hs-var">g'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
forall a. Bounded a =&gt; a
</span><span class="hs-identifier hs-var">maxBound</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
forall a. Bounded a =&gt; a
</span><span class="hs-identifier hs-var">maxBound</span></span><span>
</span><span id="line-4736"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311571"><span class="hs-identifier hs-var">g'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1000</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-number">1000</span></span><span>
</span><span id="line-4737"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">a -&gt; p
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">round</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311571"><span class="hs-identifier hs-var">g'</span></a></span><span>
</span><span id="line-4738"></span><span>
</span><span id="line-4739"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-4740"></span><span>
</span><span id="line-4741"></span><span>        </span><span id="local-6989586621679311571"><span class="annot"><span class="annottext">g' :: a
</span><a href="#local-6989586621679311571"><span class="hs-identifier hs-var hs-var">g'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679311572"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; a
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><span class="hs-operator hs-var">^</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">6</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-4742"></span><span>
</span><span id="line-4743"></span><span class="hs-comment">-- XXX we should move this to stream generation section of this file. Also, the</span><span>
</span><span id="line-4744"></span><span class="hs-comment">-- take/drop combinators above should be moved to filtering section.</span><span>
</span><span id="line-4745"></span><span>
</span><span id="line-4746"></span><span class="hs-pragma">{-# INLINE_NORMAL times #-}</span><span>
</span><span id="line-4747"></span><span id="local-6989586621679311570"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html#times"><span class="hs-identifier hs-type">times</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311570"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679311570"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#AbsTime"><span class="hs-identifier hs-type">AbsTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Time.Units.html#RelTime64"><span class="hs-identifier hs-type">RelTime64</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-4748"></span><span id="times"><span class="annot"><span class="annottext">times :: Double -&gt; Stream m (AbsTime, RelTime64)
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#times"><span class="hs-identifier hs-var hs-var">times</span></a></span></span><span> </span><span id="local-6989586621679311569"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679311569"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State Stream m (AbsTime, RelTime64)
 -&gt; Maybe (IORef Int64, ThreadId, Int64)
 -&gt; m (Step
         (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)))
-&gt; Maybe (IORef Int64, ThreadId, Int64)
-&gt; Stream m (AbsTime, RelTime64)
forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (AbsTime, RelTime64)
-&gt; Maybe (IORef Int64, ThreadId, Int64)
-&gt; m (Step
        (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64))
forall (m :: * -&gt; *) p.
(MonadIO m, MonadBaseControl IO m) =&gt;
p
-&gt; Maybe (IORef Int64, ThreadId, Int64)
-&gt; m (Step
        (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64))
</span><a href="#local-6989586621679311568"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int64, ThreadId, Int64)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-4749"></span><span>
</span><span id="line-4750"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-4751"></span><span>
</span><span id="line-4752"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-4753"></span><span>    </span><span id="local-6989586621679311568"><span class="annot"><span class="annottext">step :: p
-&gt; Maybe (IORef Int64, ThreadId, Int64)
-&gt; m (Step
        (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64))
</span><a href="#local-6989586621679311568"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int64, ThreadId, Int64)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4754"></span><span>        </span><span class="hs-comment">-- XXX note that this is safe only on a 64-bit machine. On a 32-bit</span><span>
</span><span id="line-4755"></span><span>        </span><span class="hs-comment">-- machine a 64-bit 'Var' cannot be read consistently without a lock</span><span>
</span><span id="line-4756"></span><span>        </span><span class="hs-comment">-- while another thread is writing to it.</span><span>
</span><span id="line-4757"></span><span>        </span><span id="local-6989586621679311567"><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311567"><span class="hs-identifier hs-var">timeVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef Int64) -&gt; m (IORef Int64)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef Int64) -&gt; m (IORef Int64))
-&gt; IO (IORef Int64) -&gt; m (IORef Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; IO (IORef Int64)
forall a. Prim a =&gt; a -&gt; IO (IORef a)
</span><a href="Streamly.Internal.Data.IORef.Prim.html#newIORef"><span class="hs-identifier hs-var">Prim.newIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-4758"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int64 -&gt; IO ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#updateTimeVar"><span class="hs-identifier hs-var">updateTimeVar</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311567"><span class="hs-identifier hs-var">timeVar</span></a></span><span>
</span><span id="line-4759"></span><span>        </span><span id="local-6989586621679311566"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679311566"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ThreadId
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m) =&gt;
m () -&gt; m ThreadId
</span><a href="Streamly.Internal.Data.SVar.html#forkManaged"><span class="hs-identifier hs-var">forkManaged</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ThreadId) -&gt; m () -&gt; m ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double -&gt; IORef Int64 -&gt; IO ()
forall a. RealFrac a =&gt; a -&gt; IORef Int64 -&gt; IO ()
</span><a href="Streamly.Internal.Data.Stream.StreamD.html#updateWithDelay"><span class="hs-identifier hs-var">updateWithDelay</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679311569"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311567"><span class="hs-identifier hs-var">timeVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4760"></span><span>        </span><span id="local-6989586621679311565"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679311565"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int64 -&gt; m Int64
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Int64 -&gt; m Int64) -&gt; IO Int64 -&gt; m Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int64 -&gt; IO Int64
forall a. Prim a =&gt; IORef a -&gt; IO a
</span><a href="Streamly.Internal.Data.IORef.Prim.html#readIORef"><span class="hs-identifier hs-var">Prim.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311567"><span class="hs-identifier hs-var">timeVar</span></a></span><span>
</span><span id="line-4761"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)
-&gt; m (Step
        (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)
 -&gt; m (Step
         (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)))
-&gt; Step (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)
-&gt; m (Step
        (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int64, ThreadId, Int64)
-&gt; Step (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)
forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (IORef Int64, ThreadId, Int64)
 -&gt; Step
      (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64))
-&gt; Maybe (IORef Int64, ThreadId, Int64)
-&gt; Step (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(IORef Int64, ThreadId, Int64)
-&gt; Maybe (IORef Int64, ThreadId, Int64)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311567"><span class="hs-identifier hs-var">timeVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679311566"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679311565"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4762"></span><span>
</span><span id="line-4763"></span><span>    </span><span class="annot"><a href="#local-6989586621679311568"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679311564"><span class="annot"><span class="annottext">s :: Maybe (IORef Int64, ThreadId, Int64)
</span><a href="#local-6989586621679311564"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679311563"><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311563"><span class="hs-identifier hs-var">timeVar</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679311562"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679311562"><span class="hs-identifier hs-var">t0</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-4764"></span><span>        </span><span id="local-6989586621679311561"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679311561"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int64 -&gt; m Int64
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Int64 -&gt; m Int64) -&gt; IO Int64 -&gt; m Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int64 -&gt; IO Int64
forall a. Prim a =&gt; IORef a -&gt; IO a
</span><a href="Streamly.Internal.Data.IORef.Prim.html#readIORef"><span class="hs-identifier hs-var">Prim.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int64
</span><a href="#local-6989586621679311563"><span class="hs-identifier hs-var">timeVar</span></a></span><span>
</span><span id="line-4765"></span><span>        </span><span class="hs-comment">-- XXX we can perhaps use an AbsTime64 using a 64 bit Int for</span><span>
</span><span id="line-4766"></span><span>        </span><span class="hs-comment">-- efficiency.  or maybe we can use a representation using Double for</span><span>
</span><span id="line-4767"></span><span>        </span><span class="hs-comment">-- floating precision time</span><span>
</span><span id="line-4768"></span><span>        </span><span class="annot"><span class="annottext">Step (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)
-&gt; m (Step
        (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Step (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)
 -&gt; m (Step
         (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)))
-&gt; Step (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)
-&gt; m (Step
        (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(AbsTime, RelTime64)
-&gt; Maybe (IORef Int64, ThreadId, Int64)
-&gt; Step (Maybe (IORef Int64, ThreadId, Int64)) (AbsTime, RelTime64)
forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MicroSecond64 -&gt; AbsTime
forall a. TimeUnit a =&gt; a -&gt; AbsTime
</span><a href="Streamly.Internal.Data.Time.Units.html#toAbsTime"><span class="hs-identifier hs-var">toAbsTime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; MicroSecond64
</span><a href="Streamly.Internal.Data.Time.Units.html#MicroSecond64"><span class="hs-identifier hs-var">MicroSecond64</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679311562"><span class="hs-identifier hs-var">t0</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-4769"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MicroSecond64 -&gt; RelTime64
forall a. TimeUnit64 a =&gt; a -&gt; RelTime64
</span><a href="Streamly.Internal.Data.Time.Units.html#toRelTime64"><span class="hs-identifier hs-var">toRelTime64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; MicroSecond64
</span><a href="Streamly.Internal.Data.Time.Units.html#MicroSecond64"><span class="hs-identifier hs-var">MicroSecond64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679311561"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int64 -&gt; Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679311562"><span class="hs-identifier hs-var">t0</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (IORef Int64, ThreadId, Int64)
</span><a href="#local-6989586621679311564"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-4770"></span></pre></body></html>